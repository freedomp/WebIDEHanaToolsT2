/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/Column','sap/m/Label','sap/m/MessageBox','sap/m/Table','sap/m/Text','sap/m/OverflowToolbar','sap/m/ToolbarSeparator','sap/m/VBox','sap/ui/comp/library','sap/ui/comp/providers/TableProvider','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/smartvariants/SmartVariantManagement','sap/ui/model/FilterOperator','sap/ui/model/json/JSONModel','sap/ui/table/AnalyticalColumn','sap/ui/table/AnalyticalTable','sap/ui/table/Column','sap/ui/table/Table','sap/ui/table/TreeTable','sap/ui/comp/personalization/Util'],function(q,C,L,M,R,T,O,a,V,l,b,F,S,c,J,A,d,f,g,h,P){"use strict";var j=V.extend("sap.ui.comp.smarttable.SmartTable",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},ignoredFields:{type:"string",group:"Misc",defaultValue:null},initiallyVisibleFields:{type:"string",group:"Misc",defaultValue:null},requestAtLeastFields:{type:"string",group:"Misc",defaultValue:null},ignoreFromPersonalisation:{type:"string",group:"Misc",defaultValue:null},tableType:{type:"sap.ui.comp.smarttable.TableType",group:"Misc",defaultValue:null},useVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},useExportToExcel:{type:"boolean",group:"Misc",defaultValue:true},useTablePersonalisation:{type:"boolean",group:"Misc",defaultValue:true},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},toolbarStyleClass:{type:"string",group:"Misc",defaultValue:null},enableCustomFilter:{type:"boolean",group:"Misc",defaultValue:true},persistencyKey:{type:"string",group:"Misc",defaultValue:null},useOnlyOneSolidToolbar:{type:"boolean",group:"Misc",defaultValue:false},currentVariantId:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Misc",defaultValue:false},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},tableBindingPath:{type:"string",group:"Misc",defaultValue:null},editTogglable:{type:"boolean",group:"Misc",defaultValue:false},demandPopin:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{customToolbar:{type:"sap.m.Toolbar",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},noData:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false}},events:{initialise:{},beforeRebindTable:{},editToggled:{},dataReceived:{},afterVariantInitialise:{},afterVariantSave:{},afterVariantApply:{},showOverlay:{}}}});j.prototype.init=function(){sap.m.FlexBox.prototype.init.call(this);this.addStyleClass("sapUiCompSmartTable");this.setFitContainer(true);this.setHeight("100%");this._bUpdateToolbar=true;};j.prototype._createVariantManagementControl=function(){if(this._oVariantManagement||(!this.getUseVariantManagement()&&!this.getUseTablePersonalisation())||!this.getPersistencyKey()){return;}var p=new sap.ui.comp.smartvariants.PersonalizableInfo({type:"table",keyName:"persistencyKey",dataSource:"TODO"});p.setControl(this);this._oVariantManagement=new sap.ui.comp.smartvariants.SmartVariantManagement({personalizableControls:p,initialise:function(e){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}this.fireAfterVariantInitialise();}.bind(this),save:function(e){this._variantSaved();}.bind(this),afterSave:function(){this.fireAfterVariantSave({currentVariantId:this.getCurrentVariantId()});}.bind(this),showShare:false});this._oVariantManagement.initialise();};j.prototype._variantSaved=function(){if(this._oPersController){this._oPersController.setPersonalizationData(this._oCurrentVariant);}};j.prototype.setUseExportToExcel=function(u){this.setProperty("useExportToExcel",u,true);this._bUpdateToolbar=true;};j.prototype.setUseTablePersonalisation=function(u){this.setProperty("useTablePersonalisation",u,true);this._bUpdateToolbar=true;};j.prototype.setUseVariantManagement=function(u){this.setProperty("useVariantManagement",u,true);if(this._oPersController){this._oPersController.setResetToInitialTableState(!u);}this._bUpdateToolbar=true;};j.prototype.setToolbarStyleClass=function(s){this.setProperty("toolbarStyleClass",s,true);};j.prototype.setCustomToolbar=function(o){if(this._oCustomToolbar){this.removeItem(this._oCustomToolbar);}this._oCustomToolbar=o;this._bUpdateToolbar=true;};j.prototype.getCustomToolbar=function(){return this._oCustomToolbar;};j.prototype.setHeader=function(t){this.setProperty("header",t,true);this._refreshHeaderText();};j.prototype.setShowRowCount=function(s){this.setProperty("showRowCount",s,true);this._refreshHeaderText();};j.prototype.setEditTogglable=function(t){this.setProperty("editTogglable",t,true);this._bUpdateToolbar=true;};j.prototype.setEditable=function(e){this.setProperty("editable",e,true);};j.prototype.setDemandPopin=function(D){var o=this.getDemandPopin();if(o===D){return;}this.setProperty("demandPopin",D,true);if(this.bIsInitialised){if(D){this._updateColumnsPopinFeature();}else{this._deactivateColumnsPopinFeature();}}};j.prototype._refreshHeaderText=function(){if(!this._headerText){this._bUpdateToolbar=true;return;}var t=this.getHeader();if(this.getShowRowCount()){var r=parseInt(this._getRowCount(),10);q.sap.require("sap.ui.core.format.NumberFormat");var v=sap.ui.core.format.NumberFormat.getFloatInstance().format(r);t+=" ("+v+")";}this._headerText.setText(t);};j.prototype._createToolbar=function(){var o=null;if(!this._oToolbar){o=this.getCustomToolbar();if(o){this._oToolbar=o;}else{this._oToolbar=new O({design:sap.m.ToolbarDesign.Transparent});this._oToolbar.addStyleClass("sapUiCompSmartTableToolbar");if(this.getToolbarStyleClass()){this._oToolbar.addStyleClass(q.sap.encodeHTML(this.getToolbarStyleClass()));}}this._oToolbar.setLayoutData(new sap.m.FlexItemData({shrinkFactor:0}));this.insertItem(this._oToolbar,0);}};j.prototype._createToolbarContent=function(){this._addVariantManagementToToolbar();this._addSeparatorToToolbar();this._addHeaderToToolbar();this._addSpacerToToolbar();this._addEditTogglableToToolbar();this._addTablePersonalisationToToolbar();this._addExportToExcelToToolbar();if(this._oToolbar&&(this._oToolbar.getContent().length===0||(this._oToolbar.getContent().length===1&&this._oToolbar.getContent()[0]instanceof sap.m.ToolbarSpacer))){this.removeItem(this._oToolbar);this._oToolbar.destroy();this._oToolbar=null;}};j.prototype._addEditTogglableToToolbar=function(){if(this.getEditTogglable()){if(!this._oEditButton){this._oEditButton=new sap.m.Button({type:sap.m.ButtonType.Default,icon:this.getEditable()?"sap-icon://display":"sap-icon://edit",tooltip:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_EDITTOGGLE_TOOLTIP"),press:q.proxy(function(){var e=this.getEditable();e=!e;this.setEditable(e,true);this._oEditButton.setIcon(e?"sap-icon://display":"sap-icon://edit");this.fireEditToggled({editable:e});},this)});}if(this._oEditButton){this._oToolbar.addContent(this._oEditButton);}}else if(this._oEditButton){this._oToolbar.removeContent(this._oEditButton);}};j.prototype._addHeaderToToolbar=function(){if(this.getHeader()){if(!this._headerText){this._headerText=new T();this._headerText.addStyleClass("sapMH4Style");this._headerText.addStyleClass("sapUiCompSmartTableHeader");}this._refreshHeaderText();this._oToolbar.insertContent(this._headerText,0);}else if(this._headerText){this._oToolbar.removeContent(this._headerText);}};j.prototype._addSeparatorToToolbar=function(){if(this.getHeader()&&this.getUseVariantManagement()){this._oSeparator=new a();this._oToolbar.insertContent(this._oSeparator,0);if(!this._oToolbar.getHeight()){this._oToolbar.addStyleClass("sapUiCompSmartTableToolbarHeight");}}else if(this._oSeparator){this._oToolbar.removeContent(this._oSeparator);}};j.prototype._addVariantManagementToToolbar=function(){if(this.getUseVariantManagement()){this._oToolbar.insertContent(this._oVariantManagement,0);}else if(this._oVariantManagement){this._oToolbar.removeContent(this._oVariantManagement);}};j.prototype._addSpacerToToolbar=function(){var e=false,I=this._oToolbar.getContent(),i,k;if(I){k=I.length;i=0;for(i;i<k;i++){if(I[i]instanceof sap.m.ToolbarSpacer){e=true;break;}}}if(!e){this._oToolbar.addContent(new sap.m.ToolbarSpacer());}};j.prototype._addTablePersonalisationToToolbar=function(){if(this.getUseTablePersonalisation()){if(!this._oTablePersonalisationButton){this._oTablePersonalisationButton=new sap.m.Button({type:sap.m.ButtonType.Default,icon:"sap-icon://action-settings",tooltip:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_PERSOBTN_TOOLTIP"),press:q.proxy(function(e){this._oPersController.openDialog();},this)});}this._oToolbar.addContent(this._oTablePersonalisationButton);}else if(this._oTablePersonalisationButton){this._oToolbar.removeContent(this._oTablePersonalisationButton);}};j.prototype._addExportToExcelToToolbar=function(){if(this.getUseExportToExcel()&&this._bTableSupportsExcelExport){var t=this;if(!this._oUseExportToExcel){this._oUseExportToExcel=new sap.m.Button({type:sap.m.ButtonType.Default,icon:"sap-icon://excel-attachment",tooltip:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_EXPORT_TEXT"),press:function(e){var D=function(){var o=t._getRowBinding();var u=o.getDownloadUrl("xlsx");u=t._removeExpandParameter(u);window.open(u);};var r=t._getRowCount();if(r>10000){M.confirm(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("DOWNLOAD_CONFIRMATION_TEXT",r),{actions:[M.Action.YES,M.Action.NO],onClose:function(o){if(o===M.Action.YES){D();}}});}else{D();}}});this._setExcelExportEnableState();}this._oToolbar.addContent(this._oUseExportToExcel);}else if(this._oUseExportToExcel){this._oToolbar.removeContent(this._oUseExportToExcel);}};j.prototype._adjustUrlToVisibleColumns=function(u){var v=this._getVisibleColumnPaths();var s=u.replace(new RegExp("([\\?&]\\$select=)[^&]+"),function(r,m){if(v&&v.length){return m+q.sap.encodeURL(v.join(","));}else{return"";}});return s;};j.prototype._removeExpandParameter=function(u){var s=u.replace(new RegExp("([\\?&]\\$expand=[^&]+)(&?)"),function(r,m,e){return e?m.substring(0,1):"";});return s;};j.prototype._getRowCount=function(){var r=this._getRowBinding();if(!r){return 0;}var i=0;if(r.getTotalSize){i=r.getTotalSize();}else{i=r.getLength();}if(i<0||i==="0"){i=0;}return i;};j.prototype._setExcelExportEnableState=function(){if(this._oUseExportToExcel){var r=this._getRowCount();if(r>0){this._oUseExportToExcel.setEnabled(true);}else{var e;if(this._isMobileTable){e=this._oTable.getItems();}else{e=this._oTable.getRows();}var E=e!=null&&e.length>0&&e[0].getBindingContext()!=null;this._oUseExportToExcel.setEnabled(E);}}};j.prototype._createPersonalizationController=function(){if(this._oPersController||!this.getUseTablePersonalisation()){return;}var s=this.data("p13nDialogSettings");if(typeof s==="string"){try{s=JSON.parse(s);}catch(e){s=null;}}s=this._setIgnoreFromPersonalisationToSettings(s);q.sap.require("sap.ui.comp.personalization.Controller");this._oPersController=new sap.ui.comp.personalization.Controller({table:this._oTable,setting:s,resetToInitialTableState:!this.getUseVariantManagement(),beforePotentialTableChange:q.proxy(this._beforePersonalisationModelDataChange,this),afterPotentialTableChange:q.proxy(this._afterPersonalisationModelDataChange,this),afterP13nModelDataChange:q.proxy(this._personalisationModelDataChange,this)});};j.prototype._setIgnoreFromPersonalisationToSettings=function(s){var i=P.createArrayFromString(this.getIgnoreFromPersonalisation());if(i.length){if(!s){s={};}var e=function(k){if(!s[k]){s[k]={};}s[k].ignoreColumnKeys=i;};e("filter");e("sort");e("group");e("columns");}return s;};j.prototype._getRowBinding=function(){if(this._oTable){return this._oTable.getBinding(this._sAggregation);}};j.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);this._initialiseMetadata();};j.prototype.propagateProperties=function(){V.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();};j.prototype._initialiseMetadata=function(){if(!this.bIsInitialised){var m=this.getModel();if(m){if(m.bLoadMetadataAsync&&m.getMetaModel()&&m.getMetaModel().loaded){if(!this._bMetaModelLoadAttached){m.getMetaModel().loaded().then(this._onMetadataInitialised.bind(this));this._bMetaModelLoadAttached=true;}}else{this._onMetadataInitialised();}}}};j.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){this._createTableProvider();if(this._oTableProvider){this._aTableViewMetadata=this._oTableProvider.getTableViewMetadata();if(this._aTableViewMetadata){if(!this._isMobileTable&&this.getDemandPopin()){this.setDemandPopin(false);q.sap.log.error("use SmartTable property 'demandPopin' only  with responsive table, property has been set to false");}this.bIsInitialised=true;this._bTableSupportsExcelExport=this._oTableProvider.getSupportsExcelExport();this._listenToSmartFilter();this._createVariantManagementControl();this._createToolbarContent();this._createContent();this._createPersonalizationController();this._oEditModel=new J({editable:this.getEditable()});this.bindProperty("editable",{path:"sm4rtM0d3l>/editable"});this.setModel(this._oEditModel,"sm4rtM0d3l");this.fireInitialise();if(this.getEnableAutoBinding()){this._reBindTable();}}}}};j.prototype._createTableProvider=function(){var m,e,i;e=this.getEntitySet();i=this.getIgnoredFields();m=this.getModel();if(m&&!this._bTableCreated){this._aExistingColumns=[];this._aAlwaysSelect=[];this._oTemplate=null;this._createToolbar();this._createTable();this._bTableCreated=true;}if(m&&e){if(this._aExistingColumns.length){if(i){i+=","+this._aExistingColumns.toString();}else{i=this._aExistingColumns.toString();}}this._oTableProvider=new sap.ui.comp.providers.TableProvider({entitySet:e,ignoredFields:i,initiallyVisibleFields:this.getInitiallyVisibleFields(),isEditableTable:this.getEditable(),isAnalyticalTable:this._isAnalyticalTable,dateFormatSettings:this.data("dateFormatSettings"),currencyFormatSettings:this.data("currencyFormatSettings"),defaultDropDownDisplayBehaviour:this.data("defaultDropDownDisplayBehaviour"),useSmartField:this.data("useSmartField"),enableInResultForLineItem:this.data("enableInResultForLineItem"),model:m});}};j.prototype._listenToSmartFilter=function(){var s=null;s=this.getSmartFilterId();this._oSmartFilter=this._findControl(s);if(this._oSmartFilter){this._oSmartFilter.attachSearch(q.proxy(this._reBindTable,this));this._oSmartFilter.attachFilterChange(q.proxy(function(){this._showOverlay(true);},this));this._oSmartFilter.attachCancel(q.proxy(function(){this._showOverlay(false);},this));this._setNoDataText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_DATA"));}};j.prototype._showOverlay=function(s){if(s){var o={show:true};this.fireShowOverlay({overlay:o});s=o.show;}this._oTable.setShowOverlay(s);};j.prototype._findControl=function(i){var r,v;if(i){r=sap.ui.getCore().byId(i);if(!r){v=this._getView();if(v){r=v.byId(i);}}}return r;};j.prototype._getView=function(){if(!this._oView){var o=this.getParent();while(o){if(o instanceof sap.ui.core.mvc.View){this._oView=o;break;}o=o.getParent();}}return this._oView;};j.prototype.rebindTable=function(){this._reBindTable();};j.prototype._reBindTable=function(){var t,i,e,s,p=[],k,E,r,m,n,o,u={},B={preventTableBind:false};t=this._getTablePersonalisationData()||{};k=t.filters;E=t.excludeFilters;o=t.sorters;if(this._oSmartFilter){s=this._oSmartFilter.getFilters();u=this._oSmartFilter.getParameters()||{};}if(s&&s.length){if(E){p=[new sap.ui.model.Filter([s[0],E],true)];}else{p=s;}}else if(E){p=[E];}if(k){k=p.concat(k);}else{k=p;}r=this.getRequestAtLeastFields();if(r){m=r.split(",");}else{m=[];}m.concat(this._aAlwaysSelect);n=this._getVisibleColumnPaths();if(!n||!n.length){n=m;}else{e=m.length;for(i=0;i<e;i++){if(n.indexOf(m[i])<0){n.push(m[i]);}}}if(n&&n.length){u["select"]=n.toString();}u["useBatchRequests"]=true;if(!o){o=[];}B.filters=k;B.sorter=o;B.parameters=u;this.fireBeforeRebindTable({bindingParams:B});if(!B.preventTableBind){o=B.sorter;k=B.filters;n=B.parameters["select"];if(!n||!n.length){M.error(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_COLS"),{styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});return;}this._oTable.setEnableBusyIndicator(false);this._oTable.setBusy(true);this._setNoDataText(" ");if(this._oTable._setSuppressRefresh){this._oTable._setSuppressRefresh(false);}this._bDataLoadPending=true;this._oTable.bindRows({path:this.getTableBindingPath()||("/"+this.getEntitySet()),filters:k,sorter:o,parameters:u,template:this._oTemplate,events:{dataReceived:function(v){this._onDataLoadComplete(v,true);this.fireDataReceived(v);}.bind(this),change:this._onDataLoadComplete.bind(this)}});this._showOverlay(false);this._bIsTableBound=true;}};j.prototype._onDataLoadComplete=function(e,i){if(this._bDataLoadPending||i){this._bDataLoadPending=false;if(!this._getRowCount()){this._setNoDataText();}this._oTable.setBusy(false);this._oTable.setEnableBusyIndicator(true);this.updateTableHeaderState();this._disableSumRows();}};j.prototype.setNoData=function(n){this._oNoData=n;};j.prototype.getNoData=function(){return this._oNoData;};j.prototype._setNoDataText=function(o){var s=this._oTable.setNoData;if(!s){s=this._oTable.setNoDataText;}if(!s){return;}var n=o;if(!n){n=this.getNoData();}if(!n){n=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_RESULTS");}s.call(this._oTable,n);};j.prototype.updateTableHeaderState=function(){this._refreshHeaderText();this._setExcelExportEnableState();};j.prototype._createContent=function(){var i,e=0,o,k,I,m;m=this._parseIndexedColumns();e=this._aTableViewMetadata.length;for(i=0;i<e;i++){o=this._aTableViewMetadata[i];if(o.inResult){this._aAlwaysSelect.push(o.name);}this._registerContentTemplateEvents(o.template);I=this.getId()+"-"+o.name;I=I.replace(/[^A-Za-z0-9_.:]+/g,"_");k=this._createColumn(o,I);k.data("p13nData",{columnKey:o.name,leadingProperty:o.name,additionalProperty:o.additionalProperty,sortProperty:o.sortable?o.name:undefined,filterProperty:o.filterable?o.name:undefined,type:o.filterType,maxLength:o.maxLength,precision:o.precision,scale:o.scale,aggregationRole:o.aggregationRole});if(o.filterable&&k.setFilterProperty){k.setFilterProperty(o.name);}if(o.sortable&&k.setSortProperty){k.setSortProperty(o.name);}this._oTable.addColumn(k);}this._insertIndexedColumns(m);this._updateColumnsPopinFeature();this._storeInitialColumnSettings();};j.prototype._parseIndexedColumns=function(){var i,e,o,I,k,s,m,t;var n=this._oTable.getColumns();var p=null;if(this._oTemplate&&this._oTemplate.getCells){p=this._oTemplate.getCells();}if(!n){return null;}I=[];e=n.length;for(i=0;i<e;i++){o=n[i];k=o.data("p13nData");s=null;if(k){s=k.columnIndex;}m=-1;if(s!==null&&s!==undefined){m=parseInt(s,10);}if(!isNaN(m)&&m>-1){if(p){t=p[i];this._oTemplate.removeCell(t);}else{t=null;}I.push({index:m,column:o,template:t});this._oTable.removeColumn(o);}}I.sort(function(r,u){return r.index-u.index;});return I;};j.prototype._insertIndexedColumns=function(I){var i,e,o;if(!I){return;}e=I.length;for(i=0;i<e;i++){o=I[i];this._oTable.insertColumn(o.column,o.index);if(o.template){this._oTemplate.insertCell(o.template,o.index);}}};j.prototype._updateColumnsPopinFeature=function(){if(!this._isMobileTable||!this.getDemandPopin()){return;}var e=this._oTable.getColumns();if(!e){return;}e=e.filter(function(m){return m.getVisible();});e.sort(function(m,n){return m.getOrder()-n.getOrder();});var o,k=e.length;for(var i=0;i<k;i++){o=e[i];if(i<2){o.setDemandPopin(false);o.setMinScreenWidth("1px");}else{o.setDemandPopin(true);o.setPopinDisplay(sap.m.PopinDisplay.Inline);o.setMinScreenWidth((i+1)*10+"rem");}}};j.prototype._storeInitialColumnSettings=function(){this._aInitialSorters=[];P.createSort2Json(this._oTable,this._aInitialSorters,P.createArrayFromString(this.getIgnoreFromPersonalisation()));};j.prototype._deactivateColumnsPopinFeature=function(){if(!this._isMobileTable){return;}var e=this._oTable.getColumns();if(!e){return;}var o,k=e.length;for(var i=0;i<k;i++){o=e[i];o.setDemandPopin(false);o.setMinScreenWidth("1px");}};j.prototype._registerContentTemplateEvents=function(t){if(t instanceof sap.ui.comp.navpopover.SmartLink){var s=this.getSemanticObjectController();t.setSemanticObjectController(s);}};j.prototype._updateInitialColumns=function(){var i=this._oTable.getColumns(),k=i?i.length:0,o,m,s;while(k--){s=null;o=i[k];if(o){m=o.data("p13nData");if(typeof m==="string"){try{m=JSON.parse(m);}catch(e){}if(m){o.data("p13nData",m);}}if(m){s=m["columnKey"];}if(s){this._aExistingColumns.push(s);}}}};j.prototype._getVisibleColumnPaths=function(){var s=[],e=this._oTable.getColumns(),i,k=e?e.length:0,o,m,p,n;for(i=0;i<k;i++){o=e[i];p=null;if(o.getVisible()){if(o.getLeadingProperty){p=o.getLeadingProperty();}m=o.data("p13nData");if(m){if(!p){p=m["leadingProperty"];}n=m["additionalProperty"];}if(p&&s.indexOf(p)<0){s.push(p);}if(n&&s.indexOf(n)<0){s.push(n);}}}return s;};j.prototype._createTable=function(){var e=this.getItems(),i=e?e.length:0,t;this._sAggregation="rows";while(i--){t=e[i];if(t instanceof g||t instanceof R){break;}t=null;}if(t){this._oTable=t;if(t instanceof d){this._isAnalyticalTable=true;}else if(t instanceof R){this._isMobileTable=true;this._oTemplate=(t.getItems()&&t.getItems().length>0)?t.getItems()[0]:new sap.m.ColumnListItem();t.removeAllItems();}else if(t instanceof h){this._isTreeTable=true;}this._updateInitialColumns();}else{if(this.getTableType()==="AnalyticalTable"){this._isAnalyticalTable=true;this._oTable=new d({enableCustomFilter:true});}else if(this.getTableType()==="ResponsiveTable"){this._isMobileTable=true;this._oTable=new R({growing:true});this._oTemplate=new sap.m.ColumnListItem();}else if(this.getTableType()==="TreeTable"){this._isTreeTable=true;this._oTable=new h({selectionMode:sap.ui.table.SelectionMode.MultiToggle});}else{this._oTable=new g({selectionMode:sap.ui.table.SelectionMode.MultiToggle});}if(this._oTable.setVisibleRowCountMode){this._oTable.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Auto);}this.insertItem(this._oTable,2);}if(!this._oTable.getLayoutData()){this._oTable.setLayoutData(new sap.m.FlexItemData({growFactor:1,baseSize:"0%"}));}this._oTable.addStyleClass("sapUiCompSmartTableInnerTable");this._oTable.setEnableBusyIndicator(true);this._oTable.setBusyIndicatorDelay(0);if(this._oTable.setEnableCustomFilter){this._oTable.setEnableCustomFilter(this.getEnableCustomFilter());}if(this._oTable.setShowColumnVisibilityMenu){this._oTable.setShowColumnVisibilityMenu(false);}if(this._oTable.getEnableCustomFilter&&this._oTable.getEnableCustomFilter()){if(this._oTable.setEnableCellFilter){this._oTable.setEnableCellFilter(false);}if(this._oTable.attachCustomFilter){this._oTable.attachCustomFilter(q.proxy(this._showTableFilterDialog,this));}}if(this._isAnalyticalTable){this._createColumn=this._createAnalyticalColumn;}else if(this._isMobileTable){this._sAggregation="items";this._createColumn=this._createMobileColumn;this._oTable.bindRows=this._oTable.bindItems;}if(!this._isMobileTable){this._oTable.attachEvent("_rowsUpdated",function(){this._setExcelExportEnableState();},this);}if(this._oTable._setLargeDataScrolling){this._oTable._setLargeDataScrolling(true);}};j.prototype.getTable=function(){return this._oTable;};j.prototype._showTableFilterDialog=function(e){if(this._oPersController){this._oPersController.openDialog({filter:{visible:true,payload:{column:e.getParameter("column")}}});}};j.prototype._disableSumRows=function(){if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<11){q.sap.delayedCall(60,this,function(){if(this.getEditable()){this._oTable.$().find(".sapUiAnalyticalTableSum input").prop("disabled",true);this._oTable.$().find(".sapUiTableGroupHeader input").prop("disabled",true);}});}};j.prototype._createColumn=function(o,i){var e;e=new f(i,{autoResizable:true,hAlign:o.align,width:o.width,visible:o.isInitiallyVisible,label:new L({textAlign:o.align,text:o.label}),sorted:o.sorted,sortOrder:o.sortOrder,tooltip:o.quickInfo,showSortMenuEntry:o.sortable,showFilterMenuEntry:o.filterable,name:o.fieldName,template:o.template});return e;};j.prototype._createAnalyticalColumn=function(o,i){var e;e=new A(i,{autoResizable:true,hAlign:o.align,width:o.width,visible:o.isInitiallyVisible,inResult:o.inResult,label:new L({textAlign:o.align,text:o.label}),tooltip:o.quickInfo,sorted:o.sorted,sortOrder:o.sortOrder,showSortMenuEntry:o.sortable,showFilterMenuEntry:o.filterable,summed:o.summed,leadingProperty:o.name,template:o.template});return e;};j.prototype._createMobileColumn=function(o,i){var e;e=(new C(i,{hAlign:o.align,visible:o.isInitiallyVisible,header:new T({text:o.label}),tooltip:o.quickInfo}));if(o.template&&o.template.setWrapping){o.template.setWrapping(true);}if(this._oTemplate){this._oTemplate.addCell(o.template);}return e;};j.prototype.fetchVariant=function(){if(this._oCurrentVariant==="STANDARD"||this._oCurrentVariant===null){return{};}return this._oCurrentVariant;};j.prototype.applyVariant=function(v,s){this._oCurrentVariant=v;if(this._oCurrentVariant==="STANDARD"){this._oCurrentVariant=null;}if(s==="STANDARD"){this._oApplicationDefaultVariant=this._oCurrentVariant;}if(this._oApplicationDefaultVariant&&!s){this._oCurrentVariant=q.extend(true,{},this._oApplicationDefaultVariant,v);}this._bApplyingVariant=true;if(this._oTable._setSuppressRefresh){this._oTable._setSuppressRefresh(true);}if(this._oPersController){if(this._oCurrentVariant===null||q.isEmptyObject(this._oCurrentVariant)){this._oPersController.resetPersonalization(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._oPersController.setPersonalizationData(this._oCurrentVariant);}}if(this._bIsTableBound||!this._oSmartFilter){this._reBindTable();}else{this._showOverlay(true);}this._bApplyingVariant=false;this.fireAfterVariantApply({currentVariantId:this.getCurrentVariantId()});};j.prototype._beforePersonalisationModelDataChange=function(e){this._oTable.setEnableBusyIndicator(false);this._oTable.setBusy(true);if(this._oTable._setSuppressRefresh){this._oTable._setSuppressRefresh(true);}};j.prototype._afterPersonalisationModelDataChange=function(e){this._updateColumnsPopinFeature();this._oTable.setBusy(false);this._oTable.setEnableBusyIndicator(true);};j.prototype._personalisationModelDataChange=function(e){this._oCurrentVariant=e.getParameter("persistentData");if(this._bApplyingVariant){return;}var o=e.getParameter("changeType");var i=this._getChangeStatus(o);if(i===sap.ui.comp.personalization.ChangeType.Unchanged){return;}if(!this.getUseVariantManagement()){this._persistPersonalisation();}else if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}if(i===sap.ui.comp.personalization.ChangeType.ModelChanged){if(this._bIsTableBound||!this._oSmartFilter){this._reBindTable();}else{this._showOverlay(true);}}};j.prototype._getChangeStatus=function(o){if(!o){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(o.sort===sap.ui.comp.personalization.ChangeType.ModelChanged||o.filter===sap.ui.comp.personalization.ChangeType.ModelChanged||o.columns===sap.ui.comp.personalization.ChangeType.ModelChanged||o.group===sap.ui.comp.personalization.ChangeType.ModelChanged){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(o.sort===sap.ui.comp.personalization.ChangeType.TableChanged||o.filter===sap.ui.comp.personalization.ChangeType.TableChanged||o.columns===sap.ui.comp.personalization.ChangeType.TableChanged||o.group===sap.ui.comp.personalization.ChangeType.TableChanged){return sap.ui.comp.personalization.ChangeType.TableChanged;}return sap.ui.comp.personalization.ChangeType.Unchanged;};j.prototype._getTablePersonalisationData=function(){if(!this._oCurrentVariant){return null;}var s=[],e=[],E=[],o,G,i,k,m,n,p,r,t="";if(this._isMobileTable&&this._oCurrentVariant.group&&this._oCurrentVariant.group.groupItems){G=this._oCurrentVariant.group.groupItems[0];m=this._getColumnByKey(G.columnKey);if(m){t=m.getHeader().getText();}r=this._getPathFromColumnKeyAndProperty(G.columnKey,"sortProperty");p=r;i=new sap.ui.model.Sorter(p,G.operation==="GroupDescending",function(u){var K=u.getProperty(p);return{key:K,text:t?t+" : "+K:K};});s.push(i);}if(this._oCurrentVariant.sort){k=this._oCurrentVariant.sort.sortItems;}else{k=this._aInitialSorters;}if(k){k.forEach(function(u){var D=u.operation==="Descending";r=this._getPathFromColumnKeyAndProperty(u.columnKey,"sortProperty");if(i&&i.sPath===r){i.bDescending=D;}else{s.push(new sap.ui.model.Sorter(r,D));}},this);}if(this._oCurrentVariant.filter){this._oCurrentVariant.filter.filterItems.forEach(function(u){var v=u.value1,w=u.value2;r=null;m=this._getColumnByKey(u.columnKey);if(m){if(m.getFilterProperty){r=m.getFilterProperty();}n=m.data("p13nData");if(n){if(!r){r=n["filterProperty"];}if(n["type"]==="date"){if(v&&typeof(v)==="string"){v=new Date(v);}if(w&&typeof(w)==="string"){w=new Date(w);}}}}if(v instanceof Date&&this._oTableProvider&&this._oTableProvider.getIsUTCDateHandlingEnabled()){v=F.getDateInUTCOffset(v);w=w?F.getDateInUTCOffset(w):w;}if(u.exclude){E.push(new sap.ui.model.Filter(r,c.NE,v));}else{e.push(new sap.ui.model.Filter(r,u.operation,v,w));}},this);if(E.length){o=new sap.ui.model.Filter(E,true);}}return{filters:e,excludeFilters:o,sorters:s};};j.prototype._getColumnByKey=function(s){var e,o,k,i,m;if(this._oTable){e=this._oTable.getColumns();k=e.length;for(i=0;i<k;i++){o=e[i];m=o.data("p13nData");if(m&&m.columnKey===s){return o;}}}return null;};j.prototype._getPathFromColumnKeyAndProperty=function(s,p){var e=null,o,i;o=this._getColumnByKey(s);if(o){if(p=="sortProperty"&&o.getSortProperty){e=o.getSortProperty();}else if(p=="filterProperty"&&o.getFilterProperty){e=o.getFilterProperty();}else if(p=="leadingProperty"&&o.getLeadingProperty){e=o.getLeadingProperty();}if(!e){i=o.data("p13nData");if(i){e=i[p];}}}return e;};j.prototype._persistPersonalisation=function(){var t=this;if(this._oVariantManagement){this._oVariantManagement.getVariantsInfo(function(v){var p=null;if(v&&v.length>0){p=v[0].key;}var o=p!==null;var e={name:"Personalisation",global:false,overwrite:o,key:p,def:true};t._oVariantManagement.fireSave(e);});}};j.prototype.getCurrentVariantId=function(){var k="";if(this._oVariantManagement){k=this._oVariantManagement.getCurrentVariantId();}return k;};j.prototype.setCurrentVariantId=function(v){if(this._oVariantManagement){this._oVariantManagement.setCurrentVariantId(v);}else{q.sap.log.error("sap.ui.comp.smarttable.SmartTable.prototype.setCurrentVariantId: VariantManagement does not exist");}};j.prototype.exit=function(){if(this._oTableProvider&&this._oTableProvider.destroy){this._oTableProvider.destroy();}this._oTableProvider=null;if(this._oPersController&&this._oPersController.destroy){this._oPersController.destroy();}this._oPersController=null;if(this._oVariantManagement&&this._oVariantManagement.destroy){this._oVariantManagement.destroy();}if(this._oEditModel){this._oEditModel.destroy();}if(this._oNoData&&this._oNoData.destroy){this._oNoData.destroy();}this.oNoData=null;this._oEditModel=null;this._oVariantManagement=null;this._oCurrentVariant=null;this._oApplicationDefaultVariant=null;this._aTableViewMetadata=null;this._aExistingColumns=null;this._aAlwaysSelect=null;this._oSmartFilter=null;this._oCustomToolbar=null;this._oToolbar=null;this._oUseExportToExcel=null;this._oTablePersonalisationButton=null;this._oTemplate=null;this._oView=null;this._oTable=null;};return j;},true);
