/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(['sap/ui/core/theming/Parameters','sap/ui/core/Element','./library'],function(P,E,l){"use strict";var F=E.extend("sap.ui.vbm.FeatureCollection",{metadata:{library:"sap.ui.vbm",properties:{srcURL:{type:"string",defaultValue:null},defaultFillColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(186, 193, 196, 0.5)"},defaultBorderColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(255, 255, 255, 1.0)"}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.vbm.Feature",multiple:true,singularName:"item"}},events:{click:{parameters:{featureId:{type:"string"}}},contextMenu:{parameters:{featureId:{type:"string"}}}}}});F.prototype.init=function(){this.mbGeoJSONDirty=true;};F.prototype.setSrcURL=function(s){this.mbGeoJSONDirty=true;this.setProperty("srcURL",s);};F.prototype.createFeatures=function(){var c=this.getDefaultFillColor();var a=this.getDefaultBorderColor();function b(A,D,G,H,I,J,K){this.K=A;this.P=[];this.TT=J;this.C=H;this.CB=I;this["VB:s"]=false;var L,M,N;for(var q=0,O=D.length;q<O;++q){M=D[q];N=[];for(var r=0,Q=M.length;r<Q;++r){L="";for(var s=0,R=M[r].length;s<R;++s){if(s){(L+=";");}L+=M[r][s];}N.push(L);}this.P.push(N);}}delete b.prototype.constructor;var d=null,p=null;p=this.getSrcURL();if(!d&&p){d=jQuery.sap.syncGetJSON(p).data;}if(!d){jQuery.sap.log.error("The path or the GeoJSON file at location "+p+"is invalid.");return;}this.mFeatureColl=[];this.mFeatureBBox=[];this.mNames=[];this.mFeatureProps=[];var x,y,m=0,e=0,g=0,h=0;var i=d.features,t='',j;var C;var k;var B;var n;var o;var q,r,s;for(r=0;r<i.length;++r){n=[];o=[];B=[];var f=i[r];t=(f.properties&&f.properties.name)?f.properties.name:"";this.mFeatureProps[f.id]=f.properties;var u=f.geometry.coordinates;switch(f.geometry.type){case"Polygon":g=Number.MAX_VALUE;h=-Number.MAX_VALUE;m=Number.MAX_VALUE;e=-Number.MAX_VALUE;for(q=0;q<u.length;++q){k=u[q];C=[];for(s=0;s<k.length;++s){j=k[s];if(!q){if((x=j[0])<m){m=x;}if(x>e){e=x;}if((y=j[1])<g){g=y;}if(y>h){h=y;}}C.push(j[0],j[1],"0");}o.push(C);}n.push(o);B.push([m,e,g,h]);break;case"MultiPolygon":for(var v=0,w,z=u.length;v<z;++v){g=Number.MAX_VALUE;h=-Number.MAX_VALUE;m=Number.MAX_VALUE;e=-Number.MAX_VALUE;o=[];w=u[v].length;for(q=0;q<w;++q){k=u[v][q];C=[];for(s=0;s<k.length;++s){j=k[s];if(!q){if((x=j[0])<m){m=x;}if(x>e){e=x;}if((y=j[1])<g){g=y;}if(y>h){h=y;}}C.push(j[0],j[1],"0");}o.push(C);}n.push(o);B.push([m,e,g,h]);}break;case"Point":continue;default:continue;}this.mFeatureColl.push(new b(f.id,n,f.geometry.type,c,a,t,f.id));this.mFeatureBBox[f.id]=window.VBI.MathLib.GetSurroundingBox(B);}};F.prototype.getTemplateObject=function(){var t={};t.id=this.getId();t.datasource=t.id;t.hotDeltaColor="RHLSA(0;1;1;1.5)";t.altBorderDeltaColor=(P)?P.get("sapUiChartDataPointBorderHoverSelectedColor"):"#666";t['type']="{00100000-2012-0004-B001-F311DE491C77}";t['posarraymulti.bind']=t.id+".P";t['color.bind']=t.id+".C";t['colorBorder.bind']=t.id+".CB";t['tooltip.bind']=t.id+".TT";return[t];};F.prototype.getTypeObject=function(){var t={};t['name']=this.getId();t['key']='K';t.A=[{"name":"K","alias":"K","type":"string"},{"name":"VB:s","alias":"VB:s","type":"boolean"},{"name":"P","alias":"P","type":"vectorarraymulti"},{"name":"C","alias":"C","type":"color"},{"name":"CB","alias":"CB","type":"string"},{"name":"TT","alias":"TT","type":"string"}];return[t];};F.prototype.getDataObject=function(){if(this.mbGeoJSONDirty){this.createFeatures();this.mbGeoJSONDirty=false;}var e=[];jQuery.extend(true,e,this.mFeatureColl);if(!e.length){return[];}var o={};var O=this.getItems();for(var n=0,a=O?O.length:0,i;n<a;++n){i=O[n];o[i.getFeatureId()]=i;}for(var b=0,c,d,t;b<e.length;++b){c=e[b];if((d=o[c.K])){c.C=d.getColor();if((t=d.getTooltip())){c.TT=t;}}}return[{"name":this.getId(),"type":"N","E":e}];};F.prototype.getActionArray=function(){var a=[];var i=this.getId();if(this.mEventRegistry["click"]||this.isEventRegistered("click")){a.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this.mEventRegistry["contextMenu"]||this.isEventRegistered("contextMenu")){a.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});}return a;};F.prototype.getFeaturesInfo=function(f){var r=[];for(var n=0,a=f.length,b;n<a;++n){b=f[n];r[b]={};r[b].BBox=this.mFeatureBBox[b];r[b].Midpoint=[(this.mFeatureBBox[b][0]+this.mFeatureBBox[b][1])/2,(this.mFeatureBBox[b][2]+this.mFeatureBBox[b][3])/2];r[b].Name=this.mNames[b];r[b].Properties=this.mFeatureProps[b];}return r;};F.prototype.handleEvent=function(e){var s=e.Action.name;var f="fire"+s[0].toUpperCase()+s.slice(1);var o,i=e.Action.instance;if((o=this.findInstance(i))){if(o.mEventRegistry[s]){if(s==="click"){o.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]['#'];}if(s==="contextMenu"){o.mClickPos=[e.Action.Params.Param[0]['#'],e.Action.Params.Param[1]['#']];jQuery.sap.require("sap.ui.unified.Menu");if(this.oParent.mVBIContext.m_Menus){this.oParent.mVBIContext.m_Menus.deleteMenu("DynContextMenu");}var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";o.fireContextMenu({menu:m});}else if(s==="handleMoved"){o[f]({data:e});}else{o[f]({});}}}if(this.mEventRegistry[s]){this[f]({featureId:i.split(".")[1]});}};F.prototype.openDetailWindow=function(f,p){var o=this.getParent();o.mDTWindowCxt.bUseClickPos=true;o.mDTWindowCxt.open=true;o.mDTWindowCxt.src=f;o.mDTWindowCxt.key=f.getFeatureId();o.mDTWindowCxt.params=p;o.m_bWindowsDirty=true;o.invalidate(this);};F.prototype.openContextMenu=function(f,m){this.oParent.openContextMenu("Area",f,m);};F.prototype.handleChangedData=function(e){if(e&&e.length){for(var n=0,o,i;n<e.length;++n){o=e[n];i=this.findInstance(o.K);if(i){i.handleChangedData(o);}}}};F.prototype.isEventRegistered=function(n){var o=this.getItems();if(!o){return false;}for(var a=0,b=o.length;a<b;++a){if(o[a].mEventRegistry[n]){return true;}}return false;};F.prototype.findInstance=function(n){var o=this.getItems();if(!o){return false;}var k=(n.indexOf(".")!==-1)?n.split(".")[1]:n;for(var a=0,b=o.length;a<b;++a){if(o[a].getFeatureId()===k){return o[a];}}return null;};return F;});
