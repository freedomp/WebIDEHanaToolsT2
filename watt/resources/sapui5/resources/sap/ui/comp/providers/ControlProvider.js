/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil'],function(q,C,a,D,H,I,T,S,M,O,b,c,F){"use strict";var d=function(p){if(p){this._oParentODataModel=p.model;this._oMetadataAnalyser=p.metadataAnalyser;this._aODataFieldMetadata=p.fieldsMetadata;this._oDateFormatSettings=p.dateFormatSettings;this._bEnableDescriptions=p.enableDescriptions;this._oCurrencyFormatSettings=p.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour;this.useSmartField=p.useSmartField==="true";this._sEntitySet=p.entitySet;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new O(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];};d.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};d.prototype.getFieldViewMetadata=function(f,i){var o=this._createFieldMetadata(f);this._createFieldTemplate(o,i);return o;};d.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new b({value:{path:v.name},entitySet:this._sEntitySet,contextEditable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},controlContext:"table"});this._completeSmartField(v);}else{v.template=i?this._createEditableTemplate(v):this._createDisplayOnlyTemplate(v);}};d.prototype._completeSmartField=function(v){var o={annotations:{},path:v.name};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.oMeta.getODataEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.oMeta.getODataEntityType(this._mSmartField.entitySetObject.entityType);}o.modelObject=this._oParentODataModel;o.entitySetObject=this._mSmartField.entitySetObject;o.entitySet=this._mSmartField.entitySetObject;o.entityType=this._mSmartField.entityType;this._oHelper.getProperty(o);o.annotations.uom=this._oHelper.getUnitOfMeasure2(o);o.annotations.text=this._oHelper.getTextProperty2(o);o.annotations.lineitem=this._oMetadataAnalyser.getLineItemAnnotation(o.entitySetObject.entityType);o.annotations.semantic=this._oMetadataAnalyser.getSemanticObjectAnnotationFromProperty(o.property.property);if(o.property.property["sap:value-list"]||o.property.property["com.sap.vocabularies.Common.v1.ValueList"]){o.annotations.valuelist=this._oHelper.getValueListAnnotationPath(o);if(o.property.property["sap:value-list"]){o.annotations.valuelistType=o.property.property["sap:value-list"];}else{o.annotations.valuelistType=this._oMetadataAnalyser.getValueListSemantics(o.property.property["com.sap.vocabularies.Common.v1.ValueList"]);}}this._oHelper.getUOMValueListAnnotationPath(o);delete o.entitySet;v.template.data("configdata",{"configdata":o});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);if(o.annotations.uom){var A=v.template.getTextAlign();if(A==="Initial"){A="End";}v.align=A;}};d.prototype._createEditableTemplate=function(v,B){var t=null,f,o,e;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){f=this._oDateFormatSettings;o={displayFormat:"Date"};t=new D({dateValue:{path:v.name}});}}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}else if(v.type==="Edm.Decimal"){o={precision:v.precision,scale:v.scale};}e=c.getType(v.type,f,o);if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,e,q.proxy(function(){return this._createEditableTemplate(v,true);},this));}if(!t){t=new I({value:{path:v.name,type:e}});if(v.isMeasureField){t.bindProperty("description",{path:v.unit});t.setTextAlign("End");t.setFieldWidth("80%");}else if(this._bEnableDescriptions&&v.description){t.bindProperty("description",{path:v.description});}if(v.hasValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}return t;};d.prototype._associateValueHelpAndSuggest=function(o,f){o.setShowValueHelp(true);this._aValueHelpProvider.push(new sap.ui.comp.providers.ValueHelpProvider({loadAnnotation:true,fullyQualifiedFieldName:f.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,takeOverInputValue:false,fieldName:f.fieldName,type:f.type,maxLength:f.maxLength,displayFormat:f.displayFormat,displayBehaviour:f.displayBehaviour,title:f.label}));o.setShowSuggestion(true);o.setFilterSuggests(false);this._aValueListProvider.push(new sap.ui.comp.providers.ValueListProvider({loadAnnotation:true,fullyQualifiedFieldName:f.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:f.displayFormat}));};d.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,o=null,f,e,A,s,g;if(v.displayFormat==="Date"){f=this._oDateFormatSettings;e={displayFormat:"Date"};}else if(v.type==="Edm.Decimal"){e={precision:v.precision,scale:v.scale};}o=c.getType(v.type,f,e);if(c.isNumeric(v.type)||c.isDateOrTime(v.type)){A="End";}if(v.isMeasureField){t=this._createMeasureFieldTemplate(v,o);}else if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,q.proxy(function(){return this._createDisplayOnlyTemplate(v,true);},this));}else{g={path:v.name,type:o};if(this._bEnableDescriptions&&v.description){s=this._oDefaultDropDownDisplayBehaviour||"descriptionAndId";g={parts:[{path:v.name,type:o},{path:v.description}],formatter:function(i,h){return F.getFormattedExpressionFromDisplayBehaviour(s,i,h);}};}t=new T({wrapping:false,textAlign:A,text:g});}v.align=A;return t;};d.prototype._createSmartLinkFieldTemplate=function(v,t,f){var o=new S({semanticObject:v.semanticObject,semanticObjectLabel:v.label,fieldName:v.name,text:{path:v.name,type:t}});o.setCreateControlCallback(f);return o;};d.prototype._createMeasureFieldTemplate=function(v,t){var o,V,u,e=false;e=!!(v.isCurrencyField&&this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol);V=new T({wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getAmountCurrencyFormatter():F.getMeasureUnitFormatter(),useRawValues:v.isCurrencyField}});u=new T({wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:e?F.getCurrencySymbolFormatter():undefined}});o=new H({justifyContent:"End",items:[V,u]});return o;};d.prototype._createFieldMetadata=function(f){var o={};o.fullName=f.fullName;o.type=f.type;o.name=f.name;o.displayFormat=f.displayFormat;o.maxLength=f.maxLength;o.precision=f.precision;o.scale=f.scale;o.sortable=f.sortable;o.filterable=f.filterable;o.label=f.fieldLabel||f.name;o.quickInfo=f.quickInfo||o.label;o.aggregationRole=f.aggregationRole;o.unit=f.unit;o.description=f.description;o.isCurrencyField=f.isCurrencyField;o.isMeasureField=f.isMeasureField;o.filterType=this._getFilterType(f);o.entityName=f.entityName;this._updateValueListMetadata(o,f);this._setAnnotationMetadata(o);return o;};d.prototype._updateValueListMetadata=function(f,o){f.hasValueListAnnotation=o["sap:value-list"]!==undefined;if(f.hasValueListAnnotation){f.hasFixedValues=o["sap:value-list"]==="fixed-values";}else if(o["com.sap.vocabularies.Common.v1.ValueList"]){f.hasValueListAnnotation=true;f.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(o["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};d.prototype._setAnnotationMetadata=function(f){var A=null;if(!this.useSmartField&&f&&f.fullName){A=this._oMetadataAnalyser.getSemanticObjectAnnotation(f.fullName);if(A){f.semanticObject=A.semanticObject;}}};d.prototype._getFilterType=function(f){if(f.type==="Edm.Decimal"){return"numeric";}else if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){return"date";}else if(f.type==="Edm.String"){return"string";}return undefined;};d.prototype.destroy=function(){var i;if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(this._aValueHelpProvider){i=this._aValueHelpProvider.length;while(i--){this._aValueHelpProvider[i].destroy();}}this._aValueHelpProvider=null;if(this._aValueListProvider){i=this._aValueListProvider.length;while(i--){this._aValueListProvider[i].destroy();}}if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aValueListProvider=null;this._aODataFieldMetadata=null;this._oCurrencyFormatter=null;this.bIsDestroyed=true;};return d;},true);
