/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.representations.utils.UI5ChartHelper");
sap.apf.ui.representations.utils.UI5ChartHelper=function(a,p){var s=this;this.parameter=p;this.classifiedData=[];this.extendedDataSet=[];this.fieldKeysLookup={};this.displayNameLookup={};this.fieldNameLookup={};this.filterLookup={};this.datasetObj={};this.cachedSelection=[];this.filterValues=[];this.dataAlreadySorted=false;this.init=function(D,m,i,o,f){this.metadata=m;this.formatter=f;b.bind(this)(m,D);c.bind(this)(D);d.bind(this)(i,o);if(this.parameter.requiredFilters!==undefined&&this.parameter.requiredFilters.length!==0){v();}};var v=function(){s.filterValues=s.filterValues.filter(function(f){for(var i=0;i<s.extendedDataResponse.length;i++){var h=0;for(var j=0;j<s.parameter.requiredFilters.length;j++){if(f[j]===s.extendedDataResponse[i][s.parameter.requiredFilters[j]]){h=h+1;}}if(h===s.parameter.requiredFilters.length){return true;}else if(i===s.extendedDataResponse.length-1){return false;}}});s.cachedSelection=e();};var b=function(m,D){var f=this.parameter.dimensions.concat(this.parameter.measures);var r=[];var h=function(n){var o=0;for(var i=0;i<f.length;i++){if(f[i].fieldName===n){o++;}}return(o===0?false:true);};if(this.parameter.requiredFilters){this.parameter.requiredFilters.forEach(function(n){if(!h(n)){var o={fieldName:n};r.push(o);}});}if(r.length!==0){f=f.concat(r);}for(var i=0;i<f.length;i++){var j=f[i];var k=j.fieldName;this.displayNameLookup[k]={};if(m!==undefined){if(m.getPropertyMetadata(k).hasOwnProperty('text')&&(m.getPropertyMetadata(k)["aggregation-role"]!=="measure")){var t=m.getPropertyMetadata(k).text;var l=m.getPropertyMetadata(t).label;this.displayNameLookup[k].DISPLAY_NAME=l;this.displayNameLookup[k].VALUE="formatted_"+k;}else if(m.getPropertyMetadata(k)["aggregation-role"]==="dimension"){this.displayNameLookup[k].DISPLAY_NAME=m.getPropertyMetadata(k).label;this.displayNameLookup[k].VALUE="formatted_"+k;}else{this.displayNameLookup[k].DISPLAY_NAME=m.getPropertyMetadata(k).label;this.displayNameLookup[k].VALUE=k;}if(j.fieldDesc!==undefined&&a.getTextNotHtmlEncoded(j.fieldDesc).length){this.displayNameLookup[k].DISPLAY_NAME=a.getTextNotHtmlEncoded(j.fieldDesc);}if(m.getPropertyMetadata(k).unit!==undefined){var u=m.getPropertyMetadata(k).unit;var U;if(D!==undefined&&D.length!==0){U=D[0][u];this.displayNameLookup[k].DISPLAY_NAME=this.displayNameLookup[k].DISPLAY_NAME+' ('+U+')';}}}this.fieldNameLookup[this.displayNameLookup[k].DISPLAY_NAME]={};this.fieldNameLookup[this.displayNameLookup[k].DISPLAY_NAME].FIELD_NAME=k;this.fieldNameLookup[this.displayNameLookup[k].DISPLAY_NAME].VALUE=this.displayNameLookup[k].VALUE;}};var c=function(D){this.extendedDataResponse=jQuery.extend([],true,D);var i,j,k;if(this.extendedDataResponse.length!==0){for(i=0;i<this.extendedDataResponse.length;i++){for(k=0;k<this.parameter.measures.length;k++){if(this.extendedDataResponse[i][this.parameter.measures[k].fieldName]!==null){this.extendedDataResponse[i][this.parameter.measures[k].fieldName]=parseFloat(this.extendedDataResponse[i][this.parameter.measures[k].fieldName]);}}for(j=0;j<Object.keys(this.displayNameLookup).length;j++){var f=Object.keys(this.displayNameLookup)[j];var h=(this.displayNameLookup[f].VALUE.search('formatted_')!==-1);if(h){var t=this.metadata.getPropertyMetadata(f).hasOwnProperty('text');if(!t){this.extendedDataResponse[i][this.displayNameLookup[f].VALUE]=this.formatter.getFormattedValue(f,this.extendedDataResponse[i][f]);}else{var l=this.metadata.getPropertyMetadata(f).text;var T={text:this.extendedDataResponse[i][l],key:this.extendedDataResponse[i][f]};this.extendedDataResponse[i][this.displayNameLookup[f].VALUE]=this.formatter.getFormattedValueForTextProperty(f,T);}}}var m="";for(j=0;j<this.parameter.dimensions.length;j++){var n=this.displayNameLookup[this.parameter.dimensions[j].fieldName].VALUE;this.extendedDataResponse[i][n]=this.extendedDataResponse[i][n]===null?this.extendedDataResponse[i][n]:this.extendedDataResponse[i][n].toString();m=m+this.extendedDataResponse[i][n];this.filterLookup[m]=[];if(this.parameter.requiredFilters){for(k=0;k<this.parameter.requiredFilters.length;k++){var o={};o.id=this.extendedDataResponse[i][this.parameter.requiredFilters[k]];o.text=this.extendedDataResponse[i][this.displayNameLookup[this.parameter.requiredFilters[k]].VALUE];this.filterLookup[m].push(o);}}}}}else{var q={};for(k=0;k<this.parameter.measures.length;k++){q[s.displayNameLookup[this.parameter.measures[k].fieldName].VALUE]=undefined;}for(j=0;j<this.parameter.dimensions.length;j++){q[s.displayNameLookup[this.parameter.dimensions[j].fieldName].VALUE]=undefined;}this.extendedDataResponse.push(q);}};var d=function(I,D){var o=this.extendedDataResponse;var m=new sap.ui.model.json.JSONModel();m.setData({data:o});var f=[];var M=[];var i=0;for(i=0;i<this.parameter.dimensions.length;i++){f[i]={name:this.displayNameLookup[this.parameter.dimensions[i].fieldName].DISPLAY_NAME,value:this.displayNameLookup[this.parameter.dimensions[i].fieldName].VALUE,kind:this.parameter.dimensions[i].kind?this.parameter.dimensions[i].kind:undefined,axisfeedItemId:this.parameter.dimensions[i].axisfeedItemId?this.parameter.dimensions[i].axisfeedItemId:undefined};}s.measureAxisType=I;for(i=0;i<this.parameter.measures.length;i++){M[i]={name:this.displayNameLookup[this.parameter.measures[i].fieldName].DISPLAY_NAME,value:this.displayNameLookup[this.parameter.measures[i].fieldName].VALUE,kind:this.parameter.measures[i].kind?this.parameter.measures[i].kind:undefined,axisfeedItemId:this.parameter.measures[i].axisfeedItemId?this.parameter.measures[i].axisfeedItemId:undefined};}var P={dimensions:f,measures:M};var h=D.getDataset(P);if(this.metadata!==undefined){for(i=0;i<this.parameter.dimensions.length;i++){var j=this.metadata.getPropertyMetadata(this.parameter.dimensions[i].fieldName);if(j.isCalendarYearMonth==="true"){if(this.parameter.dimensions.length>1){h.data.sorter=new sap.ui.model.Sorter(this.parameter.dimensions[0].fieldName,false);}}}}this.datasetObj=h;};this.getDataset=function(){return new sap.viz.ui5.data.FlattenedDataset(this.datasetObj);};this.getModel=function(){var o=this.extendedDataResponse;var m=new sap.ui.model.json.JSONModel();m.setData({data:o});return m;};this.getFilterCount=function(){return this.filterValues.length;};this.getFilters=function(){var f=Object.keys(this.filterLookup);var F=[];var s=this;var h=function(k){for(var i=0;i<f.length;i++){var l={};var m=f[i];for(var j=0;j<s.filterLookup[m].length;j++){if(k===s.filterLookup[m][j].id){l.id=k;l.text=s.filterLookup[m][j].text;F.push(l);return;}}}};for(var i=0;i<this.filterValues.length;i++){h(this.filterValues[i][0]);}return F;};this.getSelectionFromFilter=function(){if(this.parameter.requiredFilters===undefined||this.parameter.requiredFilters.length===0){return[];}var h=e();return h;};this.getHighlightPointsFromSelectionEvent=function(f){var h=[];var n=[];h=g(f,this.cachedSelection);for(var i=0;i<h.length;i++){var k=h[i];if(this.parameter.measures.length===1){var m=this.displayNameLookup[this.parameter.measures[0].fieldName].DISPLAY_NAME;if(k.data[m]===undefined||k.data[m]===null){continue;}}var l="";for(var j=0;j<this.parameter.dimensions.length;j++){var o=this.displayNameLookup[this.parameter.dimensions[j].fieldName].DISPLAY_NAME;l=l+k.data[o];}var q=this.filterLookup[l];var r=this.filterValues.filter(function(t){var u=0;for(var i=0;i<s.parameter.requiredFilters.length;i++){if(t[i]===q[i].id){u=u+1;}else{break;}}if(u===s.parameter.requiredFilters.length){return true;}else if(i===s.parameter.requiredFilters.length){return false;}});if(r.length===0){var M=q.map(function(t){return t.id;});this.filterValues.push(M);}}n=e();this.cachedSelection=n;return n;};var g=function(f,n){var h=f.filter(function(k){for(var i=0;i<n.length;i++){var l=0;for(var j=0;j<Object.keys(k.data).length;j++){if(n[i].data[Object.keys(k.data)[j]]===k.data[Object.keys(k.data)[j]]){l=l+1;}else{break;}}if(l===Object.keys(k.data).length){return false;}else if(j===Object.keys(k.data).length){return true;}}return true;});return h;};this.getFilterFromSelection=function(){var r=[];var i;for(i=0;i<s.filterValues.length;i++){r.push(s.filterValues[i][0]);}var f=a.createFilter();var E=f.getOperators().EQ;var F;var A=f.getTopAnd().addOr('exprssionOr');for(i=0;i<r.length;i++){var h=this.metadata.getPropertyMetadata(s.parameter.requiredFilters[0]).dataType.type;if(h==="Edm.Int32"){r[i]=r[i]===null?r[i]:parseFloat(r[i]);}F={id:r[i],name:s.parameter.requiredFilters[0],operator:E,value:r[i]};A.addExpression(F);}return f;};var e=function(){var r=[];r[0]=[];var i,j,k,l;for(i=0;i<s.filterValues.length;i++){r[0].push(s.filterValues[i][0]);}var n=[];for(i=0;i<s.extendedDataResponse.length;i++){var f=s.extendedDataResponse[i];for(j=0;j<r[0].length;j++){var h=0;for(k=0;k<r.length;k++){if(f[s.parameter.requiredFilters[k]]===r[k][j]){h=h+1;}}if(h===r.length){var m={data:{}};var o;var q;for(k=0;k<s.getDataset().getDimensions().length;k++){var t=s.getDataset().getDimensions()[k].getName();var u=s.fieldNameLookup[t].VALUE;m.data[t]=f[u];}if(!s.measureAxisType){var w;var x;for(l=0;l<s.getDataset().getMeasures().length;l++){var y=jQuery.extend(true,{},m);w=s.getDataset().getMeasures()[l].getName();x=s.fieldNameLookup[w].VALUE;y.data[w]=f[x]===null?f[x]:parseFloat(f[x]);n.push(y);}}else{for(k=0;k<s.getDataset().getMeasures().length;k++){o=s.getDataset().getMeasures()[k].getName();q=s.fieldNameLookup[o].VALUE;m.data[o]=f[q]===null?f[q]:parseFloat(f[q]);}n.push(m);}}}}return n;};this.getHighlightPointsFromDeselectionEvent=function(f){var i,j;var h=g(this.cachedSelection,f);for(i=0;i<h.length;i++){var k=h[i];var l="";for(j=0;j<this.parameter.dimensions.length;j++){var m=this.displayNameLookup[this.parameter.dimensions[j].fieldName].DISPLAY_NAME;l=l+k.data[m];}var n=this.filterLookup[l];this.filterValues=this.filterValues.filter(function(q,r){var t=0;for(var i=0;i<n.length;i++){if(n[i].id===q[i]){t=t+1;}}if(t===n.length){return false;}else{return true;}});}var o=e();this.cachedSelection=o;return o;};this.destroy=function(){if(s.formatter){s.formatter.destroy();s.formatter=null;}s.metadata=null;s.extendedDataResponse=null;};};
