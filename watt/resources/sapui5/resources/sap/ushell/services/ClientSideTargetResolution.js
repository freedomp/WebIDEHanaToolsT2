// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.ClientSideTargetResolution");jQuery.sap.require("sap.ushell.utils");sap.ushell.services.ClientSideTargetResolution=function(a,c,p,S){var _=[],h,u;this._ensureTargetMappings=function(){var g=a.getInbounds;if(!g){g=a.getTMs;}if(!h){h=new jQuery.Deferred();g.call(a).done(function(t){_=t;h.resolve(_);}).fail(h.reject.bind(h));}return h.promise();};this._getURLParsing=function(){if(u){return u;}return sap.ushell.Container.getService("URLParsing");};this._addDefaultParameterValues=function(i,s,k,m,d){var I={},D={};Object.keys(i).forEach(function(P){if(P!=="sap-ushell-defaultedParameterNames"){I[P]=i[P];}});if(!s){return I;}Object.keys(s).forEach(function(P){var t=s[P],T,v=false;if(!I[P]&&t.hasOwnProperty("defaultValue")){if(t.defaultValue.format&&t.defaultValue.format==="reference"){T=t.defaultValue.value;if(k.hasOwnProperty(T)){if(typeof k[T]==="string"){I[P]=[k[T]];v=true;}}else{I[P]=[t.defaultValue];m.push(t.defaultValue.value);}}else{I[P]=[t.defaultValue.value];v=true;}if(v){D[P]=true;}}});Object.keys(D).forEach(function(P){d.push(P);});return I;};this._matchesFilter=function(v,f,k,m){var F;if(!f){return true;}if(!v&&v!==""){return false;}F=f.value;if(f.format==="reference"){if(k.hasOwnProperty(F)){return v===k[F];}m[F]=true;return true;}if(f.format==="value"||f.format==="plain"||f.format===undefined){return v===f.value;}else if(f.format==="regexp"){return!!v.match("^"+f.value+"$");}else{jQuery.sap.log.error("illegal oFilter format");return false;}};this._addSortString=function(m){function b(n){var s="000"+n;return s.substr(s.length-3);}m.priorityString=[m.genericSO?"g":"x","MTCH="+b(m.countMatchingParams),"MREQ="+b(m.countMatchingRequiredParams),"NFIL="+b(m.countMatchingFilterParams),"NDEF="+b(m.countDefaultedParams),"POT="+b(m.countPotentiallyMatchingParams),"RFRE="+b(999-m.countFreeTargetMappingParams)].join(" ");};this._checkAdditionalParameters=function(t,i){var A=false;if(t.signature.additionalParameters==="allowed"||t.signature.additionalParameters==="ignored"){return true;}if(t.signature.additionalParameters==="nomatch"||t.signature.additionalParameters===undefined){A=Object.keys(i).every(function(P){return(!t.signature.parameters[P]&&P.indexOf("sap-")!==0)?false:true;});}else{jQuery.sap.log.error("Unexpected value of target mapping for signature.additionalParameters");}return A;};this._addFoundParametersToUserDefaultRefs=function(U,m){U.forEach(function(r){m[r]=true;});};this._extractSapPriority=function(i,m){var s;if(i&&i["sap-priority"]&&i["sap-priority"][0]){s=parseInt(i["sap-priority"][0],10);if(!isNaN(s)){m["sap-priority"]=s;}}return;};this._matchToTargetMapping=function(i,t,k,m){function n(r,R,D){r.matches=false;r.noMatchReason=R;r.noMatchDebug=D;return r;}function M(r){r.matches=true;return r;}var b=this,o={targetMapping:t};o.genericSO=(t.semanticObject==="*");if(!(i.semanticObject===undefined||i.semanticObject===t.semanticObject||t.semanticObject==='*')){return n(o,"Semantic object did not match",t.semanticObject);}if(!(i.action===undefined||i.action===t.action||t.action==='*')){return n(o,"Action did not match","Intent:"+i.action+" TM:"+t.action);}if(t.deviceTypes&&!(i.formFactor===undefined||t.deviceTypes[i.formFactor])){return n(o,"Form factor did not match","Intent:"+i.formFactor+" TM:"+JSON.stringify(t.deviceTypes));}var U=[],d=[],I=i.params;var e=this._addDefaultParameterValues(I,t.signature&&t.signature.parameters,k,U,d);o.intentParamsPlusDefaults=e;o.defaultedParamNames=d;this._extractSapPriority(e,o);var f=0,g=0,j=0,l=0;var s=Object.keys(t.signature.parameters).every(function(P){var v=e[P],V=v&&v[0],q=t.signature.parameters[P],r=I.hasOwnProperty(P);if(q.required&&(V===null||V===undefined)){return false;}if(q.filter){if(!b._matchesFilter(V,q.filter,k,m)){return false;}if(r){++j;}}if(r&&q.required){++g;}if(r){++f;}if(!r&&(V===null||V===undefined)){++l;}return true;});o.countMatchingParams=f;o.countMatchingRequiredParams=g;o.countMatchingFilterParams=j;o.countDefaultedParams=d.length;o.countPotentiallyMatchingParams=Object.keys(i.params).length;o.countFreeTargetMappingParams=l;if(!s){return n(o,"Target mapping parameter signature did not match",this._compactSignatureNotation(t.signature));}if(!this._checkAdditionalParameters(t,e)){return n(o,"Additional parameters not allowed",this._compactSignatureNotation(t.signature));}if(t.signature.additionalParameters==="ignored"){this._filterObjectKeys(e,function(K){if(K.indexOf("sap-")===0){return true;}if(t.signature.parameters.hasOwnProperty(K)){return true;}return false;},true);o.countPotentiallyMatchingParams=Object.keys(i.params).filter(function(q){return t.signature.parameters.hasOwnProperty(q);}).length;}this._constructEffectiveResolutionResult(o,t);this._addSortString(o);this._addFoundParametersToUserDefaultRefs(U,m);return M(o);};this._filterObjectKeys=function(o,f,i){var O=i?o:jQuery.extend(true,{},o);Object.keys(O).forEach(function(k){if(f(k)===false){delete O[k];}});return O;};this._constructEffectiveResolutionResult=function(m,t){var U,r=t&&t.resolutionResult;m.resolutionResult={};if(t&&t.hasOwnProperty("hideIntentLink")){m.resolutionResult.hideIntentLink=t.hideIntentLink;}m.resolutionResult.requiresFallback=!!(!t||!r||(r.applicationType!=="URL"&&r.applicationType!=="SAPUI5")||r.additionalInformation.indexOf("SAPUI5.Component")===-1||(t.parameterMapping&&Object.keys(t.parameterMapping).length>0));if(!m.resolutionResult.requiresFallback){["applicationType","additionalInformation","url","applicationDependencies"].forEach(function(P){if(t.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=t.resolutionResult[P];}});U=this._getURLParsing().paramsToString(m.intentParamsPlusDefaults);if(U){m.resolutionResult.url=t.resolutionResult.url+((t.resolutionResult.url.indexOf("?")<0)?"?":"&")+U;}if(typeof t.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=t.resolutionResult.ui5ComponentName;}if(typeof t.resolutionResult.text!=="undefined"){m.resolutionResult.text=t.resolutionResult.text;}}};this.resolveHashFragment=function(H,f){var t=this,d=new jQuery.Deferred();this._ensureTargetMappings().done(function(){t._resolveHashFragment(H,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._resolveHashFragment=function(H,f){var U=this._getURLParsing(),d=new jQuery.Deferred(),F=H.indexOf("#")===0?H:"#"+H,s=U.parseShellHash(F);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+H+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}var g=new jQuery.Deferred();s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingTargets(s,_).fail(function(e){jQuery.sap.log.error("Could not resolve "+H,"_getMatchingTargets promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){if(m.length===0){jQuery.sap.log.warning("Could not resolve "+H,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");d.reject("Could not resolve navigation target");return;}var M=m[0],r=M.resolutionResult;if(!r.requiresFallback){g.resolve(M,r);return;}if(typeof f!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",F+" has matched a target mapping that cannot be resolved client side and no fallback logic can be used","sap.ushell.services.ClientSideTargetResolution");d.reject("client side resolution without valid result");return;}jQuery.sap.log.warning("Cannot resolve hash fragment client side",F+" has matched a target mapping that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");f(F,jQuery.extend(true,{},M.targetMapping),M.intentParamsPlusDefaults).done(g.resolve.bind(g,M)).fail(d.reject.bind(d));});g.done(function(m,r){if(r&&typeof r.url==="string"&&m.defaultedParamNames.length>0){var D=U.paramsToString({"sap-ushell-defaultedParameterNames":[JSON.stringify(m.defaultedParamNames)]});r.url+=(r.url.indexOf("?")<0?"?":"&")+D;}d.resolve(r);});return d.promise();};this.getSemanticObjectLinks=function(s,P,i){var t=this,d=new jQuery.Deferred();this._ensureTargetMappings().done(function(){t._getSemanticObjectLinks(s,P,i).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._getSemanticObjectLinks=function(s,P,i){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getSemanticObjectLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return new jQuery.Deferred().reject("invalid semantic object").promise();}if(s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getSemanticObjectLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return new jQuery.Deferred().reject("invalid semantic object").promise();}if(s==="*"){return new jQuery.Deferred().resolve([]).promise();}function C(U,P){var b=U.paramsToString(P);return b?"?"+b:"";}var t=this,U=this._getURLParsing(),d=new jQuery.Deferred(),f=sap.ushell.utils.getFormFactor(),A=U.parseParameters(C(U,P)),o={semanticObject:(s===""?undefined:s),action:undefined,formFactor:(i?undefined:f),params:A};this._getMatchingTargets(o,_).done(function(m){var b={},r=m.map(function(M){var e=s||M.targetMapping.semanticObject,I="#"+e+"-"+M.targetMapping.action,n;if(e==="*"){return undefined;}if(M.resolutionResult.hideIntentLink===true){return undefined;}if(!b.hasOwnProperty(I)){b[I]=1;if(M.targetMapping.signature.additionalParameters==="ignored"){n=t._filterObjectKeys(A,function(g){return(g.indexOf("sap-")===0)||M.targetMapping.signature.parameters.hasOwnProperty(g);},false);}else{n=A;}return{"intent":I+C(U,n),"text":M.targetMapping.resolutionResult._original.text};}else{b[I]++;}return undefined;}).filter(function(e){return typeof e==="object";}).sort(function(g,G){return g.intent<G.intent?-1:1;});jQuery.sap.log.debug("_getSemanticObjectLinks filtered to unique intents.","Reporting histogram: "+JSON.stringify(b,null,"   "),"sap.ushell.services.ClientSideTargetResolution");d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};this._serializeMatchingResult=function(m){var r=m.targetMapping.resolutionResult;return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(k){return r.hasOwnProperty(k)?r[k]:"";}).join("");};this._resolveAllReferences=function(r){var t=this,d=new jQuery.Deferred(),U,R,A=true,b=r.map(function(s){var e=t._extractUserDefaultReferenceName(s);if(typeof e!=="string"){A=false;}return{full:s,name:e};});if(!A){return d.reject("Cannot determine value for all references "+r.join(", ")).promise();}U=sap.ushell.Container.getService("UserDefaultParameters");R=b.map(function(o){return U.getValue(o.name);});jQuery.when.apply(jQuery,R).done(function(){var k={},e=arguments,i=0;b.forEach(function(o){k[o.full]=e[i].value;++i;});d.resolve(k);});return d.promise();};this._getMatchingTargets=function(s,t){var b=this,d=new jQuery.Deferred(),r=new jQuery.Deferred(),R=new jQuery.Deferred();function w(f){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.INFO){f();}}setTimeout(function(){var m=[],M={},P=[],n={};jQuery.sap.log.debug("Matching intent to target mappings (first round)",JSON.stringify(s,null,"   "),"sap.ushell.services.ClientSideTargetResolution");t.forEach(function(T){var o=b._matchToTargetMapping(s,T,{},M);if(o.matches){m.push(o);P.push(T);}else{w(function(){if(!n[o.noMatchReason]){n[o.noMatchReason]=[];}n[o.noMatchReason].push("#"+(o.targetMapping||{}).semanticObject+"-"+(o.targetMapping||{}).action+"|"+o.noMatchDebug);});}});w(function(){Object.keys(n).forEach(function(e){jQuery.sap.log.debug(e+": "+n[e].join("; "),null,"sap.ushell.services.ClientSideTargetResolution");});});if(jQuery.isEmptyObject(M)){r.resolve(m);}else{b._resolveAllReferences(Object.keys(M)).done(function(o){R.resolve(o,P);}).fail(function(e){jQuery.sap.log.error("Failed to resolve all references",e,"sap.ushell.services.ClientSideTargetResolution");r.resolve([]);});}},0);R.done(function(k,P){jQuery.sap.log.debug("Matching intent to target mappings (rematch)","Known References:"+JSON.stringify(k,null,"   "),"sap.ushell.services.ClientSideTargetResolution");var e=[],m={};P.forEach(function(T){var M=b._matchToTargetMapping(s,T,k,m);if(M.matches){e.push(M);}});if(jQuery.isEmptyObject(m)){r.resolve(e);}else{jQuery.sap.log.error("Still obtained unknown references during rematch",JSON.stringify(m,null,"   "),"sap.ushell.services.ClientSideTargetResolution");d.reject("Rematching returned unknown references!");}});r.done(function(P){b._sortMatchingResultsDeterministic(P);w(function(){jQuery.sap.log.debug("Returning sorted results","\n"+P.map(function(m){return"#"+(m.targetMapping||{}).semanticObject+"-"+(m.targetMapping||{}).action+" "+(m["sap-priority"]||"")+" Priority: "+(m["sap-priority"]?"sap-priority : "+m["sap-priority"]:"")+m.priorityString+" Signature: "+b._compactSignatureNotation((m.targetMapping||{}).signature)+" Deterministic: "+b._serializeMatchingResult(m);}).join("\n")+"\nwith first Result being:"+JSON.stringify(P[0],null,"   "),"sap.ushell.services.ClientSideTargetResolution");});d.resolve(P);});return d.promise();};this._sortMatchingResultsDeterministic=function(m){var t=this;m.sort(function(M,o){if((M["sap-priority"]||0)-(o["sap-priority"]||0)!==0){return-((M["sap-priority"]||0)-(o["sap-priority"]||0));}if(M.priorityString<o.priorityString){return 1;}if(M.priorityString>o.priorityString){return-1;}return(t._serializeMatchingResult(M)<t._serializeMatchingResult(o))?1:-1;});};this._isIntentSupportedOne=function(i){var d=new jQuery.Deferred(),s=this._getURLParsing().parseShellHash(i);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+i+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingTargets(s,_).done(function(t){d.resolve(t.length>0);}).fail(function(){d.reject();});return d.promise();};this.isIntentSupported=function(i){var t=this,d=new jQuery.Deferred();this._ensureTargetMappings().done(function(){t._isIntentSupported(i).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._isIntentSupported=function(i){var t=this,d=new jQuery.Deferred(),s={};d.resolve();function b(I,e){s[I]={supported:e};}i.forEach(function(I){var n=t._isIntentSupportedOne(I);n.fail(function(e){b(I,false);});n.done(function(R){b(I,R);});d=jQuery.when(d,n);});var r=new jQuery.Deferred();d.done(function(){r.resolve(s);}).fail(function(){r.reject.bind(d);});return r.promise();};this._extractUserDefaultReferenceName=function(r){if(typeof r!=="string"||r.indexOf("UserDefault.")!==0){return undefined;}return r.replace(/^UserDefault[.]/,"");};this.getUserDefaultParameterNames=function(){var t=this,d=new jQuery.Deferred();this._ensureTargetMappings().done(function(T){try{d.resolve(t._getUserDefaultParameterNames());}catch(e){d.reject("Cannot get user default parameters from target mappings: "+e);}}).fail(d.reject.bind(d));return d.promise();};this._getUserDefaultParameterNames=function(){var U={},t=this;_.forEach(function(T){var s=T.signature&&T.signature.parameters||[];Object.keys(s).forEach(function(P){var o=s[P],b;if(o){if(o.filter&&o.filter.format==="reference"){b=o.filter.value;}else if(o.defaultValue&&o.defaultValue.format==="reference"){b=o.defaultValue.value;}if(typeof b==="string"){var r=t._extractUserDefaultReferenceName(b);if(typeof r==="string"){U[r]=1;}}}});});return Object.keys(U);};this._compactSignatureNotation=function(s){var f=s||{};var P=f.parameters||{},t={optional:"[FORMAT]",required:"FORMAT"},F={regexp:"/VALUE/",reference:"@VALUE",value:"VALUE",plain:"VALUE",_unknown:"?VALUE"},A={allowed:"<+>",nomatch:"<->",ignored:"<o>",_unknown:"<?>"};if(jQuery.isEmptyObject(P)){return"<no params>"+(A[f.additionalParameters||"_unknown"]);}var r=[];Object.keys(P).forEach(function(b){var o=P[b],d=o.required?"required":"optional",e=o.filter&&o.filter.value,g=o.defaultValue&&o.defaultValue.value,i=(o.filter&&o.filter.format)||"plain",j=(o.defaultValue&&o.defaultValue.format)||"plain";var v=[],k=F[i]||F._unknown,l=F[j]||F._unknown;if(e){v.push(t["required"].replace("FORMAT",k.replace("VALUE",e)));}if(g){v.push(t["optional"].replace("FORMAT",l.replace("VALUE",g)));}r.push(t[d].replace("FORMAT",b+":"+v.join("")));});return r.join(";")+(A[f.additionalParameters||"_unknown"]);};};sap.ushell.services.ClientSideTargetResolution.hasNoAdapter=false;}());
