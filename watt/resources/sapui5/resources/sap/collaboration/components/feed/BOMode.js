/*
* ! @copyright@
*/
sap.ui.define(["./Mode","sap/m/CustomListItem","sap/m/Label","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/collaboration/components/utils/PendingRequestsUtil"],function(M,C,L,F,a,P){var B=M.extend("sap.collaboration.components.feed.BOMode",{constructor:function(f,l){M.apply(this,[f,"jam"]);this._sJamBOId=undefined;this._oPendingRequestsUtil=new P();this._oSMIModel=this._oFeedController.getModel("smi");this._oLanguageBundle=l;this.FILTER_CONSTANTS={GROUP_WALL:"Group Wall",GROUP_OBJECT_WALL:"Group Object Wall"};f.byId("filter_popover").attachSelectionChange(this.onFilterSelection,this);}});B.prototype.start=function(f){if(f){this._oFeedSourcesData=f;this._sendRequestMapInternalBOToExternalBO(f.appContext,f.collection,f.key,f.odataServicePath).then((function(d,r){return this._sendRequestExternalObjects_FindByExidAndObjectType(d.MapInternalBOToExternalBO.Exid,d.MapInternalBOToExternalBO.ObjectType);}).bind(this),(function(e){this._oFeedController.logError("The internal to external mapping for the business object could not be performed.");this._oFeedController._displayErrorMessage(this._oLanguageBundle.getText("SMIV2_INTERNAL_TO_EXTERNAL_BO_MAPPING_COULD_NOT_BE_PERFORMED"));return null;}).bind(this)).then((function(d,r){this._sJamBOId=d.results.Id;this._oList.bindItems({path:"/ExternalObjects('"+d.results.Id+"')/Groups",template:this._oItemTemplate});}).bind(this),(function(e){if(e!==null){this._oFeedController.logError("An external object associated with the given Exid and ObjectType could not be found.");this._oFeedController._displayErrorMessage(this._oLanguageBundle.getText("JAM_EXTERNAL_OBJECT_COULD_NOT_BE_FOUND"));}}).bind(this));this._oViewDataModel.setProperty("/filterEnabled",true);this._setFilterOptions(f.name);}};B.prototype.stop=function(){this._oPendingRequestsUtil.abortAll();this._oViewDataModel.setProperty("/filterEnabled",false);this._oList.attachUpdateFinished(this.onGroupSelectorUpdateFinished,this);};B.prototype._sendODataRequest=function(o,O,s,u){var d=jQuery.Deferred();var A=o[O](s,{urlParameters:u,success:function(D,r){d.resolve(D,r);},error:function(e){d.reject(e);}});var b=d.promise(A);this._oPendingRequestsUtil.add(b);d.always((function(){this._oPendingRequestsUtil.remove(b);}).bind(this));return b;};B.prototype._sendRequestMapInternalBOToExternalBO=function(A,o,O,s){return this._sendODataRequest(this._oSMIModel,"callFunction","/MapInternalBOToExternalBO",{ApplicationContext:A,ODataCollection:o,ODataKeyPredicate:O,ODataServicePath:s});};B.prototype._sendRequestExternalObjects_FindByExidAndObjectType=function(E,O){return this._sendODataRequest(this._oJamModel,"callFunction","/ExternalObjects_FindByExidAndObjectType",{Exid:E,ObjectType:O});};B.prototype._setFilterOptions=function(b){var s;b?s=this._oLanguageBundle.getText("GF_FILTER_OBJECT",b):s=this._oLanguageBundle.getText("GF_FILTER_OBJECT_DEFAULT");var f=[{text:this._oLanguageBundle.getText("GF_FILTER_GROUP"),key:this.FILTER_CONSTANTS.GROUP_WALL},{text:s,key:this.FILTER_CONSTANTS.GROUP_OBJECT_WALL}];this._oViewDataModel.setProperty("/filter",f);var o=this._oFeedController.byId("filter_popover");o.setSelectedItem(o.getItems()[0]);};B.prototype.onGroupSelected=function(e){var g=e.getSource().getSelectedItem().getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",{Id:g.Id,Name:g.Name,WebURL:g.WebURL});this._oViewDataModel.setProperty("/url","/Groups('"+g.Id+"')/FeedEntries");this._oViewDataModel.setProperty("/filterMessage","");var f=this._oFeedController.byId("filter_popover");f.setSelectedItem(f.getItems()[0]);this._oGroupSelectPopover.close();};B.prototype.onGroupSelectorButtonPress=function(e){this._oGroupSelectPopover.openBy(e.getSource());};B.prototype.onGroupSelectorUpdateStarted=function(e){};B.prototype.onBatchCompleted=function(e){};B.prototype.onGroupSelectorUpdateFinished=function(c){var l=c.getSource();if(!l.getSelectedItem()){l.setSelectedItem(l.getItems()[0]);}var g=l.getItems()[0].getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",g);this._oViewDataModel.setProperty("/url","/Groups('"+g.Id+"')/FeedEntries");this._oList.detachUpdateFinished(this.onGroupSelectorUpdateFinished,this);};B.prototype.onGroupSearch=function(c){var f=[];var q=c.getSource().getValue();if(q&&q.length>0){var b=new F("Name",a.Contains,q);f.push(b);}var g=this._oList;g.getBinding("items").filter(f);};B.prototype.onFilterSelection=function(c){var s=c.getParameter("listItem");var f=s.getBindingContext().getObject();var g=this._oViewDataModel.getProperty("/groupSelected/Id");switch(f.key){case this.FILTER_CONSTANTS.GROUP_WALL:this._oViewDataModel.setProperty("/url","/Groups('"+g+"')/FeedEntries");this._oViewDataModel.setProperty("/filterMessage","");break;case this.FILTER_CONSTANTS.GROUP_OBJECT_WALL:this._oViewDataModel.setProperty("/url","/GroupExternalObjects(GroupId='"+g+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries");this._oViewDataModel.setProperty("/filterMessage",this._oLanguageBundle.getText("ST_FILTER_TEXT")+" "+f.text);break;}};B.prototype.addPost=function(c,g){var p="/GroupExternalObjects(GroupId='"+g+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries";return M.prototype.addPost.apply(this,[c,p]);};return B;},true);
