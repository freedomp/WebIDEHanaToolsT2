/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var c;var e;var m=I.instances.messageHandler;this.getNavigationTargets=function(){var d;var n=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var s=[];if(e){d=jQuery.Deferred();d.resolve(b(e));return d.promise();}if(!c){a();}c.forEach(function(i){if(jQuery.inArray(i.semanticObject,s)===-1){s.push(i.semanticObject);}});e=jQuery.extend(true,[],c);e.forEach(function(i){i.text="";});d=jQuery.Deferred();h(0).done(function(){d.resolve(b(e));}).fail(function(){d.resolve(b(e));});return d.promise();function f(i,j,t){e.forEach(function(k){if(i===k.semanticObject&&j===k.action){k.text=t;}});}function h(i){var d=jQuery.Deferred();var j=[];if(i===s.length){d=jQuery.Deferred();e.forEach(function(l){if(l.text!==""){j.push(l);}});e=j;d.resolve(e);return d.promise();}var k=s[i];n.getSemanticObjectLinks(k,undefined,false,I.instances.component,undefined).done(function(l){l.forEach(function(o){var p=o.intent.split("-");var q=p[1].split("?");q=q[0].split("~");f(k,q[0],o.text);});h(i+1).done(function(){d.resolve(e);});}).fail(function(){return h(i+1);});return d.promise();}};this.navigateToApp=function(n){if(!c){a();}var N=g(n);if(!N){return;}var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(!N.filterMapping||!N.filterMapping.requestForMappedFilter){d(null,null);}else{var M=I.functions.createRequest(N.filterMapping.requestForMappedFilter);sap.apf.utils.executeFilterMapping(C,M,N.filterMapping.target,d,m);}function d(f,o){var i;if(o){return;}if(f){C=C.addAnd(f);}var j=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(j){var s={sapApfState:I.functions.serializePath()};I.instances.startFilterHandler.serialize().done(function(k){s.sapApfState.filterIdHandler=I.functions.serializeFilterIds();s.sapApfState.startFilterHandler=k;s.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();i=j.createEmptyAppState(I.instances.component);i.setData(s);i.save();if(h){h.replaceHash("sap-iapp-state="+i.getKey());}j.toExternal({target:{semanticObject:N.semanticObject,action:N.action},appStateKey:i.getKey()});});}}});};this.checkMode=function(){var d=jQuery.Deferred();var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var f,j,k,l;if(h){k=i.exec(h.getHash());if(k){f=k[1];}}j=I.functions.getXappStateId();if(f){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,f).done(function(n){l=n.getData();if(l.sapApfState){I.functions.deserializeFilterIds(l.sapApfState.filterIdHandler);I.functions.deserializePath(l.sapApfState);I.instances.startFilterHandler.getStartFilters().done(function(){I.instances.startFilterHandler.deserialize(l.sapApfState.startFilterHandler);d.resolve({navigationMode:"backward"});});}});}else if(j){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,j).done(function(n){l=n.getData();if(l&&l.sapApfCumulativeFilter){d.resolve({navigationMode:"forward",sapApfCumulativeFilter:l.sapApfCumulativeFilter});}else{d.resolve({navigationMode:"forward"});}});}else{d.resolve({navigationMode:"forward"});}if(h){h.replaceHash("");}return d.promise();};function a(){c=I.functions.getNavigationTargets();}function g(n){for(var i=0,l=c.length;i<l;i++){if(c[i].id===n){return c[i];}}}function b(t){var d=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};d.forEach(function(f){if(f.isStepSpecific&&i(f.id)){delete f.isStepSpecific;r.stepSpecific.push(f);}else if(!f.isStepSpecific){delete f.isStepSpecific;r.global.push(f);}});return r;function i(f){var h=false;var j;var k=I.functions.getActiveStep();if(k&&k.getAssignedNavigationTargets){j=k.getAssignedNavigationTargets();if(j&&jQuery.isArray(j)){j.forEach(function(l){if(f===l.id){h=true;}});}}return h;}}};}());
