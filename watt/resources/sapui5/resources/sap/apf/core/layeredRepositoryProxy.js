jQuery.sap.declare("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.utils.hashtable');jQuery.sap.require('sap.ui.fl.LrepConnector');jQuery.sap.require('sap.apf.utils.parseTextPropertyFile');(function(){'use strict';sap.apf.core.LayeredRepositoryProxy=function(s,a){var c=a.instance.coreApi;var b;var m=a.instance.messageHandler;var n='sap/apf/dt';var t='text.properties';var d=new sap.apf.utils.Hashtable(a.instance.messageHandler);var e=new sap.apf.utils.Hashtable(a.instance.messageHandler);function f(i){var j=(i&&i.layer)||"CUSTOMER";if(j==="ALL"){return undefined;}return j;}function g(i,j){return m.createMessageObject({code:i,aParameters:j});}function h(){return{};}function k(i){return n+'/'+i;}function l(i,j){var H=i.application;var I=i.inputParameters[0].value;var J;p(H).done(function(){J=d.getItem(H);J.removeItem(I);j(i,h());}).fail(function(){j(undefined,h(),g('5201'));})}function o(i,j,H){var O;var P=[];var R="/sap/bc/lrep/content/";R+=n+"/"+i+'/'+t;P.push({name:"layer",value:"CUSTOMER"});O={async:!H,contentType:'text/plain'};if(H){O.complete=j;}R+=b._buildParams(P);return b.send(R,'GET',{},O);}function p(i,j){var H=jQuery.Deferred();var I;var J=d.getItem(i);var K=function(L){var M=(L&&L.response)||(L&&L.responseText)||"";var N=sap.apf.utils.parseTextPropertyFile(M,{instance:{messageHandler:m}});J=new sap.apf.utils.Hashtable(a.instance.messageHandler);N.TextElements.forEach(function(O){J.setItem(O.TextElement,O);});d.setItem(i,J);H.resolve({});};if(J===undefined){if(j!==undefined&&j===false){o(i,K,true);}else{I=o(i,undefined,false);I.then(function(L){K(L);},function(L){H.reject(g('5201'));});}}else{H.resolve({});}return H.promise();}function q(i,j,H){var I=i.Application;if(i.TextElement===undefined||!sap.apf.utils.isValidGuid(i.TextElement)){i.TextElement=sap.apf.utils.createPseudoGuid();}p(I,H).done(function(){var J=d.getItem(I);J.setItem(i.TextElement,i);j(i,h());}).fail(function(){j(undefined,h(),g('5201'));})}function r(j,H){var i,I;var J=k(j);var K=b.listContent(J,'CUSTOMER');K.then(function(L){var M=L.response;I=[];for(i=0;i<M.length;i++){if(M[i].fileType==="apfconfiguration"){I.push(M[i].name);}}H(I);},function(L){H([]);});}function u(i,j,H){function I(){var M=sap.apf.utils.renderHeaderOfTextPropertyFile(i,m);M=M+sap.apf.utils.renderTextEntries(K,m);var N=b.upsert(J,'text','properties',"CUSTOMER",M,'text/plain');N.then(function(O){j(h());},function(O){j(h(),g('5201'));});}var J=k(i);var K=d.getItem(i);if(!K){j(h());return;}if(H){I();}else{var L=o(i,undefined,false);L.then(function(M){var N=(M&&M.response)||(M&&M.responseText)||"";var O=sap.apf.utils.parseTextPropertyFile(N,{instance:{messageHandler:m}});O.TextElements.forEach(function(P){K.setItem(P.TextElement,P);});I();},function(M){j(h(),g('5201'));});}}function v(i,j,H){var I=k(i);var J=b.getFileAttributes(I,j,'apfconfiguration',"CUSTOMER");J.then(function(K){var L=K.response;var M=e.getItem(i);if(M===undefined){M=new sap.apf.utils.Hashtable(a.instance.messageHandler);}M.setItem(j,L);e.setItem(i,M);u(i,H);},function(K){H(undefined,h(),g('5201'));});}function w(i,j){var H=i.Application;var I=i.AnalyticalConfiguration;var J=JSON.parse(i.SerializedAnalyticalConfiguration);var K=k(H);var L=b.getStaticResource(K,"metadata","apfapplication");L.then(function(M){var N={Application:H,ApplicationName:M.response.ApplicationName,SemanticObject:M.response.SemanticObject,AnalyticalConfiguration:I,AnalyticalConfigurationName:i.AnalyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};J=jQuery.extend(true,J,{configHeader:N});J=JSON.stringify(J);var O=b.upsert(K,I,'apfconfiguration','CUSTOMER',J,'application/json');return O;},function(M){j(undefined,h(),g('5201'));}).then(function(M){v(H,I,j);},function(M){j(h(),g('5201'));});}function x(i,j,H){var I=f(H);function J(K,L,P,M,j){var N=k(K);var Q=b.upsert(N,L,'apfconfiguration',I,M,'application/json');Q.then(function(R){v(K,L,function(S,T,U){if(!U){j({AnalyticalConfiguration:L,AnalyticalConfigurationName:i.AnalyticalConfigurationName},h());}else{j(undefined,h(),g('5201'));}});},function(R){j(undefined,h(),g('5201'));});}var K=i.Application;var L=i.AnalyticalConfiguration;if(L===undefined||!sap.apf.utils.isValidGuid(L)){L=sap.apf.utils.createPseudoGuid(32);}var M=JSON.parse(i.SerializedAnalyticalConfiguration);var N=k(K);var O=b.getStaticResource(N,"metadata","apfapplication");O.then(function(P){var Q={Application:K,ApplicationName:P.response.ApplicationName,SemanticObject:P.response.SemanticObject,AnalyticalConfiguration:L,AnalyticalConfigurationName:M.analyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};M=jQuery.extend(true,M,{configHeader:Q});M=JSON.stringify(M);J(K,L,i.AnalyticalConfigurationName,M,j);},function(P){j(undefined,h(),g('5201'));});}function y(i,j,H){var I=i[0].value;m.check(I!==undefined,"configuration may not be undefined");m.check(H!==undefined,"application of configuration not found");var J=k(H);var K=b.deleteFile(J,I,'apfconfiguration','CUSTOMER');K.then(function(L){j(h());},function(L){j(h(),g('5201'));});}function z(j,H){var i=0;var I={Application:j};var J,K;for(i=0;i<H.length;i++){J=H[i].name;K=H[i].value;if(J==="apfdt-applname"){J="ApplicationName";}else if(J==='createdAt'){J="CreationUTCDateTime";}else if(J==='createdBy'){J="CreatedByUser";}else if(J==='lastChangedAt'){J="LastChangeUTCDateTime";}else if(J==='lastChangedBy'){J="LastChangedByUser";}else if(J==="apfdt-configname"){J='AnalyticalConfigurationName';}else if(J==='size'||J==='layer'){continue;}I[J]=K;}return I;}function A(i,j,H){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var I=i.Application;if(I===undefined||!sap.apf.utils.isValidGuid(I)){I=sap.apf.utils.createPseudoGuid(32);}var J=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:I});var K=sap.apf.utils.renderHeaderOfTextPropertyFile(I,m);var L=f(H);function M(){j(undefined,h(),g('5201'));}var N=k(I);var O=b.upsert(N,'metadata','apfapplication',L,J,'application/json');O.then(function(P){return b.upsert(N,'text','properties',L,K,'text/plain');},M).then(function(P){d.setItem(I,new sap.apf.utils.Hashtable(a.instance.messageHandler));j({Application:I,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject},h());},M);}function B(i,j){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var H=i.Application;var I=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:H});function J(){j(undefined,g('5201'));}var K=k(H);var L=b.upsert(K,'metadata','apfapplication','CUSTOMER',I,'application/json');L.then(function(M){j({Application:H,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject});},J);}function C(i,j){var H=i[0].value;function I(L){var M=D(L);j(h(),M);}var J=k(H);var K=b.listContent(J,'CUSTOMER');K.then(function(L){var M=L.response;var P=[];M.forEach(function(O){P.push(b.deleteFile(J,O.name,O.fileType,O.layer));});var N=Promise.all(P);return N;},I).then(function(L){j(h());},I);}function D(i){var j;if(i.messageObject&&i.messageObject.getCode){j=i.messageObject;}else if(i.response&&i.response.statusCode&&i.response.statusCode>=400){j=m.createMessageObject({code:'11005',aParameters:[i.response.statusCode.toString(),i.response.statusText]});}else{j=m.createMessageObject({code:'5201'});}m.putMessage(j);return j;}function E(H){function I(i){H(undefined,h(),m.createMessageObject({code:'5201'}));}var J=b.listContent(n,'CUSTOMER');var K=0;var L=[];J.then(function(j){var M=j.response.length;for(var i=0;i<M;i++){var N=j.response[i].name;if(sap.apf.utils.isValidPseudoGuid(N)){var O=k(N);var P=b.getStaticResource(O,'metadata','apfapplication');K++;L.push(P);}}return Promise.all(L);},I).then(function(M){var N=[];var O=M;if(O.length===undefined&&K>0){for(var j=0;j<K;j++){N.push(L[j].response);}}var i;for(i=0;i<O.length;i++){N.push(O[i].response);}H(N,h());},I);}function F(i,j,H,I,J){var K=f(J);var O={async:false,complete:function(M){var N={};N.SerializedAnalyticalConfiguration=M.responseText;i(N,h());}};var P=[];var L;var R="/sap/bc/lrep/content/";a.instance.messageHandler.check(I===undefined||I.indexOf("SerializedAnalyticalConfiguration")>=0,"layered repository proxy - read configuration async without analytical configuration - not supported call");R+=n+"/"+H+'/'+j+'.apfconfiguration';if(K){P.push({name:"layer",value:K});}R+=b._buildParams(P);L=b.send(R,'GET',{},O);L.then(function(M){},function(M){i(undefined,h(),g('5201'));});}function G(){if(a.constructor&&a.constructor.LrepConnector){b=a.constructor.LrepConnector.createConnector();}else{b=sap.ui.fl.LrepConnector.createConnector();}if(!b._sClient){b._sClient=c.getStartParameterFacade().getSapClient();}}this.getConnector=function(){return b;};this.readEntity=function(j,H,I,J,K,L,M){var N=I[0].value;var O=k(L);var P=[];var Q=false;var R=1;var S=0;var T;var U=e.getItem(L);var V;var W;var i;var X;var Y;var Z;var $;var _=f(M);a.instance.messageHandler.check(j==='configuration',"layered repository proxy - only read entity of configuration supported");if(K!==undefined&&K===false){return F(H,N,L,J,M);}if(J===undefined||J.indexOf("SerializedAnalyticalConfiguration")>=0){Q=true;var a1=b.getStaticResource(O,N,'apfconfiguration');P.push(a1);}else{R=0;}if(U===undefined){U=new sap.apf.utils.Hashtable(a.instance.messageHandler);}T=U.getItem(N);if(T===undefined){var b1=b.getFileAttributes(O,N,'apfconfiguration',_);P.push(b1);}V=Promise.all(P);V.then(function(c1){U=e.getItem(L);if(U===undefined){U=new sap.apf.utils.Hashtable(a.instance.messageHandler);}T=U.getItem(N);if(T===undefined){T=c1[R].response;}U.setItem(N,T);e.setItem(L,U);W=z(L,T);if(Q){$=c1[S].response;W.SerializedAnalyticalConfiguration=JSON.stringify($);W=jQuery.extend({},true,$,W);}W.AnalyticalConfiguration=N;if(J&&J.length!==0){X=J.length;Y={};for(i=0;i<X;i++){Z=J[i];Y[Z]=W[Z];}W=Y;}H(W,h());},function(c1){H(undefined,h(),g('5201'));});};this.doChangeOperationsInBatch=function(j,H,I){function J(M,N){H(N);}var i,K;function L(){}p(I).then(function(){for(i=0;i<j.length;i++){K=j[i];K.application=I;if(K.method==='DELETE'&&K.entitySetName==='texts'){l(K,L);}else if(K.method==='POST'&&sap.apf.utils.isValidPseudoGuid(K.data.TextElement)){q(K.data,L);}else{q(K.data,L);}}u(I,J,true);}).fail(function(M){H(M);});};this.readCollectionsInBatch=function(j,H,I){var J=this;var K=j.length;var L=[];var M=0;function N(P){function Q(R,S,T){if(T){H(undefined,T);}else{M++;L[P]=R;if(M===K){H(L);}}}return Q;}for(var i=0;i<K;i++){var O=j[i];J.readCollection(O.entitySetName,N(i),O.inputParameters,O.selectList,O.filter,I);}};this.readCollection=function(i,j,H,I,J,K){var L=this;var T,M,N;var O;var P=function(N){var R=new sap.apf.utils.Hashtable(a.instance.messageHandler);var S=[];var U=(N&&N.response)||(N&&N.responseText)||"";var V=sap.apf.utils.parseTextPropertyFile(U,{instance:{messageHandler:m}});R=new sap.apf.utils.Hashtable(a.instance.messageHandler);V.TextElements.forEach(function(W){R.setItem(W.TextElement,W);S.push(W);});d.setItem(M,R);j(S,h());};if(i==='application'){m.check(!H&&!I&&!J,"unsupported parameters when calling readCollection for application");m.check(K===undefined||K===true,'no async readCollection of application supported');E(j);}else if(i==='texts'){T=J.getFilterTermsForProperty('Application');M=T[0].getValue();if(K!==undefined&&K===false){o(M,P,true);}else{O=o(M,undefined,false);O.then(function(N){P(N);},function(R){var S=D(Error);j(undefined,h(),S);});}}else if(i==='configuration'){T=J.getFilterTermsForProperty('Application');M=T[0].getValue();N=[];var Q=function(R,S){function U(V,W,S){N.push(V);if(N.length===R.length){j(N,h(),S);}}if(R.length===0){j(N,h(),S);}R.forEach(function(V){L.readEntity('configuration',U,[{value:V}],I,K,M);});};r(M,Q);}};this.remove=function(i,j,H,I,J){if(i==='application'){C(j,H);}else if(i==='configuration'){y(j,H,J);}else{m.check(false,'the remove operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.create=function(i,j,H,I,J){if(i==='application'){m.check(I===undefined||I===true,'no async creation of application supported');A(j,H,J);}else if(i==='configuration'){m.check(I===undefined||I===true,'no async creation of configuration supported');x(j,H,J);}else if(i==='texts'&&I===false){q(j,H,false);}else{m.check(false,'the create operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.update=function(i,j,H,I){if(i==='configuration'){w(j,H);}else if(i==='application'){B(j,H);}else{m.check(false,'the update operation on entity set '+i+' is currently not supported by the lrep proxy');}};G();};}());
