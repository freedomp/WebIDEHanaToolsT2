/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.utils.startFilterHandler');jQuery.sap.require('sap.apf.utils.filter');jQuery.sap.require('sap.apf.core.utils.filter');
sap.apf.utils.StartFilterHandler=function(a){'use strict';var s=[{isLevel:true}];var S=(a&&a.constructor&&a.constructor.StartFilter)||sap.apf.utils.StartFilter;var r={};var b={};var m=a.instance.messageHandler;var d=jQuery.Deferred();var c=false;this.getStartFilters=function(){if(!c){c=true;a.functions.getCombinedContext().done(function(l){var n=a.functions.getFacetFilterConfigurations();var o=l.getProperties();var p=o.length;var q=null;n.forEach(function(t){for(var i=0;i<p;i++){if(t.property===o[i]){q=o[i];break;}}if(q){s.push(new S(a,t,e(l,q)));o.splice(o.indexOf(q),1);q=null;}else{s.push(new S(a,t));}});o.forEach(function(i){s.unshift(new S(a,{property:i,invisible:true,multiSelection:true},e(l,i)));});k();d.resolve(f());});}return d.promise();};this.setRestrictionByProperty=function(i){var l=i.getInternalFilter();var n=g(l);var p=l.getProperties()[0];var o=true;h().forEach(function(q){if(q.getPropertyName()===p){q.setSelectedValues(n);o=false;}});if(o){s.unshift(new S(a,{multiSelection:true,property:p,invisible:true},n));}k();r[p]=i;if(!b[p]){b[p]=i.serialize();}};this.getRestrictionByProperty=function(p){if(r[p]){return r[p];}return new sap.apf.utils.Filter(m);};this.getCumulativeFilter=function(){var i=jQuery.Deferred();var l=new sap.apf.core.utils.Filter(m);var n;var o;d.done(function(){o=h().length;if(o==0){i.resolve(new sap.apf.core.utils.Filter(m));}h().forEach(function(q){q.getSelectedValues().done(function(v){n=new sap.apf.core.utils.Filter(m);if(v&&v.type==='internalFilter'){n=v;}if(jQuery.isArray(v)){v.forEach(function(t){n.addOr(new sap.apf.core.utils.Filter(m,q.getPropertyName(),'eq',t));});}l.addAnd(n);p();});});});return i.promise();function p(){o--;if(o==0){i.resolve(l);}}};this.serialize=function(){var i=jQuery.Deferred();var n;var l;var o={};o.startFilters=[];o.restrictionsSetByApplication={};for(l in r){o.restrictionsSetByApplication[l]=r[l].serialize();}n=h().length;if(h().length>0){h().forEach(function(p){p.serialize().done(function(q){o.startFilters.push(q);n--;if(n==0){i.resolve(o);}});});}else{i.resolve(o);}return i.promise();};this.deserialize=function(l){var s=h();var n;var o;r={};l.startFilters.forEach(function(p){for(var i=0,q=s.length;i<q;i++){if(p.propertyName===s[i].getPropertyName()){s[i].deserialize(p);}}});for(n in l.restrictionsSetByApplication){o=new sap.apf.utils.Filter(m);o.deserialize(l.restrictionsSetByApplication[n]);r[n]=o;}};this.resetAll=function(){var i;h().forEach(function(l){l.reset();});r={};for(i in b){r[i]=new sap.apf.utils.Filter(m).deserialize(b[i]);}};this.resetVisibleStartFilters=function(){f().forEach(function(i){i.reset();});};function g(i){var l=[];i.getFilterTerms().forEach(function(t){l.push(t.getValue());});return l;}function e(l,p){var n=[];var t=l.getFilterTermsForProperty(p);var o=l.reduceToProperty(p);if(o.toUrlParam().indexOf('%20and%20')>-1){return o;}for(var i=0,q=t.length;i<q;i++){if(t[i].getOp()!=='EQ'){return o;}n.push(t[i].getValue());}return n;}function f(){var v=[];h().forEach(function(i){if(i.isVisible()){v.push(i);}});return v;}function h(){var i=[];s.forEach(function(l){if(!l.isLevel){i.push(l);}});return i;}function j(){var l=[];for(var i=0,n=s.length;i<n;i++){if(!s[i].isLevel){l.push(s[i]);}else{break;}}return l;}function k(){l(i(j()));function i(n){var o=new sap.apf.core.utils.Filter(m);n.forEach(function(p){var q=new sap.apf.core.utils.Filter(m);p.getSelectedValues().done(function(v){if(v.type==='internalFilter'){q.addOr(v);}else{v.forEach(function(t){q.addOr(p.getPropertyName(),'eq',t);});}});o.addAnd(q);});return o;}function l(n){var o=false;s.forEach(function(p){if(p.isLevel){o=true;return;}if(o){p.setRestriction(n);}});}}};
