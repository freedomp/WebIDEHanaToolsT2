sap.ui.define(["sap/suite/ui/generic/template/lib/TemplateViewController","sap/ui/model/json/JSONModel","sap/m/Table","sap/m/Text","sap/m/Link","sap/ui/core/Icon","sap/m/HBox","sap/m/ObjectIdentifier","sap/ui/comp/smarttable/SmartTable","sap/ui/comp/smartfield/SmartField","sap/suite/ui/generic/template/ListReport/nav/NavigationHandler","sap/suite/ui/generic/template/library","sap/suite/ui/generic/template/ListReport/nav/SelectionVariant","sap/suite/ui/generic/template/ListReport/nav/Error"],function(B,J,T,a,L,I,H,O,S,b,N,d,e,E){"use strict";var f=d.ListReport.nav.NavType;var l=B.extend("sap.suite.ui.generic.template.ListReport.view.ListReport",{bOnInitFinished:false,bFilterBarInitialized:false,onInit:function(){B.prototype.onInit.apply(this,arguments);var t=this;var C=this.getComponent();var v=this.getView();var o=v.byId("listReport");var s=C.getEntitySet();var A=new sap.ui.model.json.JSONModel({HasDetail:!this.getOwnerComponent().getIsLeaf()});A.setDefaultBindingMode("OneWay");v.setModel(A,"admin");var g=new sap.ui.model.json.JSONModel({DraftState:" "});v.setModel(g,"sfb");var G=jQuery.sap.getObject("sap.ushell.Container.getUser");var m=this.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var h=(m&&m.icons&&m.icons.icon)?m.icons.icon:"";var j=new J({bookmarkIcon:h,bookmarkCustomUrl:function(){try{this.storeCurrentAppState();}catch(U){jQuery.sap.log.error("ListReport.bookmarkCustomUrl: "+U);}return document.URL;}.bind(this),bookmarkServiceUrl:function(){if(this.oSmartTable.getTable().getBinding("rows")){return this.oSmartTable.getTable().getBinding("rows").getDownloadUrl()+"&$top=0&$inlinecount=allpages";}else if(this.oSmartTable.getTable().getBinding("items")){return this.oSmartTable.getTable().getBinding("items").getDownloadUrl()+"&$top=0&$inlinecount=allpages";}else{return"";}}.bind(this),isShareInJamActive:G?G().isJamActive():false});j.setDefaultBindingMode("OneWay");v.setModel(j,"share");this.oSmartTable=this.byId("listReport");this.oSmartFilterBar=this.byId("listReportFilter");if(sap.ui.Device.system.desktop){v.addStyleClass("sapUiSizeCompact");o.addStyleClass("sapUiSizeCondensed");}else{o.addStyleClass("sapUiSizeCozy");}var D=function(U,V){return(!U||(U&&V));};var n=function(U,V,W){this.removeStyleClass("sapSmartTemplatesListReportDraftInfoIcon");this.addStyleClass("sapSmartTemplatesListReportDraftInfoIcon");return((U&&V&&W!==''));};var p=function(U,V,W){return t.formatDraftLockTextGeneric(U,V,W,t);};var q=function(U){var V=U.getSource().getBindingContext();t.oButton=U.getSource();B.prototype.fnDraftPopover.call(this,t,V,t.oView,t.oButton);};if(o instanceof S){for(var i=0;i<o.getItems().length;i++){if(o.getItems()[i]instanceof T){o=o.getItems()[i];if(C.hasDraft()){jQuery.sap.log.info(s+" is draft enabled");var r=this.getTransactionController().getDraftController().getDraftContext().hasDraftAdministrativeData(s);if(!r){jQuery.sap.log.info(s+" doesn't have nav. prop. DraftAdministrativeData - no admin data is shown");}else{var u=o.getItems()||[];var w=u[0];if(w){var x=w.getCells()||[];var y=this.getTransactionController().getDraftController().getDraftContext().getSemanticKey(s);var z="";var F;var K;var M;var P;for(var k=0;k<y.length;k++){for(var c=0;c<x.length;c++){u=x[c].getItems();for(i=0;i<u.length;i++){if(u[i]instanceof O){z=u[i].getBindingPath("title");}else if(u[i]instanceof b){z=u[i].getBindingPath("value");}else{z=u[i].getBindingPath("text");}if(!(P&&M)){M=u[i];P=x[c];}if(z===y[k].name){F=u[i];K=x[c];break;}}if(F){break;}}if(F){break;}}if(!(K&&F)){K=P;F=M;}if(!(K&&F)){jQuery.sap.log.info("No semantic key found in Object List - no admin data is shown");}else{if(!(F instanceof O)){if(F instanceof a){z=F.getBindingPath("text");K.removeItem(F);F=new O({title:{path:z}});K.addItem(F);}}var Q=new I({src:"sap-icon://locked",enabled:{parts:[{path:'IsActiveEntity'},{path:'HasDraftEntity'},{path:'DraftAdministrativeData/InProcessByUser'}],formatter:n},visible:{parts:[{path:'IsActiveEntity'},{path:'HasDraftEntity'},{path:'DraftAdministrativeData/InProcessByUser'}],formatter:n}}).addStyleClass("sapUiTinyMarginTop");var R=new L({enabled:{parts:[{path:'IsActiveEntity'},{path:'HasDraftEntity'}],formatter:D},visible:{parts:[{path:'IsActiveEntity'},{path:'HasDraftEntity'}],formatter:D},press:q,text:{parts:[{path:'IsActiveEntity'},{path:'HasDraftEntity'},{path:'DraftAdministrativeData/InProcessByUser'}],formatter:p}}).addStyleClass("sapUiTinyMarginTop");K.addItem(new H({items:[Q,R]}));}}}}}}}if(sap.ushell){this.oNavigationHandler=new N(this);this.bOnInitFinished=true;this.initAppState();}},initAppState:function(){if(!(this.bFilterBarInitialized&&this.bOnInitFinished&&this.oNavigationHandler)){return;}var p=this.oNavigationHandler.parseNavigation();var t=this;p.done(function(A,u,n){if(n!==f.initial){t.oSmartFilterBar.clearVariantSelection();t.oSmartFilterBar.setDataSuiteFormat(A.selectionVariant,true);t.oSmartTable.setCurrentVariantId(A.tableVariantId);t.restoreCustomAppStateData(A.customData);t.oSmartTable.rebindTable();}});p.fail(function(o){t._handleError(o);});},storeCurrentAppState:function(){if(this.oNavigationHandler){if(!this.oNavigationHandler.hasCrossApplicationNavigationService()){return undefined;}var A=this.oNavigationHandler.storeInnerAppState(this.getCurrentAppState());A.fail(function(o){this._handleError(o);}.bind(this));return A;}else{throw"ListReport: navigation handler is not defined. Check if UShell services exist.";}},getCurrentAppState:function(){var s=new e(this.oSmartFilterBar.getDataSuiteFormat());var v=this.getVisibleSelectionsWithDefaults();for(var i=0;i<v.length;i++){if(!s.getValue(v[i])){s.addSelectOption(v[i],"I","EQ","");}}return{selectionVariant:s.toJSONString(),tableVariantId:this.oSmartTable.getCurrentVariantId(),customData:this.getCustomAppStateData()};},getCustomAppStateData:function(){var c={};if(this.getCustomAppStateDataExtension){this.getCustomAppStateDataExtension(c);}return c;},restoreCustomAppStateData:function(c){if(this.restoreCustomAppStateDataExtension){this.restoreCustomAppStateDataExtension(c);}},getVisibleSelectionsWithDefaults:function(){var v=[];return v;},onInitSmartFilterBar:function(o){if(this.onInitSmartFilterBarExtension){this.onInitSmartFilterBarExtension(o);}this.bFilterBarInitialized=true;this.initAppState();},onBeforeRebindTable:function(o){sap.suite.ui.generic.template.lib.TemplateViewController.prototype.onBeforeRebindTable.apply(this,arguments);if(this.onBeforeRebindTableExtension){this.onBeforeRebindTableExtension(o);}},onExit:function(){if(this._oPopover){this._oPopover.destroy();}},getTable:function(){var s=this.getView().byId("listReport");return s.getTable();},onCallAction:function(o){this.onCallActionFromList(o,this.oSmartFilterBar);},getSelectedContext:function(){var t=this.getTable();var s=[];if(t instanceof T){s=t.getSelectedContexts();}else{var c=t.getSelectedIndices();for(var i=0;i<c.length;i++){s.push(t.getContextByIndex(c[i]));}}var o=null;var g=this.getView().getModel("i18n").getResourceBundle();var C=!!this.getView().$().closest(".sapUiSizeCompact").length;if((!s||s.length===0)){sap.m.MessageBox.error(g.getText("NO_ITEM_SELECTED"),{styleClass:C?"sapUiSizeCompact":""});return undefined;}else if(s.length>1){sap.m.MessageBox.error(g.getText("MULTIPLE_ITEMS_SELECTED"),{styleClass:C?"sapUiSizeCompact":""});return undefined;}else{o=s[0];}return o;},onSearchButtonPressed:function(){this.storeForBackNavigation();},onBeforePopoverOpens:function(o){if(this.oNavigationHandler){var p=o.getParameters();var s=this.oSmartFilterBar.getDataSuiteFormat();this.oNavigationHandler.processBeforeSmartLinkPopoverOpens(p,s);}else{o.getParameters().open();}},onPopoverLinkPressed:function(){this.storeForBackNavigation();},onAfterTableVariantSave:function(){this.storeForBackNavigation();},onAfterApplyTableVariant:function(){this.storeForBackNavigation();},onBeforeSFBVariantSave:function(o){if(o.getParameter("context")!=="STANDARD"){this.oSmartFilterBar.setFilterData({"_CUSTOM":this.getCustomAppStateData()});}this.storeForBackNavigation();},onAfterSFBVariantLoad:function(){var D=this.oSmartFilterBar.getFilterData();if(D["_CUSTOM"]!==undefined){this.restoreCustomAppStateData(D["_CUSTOM"]);}this.storeForBackNavigation();},storeForBackNavigation:function(){try{this.storeCurrentAppState();}catch(c){jQuery.sap.log.error("ListReport.storeForBackNavigation: "+c);}},onShareEmailPress:function(){var r=this.getView().getModel("i18n").getResourceBundle();try{this.storeCurrentAppState().done(function(){sap.m.URLHelper.triggerEmail(null,r.getText("EMAIL_HEADER",[r.getText("PAGEHEADER")]),document.URL);});}catch(c){jQuery.sap.log.error("ListReport.onShareInJamPress: "+c);sap.m.URLHelper.triggerEmail(null,r.getText("EMAIL_HEADER",[r.getText("PAGEHEADER")]),document.URL);}},onShareInJamPress:function(){var r=this.getView().getModel("i18n").getResourceBundle();try{this.storeCurrentAppState().done(function(){var s=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:r.getText("PAGEHEADER")}}});s.open();});}catch(c){jQuery.sap.log.error("ListReport.onShareInJamPress: "+c);var s=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:r.getText("PAGEHEADER")}}});s.open();}},onBeforePressBookmark:function(){try{this.storeCurrentAppState();}catch(c){jQuery.sap.log.error("ListReport.onBeforePressBookmark: "+c);}},onNavigateToDetail:function(o){var s=this.getSelectedContext();this.navigateFromListItem(s,this.getTable());},_handleError:function(o){if(o instanceof E){o.showMessageBox();}}});return l;},true);
