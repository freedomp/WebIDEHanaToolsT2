tinymce.PluginManager.add('media',function(a,u){var b=[{regex:/youtu\.be\/([\w\-.]+)/,type:'iframe',w:425,h:350,url:'//www.youtube.com/embed/$1',allowFullscreen:true},{regex:/youtube\.com(.+)v=([^&]+)/,type:'iframe',w:425,h:350,url:'//www.youtube.com/embed/$2',allowFullscreen:true},{regex:/vimeo\.com\/([0-9]+)/,type:'iframe',w:425,h:350,url:'//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc',allowfullscreen:true},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:true},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:'iframe',w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:false}];var c=(tinymce.Env.ie&&tinymce.Env.ie<=8)?'onChange':'onInput';function g(u){u=u.toLowerCase();if(u.indexOf('.mp3')!=-1){return'audio/mpeg';}if(u.indexOf('.wav')!=-1){return'audio/wav';}if(u.indexOf('.mp4')!=-1){return'video/mp4';}if(u.indexOf('.webm')!=-1){return'video/webm';}if(u.indexOf('.ogg')!=-1){return'video/ogg';}if(u.indexOf('.swf')!=-1){return'application/x-shockwave-flash';}return'';}function d(e){var p=a.settings.media_scripts;if(p){for(var i=0;i<p.length;i++){if(e.indexOf(p[i].filter)!==-1){return p[i];}}}}function s(){var w,n,o,p;var q=[{name:'source1',type:'filepicker',filetype:'media',size:40,autofocus:true,label:'Source',onchange:function(e){tinymce.each(e.meta,function(i,x){w.find('#'+x).value(i);});}}];function r(e){var i,x,y,z;i=w.find('#width')[0];x=w.find('#height')[0];y=i.value();z=x.value();if(w.find('#constrain')[0].checked()&&n&&o&&y&&z){if(e.control==i){z=Math.round((y/n)*z);if(!isNaN(z)){x.value(z);}}else{y=Math.round((z/o)*y);if(!isNaN(y)){i.value(y);}}}n=y;o=z;}if(a.settings.media_alt_source!==false){q.push({name:'source2',type:'filepicker',filetype:'media',size:40,label:'Alternative source'});}if(a.settings.media_poster!==false){q.push({name:'poster',type:'filepicker',filetype:'image',size:40,label:'Poster'});}if(a.settings.media_dimensions!==false){q.push({type:'container',label:'Dimensions',layout:'flex',align:'center',spacing:5,items:[{name:'width',type:'textbox',maxLength:5,size:3,onchange:r,ariaLabel:'Width'},{type:'label',text:'x'},{name:'height',type:'textbox',maxLength:5,size:3,onchange:r,ariaLabel:'Height'},{name:'constrain',type:'checkbox',checked:true,text:'Constrain proportions'}]});}p=k(a.selection.getNode());n=p.width;o=p.height;var t={id:'mcemediasource',type:'textbox',flex:1,name:'embed',value:f(),multiline:true,label:'Source'};function v(){p=j(this.value());this.parent().parent().fromJSON(p);}t[c]=v;w=a.windowManager.open({title:'Insert/edit video',data:p,bodyType:'tabpanel',body:[{title:'General',type:"form",onShowTab:function(){p=j(this.next().find('#embed').value());this.fromJSON(p);},items:q},{title:'Embed',type:"container",layout:'flex',direction:'column',align:'stretch',padding:10,spacing:10,onShowTab:function(){this.find('#embed').value(h(this.parent().toJSON()));},items:[{type:'label',text:'Paste your embed code below:',forId:'mcemediasource'},t]}],onSubmit:function(){var e,x,i,y;e=a.dom.select('img[data-mce-object]');a.insertContent(h(this.toJSON()));x=a.dom.select('img[data-mce-object]');for(i=0;i<e.length;i++){for(y=x.length-1;y>=0;y--){if(e[i]==x[y]){x.splice(y,1);}}}a.selection.select(x[0]);a.nodeChanged();}});}function f(){var e=a.selection.getNode();if(e.getAttribute('data-mce-object')){return a.selection.getContent();}}function h(e){var n='';if(!e.source1){tinymce.extend(e,j(e.embed));if(!e.source1){return'';}}if(!e.source2){e.source2='';}if(!e.poster){e.poster='';}e.source1=a.convertURL(e.source1,"source");e.source2=a.convertURL(e.source2,"source");e.source1mime=g(e.source1);e.source2mime=g(e.source2);e.poster=a.convertURL(e.poster,"poster");e.flashPlayerUrl=a.convertURL(u+'/moxieplayer.swf',"movie");tinymce.each(b,function(p){var q,i,u;if((q=p.regex.exec(e.source1))){u=p.url;for(i=0;q[i];i++){u=u.replace('$'+i,function(){return q[i];});}e.source1=u;e.type=p.type;e.allowFullscreen=p.allowFullscreen;e.width=e.width||p.w;e.height=e.height||p.h;}});if(e.embed){n=m(e.embed,e,true);}else{var v=d(e.source1);if(v){e.type='script';e.width=v.width;e.height=v.height;}e.width=e.width||300;e.height=e.height||150;tinymce.each(e,function(i,p){e[p]=a.dom.encode(i);});if(e.type=="iframe"){var o=e.allowFullscreen?' allowFullscreen="1"':'';n+='<iframe src="'+e.source1+'" width="'+e.width+'" height="'+e.height+'"'+o+'></iframe>';}else if(e.source1mime=="application/x-shockwave-flash"){n+='<object data="'+e.source1+'" width="'+e.width+'" height="'+e.height+'" type="application/x-shockwave-flash">';if(e.poster){n+='<img src="'+e.poster+'" width="'+e.width+'" height="'+e.height+'" />';}n+='</object>';}else if(e.source1mime.indexOf('audio')!=-1){if(a.settings.audio_template_callback){n=a.settings.audio_template_callback(e);}else{n+=('<audio controls="controls" src="'+e.source1+'">'+(e.source2?'\n<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':'')+' />\n':'')+'</audio>');}}else if(e.type=="script"){n+='<script src="'+e.source1+'"></script>';}else{if(a.settings.video_template_callback){n=a.settings.video_template_callback(e);}else{n=('<video width="'+e.width+'" height="'+e.height+'"'+(e.poster?' poster="'+e.poster+'"':'')+' controls="controls">\n'+'<source src="'+e.source1+'"'+(e.source1mime?' type="'+e.source1mime+'"':'')+' />\n'+(e.source2?'<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':'')+' />\n':'')+'</video>');}}}return n;}function j(e){var i={};new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:'script,noscript',start:function(n,o){if(!i.source1&&n=="param"){i.source1=o.map.movie;}if(n=="iframe"||n=="object"||n=="embed"||n=="video"||n=="audio"){if(!i.type){i.type=n;}i=tinymce.extend(o.map,i);}if(n=="script"){var v=d(o.map.src);if(!v){return;}i={type:"script",source1:o.map.src,width:v.width,height:v.height};}if(n=="source"){if(!i.source1){i.source1=o.map.src;}else if(!i.source2){i.source2=o.map.src;}}if(n=="img"&&!i.poster){i.poster=o.map.src;}}}).parse(e);i.source1=i.source1||i.src||i.data;i.source2=i.source2||'';i.poster=i.poster||'';return i;}function k(e){if(e.getAttribute('data-mce-object')){return j(a.serializer.serialize(e,{selection:true}));}return{};}function l(e){if(a.settings.media_filter_html===false){return e;}var w=new tinymce.html.Writer(),n;new tinymce.html.SaxParser({validate:false,allow_conditional_comments:false,special:'script,noscript',comment:function(t){w.comment(t);},cdata:function(t){w.cdata(t);},text:function(t,r){w.text(t,r);},start:function(o,p,q){n=true;if(o=='script'||o=='noscript'){return;}for(var i=0;i<p.length;i++){if(p[i].name.indexOf('on')===0){return;}if(p[i].name=='style'){p[i].value=a.dom.serializeStyle(a.dom.parseStyle(p[i].value),o);}}w.start(o,p,q);n=false;},end:function(i){if(n){return;}w.end(i);}},new tinymce.html.Schema({})).parse(e);return w.getContent();}function m(e,n,o){var w=new tinymce.html.Writer();var p=0,q;function r(t,v){var x,i,y,z;for(x in v){y=""+v[x];if(t.map[x]){i=t.length;while(i--){z=t[i];if(z.name==x){if(y){t.map[x]=y;z.value=y;}else{delete t.map[x];t.splice(i,1);}}}}else if(y){t.push({name:x,value:y});t.map[x]=y;}}}new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:'script,noscript',comment:function(t){w.comment(t);},cdata:function(t){w.cdata(t);},text:function(t,i){w.text(t,i);},start:function(i,t,v){switch(i){case"video":case"object":case"embed":case"img":case"iframe":r(t,{width:n.width,height:n.height});break;}if(o){switch(i){case"video":r(t,{poster:n.poster,src:""});if(n.source2){r(t,{src:""});}break;case"iframe":r(t,{src:n.source1});break;case"source":p++;if(p<=2){r(t,{src:n["source"+p],type:n["source"+p+"mime"]});if(!n["source"+p]){return;}}break;case"img":if(!n.poster){return;}q=true;break;}}w.start(i,t,v);},end:function(i){if(i=="video"&&o){for(var t=1;t<=2;t++){if(n["source"+t]){var v=[];v.map={};if(p<t){r(v,{src:n["source"+t],type:n["source"+t+"mime"]});w.start("source",v,true);}}}}if(n.poster&&i=="object"&&o&&!q){var x=[];x.map={};r(x,{src:n.poster,width:n.width,height:n.height});w.start("img",x,true);}w.end(i);}},new tinymce.html.Schema({})).parse(e);return w.getContent();}a.on('ResolveName',function(e){var n;if(e.target.nodeType==1&&(n=e.target.getAttribute("data-mce-object"))){e.name=n;}});a.on('preInit',function(){var e=a.schema.getSpecialElements();tinymce.each('video audio iframe object'.split(' '),function(i){e[i]=new RegExp('<\/'+i+'[^>]*>','gi');});var n=a.schema.getBoolAttrs();tinymce.each('webkitallowfullscreen mozallowfullscreen allowfullscreen'.split(' '),function(i){n[i]={};});a.parser.addNodeFilter('iframe,video,audio,object,embed,script',function(o,p){var i=o.length,q,r,t,v,w,x,y;var z;while(i--){r=o[i];if(!r.parent){continue;}if(r.name=='script'){z=d(r.attr('src'));if(!z){continue;}}t=new tinymce.html.Node('img',1);t.shortEnded=true;if(z){if(z.width){r.attr('width',z.width.toString());}if(z.height){r.attr('height',z.height.toString());}}x=r.attributes;q=x.length;while(q--){v=x[q].name;w=x[q].value;if(v!=="width"&&v!=="height"&&v!=="style"){if(v=="data"||v=="src"){w=a.convertURL(w,v);}t.attr('data-mce-p-'+v,w);}}y=r.firstChild&&r.firstChild.value;if(y){t.attr("data-mce-html",escape(y));t.firstChild=null;}t.attr({width:r.attr('width')||"300",height:r.attr('height')||(p=="audio"?"30":"150"),style:r.attr('style'),src:tinymce.Env.transparentSrc,"data-mce-object":p,"class":"mce-object mce-object-"+p});r.replace(t);}});a.serializer.addAttributeFilter('data-mce-object',function(o,p){var i=o.length,q,r,t,v,w,x,y;while(i--){q=o[i];if(!q.parent){continue;}y=q.attr(p);r=new tinymce.html.Node(y,1);if(y!="audio"&&y!="script"){r.attr({width:q.attr('width'),height:q.attr('height')});}r.attr({style:q.attr('style')});v=q.attributes;t=v.length;while(t--){var z=v[t].name;if(z.indexOf('data-mce-p-')===0){r.attr(z.substr(11),v[t].value);}}if(y=="script"){r.attr('type','text/javascript');}w=q.attr('data-mce-html');if(w){x=new tinymce.html.Node('#text',3);x.raw=true;x.value=l(unescape(w));r.append(x);}q.replace(r);}});});a.on('ObjectSelected',function(e){var o=e.target.getAttribute('data-mce-object');if(o=="audio"||o=="script"){e.preventDefault();}});a.on('objectResized',function(e){var t=e.target,i;if(t.getAttribute('data-mce-object')){i=t.getAttribute('data-mce-html');if(i){i=unescape(i);t.setAttribute('data-mce-html',escape(m(i,{width:e.width,height:e.height})));}}});a.addButton('media',{tooltip:'Insert/edit video',onclick:s,stateSelector:['img[data-mce-object=video]','img[data-mce-object=iframe]']});a.addMenuItem('media',{icon:'media',text:'Insert/edit video',onclick:s,context:'insert',prependToContext:true});a.addCommand('mceMedia',s);this.showDialog=s;});
