/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.controller("sap.apf.modeler.ui.controller.navigationTarget",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.oViewData=this.getView().getViewData();this.oConfigurationHandler=this.oViewData.oConfigurationHandler;this.oConfigurationEditor=this.oViewData.oConfigurationEditor;this.oTextPool=this.oConfigurationHandler.getTextPool();this.getText=this.oViewData.getText;this.params=this.oViewData.oParams;this.createMessageObject=this.oViewData.createMessageObject;this.putMessage=this.oViewData.putMessage;this.updateTitleAndBreadCrumb=this.oViewData.updateTitleAndBreadCrumb;this.getAllAvailableSemanticObjects=this.oViewData.getAllAvailableSemanticObjects;this.getSemanticActions=this.oViewData.getSemanticActions;this.setNavigationTargetName=this.oViewData.setNavigationTargetName;var s=this;if(!this.oConfigurationEditor){this.oConfigurationHandler.loadConfiguration(this.params.arguments.configId,function(c){s.oConfigurationEditor=c;});}this._setDisplayText();this._prepareNavTargetTypeModel();var m=[];m.push(this.byId("idSemanticObjectField"));m.push(this.byId("idActionField"));m.push(this.byId("idContextMapEntitySelect"));m.push(this.byId("idMappedPropertiesCombo"));this._setMandatoryFields(m);this.getAllAvailableSemanticObjects(function(a,b){if(b===undefined){s._populateSemanticObjectModel(a);s.setDetailData();if(s.oNavTarget&&(s.oNavTarget.getFilterMappingService()===undefined||s.oNavTarget.getFilterMappingService()==="")){s._removeMandatoryFromContextMap();}}else{var M=s.createMessageObject({code:"11504"});M.setPrevious(b);s.putMessage(M);}});},_populateSemanticObjectModel:function(a){var A;var b=[];a.forEach(function(S){var o={};o.semanticObjectKey=S.id;o.semanticObjectName=S.id;b.push(o);});var s={aAllSemanticObjects:b};A=new sap.ui.model.json.JSONModel();A.setSizeLimit(500);A.setData(s);this.byId("idSemanticObjectField").setModel(A);},_setDisplayText:function(){this.byId("idNavigationTargetHeaderLabel").setTitle(this.getText("basicData"));this.byId("idSemanticObjectLabel").setText(this.getText("semanticObject"));this.byId("idSemanticObjectLabel").setRequired(true);this.byId("idActionLabel").setText(this.getText("action"));this.byId("idActionLabel").setRequired(true);this.byId("idDescriptionLabel").setText(this.getText("navigationTargetTitle"));this.byId("idNavigationTargetTypeHeaderLabel").setTitle(this.getText("navigationTargetType"));this.byId("idNavigationTargetTypeLabel").setText(this.getText("assignmentType"));this.byId("idAssignedStepsLabel").setText(this.getText("assignedSteps"));this.byId("idContextMapping").setTitle(this.getText("contextMapping"));this.byId("idContextMapSourceLabel").setText(this.getText("source"));this.byId("idContextMapEntityLabel").setText(this.getText("entity"));this.byId("idMappedPropertiesLabel").setText(this.getText("mappedProperties"));},_prepareNavTargetTypeModel:function(){var n=[{typeKey:this.getText("globalNavTargets"),typeName:this.getText("globalNavTargets")},{typeKey:this.getText("stepSpecific"),typeName:this.getText("stepSpecific")}];var N=new sap.ui.model.json.JSONModel();var o={navTargetType:n};N.setData(o);this.byId("idNavigationTargetTypeField").setModel(N);},_prepareAssignStepModel:function(){var a=[];var A=new sap.ui.model.json.JSONModel();var s=this.oConfigurationEditor.getSteps();for(var i=0;i<s.length;i++){var S={};S.stepKey=s[i].getId();S.stepName=this.oTextPool.get(s[i].getTitleId()).TextElementDescription;a.push(S);}var o={allSteps:a};A.setData(o);this.byId("idAssignedStepsCombo").setModel(A);},setDetailData:function(){var s=this.byId("idSemanticObjectField").getModel().getData().aAllSemanticObjects;if(this.params&&this.params.arguments&&this.params.arguments.navTargetId){this.oNavTarget=this.oConfigurationEditor.getNavigationTarget(this.params.arguments.navTargetId);}if(this.oNavTarget){var S;var a=this.oNavTarget.getSemanticObject();for(var i=0;i<s.length;i++){if(a===s[i].semanticObjectKey){S=true;break;}}this.byId("idSemanticObjectField").setValue(a);var b={changeSemanticObject:false,semanticObjectInList:S?true:false};this._populateActions(a,b);var n=this.oNavTarget.isStepSpecific()?this.getText("stepSpecific"):this.getText("globalNavTargets");if(n===this.getText("stepSpecific")){this.byId("idAssignedStepsLabel").setVisible(true);this.byId("idAssignedStepsCombo").setVisible(true);this._prepareAssignStepModel();var A=this.oConfigurationEditor.getStepsAssignedToNavigationTarget(this.oNavTarget.getId());this.byId("idAssignedStepsCombo").setSelectedKeys(A);}this.byId("idNavigationTargetTypeField").setSelectedKey(n);if(this.oNavTarget.getFilterMappingService&&this.oNavTarget.getFilterMappingService()!==undefined&&this.oNavTarget.getFilterMappingService().length!==0){this.byId("idContextMapSourceSelect").setValue(this.oNavTarget.getFilterMappingService());var c=this.oNavTarget.getFilterMappingService();var d=[];var e=[];d=this.oConfigurationEditor.getAllEntitySetsOfService(c);d.forEach(function(r){var E={};E.entityKey=r;E.entityName=r;e.push(E);});var D={Entity:e};var m=new sap.ui.model.json.JSONModel();m.setSizeLimit(500);m.setData(D);this.byId("idContextMapEntitySelect").setModel(m);this._addMandatoryToContextMap();}else{this._removeMandatoryFromContextMap();this._resetContextMappingFields();}if(this.oNavTarget.getFilterMappingEntitySet&&this.oNavTarget.getFilterMappingEntitySet()!==undefined&&this.oNavTarget.getFilterMappingEntitySet().length!==0){this.byId("idContextMapEntitySelect").setSelectedKey(this.oNavTarget.getFilterMappingEntitySet());var f=this.oNavTarget.getFilterMappingService();var F=this.oNavTarget.getFilterMappingEntitySet();var g=[],p=[];if(f&&f!==null&&f!==""){g=this.oConfigurationEditor.getAllPropertiesOfEntitySet(f,F);g.forEach(function(r){var P={};P.propertyKey=r;P.propertyName=r;p.push(P);});var o={Properties:p};var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(500);M.setData(o);this.byId("idMappedPropertiesCombo").setModel(M);}}if(this.oNavTarget.getFilterMappingTargetProperties&&this.oNavTarget.getFilterMappingTargetProperties()!==undefined&&this.oNavTarget.getFilterMappingTargetProperties().length!==0){this.byId("idMappedPropertiesCombo").setSelectedKeys(this.oNavTarget.getFilterMappingTargetProperties());}}else{var h=this.oConfigurationEditor.createNavigationTarget();this.oNavTarget=this.oConfigurationEditor.getNavigationTarget(h);s.splice(0,0,{semanticObjectKey:"",semanticObjectName:""});var j={aAllSemanticObjects:s};this.byId("idSemanticObjectField").getModel().setData(j);this.byId("idSemanticObjectField").setSelectedKey("");var k=new sap.ui.model.json.JSONModel();var l={aActions:[{id:"",text:""}]};k.setData(l);this.byId("idActionField").setModel(k);this.byId("idActionField").setSelectedKey("");var q={id:h,icon:"sap-icon://BusinessSuiteInAppSymbols/icon-where-used"};this.oViewData.updateSelectedNode(q);this.oNavTarget.setGlobal();this.byId("idNavigationTargetTypeField").setSelectedKey(this.getText("globalNavTargets"));}this._addAutoCompleteFeatureOnInputs();},handleChangeSemanticObjectValue:function(e){var s=this.byId("idSemanticObjectField").getModel().getData().aAllSemanticObjects;if(s[0].semanticObjectKey===""){s.splice(0,1);var S={aAllSemanticObjects:s};this.byId("idSemanticObjectField").getModel().setData(S);}var a=e.getParameter("value");var b=this.byId("idSemanticObjectField").getSelectedKey();var c={changeSemanticObject:true,semanticObjectInList:a===b?true:false};if(a!==""&&a!==null){this.oConfigurationEditor.setIsUnsaved();this.oNavTarget.setSemanticObject(a);this._populateActions(a,c);}},_getActionText:function(){var t;var s=this.byId("idActionField").getModel().getData().aActions;for(var i=0;i<s.length;i++){if(s[i].id===this.oNavTarget.getAction()){t=s[i].text;break;}}return t;},handleChangeofAction:function(e){var t;var a=e.getParameter("value");if(a!==""&&a!==null){this.oNavTarget.setAction(a);t=this._getActionText();}this.oConfigurationEditor.setIsUnsaved();if(t===undefined){t=this.oNavTarget.getSemanticObject();}var A={name:t,icon:this.oNavTarget.isGlobal()?"sap-icon://BusinessSuiteInAppSymbols/icon-where-used":"sap-icon://pushpin-off"};this.byId("idDescription").setValue(t);var n={key:this.oNavTarget.getId(),value:t};this.setNavigationTargetName(n);this.oViewData.updateSelectedNode(A);t=this.getText("navigationTarget")+": "+t;this.updateTitleAndBreadCrumb(t);},_updateDescriptionAndTitle:function(s,t){if(s.changeSemanticObject){if(t===undefined){t=this.oNavTarget.getSemanticObject();}var a={name:t,icon:this.oNavTarget.isGlobal()?"sap-icon://BusinessSuiteInAppSymbols/icon-where-used":"sap-icon://pushpin-off"};this.byId("idDescription").setValue(t);this.oViewData.updateSelectedNode(a);var n={key:this.oNavTarget.getId(),value:t};this.setNavigationTargetName(n);t=this.getText("navigationTarget")+": "+t;this.updateTitleAndBreadCrumb(t);}},_populateActions:function(s,a){var b=this;var t;if(a&&a.semanticObjectInList){var p=this.getSemanticActions(s);p.then(function(S){var A={aActions:S.semanticActions};var o=new sap.ui.model.json.JSONModel();o.setData(A);b.byId("idActionField").setModel(o);if(b.oNavTarget.getAction()&&a&&a.changeSemanticObject===false){b.byId("idActionField").setValue(b.oNavTarget.getAction());var T=b._getActionText()?b._getActionText():b.oNavTarget.getSemanticObject();b.byId("idDescription").setValue(T);}else if(o.getData().aActions.length>0){b.byId("idActionField").setSelectedKey(o.getData().aActions[0].id);b.oNavTarget.setAction(o.getData().aActions[0].id);t=o.getData().aActions[0].text;}b._updateDescriptionAndTitle(a,t);},function(c){var M=b.createMessageObject({code:"11505"});M.setPrevious(c);b.putMessage(M);});}else{var m=new sap.ui.model.json.JSONModel();var d={aActions:[]};m.setData(d);this.byId("idActionField").setModel(m);if(this.oNavTarget.getAction()&&a&&a.changeSemanticObject===false){this.byId("idActionField").setValue(this.oNavTarget.getAction());var T=b.oNavTarget.getSemanticObject();b.byId("idDescription").setValue(T);}else{this.byId("idActionField").setValue("");}this._updateDescriptionAndTitle(a,t);}},handleChangeOfNavigationTargetType:function(){this.oConfigurationEditor.setIsUnsaved();var n={};var a=this.byId("idNavigationTargetTypeField").getSelectedKey();if(a===this.getText("stepSpecific")){this.byId("idAssignedStepsLabel").setVisible(true);this.byId("idAssignedStepsCombo").setVisible(true);this._prepareAssignStepModel();this.oNavTarget.setStepSpecific();n.name=this.byId("idDescription").getValue();n.icon="sap-icon://pushpin-off";}else{this.byId("idAssignedStepsLabel").setVisible(false);this.byId("idAssignedStepsCombo").setVisible(false);this.byId("idAssignedStepsCombo").setSelectedKeys([]);this.oNavTarget.setGlobal();var b=this.oConfigurationEditor.getStepsAssignedToNavigationTarget(this.oNavTarget.getId());for(var i=0;i<b.length;i++){var s=this.oConfigurationEditor.getStep(b[i]);s.removeNavigationTarget(this.oNavTarget.getId());}n.name=this.byId("idDescription").getValue();n.icon="sap-icon://BusinessSuiteInAppSymbols/icon-where-used";}this.oViewData.updateSelectedNode(n);},handleChangeForAssignedSteps:function(){var s=this;this.oConfigurationEditor.setIsUnsaved();var a=this.byId("idAssignedStepsCombo").getSelectedKeys();var p=this.oConfigurationEditor.getStepsAssignedToNavigationTarget(this.oNavTarget.getId());p.forEach(function(S){if(a.indexOf(S)===-1){var o=s.oConfigurationEditor.getStep(S);o.removeNavigationTarget(s.oNavTarget.getId());}});a.forEach(function(S){if(p.indexOf(S)===-1){var o=s.oConfigurationEditor.getStep(S);o.addNavigationTarget(s.oNavTarget.getId());}});},handleChangeForService:function(){this.oConfigurationEditor.setIsUnsaved();var a,A=[],s=[];var S=this.byId("idContextMapSourceSelect").getValue().trim();var b=this.oConfigurationEditor.registerService(S);if(b){this._addMandatoryToContextMap();a=this.oConfigurationEditor.getAllEntitySetsOfService(S);if(a.length>0){a.forEach(function(d){var f={};f.entityKey=d;f.entityName=d;A.push(f);});}var e={Entity:A};var E=new sap.ui.model.json.JSONModel();E.setSizeLimit(500);E.setData(e);this.byId("idContextMapEntitySelect").setModel(E);if(a.length>=1){var p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(S,a[0]);this.oNavTarget.setFilterMappingEntitySet(a[0]);this.byId("idContextMapEntitySelect").setSelectedKey(a[0]);p.forEach(function(d){var P={};P.propertyKey=d;P.propertyName=d;s.push(P);});}var o={Properties:s};var c=new sap.ui.model.json.JSONModel();c.setSizeLimit(500);c.setData(o);this.byId("idMappedPropertiesCombo").setModel(c);this._validateAndSetDataForContextMapping();}else{this._resetContextMappingFields();this._removeMandatoryFromContextMap();}},handleChangeForEntity:function(){this.oConfigurationEditor.setIsUnsaved();var p=[];var e=this.byId("idContextMapEntitySelect").getSelectedKey();var s=this.byId("idContextMapSourceSelect").getValue().trim();var P=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,e);P.forEach(function(a){var b={};b.propertyKey=a;b.propertyName=a;p.push(b);});var S={Properties:p};var o=new sap.ui.model.json.JSONModel();o.setSizeLimit(500);o.setData(S);this.byId("idMappedPropertiesCombo").setModel(o);var m=this.oNavTarget.getFilterMappingTargetProperties();var c=[];P.forEach(function(a){m.forEach(function(b){if(b===a){c.push(b);}});});this.byId("idMappedPropertiesCombo").setSelectedKeys(c);this._validateAndSetDataForContextMapping();},handleChangeForMappedProperties:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idMappedPropertiesCombo").getSelectedKeys();if(s.length!==0){this._validateAndSetDataForContextMapping();}},_getMandatoryFields:function(){return this.mandatoryFields;},_setMandatoryFields:function(f){this.mandatoryFields=this.mandatoryFields||[];for(var i=0;i<f.length;i++){f[i].isMandatory=true;this.mandatoryFields.push(f[i]);}},_setValidationState:function(){var m=this._getMandatoryFields();if(m.length!==0){for(var i=0;i<m.length;i++){if(m[i].isMandatory===true){if(typeof m[i].getSelectedKeys==="function"){this.isValidState=(m[i].getSelectedKeys().length>=1)?true:false;}else if(typeof m[i].getValue==="function"){this.isValidState=(m[i].getValue().trim()!=="")?true:false;}else{this.isValidState=(m[i].getSelectedKey()!==""&&m[i].getSelectedKey()!==undefined)?true:false;}if(this.isValidState===false){break;}}}}},getValidationState:function(){this._setValidationState();var i=(this.isValidState!==undefined)?this.isValidState:true;return i;},_validateAndSetDataForContextMapping:function(){var s=this;var S=this.byId("idContextMapSourceSelect").getValue().trim();var a=this.byId("idContextMapEntitySelect").getSelectedKey();var m=this.byId("idMappedPropertiesCombo").getSelectedKeys();if((S!==""||S!==undefined)&&(a!==""||a!==undefined)&&(m.length!==0)){this.oNavTarget.setFilterMappingService(S);this.oNavTarget.setFilterMappingEntitySet(a);var o=this.oNavTarget.getFilterMappingTargetProperties();o.forEach(function(p){s.oNavTarget.removeFilterMappingTargetProperty(p);});m.forEach(function(p){s.oNavTarget.addFilterMappingTargetProperty(p);});}},_addMandatoryToContextMap:function(){this.byId("idContextMapEntitySelect").isMandatory=true;this.byId("idMappedPropertiesCombo").isMandatory=true;this.byId("idContextMapEntityLabel").setRequired(true);this.byId("idMappedPropertiesLabel").setRequired(true);},_removeMandatoryFromContextMap:function(){this.byId("idContextMapEntitySelect").isMandatory=false;this.byId("idMappedPropertiesCombo").isMandatory=false;this.byId("idContextMapEntityLabel").setRequired(false);this.byId("idMappedPropertiesLabel").setRequired(false);},_resetContextMappingFields:function(){var s=this;this.oNavTarget.setFilterMappingService("");this.oNavTarget.setFilterMappingEntitySet(undefined);var o=this.oNavTarget.getFilterMappingTargetProperties();o.forEach(function(p){s.oNavTarget.removeFilterMappingTargetProperty(p);});var e=new sap.ui.model.json.JSONModel();var E={NoData:[]};e.setData(E);this.byId("idContextMapSourceSelect").setValue("");this.byId("idContextMapEntitySelect").setModel(e);this.byId("idContextMapEntitySelect").setSelectedKey();this.byId("idMappedPropertiesCombo").setModel(e);var S=this.byId("idMappedPropertiesCombo").getSelectedKeys();this.byId("idMappedPropertiesCombo").removeSelectedKeys(S);},_addAutoCompleteFeatureOnInputs:function(){if(this.oConfigurationHandler){var t=new sap.apf.modeler.ui.utils.TextPoolHelper(this.oTextPool);var d={oConfigurationEditor:this.oConfigurationEditor,type:"service"};var s=this.byId("idContextMapSourceSelect");t.setAutoCompleteOn(s,d);}}});
