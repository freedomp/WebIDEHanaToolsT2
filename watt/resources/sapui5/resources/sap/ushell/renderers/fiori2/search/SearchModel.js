(function(g){"use strict";jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchHelper');jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchResultListFormatter');jQuery.sap.require('sap.ushell.renderers.fiori2.search.INAV2SearchFacetsFormatter');jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchTabStripsFormatter');jQuery.sap.require('sap.ushell.renderers.fiori2.search.FacetItem');jQuery.sap.require('sap.ushell.renderers.fiori2.search.suggestions.SuggestionHandler');jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchIntentsResolver');var s=g.sap;var S=s.ushell.renderers.fiori2.search.SearchHelper;var a=s.ushell.renderers.fiori2.search.SearchResultListFormatter;var T=s.ushell.renderers.fiori2.search.SearchTabStripsFormatter.Formatter;var b=s.ushell.renderers.fiori2.search.suggestions.SuggestionHandler;s.ushell.renderers.fiori2.search.getModelSingleton=function(){if(!s.ushell.renderers.fiori2.search.oModel){s.ushell.renderers.fiori2.search.oModel=new s.ushell.renderers.fiori2.search.SearchModel();}return s.ushell.renderers.fiori2.search.oModel;};s.ui.model.json.JSONModel.extend("sap.ushell.renderers.fiori2.search.SearchModel",{constructor:function(p){var t=this;p=p||{};s.ui.model.json.JSONModel.prototype.constructor.apply(t,[]);t.urlParameters=t.parseUrlParameters();t.setSizeLimit(200);t.sina=s.ushell.Container.getService("Search").getSina();this.suggestionQuery=this.sina.createSuggestionQuery();t.suggestionHandler=new b({model:this});t.query=t.sina.createPerspectiveQuery({templateFactsheet:true});t.resetFilterConditions(false);t.createAllAndAppDataSource();t.query.getResultSet=S.refuseOutdatedRequests(t.query.getResultSet,'search');t.searchApplications=S.refuseOutdatedRequests(t.searchApplications,'search');t.oFacetFormatter=new s.ushell.renderers.fiori2.search.INAV2SearchFacetsFormatter();t.tabStripFormatter=new T();t.dataSourceTree=t.tabStripFormatter.tree;t.appTopDefault=20;t.boTopDefault=10;this.setProperty('/isInvalidated',true);t.setProperty('/searchBoxTerm','');t.setProperty('/lastSearchTerm',null);t.setProperty('/isBusy',false);t.setProperty('/dataSource',null);t.setProperty('/lastDataSource',null);t.setProperty('/top',10);t.setProperty('/lastTop',10);t.setProperty('/skip',0);t.setProperty('/lastSkip',0);t.setProperty('/results',[]);t.setProperty('/appResults',[]);t.setProperty('/boResults',[]);t.setProperty('/count',0);t.setProperty('/boCount',0);t.setProperty('/appCount',0);t.setProperty('/facets',[]);t.setProperty('/filterConditions',[]);t.setProperty('/lastFilterConditions',[]);t.setProperty('/dataSources',[t.allDataSource,t.appDataSource]);t.setProperty('/recentDataSources',[]);t.setProperty('/businessObjSearchEnabled',true);t.setProperty('/suggestions',[]);t.setProperty('/resultsVisibility',true);t.setProperty('/appsVisibility',true);t.setProperty('/facetVisibility',S.loadFilterButtonStatus());t.setProperty('/lastFacetVisibility',false);t.resetDataSource(false);t.initBusinessObjSearch();try{t.analytics=s.ushell.Container.getService("UsageAnalytics");}catch(e){}if(!t.analytics){t.analytics={logCustomEvent:function(){}};}},doSuggestion:function(){this.suggestionHandler.doSuggestion();},abortSuggestions:function(){this.suggestionHandler.abortSuggestions();},parseUrlParameters:function(){var u=s.ushell.Container.getService("URLParsing");var p=u.parseParameters(window.location.search);var n={};for(var k in p){var v=p[k];if(v.length!==1){continue;}v=v[0];if(typeof v!=='string'){continue;}n[k.toLowerCase()]=v.toLowerCase();}return n;},setProperty:function(n,v){var t=this;var r=s.ui.model.json.JSONModel.prototype.setProperty.apply(this,arguments);switch(n){case'/boResults':case'/appResults':t.calculateResultList();break;case'/appCount':case'/boCount':r=t.setProperty('/count',t.getProperty('/appCount')+t.getProperty('/boCount'));break;default:break;}return r;},calculateResultList:function(){var t=this;var r=[];var c=t.getProperty('/boResults');if(c&&c.length){r.push.apply(r,c);}var d=t.getProperty('/appResults');if(d&&d.length>0){var e={type:'appcontainer',tiles:d};if(r.length>0){if(r.length>3){r.splice(3,0,e);}else{r.push(e);}}else{r=[e];}}s.ui.model.json.JSONModel.prototype.setProperty.apply(this,['/results',r]);},initBusinessObjSearch:function(){var t=this;if(!t.isBusinessObjSearchConfigured()){t.setDataSource(t.appDataSource,false);t.setProperty('/businessObjSearchEnabled',false);t.setProperty('/facetVisibility',false);return;}t.sina.sinaSystem().getServerInfo().done(function(){t.loadDataSources();}).fail(function(){t.setDataSource(t.appDataSource,false);t.setProperty('/businessObjSearchEnabled',false);t.setProperty('/facetVisibility',false);});},loadDataSources:function(){var t=this;t.getServerDataSources().done(function(d){if(!jQuery.isArray(d)){d=[];}d=d.slice();d.splice(0,0,t.appDataSource);d.splice(0,0,t.allDataSource);d=t._concatenateLabelAndRemoteSystem(d);t.setProperty("/dataSources",d);t.updateDataSourceList(t.getDataSource());var c=t.getDataSource();t.setProperty("/dataSource",{});t.setProperty("/dataSource",c);});},_concatenateLabelAndRemoteSystem:function(d){var f=d;for(var i=0;i<f.length-1;i++){if(f[i].remoteSystem!==undefined&&f[i].remoteSystem!==""){f[i].label=f[i].label+' '+s.ushell.resources.i18n.getText("textIn")+' '+f[i].remoteSystem;f[i].labelPlural=f[i].labelPlural+' '+s.ushell.resources.i18n.getText("textIn")+' '+f[i].remoteSystem;}}return f;},getServerDataSources:function(){var t=this;if(t.getDataSourcesDeffered){return t.getDataSourcesDeffered;}t.getDataSourcesDeffered=t.sina.getAllDataSources({top:1000});return t.getDataSourcesDeffered;},isBusinessObjSearchConfigured:function(){try{var c=window['sap-ushell-config'].renderers.fiori2.componentData.config;return c.searchBusinessObjects!=='hidden';}catch(e){return true;}},isBusinessObjSearchEnabled:function(){return this.getProperty('/businessObjSearchEnabled');},isFacetSearchEnabled:function(){if(this.urlParameters.disableeshfacets==='true'){return false;}return true;},searchApplications:function(c,t,d){return s.ushell.Container.getService("Search").queryApplications({searchTerm:c,searchInKeywords:true,top:t,skip:d});},createAllAndAppDataSource:function(){this.allDataSource=this.sina.getRootDataSource();this.allDataSource.label=s.ushell.resources.i18n.getText("label_all");this.allDataSource.labelPlural=s.ushell.resources.i18n.getText("label_all");this.appDataSource=new s.bc.ina.api.sina.base.datasource.DataSource({label:s.ushell.resources.i18n.getText("label_apps"),labelPlural:s.ushell.resources.i18n.getText("label_apps"),type:'Apps',name:'Apps'});},isAllCategory:function(){var d=this.getProperty("/dataSource");return d.equals(this.allDataSource);},isAppCategory:function(){var d=this.getProperty("/dataSource");return d.equals(this.appDataSource);},addFilterCondition:function(f,c){var t=this,d=f.filterCondition;function e(f){var n=t.getProperty("/filterConditions");n.push(f);t.setProperty("/filterConditions",n);}if(d.attribute||d.conditions){if(!t.query.getFilter().hasFilterCondition(d)){t.query.addFilterCondition(d);e(f);}if(!t.suggestionQuery.getFilter().hasFilterCondition(d)){t.suggestionQuery.addFilterCondition(d);}}else{t.setDataSource(d,false);}if(c||c===undefined){t._searchFireQuery();}},removeFilterCondition:function(f,c){var t=this,d=f.filterCondition;function r(f){var n=t.getProperty("/filterConditions");var i=t.getProperty("/filterConditions").length;while(i--){var e=t.getProperty("/filterConditions")[i].filterCondition;if(e.equals(f.filterCondition)){n.splice(i,1);break;}}t.setProperty("/filterConditions",n);}if(d.attribute){r(f);t.query.removeFilterCondition(d.attribute,d.operator,d.value);t.suggestionQuery.removeFilterCondition(d.attribute,d.operator,d.value);}else if(d.conditions){r(f);t.query.getFilter().removeFilterConditionGroup(d);t.suggestionQuery.getFilter().removeFilterConditionGroup(d);}else{t.setDataSource(d,false);}if(c||c===undefined){t._searchFireQuery();}},hasFilterCondition:function(f){return this.query.getFilter().hasFilterCondition(f);},resetFilterConditions:function(f){var t=this;t.query.resetFilterConditions();t.suggestionQuery.resetFilterConditions();t.setProperty("/filterConditions",[]);t.query.addFilterCondition('$$RenderingTemplatePlatform$$','=','html');t.query.addFilterCondition('$$RenderingTemplateTechnology$$','=','Tempo');t.query.addFilterCondition('$$RenderingTemplateVariant$$','=','');t.query.addFilterCondition('$$RenderingTemplateType$$','=','ItemDetails');t.query.addFilterCondition('$$RenderingTemplateType$$','=','ResultItem');if(f||f===undefined){t._searchFireQuery();}},getFacets:function(){var t=this;return t.getProperty('/facets');},getTop:function(){return this.getProperty('/top');},setTop:function(t,f){this.setProperty('/top',t);if(f||f===undefined){this._searchFireQuery();}},getSkip:function(){return this.getProperty('/skip');},setSkip:function(c,f){this.setProperty('/skip',c);if(f||f===undefined){this._searchFireQuery();}},calculatePlaceholder:function(){var t=this;if(t.isAllCategory()){return s.ushell.resources.i18n.getText("search");}else{return s.ushell.resources.i18n.getText("searchInPlaceholder",t.getDataSource().label);}},setFacetVisibility:function(v,f){var t=this;if(v===this.getProperty('/facetVisibility')){return;}if(!v||t.getDataSource().getType().value==='Category'||t.isAppCategory()){t.setProperty('/lastFacetVisibility',v);}this.setProperty('/facetVisibility',v);S.saveFilterButtonStatus(v);if(f||f===undefined){this._searchFireQuery();}},getFacetVisibility:function(){return this.getProperty('/facetVisibility');},getDataSource:function(){var t=this;return t.getProperty("/dataSource");},setDataSource:function(d,f){var t=this;var o=t.getProperty('/dataSource');var c=false;var r=t.getProperty("/recentDataSources");for(var i=0,l=r.length;i<l;i++){var e=r[i];if(d.equals(e)){c=true;r.splice(i,Number.MAX_VALUE);t.setProperty("/recentDataSources",r);break;}}if(!c){if(o&&!this.allDataSource.equals(o)&&!this.appDataSource.equals(o)){if(this.tabStripFormatter.tree.hasChild(o,d)){r.push(o);}else if(this.tabStripFormatter.tree.hasSibling(o,d)){}else if(d.equals(o)){t.resetFilterConditions(false);}}}if(this.allDataSource.equals(d)){t.setProperty("/recentDataSources",[]);}t.updateDataSourceList(d);t.setProperty("/dataSource",d);t.setProperty("/searchTermPlaceholder",t.calculatePlaceholder());t.setSkip(0,false);if(t.isAppCategory()){t.setTop(t.appTopDefault,false);}else{t.setTop(t.boTopDefault,false);}if(f||f===undefined){t._searchFireQuery();}},updateDataSourceList:function(n){var d=this.getProperty('/dataSources');while(d.length>0&&!d[0].equals(this.allDataSource)){d.shift();}if(n.equals(this.allDataSource)||n.equals(this.appDataSource)){return;}if(n&&n.key){if(n.key.indexOf('~')>=0){return;}}for(var i=0;i<d.length;++i){var c=d[i];if(c.equals(n)){return;}}d.unshift(n);this.setProperty('/dataSources',d);},resetDataSource:function(f){this.setDataSource(this.allDataSource,f);},getSearchBoxTerm:function(){var t=this;return t.getProperty("/searchBoxTerm");},setSearchBoxTerm:function(c,f){var t=this;var d=c.replace(/^\s+/,"");t.setProperty("/searchBoxTerm",d);if(d.length===0){return;}if(f||f===undefined){t._searchFireQuery();}},invalidateQuery:function(){this.setProperty('/isInvalidated',true);},_searchFireQuery:function(d){var t=this;var f=!t.checkFiltersIdentical(t.getProperty('/filterConditions'),t.getProperty('/lastFilterConditions'));if(t.getProperty('/lastSearchTerm')===t.getProperty('/searchBoxTerm')&&t.getProperty('/lastDataSource').equals(t.getProperty('/dataSource'))&&t.getProperty('/lastTop')===t.getProperty('/top')&&t.getProperty('/lastSkip')===t.getProperty('/skip')&&t.getProperty('/lastFacetVisibility')===t.getProperty('/facetVisibility')&&!t.getProperty('/isInvalidated')&&!f){return;}if(t.getProperty('/searchBoxTerm').length===0&&t.getProperty('/lastSearchTerm').length!==0){t.setProperty('/searchBoxTerm',t.getProperty('/lastSearchTerm'));}if(t.getProperty('/lastSearchTerm')||t.getProperty('/lastDataSource')){if(t.getProperty('/lastSearchTerm')!==t.getProperty('/searchBoxTerm')||t.getProperty('/lastDataSource')!==t.getProperty('/dataSource')||f){t.setProperty('/skip',0);if(t.isAppCategory()){t.setProperty('/top',t.appTopDefault);}else{t.setProperty('/top',t.boTopDefault);}}}if(t.getProperty('/lastSearchTerm')!==t.getProperty('/searchBoxTerm')||f){t.tabStripFormatter.invalidateCount();}if(!d&&t.getProperty('/lastDataSource')!==null&&!t.getProperty('/lastDataSource').equals(t.getProperty('/dataSource'))){t.resetFilterConditions(false);}t.setProperty('/lastSearchTerm',t.getProperty('/searchBoxTerm'));t.setProperty('/lastDataSource',t.getProperty('/dataSource'));t.setProperty('/lastTop',t.getProperty('/top'));t.setProperty('/lastSkip',t.getProperty('/skip'));t.setProperty('/lastFacetVisibility',t.getProperty('/facetVisibility'));t.setProperty('/lastFilterConditions',t.cloneFilterConditions(this.getProperty('/filterConditions')));t.setProperty('/isInvalidated',false);s.ui.getCore().getEventBus().publish("allSearchStarted");t.abortSuggestions();S.abortRequests('search');t.calculateVisibility();t.updateSearchURLSilently();t.analytics.logCustomEvent('FLP: Search','Search',[t.getProperty('/searchBoxTerm'),t.getProperty('/dataSource').key]);var c=t.getDataSource();t.setProperty('/isBusy',true);jQuery.when.apply(null,[t.normalSearch(d),t.appSearch(d)]).done(function(){t.setProperty('/tabStrips',t.tabStripFormatter.format(c,t.perspective,t));t.setProperty('/facets',t.oFacetFormatter.getFacets(c,t.perspective,t));}).always(function(){t.setProperty('/isBusy',false);s.ui.getCore().getEventBus().publish("allSearchFinished");});},autoStartApp:function(){var t=this;if(t.getProperty("/appCount")&&t.getProperty("/appCount")===1&&t.getProperty("/count")&&t.getProperty("/count")===1){var A=t.getProperty("/appResults");if(A&&A.length>0&&A[0]&&A[0].url&&t.getProperty('/searchBoxTerm')&&A[0].tooltip&&t.getProperty('/searchBoxTerm').toLowerCase().trim()===A[0].tooltip.toLowerCase().trim()){if(A[0].url[0]==='#'){window.location.href=A[0].url;}else{window.open(A[0].url,'_blank');}}}},calculateVisibility:function(){var t=this;if(t.isAppCategory()){t.setProperty('/resultsVisibility',false);t.setProperty('/appsVisibility',true);}else{t.setProperty('/resultsVisibility',true);t.setProperty('/appsVisibility',false);}},appSearch:function(d){var t=this;var n=t.getTop();var c=t.getSkip();if(d===true){if(t.getSkip()>0){n=t.getSkip()+t.getTop();c=0;}}if(c===0){t.setProperty("/appResults",[]);t.setProperty("/appCount",0);}if(t.isAllCategory()||t.isAppCategory()){return t.searchApplications(t.getProperty('/searchBoxTerm'),n,c).then(function(r){t.setProperty("/appCount",r.totalResults);if(c>0){var e=t.getProperty("/appResults").slice();e.push.apply(e,r.getElements());t.setProperty("/appResults",e);}else{t.setProperty("/appResults",r.getElements());}s.ui.getCore().getEventBus().publish("appSearchFinished",r);},function(){s.ui.getCore().getEventBus().publish("appSearchFinished");return jQuery.when(true);});}else{t.setProperty("/appResults",[]);t.setProperty("/appCount",0);s.ui.getCore().getEventBus().publish("appSearchFinished");}},normalSearch:function(d){var t=this;if(t.isBusinessObjSearchEnabled()&&!t.isAppCategory()){t.query.setSearchTerms(t.getSearchBoxTerm());t.query.setDataSource(t.getDataSource());var n=t.getTop();var c=t.getSkip();if(d===true){if(t.getSkip()>0){n=t.getSkip()+t.getTop();c=0;}}t.query.setTop(n);t.query.setSkip(c);if(t.query.setExpand){if((t.getFacetVisibility()&&t.isFacetSearchEnabled())||t.getDataSource().getType().value==='Category'){t.query.setExpand(['Grid','Items','ResultsetFacets','TotalCount']);}else{t.query.setExpand(['Grid','Items','TotalCount']);}}return t.query.getResultSet().then(function(p){t.perspective=p;return t._afterSearchPrepareResultList(t.perspective,c>0).then(function(){s.ui.getCore().getEventBus().publish("normalSearchFinished",{append:t.getSkip()>0,resultset:t.perspective});});},function(e){s.ui.getCore().getEventBus().publish("normalSearchFinished",{append:t.getSkip()>0,resultset:null});t.normalSearchErrorHandling(e);t.perspective=null;return jQuery.when(true);});}else{t.setProperty("/boResults",[]);t.setProperty("/boCount",0);s.ui.getCore().getEventBus().publish("normalSearchFinished",{append:t.getSkip()>0,resultset:null});}},normalSearchErrorHandling:function(e){var c=["ESH_FED_MSG016"];if(e){if(e.status===500){jQuery.sap.log.error(e.responseText);jQuery.sap.require("sap.m.MessageBox");s.m.MessageBox.alert(e.responseText,{title:"Search Error: "+e.statusText,icon:s.m.MessageBox.Icon.ERROR});}if(e.responseText){var d=true;var f=jQuery.parseJSON(e.responseText);var h='';var j='';if(f.Error){if(f.Error.Message){h+=''+f.Error.Message;}if(f.Error.Code){h+=' (Code '+f.Error.Code+').';}}if(f.ErrorDetails){j+='';for(var i=0;i<f.ErrorDetails.length;i++){j+=f.ErrorDetails[i].Message+' (Code '+f.ErrorDetails[i].Code+')';if(c.indexOf(f.ErrorDetails[i].Code)!==-1){d=false;}}}jQuery.sap.log.error(h+' Details: '+j);if(d){jQuery.sap.require("sap.m.MessageBox");s.m.MessageBox.alert(j,{title:"Search Error: "+h,icon:s.m.MessageBox.Icon.ERROR});}}else{var m='Search error:'+e.toString();jQuery.sap.log.error(m);jQuery.sap.require("sap.m.MessageBox");s.m.MessageBox.alert(m,{title:'Search Error',icon:s.m.MessageBox.Icon.ERROR});}}},_afterSearchPrepareResultList:function(p,c){var t=this;var o=t.getProperty("/boResults");if(c){o.pop();}else{t.setProperty("/boResults",[]);t.setProperty("/boCount",0);o=t.getProperty("/boResults");}var f=new a();var r=f.format(p.getSearchResultSet(),this.query.filter.searchTerms);var i=new s.ushell.renderers.fiori2.search.SearchIntentsResolver(t);var d=i.resolveIntents(r);d.done(function(e){var n=o.concat(r);if(n.length<p.getSearchResultSet().totalcount){var h={};h.type="footer";n.push(h);}t.setProperty("/boCount",p.getSearchResultSet().totalcount);t.setProperty("/boResults",n);});return d;},createSearchURL:function(){var h="#Action-search";h+="&/searchterm="+encodeURIComponent(this.getProperty('/searchBoxTerm'));h+="&datasource="+encodeURIComponent(JSON.stringify(this.getDataSource().toURL()));h+="&top="+this.getTop();h+="&skip="+this.getSkip();if(this.getProperty("/filterConditions").length>0){h+="&filter="+encodeURIComponent(JSON.stringify(this.getProperty("/filterConditions")));}return h;},updateSearchURLSilently:function(){var h=this.createSearchURL();S.hasher.setHash(h);},deserializeURL:function(){if(!S.hasher.hasChanged()){return;}var u=s.ushell.Container.getService("URLParsing");var c=u.splitHash(window.location.hash).appSpecificRoute;if(!c){return;}var p=u.parseParameters("?"+c.substring(2));var P={};jQuery.each(p,function(i,v){P[i.toLowerCase()]=v[0];});if(!P.searchterm){return;}var d=P.searchterm;this.setSearchBoxTerm(d,false);var e;if(P.datasource){var f=JSON.parse(P.datasource);if(f.name==='Apps'){e=this.appDataSource;}else{e=this.sina.createDataSource(f);}this.setDataSource(e,false);}else{this.resetDataSource(false);}if(P.top){var t=parseInt(P.top,10);this.setTop(t,false);}if(P.skip){var h=parseInt(P.skip,10);this.setSkip(h,false);}this.resetFilterConditions(false);if(P.filter){var j=JSON.parse(P.filter);for(var i=0,l=j.length;i<l;i++){var k=new s.ushell.renderers.fiori2.search.FacetItem(j[i]);this.addFilterCondition(k,false);}}this._searchFireQuery(true);},checkFiltersIdentical:function(f,c){var d=[];for(var i=0;i<f.length;++i){var e=f[i];var m=false;for(var j=0;j<c.length;++j){var h=c[j];if(e.filterCondition.equals(h.filterCondition)){m=true;d[j]=true;break;}}if(!m){return false;}}for(var k=0;k<c.length;++k){if(!d[k]){return false;}}return true;},cloneFilterConditions:function(f){var n=jQuery.extend(true,[],f);return n;}});})(window);
