/*
 * ! @copyright@
 */
sap.ui.define(["./Error","./SelectionVariant","sap/suite/ui/generic/template/library"],function(E,S,T){"use strict";var N=T.ListReport.nav.NavType;var P=T.ListReport.nav.ParamHandlingMode;var a=T.ListReport.nav.Severity;var b=T.ListReport.nav.SuppressionBehavior;var c=sap.ui.base.Object.extend("sap.suite.ui.generic.template.ListReport.nav.NavigationHandler",{metadata:{publicMethods:["navigate","parseNavigation","storeInnerAppState","openSmartLinkPopover","mixAttributesAndSelectionVariant"]},constructor:function(C,p){this.oRouter=this._getRouter(C);this.oComponent=C.getOwnerComponent().getAppComponent();if(typeof this.oRouter==="undefined"||typeof this.oComponent==="undefined"){throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}try{this.oCrossAppNavService=sap.ushell.Container.getService("CrossApplicationNavigation");}catch(e){jQuery.sap.log.error("NavigationHandler: UShell service for cross app navigation is not available.");}this.IAPP_STATE="sap-iapp-state";this._oLastSavedInnerAppData={sAppStateKey:"",oAppData:{},iCacheHit:0,iCacheMiss:0};this._rIAppStateOld=new RegExp("/"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateOldAtStart=new RegExp("^"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateNew=new RegExp("[\?&]"+this.IAPP_STATE+"=([^&]+)");if(p===P.URLParamWins||p===P.InsertInSelOpt){this.sParamHandlingMode=p;}else{this.sParamHandlingMode=P.SelVarWins;}this.oi18n=new sap.ui.model.resource.ResourceModel({bundleName:"sap.suite.ui.generic.template.ListReport.i18n.i18n",bundleLocale:sap.ui.getCore().getConfiguration().getFormatLocale()}).getResourceBundle();},hasCrossApplicationNavigationService:function(){return this.oCrossAppNavService!==undefined;},_getRouter:function(C){return sap.ui.core.UIComponent.getRouterFor(C);},navigate:function(s,A,n,i,o){var d,p;if(typeof n==="string"){d=n;p=this._getURLParametersFromSelectionVariant(d);}else if(typeof n==="object"){p=n;var e=this._addParametersToAppData({},p);d=e.selectionVariant;}else{throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}var t=this;var f={target:{semanticObject:s,action:A},params:p||{}};var I=t.oCrossAppNavService.hrefForExternal(f);var g=t.oCrossAppNavService.isIntentSupported([I]);g.done(function(h){if(h[I].supported){var j=t.storeInnerAppState(i);j.done(function(){var O=function(q){f.appStateKey=q;t.oCrossAppNavService.toExternal(f,t.oComponent);};t._saveAppState({selectionVariant:d},O,o);});if(o){j.fail(function(m){o(m);});}}else if(o){var k="NavigationHandler.isIntentSupported.notSupported";var l=a.ERROR;var u={oi18n:t.oi18n,sTextKey:"INTENT_NOT_SUPPORTED",aParams:[s,A]};var m=new E(k,l,undefined,u);o(m);}});if(o){g.fail(function(){var h=t._createTechnicalError("NavigationHandler.isIntentSupported.failed");o(h);});}},parseNavigation:function(){var A=this.oRouter.oHashChanger.getHash();var i=this._getInnerAppStateKey(A);var C=this.oComponent.oComponentData;var s;if(C){s=C.startupParameters;}var m=jQuery.Deferred();var t=this;if(i){this._loadAppState(i,m);}else{var I=C!==undefined&&C["sap-xapp-state"]!==undefined;if(I){var o=this.oCrossAppNavService.getStartupAppState(this.oComponent);o.done(function(e){var f;var g=e.getData();if(!jQuery.isEmptyObject(s)){if(g){g=t._addParametersToAppData(g,s);m.resolve(g,s,N.xAppState);}else{f=t._createTechnicalError("NavigationHandler.getDataFromAppState.failed");m.reject(f,s,N.xAppState);}}else if(g){jQuery.sap.log.warning("Broken Sender navigation via xapp-state detected; sender did not provide legacy URL parameters");g.selectionVariant=t._ensureSelectionVariantFormatString(g.selectionVariant);m.resolve(g,{},N.xAppState);}else{jQuery.sap.log.warning("Broken Sender navigation via xapp-state detected; sender did not provide legacy URL parameters");f=t._createTechnicalError("NavigationHandler.getDataFromAppState.failed");m.reject(f,{},N.xAppState);}});o.fail(function(){var e=t._createTechnicalError("NavigationHandler.getStartupState.failed");m.reject(e,{},N.xAppState);});}else if(s){var d=t._addParametersToAppData({},s);m.resolve(d,s,N.URLParams);}else{m.resolve({},{},N.initial);}}return m.promise();},storeInnerAppState:function(i,I){if(typeof I!=="boolean"){I=true;}var t=this;var m=jQuery.Deferred();var r=function(s){var e=t.oRouter.oHashChanger.getHash();var f=t._replaceInnerAppStateKey(e,s);t.oRouter.oHashChanger.replaceHash(f);};var A=this._oLastSavedInnerAppData.sAppStateKey;var d=(JSON.stringify(i)===JSON.stringify(this._oLastSavedInnerAppData.oAppData));if(d&&A){this._oLastSavedInnerAppData.iCacheHit++;r(A);m.resolve(A);return m.promise();}this._oLastSavedInnerAppData.iCacheMiss++;var o=function(s){if(!I){r(s);}t._oLastSavedInnerAppData.oAppData=i;t._oLastSavedInnerAppData.sAppStateKey=s;m.resolve(s);};var O=function(e){m.reject(e);};var s=this._saveAppState(i,o,O);if(s!==undefined){if(I){r(s);}}return m.promise();},processBeforeSmartLinkPopoverOpens:function(t,s,i){var m=jQuery.Deferred();var d=t.semanticAttributes;var e=this;var f=function(d,s){s=s||"{}";var g=b.raiseErrorOnNull|b.raiseErrorOnUndefined;var M=e.mixAttributesAndSelectionVariant(d,s,g);s=M.toJSONString();d=e._getURLParametersFromSelectionVariant(M);var O=function(A){t.setSemanticAttributes(d);t.setAppStateKey(A);t.open();m.resolve(t);};var h=function(j){m.reject(j);};e._saveAppState({selectionVariant:s},O,h);};if(i){var o=this.storeInnerAppState(i,true);o.done(function(){f(d,s);});o.fail(function(g){m.reject(g);});}else{f(d,s);}return m.promise();},mixAttributesAndSelectionVariant:function(s,d,e){if(e===undefined){e=sap.suite.ui.generic.template.ListReport.nav.SuppressionBehavior.standard;}var o=new S(d);var n=new S();for(var p in s){if(s.hasOwnProperty(p)){var v=s[p];if(jQuery.type(v)==="array"||jQuery.type(v)==="object"){v=JSON.stringify(v);}else if(jQuery.type(v)==="date"){v=v.toJSON();}else if(jQuery.type(v)==="number"||jQuery.type(v)==="boolean"){v=v.toString();}if(v===""){if(e&b.ignoreEmptyString){jQuery.sap.log.info("Semantic attribute "+p+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue;}}if(v===null){if(e&b.raiseErrorOnNull){throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}else{jQuery.sap.log.warning("Semantic attribute "+p+" is null and ignored for mix in to selection variant");continue;}}if(v===undefined){if(e&b.raiseErrorOnUndefined){throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}else{jQuery.sap.log.warning("Semantic attribute "+p+" is undefined and ignored for mix in to selection variant");continue;}}if(jQuery.type(v)==="string"){n.addSelectOption(p,"I","EQ",v);}else{throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}}}var f=o.getParameterNames();var i;for(i=0;i<f.length;i++){if(!n.getSelectOption(f[i])){n.addSelectOption(f[i],"I","EQ",o.getParameter(f[i]));}}var g=o.getSelectOptionsPropertyNames();for(i=0;i<g.length;i++){if(!n.getSelectOption(g[i])){var h=o.getSelectOption(g[i]);for(var j=0;j<h.length;j++){n.addSelectOption(g[i],h[j].Sign,h[j].Option,h[j].Low,h[j].High);}}}return n;},_ensureSelectionVariantFormatString:function(s){if(s===undefined){return undefined;}var C=s;if(typeof s==="object"){C=JSON.stringify(s);}return C;},_addParametersToAppData:function(A,s){var v=A.selectionVariant||{};var o=new S(v);for(var p in s){if(s.hasOwnProperty(p)){var V="";if(typeof s[p]==="string"){V=s[p];}else if(jQuery.type(s[p])==="array"&&s[p].length===1){V=s[p][0];}else{throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}if(typeof o.getSelectOption(p)==="undefined"&&typeof o.getParameter(p)==="undefined"){o.addSelectOption(p,"I","EQ",V);continue;}if(o.getSelectOption(p)||o.getParameter(p)){switch(this.sParamHandlingMode){case P.SelVarWins:break;case P.URLParamWins:o.removeSelectOption(p);o.removeParameter(p);o.addSelectOption(p,"I","EQ",V);break;case P.InsertInSelOpt:var O=o.getParameter(p);if(O){o.removeParameter(p);o.addSelectOption(p,"I","EQ",O);}o.addSelectOption(p,"I","EQ",V);break;default:break;}}}}A.selectionVariant=o.toJSONString();return A;},_saveAppState:function(A,o,O){var d=this.oCrossAppNavService.createEmptyAppState(this.oComponent);var s=d.getKey();var e;var f={selectionVariant:{},tableVariantId:"",customData:{}};if(A.selectionVariant){if(typeof A.selectionVariant==="string"){try{f.selectionVariant=JSON.parse(A.selectionVariant);}catch(x){e=this._createTechnicalError("NavigationHandler.AppStateSave.parseError");if(O){O(e);}return undefined;}}else{f.selectionVariant=A.selectionVariant;}}if(A.tableVariantId){f.tableVariantId=A.tableVariantId;}if(A.customData){f.customData=A.customData;}d.setData(f);var g=d.save();if(o){g.done(function(){o(s);});}if(O){var t=this;g.fail(function(){e=t._createTechnicalError("NavigationHandler.AppStateSave.failed");O(e);});}return s;},_loadAppState:function(A,d){var o=this.oCrossAppNavService.getAppState(this.oComponent,A);var t=this;o.done(function(e){var f={selectionVariant:"{}",tableVariantId:"",customData:{}};var g=e.getData();if(typeof g==="undefined"){var h=t._createTechnicalError("NavigationHandler.getDataFromAppState.failed");d.reject(h,{},N.iAppState);}else{if(g.selectionVariant){f.selectionVariant=t._ensureSelectionVariantFormatString(g.selectionVariant);}if(g.tableVariantId){f.tableVariantId=g.tableVariantId;}if(g.customData){f.customData=g.customData;}}d.resolve(f,{},N.iAppState);});o.fail(function(){var e=t._createTechnicalError("NavigationHandler.getAppState.failed");d.reject(e,{},N.iAppState);});},_getInnerAppStateKey:function(A){if(!A){return undefined;}var m=this._rIAppStateNew.exec(A);if(m===null){m=this._rIAppStateOld.exec(A);}if(m===null){m=this._rIAppStateOldAtStart.exec(A);}if(m===null){return undefined;}return m[1];},_replaceInnerAppStateKey:function(A,s){var n=this.IAPP_STATE+"="+s;if(!A){return"?"+n;}var f=function(A){if(A.indexOf("?")!==-1){return A+"&"+n;}return A+"?"+n;};if(!this._getInnerAppStateKey(A)){return f(A);}if(this._rIAppStateNew.test(A)){return A.replace(this._rIAppStateNew,function(d){return d.replace(/\=.*/ig,"="+s);});}var r=function(d,A){A=A.replace(d,"");return f(A);};if(this._rIAppStateOld.test(A)){return r(this._rIAppStateOld,A);}if(this._rIAppStateOldAtStart.test(A)){return r(this._rIAppStateOldAtStart,A);}return undefined;},_getURLParametersFromSelectionVariant:function(s){var u={};var i=0;var o;if(typeof s==="string"){o=new S(s);}else if(typeof s==="object"){o=s;}else{throw new E("NavigationHandler.INVALID_INPUT",a.ERROR);}var d=o.getSelectOptionsPropertyNames();for(i=0;i<d.length;i++){var e=o.getSelectOption(d[i]);if(e.length===1&&e[0].Sign==="I"&&e[0].Option==="EQ"){u[d[i]]=e[0].Low;}}var p=o.getParameterNames();for(i=0;i<p.length;i++){var f=o.getParameter(p[i]);u[p[i]]=f;}return u;},_createTechnicalError:function(e,p){var s=a.ERROR;var u={oi18n:this.oi18n,sTextKey:"TECHNICAL_ERROR"};return new E(e,s,p,u);}});return c;});
