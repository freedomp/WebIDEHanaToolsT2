/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright
		2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['sap/m/PlacementType','sap/m/Popover','sap/m/Toolbar','sap/ui/core/Item','sap/ui/core/ResizeHandler','sap/ui/core/delegate/ScrollEnablement','./HierarchicalSelect','./library'],function(P,a,T,I,R,S,H,l){"use strict";var A=T.extend("sap.uxap.AnchorBar",{metadata:{library:"sap.uxap",properties:{showPopover:{type:"boolean",defaultValue:true},upperCase:{type:"boolean",defaultValue:false}},associations:{selectedButton:{type:"sap.m.Button",multiple:false}},aggregations:{_select:{type:"sap.uxap.HierarchicalSelect",multiple:false,visibility:"hidden"},_popovers:{type:"sap.m.Popover",multiple:true,visibility:"hidden"}}}});A.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.addStyleClass("sapUxAPAnchorBar");this._oPressHandlers={};this._oSectionInfo={};this._oScroller=null;this._oArrowLeft=null;this._oArrowRight=null;this._bRtlScenario=sap.ui.getCore().getConfiguration().getRTL()&&!sap.ui.Device.browser.msie;this._bHasButtonsBar=sap.ui.Device.system.tablet||sap.ui.Device.system.desktop;this._oSelect=this._getHierarchicalSelect();if(this._bHasButtonsBar){this._oScroller=new S(this,this.getId()+"-scroll",{horizontal:true,vertical:false,nonTouchScrolling:true});this._oArrowLeft=this._getArrowLeft(this._oArrowLeft,this);this._oArrowRight=this._getArrowRight(this._oArrowRight,this);this._iREMSize=parseInt(jQuery("body").css("font-size"),10);this._iTolerance=this._iREMSize*1;this._iOffset=this._iREMSize*3;this._sResizeListenerId=undefined;}this.setDesign("Transparent");};A.SCROLL_STEP=250;A.SCROLL_DURATION=500;A.DOM_CALC_DELAY=200;A.prototype.setSelectedButton=function(b){if(typeof b==="string"){b=sap.ui.getCore().byId(b);}if(b){var s=b.data("sectionId");if(s){this._oSelect.setSelectedKey(b.getId());}if(this._bHasButtonsBar){this.$().find(".sapUxAPAnchorBarButtonSelected").removeClass("sapUxAPAnchorBarButtonSelected");b.$().addClass("sapUxAPAnchorBarButtonSelected");if(s){this.scrollToSection(s,A.SCROLL_DURATION);}this._setAnchorButtonsTabFocusValues(b);}}return this.setAssociation("selectedButton",b,true);};A.prototype.setShowPopover=function(v,s){if(this.getShowPopover()===v){return;}var b,n=!jQuery.isEmptyObject(this._oPressHandlers);if(n){var c=this.getContent()||[];b=this.getSelectedButton();c.forEach(this._detachPopoverHandler,this);}this.setProperty("showPopover",v,true);if(n){this.rerender();if(b){this.setSelectedButton(b);}}return this;};A.prototype.getSelectedSection=function(){var s=this.getSelectedButton();if(s&&(typeof(s)==="string")){s=sap.ui.getCore().byId(s);}if(s&&(s instanceof sap.m.Button)&&s.data("sectionId")){return sap.ui.getCore().byId(s.data("sectionId"));}return null;};A.prototype.onBeforeRendering=function(){if(T.prototype.onBeforeRendering){T.prototype.onBeforeRendering.call(this);}var c=this.getContent()||[],u=this.getUpperCase(),p={oLastFirstLevelButton:null,oCurrentPopover:null};this._oSelect.removeAllItems();this._oSelect.setUpperCase(u);this.toggleStyleClass("sapUxAPAnchorBarUpperCase",u);c.forEach(function(b){this._createSelectItem(b);if(this._bHasButtonsBar){this._createPopoverSubMenu(b,p)}},this);};A.prototype.addContent=function(b,i){b.addStyleClass("sapUxAPAnchorBarButton");b.removeAllAriaDescribedBy();if(this._bHasButtonsBar&&(b.data("secondLevel")===true||b.data("secondLevel")==="true")){b.attachPress(this._handleDirectScroll,this);}return this.addAggregation("content",b,i);};A.prototype._createSelectItem=function(b){var i=b.data("secondLevel")===true||b.data("secondLevel")==="true",p=null;if(b.getText().trim()!=""&&(!i||b.data("bTitleVisible")===true)){var o=new I({key:b.getId(),text:b.getText(),customData:[new sap.ui.core.CustomData({key:"secondLevel",value:b.data("secondLevel")})]});this._oSelect.addItem(o);}};A.prototype._createPopoverSubMenu=function(b,p){var i=b.data("secondLevel")===true||b.data("secondLevel")==="true",f=null;if(i){if(p.oLastFirstLevelButton&&p.oCurrentPopover){if(!this._oPressHandlers[p.oLastFirstLevelButton.getId()]){f=jQuery.proxy(this._handlePopover,{oCurrentPopover:p.oCurrentPopover,oLastFirstLevelButton:p.oLastFirstLevelButton});p.oLastFirstLevelButton.attachPress(f);this._oPressHandlers[p.oLastFirstLevelButton.getId()]=f;}p.oCurrentPopover.addContent(b);}else if(this.getShowPopover()){jQuery.sap.log.error("sapUxApAnchorBar :: missing parent first level for item "+b.getText());}else{this.removeContent(b);}}else{p.oLastFirstLevelButton=b;if(this.getShowPopover()){p.oCurrentPopover=new a({placement:P.Bottom,showHeader:false,verticalScrolling:true,horizontalScrolling:false,contentWidth:"auto",showArrow:false});p.oCurrentPopover.addStyleClass("sapUxAPAnchorBarPopover");this._addKeyboardHandling(p.oCurrentPopover);this.addAggregation('_popovers',p.oCurrentPopover);}else{if(!this._oPressHandlers[p.oLastFirstLevelButton.getId()]){f=jQuery.proxy(this._handleDirectScroll,this);p.oLastFirstLevelButton.attachPress(f);this._oPressHandlers[p.oLastFirstLevelButton.getId()]=f;}}}};A.prototype._addKeyboardHandling=function(c){c.onsapdown=function(e){if(e.target.nextSibling){e.target.nextSibling.focus();}};c.onsapright=function(e){c.onsapdown(e);};c.onsapup=function(e){if(e.target.previousSibling){e.target.previousSibling.focus();}};c.onsapleft=function(e){c.onsapup(e);};c.onsaphome=function(e){if(e.target.parentElement.firstChild){e.target.parentElement.firstChild.focus();}};c.onsapend=function(e){if(e.target.parentElement.lastChild){e.target.parentElement.lastChild.focus();}};c.onsappageup=this._handlePageUp.bind(c);c.onsappagedown=this._handlePageDown.bind(c);};A.prototype._detachPopoverHandler=function(b){if(this._oPressHandlers[b.getId()]){b.detachPress(this._oPressHandlers[b.getId()]);this._oPressHandlers[b.getId()]=null;}};A.prototype._handlePopover=function(e){var p=this.oCurrentPopover.getContent()||[];if(this.oLastFirstLevelButton.$().is(":visible")){if(p.length==1){p[0].firePress({});}else{this.oCurrentPopover.openBy(this.oLastFirstLevelButton);}}};A.prototype._handleDirectScroll=function(e){if(e.getSource().getParent()instanceof a){e.getSource().getParent().close();}this._requestScrollToSection(e.getSource().data("sectionId"));};A.prototype._requestScrollToSection=function(r){var o=sap.ui.getCore().byId(r),b=o.getParent();if(this.getParent()instanceof sap.uxap.ObjectPageLayout){var n=r;if(o instanceof sap.uxap.ObjectPageSubSection&&b instanceof sap.uxap.ObjectPageSection){n=b.getId();}this.getParent().setDirectScrollingToSection(n);this.getParent().scrollToSection(o.getId());}if(o instanceof sap.uxap.ObjectPageSubSection&&b instanceof sap.uxap.ObjectPageSection){b.setAssociation("selectedSubSection",o,true);}};A.prototype._onSelectChange=function(e){var s=e.getParameter("selectedItem"),o;o=sap.ui.getCore().byId(s.getKey());if(o){this._requestScrollToSection(o.data("sectionId"));}else{jQuery.sap.log.error("AnchorBar :: cannot find corresponding button",s.getKey());}};A.prototype._isMobileScenario=function(){if(sap.ui.Device.system.phone){return true;}if(sap.ui.Device.media.hasRangeSet(sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED)){var r=sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED);if(r&&r==='Phone'){return true;}}return jQuery("html").hasClass("sapUiMedia-Std-Phone");};A.prototype._getHierarchicalSelect=function(){if(!this.getAggregation('_select')){this.setAggregation('_select',new H({width:"100%",icon:"sap-icon://slim-arrow-down",change:jQuery.proxy(this._onSelectChange,this)}));}return this.getAggregation('_select');};A.prototype._getArrowLeft=function(o,p){return sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollLeft",o,p,{src:"sap-icon://navigation-left-arrow"},["sapMITBArrowScroll","sapMITBArrowScrollLeft","sapUxAPAnchorBarArrowScroll","sapUxAPAnchorBarButton"]);};A.prototype._getArrowRight=function(o,p){return sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollRight",o,p,{src:"sap-icon://navigation-right-arrow"},["sapMITBArrowScroll","sapMITBArrowScrollRight","sapUxAPAnchorBarArrowScroll","sapUxAPAnchorBarButton"]);};A._hierarchicalSelectModes={"Icon":"icon","Text":"text"};A.prototype._applyHierarchicalSelectMode=function(){if(this._sHierarchicalSelectMode===A._hierarchicalSelectModes.Icon){this.$().find(".sapUxAPAnchorBarScrollContainer").show();this._oSelect.setWidth("auto");this._oSelect.setAutoAdjustWidth(true);this._oSelect.setType(sap.m.SelectType.IconOnly);this._computeBarSectionsInfo();}else{this.$().find(".sapUxAPAnchorBarScrollContainer").hide();this._oSelect.setWidth("100%");this._oSelect.setAutoAdjustWidth(false);this._oSelect.setType(sap.m.SelectType.Default);}this.$().toggleClass("sapUxAPAnchorBarOverflow",this._sHierarchicalSelectMode===A._hierarchicalSelectModes.Icon);};A.prototype._adjustSize=function(){var n=this._isMobileScenario()?A._hierarchicalSelectModes.Text:A._hierarchicalSelectModes.Icon;if(n!==this._sHierarchicalSelectMode){this._sHierarchicalSelectMode=n;this._applyHierarchicalSelectMode();}if(this._sHierarchicalSelectMode===A._hierarchicalSelectModes.Icon){if(this._iMaxPosition<0){return;}var $=this.$(),N,b,c;c=this.$().find(".sapUxAPAnchorBarScrollContainer").width();if(this._bRtlScenario){if(sap.ui.Device.browser.firefox){b=Math.abs(this._oScroller.getScrollLeft())+c<(this._iMaxPosition-this._iTolerance);N=Math.abs(this._oScroller.getScrollLeft())>=this._iTolerance;}else{b=Math.abs(this._oScroller.getScrollLeft())>=this._iTolerance;N=Math.abs(this._oScroller.getScrollLeft())+c<(this._iMaxPosition-this._iTolerance);}}else{b=this._oScroller.getScrollLeft()+c<(this._iMaxPosition-this._iTolerance);N=this._oScroller.getScrollLeft()>=this._iTolerance;}jQuery.sap.log.debug("AnchorBar :: scrolled at "+this._oScroller.getScrollLeft(),"scrollBegin ["+(N?"true":"false")+"] scrollEnd ["+(b?"true":"false")+"]");$.toggleClass("sapUxAPAnchorBarScrollLeft",N);$.toggleClass("sapUxAPAnchorBarScrollRight",b);}};A.prototype.ontap=function(e){var t=e.target.id,i=this.getId(),s=(t==i+"-arrowScrollLeft"),b=(t==i+"-arrowScrollRight"),c;if(s||b){e.preventDefault();if((!this._bRtlScenario&&s)||(this._bRtlScenario&&b)){c=-1;}else{c=1;}this._oScroller.scrollTo(this._iMaxPosition*c,0,A.SCROLL_DURATION*3);}};A.prototype.scrollToSection=function(i,d){if(this._bHasButtonsBar){var D=d||A.SCROLL_DURATION,s;if((this._sHierarchicalSelectMode===A._hierarchicalSelectModes.Icon)&&this._oSectionInfo[i]){s=this._oSectionInfo[i].scrollLeft-this._iOffset;if(s<0){s=0;}jQuery.sap.log.debug("AnchorBar :: scrolling to section "+i+" of "+s);if(this._sCurrentScrollId!=i){this._sCurrentScrollId=i;if(this._iCurrentScrollTimeout){jQuery.sap.clearDelayedCall(this._iCurrentScrollTimeout);jQuery.sap.byId(this.getId()+"-scroll").parent().stop(true,false);}this._iCurrentScrollTimeout=jQuery.sap.delayedCall(d,this,function(){this._sCurrentScrollId=undefined;this._iCurrentScrollTimeout=undefined;});this._oScroller.scrollTo(s,0,D);}}else{jQuery.sap.log.debug("AnchorBar :: no need to scroll to "+i);}}};A.prototype.getScrollDelegate=function(){return this._oScroller;};A.PAGEUP_AND_PAGEDOWN_JUMP_SIZE=5;A.prototype.onsapdown=function(e){e.preventDefault();if(e.target.nextSibling){e.target.nextSibling.focus();}};A.prototype.onsapright=function(e){this.onsapdown(e);};A.prototype.onsapup=function(e){e.preventDefault();if(e.target.previousSibling){e.target.previousSibling.focus();}};A.prototype.onsapleft=function(e){this.onsapup(e);};A.prototype.onsaphome=function(e){e.preventDefault();if(e.target.parentElement.firstChild){e.target.parentElement.firstChild.focus();}};A.prototype.onsapend=function(e){e.preventDefault();if(e.target.parentElement.lastChild){e.target.parentElement.lastChild.focus();}};A.prototype.onsappageup=function(e){this._handlePageUp(e);};A.prototype.onsappagedown=function(e){this._handlePageDown(e);};A.prototype._handlePageUp=function(e){e.preventDefault();var n;var b=this.getContent();b.forEach(function(o,i){if(o.getId()===e.target.id){n=i-(A.PAGEUP_AND_PAGEDOWN_JUMP_SIZE+1);return;}});if(n&&b[n]){b[n].focus();}else if(b[0]){b[0].focus();}};A.prototype._handlePageDown=function(e){e.preventDefault();var n;var b=this.getContent();b.forEach(function(o,i){if(o.getId()===e.target.id){n=i+A.PAGEUP_AND_PAGEDOWN_JUMP_SIZE+1;return;}});if(n&&b[n]){b[n].focus();}else if(b[b.length-1]){b[b.length-1].focus();}};A.prototype._setAnchorButtonsTabFocusValues=function(s){var b=this.getContent()||[],$,f='0',n='-1',t="tabIndex";b.forEach(function(o){$=o.$();if(o.sId===s.sId){$.attr(t,f);}else{$.attr(t,n);}});};A.prototype.onsapskipforward=function(e){this._handleGroupNavigation(e,false);};A.prototype._handleGroupNavigation=function(e,s){var E=jQuery.Event("keydown"),o={},b=this.getParent().getSections(),c=[this.getDomRef()],C;b.forEach(function(d){C=d.getSubSections().map(function(f){return f.$().attr("tabindex",-1)[0];});c=c.concat(C);});o.scope=c;e.preventDefault();this.$().focus();E.target=e.target;E.keyCode=jQuery.sap.KeyCodes.F6;E.shiftKey=s;jQuery.sap.handleF6GroupNavigation(E,o);};A.prototype.onAfterRendering=function(){if(T.prototype.onAfterRendering){T.prototype.onAfterRendering.call(this);}this._sHierarchicalSelectMode=A._hierarchicalSelectModes.Text;this._iMaxPosition=-1;this._sResizeListenerId=R.register(this,jQuery.proxy(this._adjustSize,this));this.$().find(".sapUxAPAnchorBarScrollContainer").scroll(jQuery.proxy(this._onScroll,this));if(this._bHasButtonsBar){jQuery.sap.delayedCall(A.DOM_CALC_DELAY,this,this._adjustSize);var $=this._oArrowLeft.$();var b=this._oArrowRight.$();if($&&b){$.attr("tabIndex",'-1');b.attr("tabIndex",'-1');}}if(this.getSelectedButton()){this.setSelectedButton(this.getSelectedButton());}};A.prototype._onScroll=function(){if(!this._iCurrentSizeCheckTimeout){this._iCurrentSizeCheckTimeout=jQuery.sap.delayedCall(A.SCROLL_DURATION,this,function(){this._iCurrentSizeCheckTimeout=undefined;this._adjustSize();});}};A.prototype._computeBarSectionsInfo=function(){this._iMaxPosition=0;var c=this.getContent()||[];c.forEach(this._computeNextSectionInfo,this);if(this._bRtlScenario&&sap.ui.Device.browser.webkit){c.forEach(this._adjustNextSectionInfo,this);this._oScroller.scrollTo(this._iMaxPosition,0,0);}};A.prototype._computeNextSectionInfo=function(c){if(c.data("bHasSubMenu")){c.$().attr("aria-haspopup","true");}c.$().attr("aria-controls",c.data("sectionId"));var w=c.$().outerWidth(true);this._oSectionInfo[c.data("sectionId")]={scrollLeft:this._iMaxPosition,width:w};this._iMaxPosition+=w;};A.prototype._adjustNextSectionInfo=function(c){var s=this._oSectionInfo[c.data("sectionId")];s.scrollLeft=this._iMaxPosition-s.scrollLeft-s.width;};A.prototype.exit=function(){if(this._sResizeListenerId){R.deregister(this._sResizeListenerId);this._sResizeListenerId=null;}if(this._oScroller){this._oScroller.destroy();this._oScroller=null;}};return A;});
