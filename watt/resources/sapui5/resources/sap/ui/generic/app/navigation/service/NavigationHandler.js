/*!
 * @copyright@
 */
sap.ui.define(["./NavError","./SelectionVariant","sap/ui/base/Object","sap/ui/model/resource/ResourceModel","sap/ui/core/UIComponent","jquery.sap.global"],function(E,S,B,R,U,q){"use strict";var N=B.extend("sap.ui.generic.app.navigation.service.NavigationHandler",{metadata:{publicMethods:["navigate","parseNavigation","storeInnerAppState","openSmartLinkPopover","mixAttributesAndSelectionVariant"]},constructor:function(c,p){if(typeof c==="undefined"||typeof c.getOwnerComponent!=="function"){throw new E("NavigationHandler.INVALID_INPUT");}this.oRouter=this._getRouter(c);this.oComponent=c.getOwnerComponent();if(typeof this.oRouter==="undefined"||typeof this.oComponent==="undefined"||typeof this.oComponent.getComponentData!=="function"){throw new E("NavigationHandler.INVALID_INPUT");}try{this.oCrossAppNavService=sap.ushell.Container.getService("CrossApplicationNavigation");}catch(e){q.sap.log.error("NavigationHandler: UShell service API for CrossApplicationNavigation is not available.");}this.IAPP_STATE="sap-iapp-state";this.sDefaultedParamProp="sap-ushell-defaultedParameterNames";this.sSAPSystemProp="sap-system";this._oLastSavedInnerAppData={sAppStateKey:"",oAppData:{},iCacheHit:0,iCacheMiss:0};this._rIAppStateOld=new RegExp("/"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateOldAtStart=new RegExp("^"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateNew=new RegExp("[\?&]"+this.IAPP_STATE+"=([^&]+)");if(p===sap.ui.generic.app.navigation.service.ParamHandlingMode.URLParamWins||p===sap.ui.generic.app.navigation.service.ParamHandlingMode.InsertInSelOpt){this.sParamHandlingMode=p;}else{this.sParamHandlingMode=sap.ui.generic.app.navigation.service.ParamHandlingMode.SelVarWins;}},_getRouter:function(c){return U.getRouterFor(c);},navigate:function(s,a,n,i,o){var b,p;if(typeof n==="string"){b=n;p=this._getURLParametersFromSelectionVariant(b);}else if(typeof n==="object"){p=n;var e=this._splitInboundNavigationParameters(new S(),p,[]).oNavigationSelVar;b=e.toJSONString();}else{throw new E("NavigationHandler.INVALID_INPUT");}var c=this;var d={target:{semanticObject:s,action:a},params:p||{}};var I=c.oCrossAppNavService.hrefForExternal(d,c.oComponent);var f=c.oCrossAppNavService.isIntentSupported([I]);f.done(function(t){if(t[I].supported){var g=c.storeInnerAppState(i);g.done(function(){var O=function(A){d.appStateKey=A;c.oCrossAppNavService.toExternal(d,c.oComponent);};c._saveAppState({selectionVariant:b},O,o);});if(o){g.fail(function(j){o(j);});}}else{if(o){var h="NavigationHandler.isIntentSupported.notSupported";var j=new E(h);o(j);}}});if(o){f.fail(function(){var g=c._createTechnicalError("NavigationHandler.isIntentSupported.failed");o(g);});}},parseNavigation:function(){var a=this.oRouter.oHashChanger.getHash();var I=this._getInnerAppStateKey(a);var c=this.oComponent.getComponentData();if(c===undefined){q.sap.log.warning("The navigation Component's data was not set properly; assuming instead that no parameters are provided.");c={};}var s=c.startupParameters;var d=[];if(s&&s[this.sDefaultedParamProp]&&s[this.sDefaultedParamProp].length>0){d=JSON.parse(s[this.sDefaultedParamProp][0]);}var m=q.Deferred();var n=this;if(I){this._loadAppState(I,m);}else{var b=c["sap-xapp-state"]!==undefined;if(b){var o=this.oCrossAppNavService.getStartupAppState(this.oComponent);o.done(function(f){var A=f.getData();if(A){try{A=JSON.parse(JSON.stringify(A));}catch(x){var g=n._createTechnicalError("NavigationHandler.AppStateData.parseError");m.reject(g,s,sap.ui.generic.app.navigation.service.NavType.xAppState);return m.promise();}}if(!q.isEmptyObject(s)){if(A){var h=new S(A.selectionVariant);var i=d.length;while(i--){if(h.getValue(d[i])){d.splice(i,1);}}var e=n._splitInboundNavigationParameters(h,s,d);A.selectionVariant=e.oNavigationSelVar.toJSONString();A.oSelectionVariant=e.oNavigationSelVar;A.oDefaultedSelectionVariant=e.oDefaultedSelVar;A.bNavSelVarHasDefaultsOnly=e.bNavSelVarHasDefaultsOnly;m.resolve(A,s,sap.ui.generic.app.navigation.service.NavType.xAppState);}else{g=n._createTechnicalError("NavigationHandler.getDataFromAppState.failed");m.reject(g,s,sap.ui.generic.app.navigation.service.NavType.xAppState);}}else{if(A){q.sap.log.warning("Broken Sender navigation via xapp-state detected; sender did not provide legacy URL parameters");A.selectionVariant=n._ensureSelectionVariantFormatString(A.selectionVariant);A.oSelectionVariant=new S(A.selectionVariant);A.oDefaultedSelectionVariant=new S();A.bNavSelVarHasDefaultsOnly=false;m.resolve(A,{},sap.ui.generic.app.navigation.service.NavType.xAppState);}else{q.sap.log.warning("Broken Sender navigation via xapp-state detected; sender did not provide legacy URL parameters");g=n._createTechnicalError("NavigationHandler.getDataFromAppState.failed");m.reject(g,{},sap.ui.generic.app.navigation.service.NavType.xAppState);}}});o.fail(function(){var f=n._createTechnicalError("NavigationHandler.getStartupState.failed");m.reject(f,{},sap.ui.generic.app.navigation.service.NavType.xAppState);});}else{if(s){var e=n._splitInboundNavigationParameters(new S(),s,d);if(e.oNavigationSelVar.isEmpty()&&e.oDefaultedSelVar.isEmpty()){m.resolve({},s,sap.ui.generic.app.navigation.service.NavType.initial);}else{var A={};A.selectionVariant=e.oNavigationSelVar.toJSONString();A.oSelectionVariant=e.oNavigationSelVar;A.oDefaultedSelectionVariant=e.oDefaultedSelVar;A.bNavSelVarHasDefaultsOnly=e.bNavSelVarHasDefaultsOnly;m.resolve(A,s,sap.ui.generic.app.navigation.service.NavType.URLParams);}}else{m.resolve({},{},sap.ui.generic.app.navigation.service.NavType.initial);}}}return m.promise();},_splitInboundNavigationParameters:function(s,o,d){if(!q.isArray(d)){throw new E("NavigationHandler.INVALID_INPUT");}var p;var a={};for(p in o){if(!o.hasOwnProperty(p)){continue;}if(p===this.sSAPSystemProp||p===this.sDefaultedParamProp){continue;}if(typeof o[p]==="string"){a[p]=o[p];}else if(q.type(o[p])==="array"&&o[p].length===1){a[p]=o[p][0];}else{throw new E("NavigationHandler.INVALID_INPUT");}}var D=new S();var n=new S();var b=s.getParameterNames().concat(s.getSelectOptionsPropertyNames());for(var i=0;i<b.length;i++){p=b[i];if(p in a){if(q.inArray(p,d)>-1){n.massAddSelectOption(p,s.getValue(p));D.addSelectOption(p,"I","EQ",a[p]);}else{switch(this.sParamHandlingMode){case sap.ui.generic.app.navigation.service.ParamHandlingMode.SelVarWins:n.massAddSelectOption(p,s.getValue(p));break;case sap.ui.generic.app.navigation.service.ParamHandlingMode.URLParamWins:n.addSelectOption(p,"I","EQ",a[p]);break;case sap.ui.generic.app.navigation.service.ParamHandlingMode.InsertInSelOpt:n.massAddSelectOption(p,s.getValue(p));n.addSelectOption(p,"I","EQ",a[p]);break;default:throw new E("NavigationHandler.INVALID_INPUT");}}}else{if(q.inArray(p,d)>-1){D.massAddSelectOption(p,s.getValue(p));}else{n.massAddSelectOption(p,s.getValue(p));}}}for(p in a){if(q.inArray(p,b)>-1){continue;}if(q.inArray(p,d)>-1){D.addSelectOption(p,"I","EQ",a[p]);}else{n.addSelectOption(p,"I","EQ",a[p]);}}var c=false;if(n.isEmpty()){c=true;var P=D.getSelectOptionsPropertyNames();for(i=0;i<P.length;i++){n.massAddSelectOption(P[i],D.getValue(P[i]));}}return{oNavigationSelVar:n,oDefaultedSelVar:D,bNavSelVarHasDefaultsOnly:c};},storeInnerAppState:function(i,I){if(typeof I!=="boolean"){I=true;}var n=this;var m=q.Deferred();var r=function(A){var s=n.oRouter.oHashChanger.getHash();var c=n._replaceInnerAppStateKey(s,A);n.oRouter.oHashChanger.replaceHash(c);};var a=this._oLastSavedInnerAppData.sAppStateKey;var b=(JSON.stringify(i)===JSON.stringify(this._oLastSavedInnerAppData.oAppData));if(b&&a){this._oLastSavedInnerAppData.iCacheHit++;r(a);m.resolve(a);return m.promise();}this._oLastSavedInnerAppData.iCacheMiss++;var o=function(A){if(!I){r(A);}n._oLastSavedInnerAppData.oAppData=i;n._oLastSavedInnerAppData.sAppStateKey=A;m.resolve(A);};var O=function(e){m.reject(e);};var A=this._saveAppState(i,o,O);if(A!==undefined){if(I){r(A);}}return m.promise();},processBeforeSmartLinkPopoverOpens:function(t,s,i){var m=q.Deferred();var a=t.semanticAttributes;var n=this;var f=function(a,s){s=s||"{}";var b=sap.ui.generic.app.navigation.service.SuppressionBehavior.raiseErrorOnNull|sap.ui.generic.app.navigation.service.SuppressionBehavior.raiseErrorOnUndefined;var M=n.mixAttributesAndSelectionVariant(a,s,b);s=M.toJSONString();a=n._getURLParametersFromSelectionVariant(M);var O=function(A){t.setSemanticAttributes(a);t.setAppStateKey(A);t.open();m.resolve(t);};var c=function(e){m.reject(e);};n._saveAppState({selectionVariant:s},O,c);};if(i){var o=this.storeInnerAppState(i,true);o.done(function(){f(a,s);});o.fail(function(e){m.reject(e);});}else{f(a,s);}return m.promise();},mixAttributesAndSelectionVariant:function(s,a,b){if(b===undefined){b=sap.ui.generic.app.navigation.service.SuppressionBehavior.standard;}var o=new S(a);var n=new S();for(var p in s){if(s.hasOwnProperty(p)){var v=s[p];if(q.type(v)==="array"||q.type(v)==="object"){v=JSON.stringify(v);}else if(q.type(v)==="date"){v=v.toJSON();}else if(q.type(v)==="number"||q.type(v)==="boolean"){v=v.toString();}if(v===""){if(b&sap.ui.generic.app.navigation.service.SuppressionBehavior.ignoreEmptyString){q.sap.log.info("Semantic attribute "+p+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue;}}if(v===null){if(b&sap.ui.generic.app.navigation.service.SuppressionBehavior.raiseErrorOnNull){throw new E("NavigationHandler.INVALID_INPUT");}else{q.sap.log.warning("Semantic attribute "+p+" is null and ignored for mix in to selection variant");continue;}}if(v===undefined){if(b&sap.ui.generic.app.navigation.service.SuppressionBehavior.raiseErrorOnUndefined){throw new E("NavigationHandler.INVALID_INPUT");}else{q.sap.log.warning("Semantic attribute "+p+" is undefined and ignored for mix in to selection variant");continue;}}if(q.type(v)==="string"){n.addSelectOption(p,"I","EQ",v);}else{throw new E("NavigationHandler.INVALID_INPUT");}}}var P=o.getParameterNames();for(var i=0;i<P.length;i++){if(!n.getSelectOption(P[i])){n.addSelectOption(P[i],"I","EQ",o.getParameter(P[i]));}}var c=o.getSelectOptionsPropertyNames();for(i=0;i<c.length;i++){if(!n.getSelectOption(c[i])){var d=o.getSelectOption(c[i]);for(var j=0;j<d.length;j++){n.addSelectOption(c[i],d[j].Sign,d[j].Option,d[j].Low,d[j].High);}}}return n;},_ensureSelectionVariantFormatString:function(s){if(s===undefined){return undefined;}var c=s;if(typeof s==="object"){c=JSON.stringify(s);}return c;},_saveAppState:function(a,o,O){var A=this.oCrossAppNavService.createEmptyAppState(this.oComponent);var s=A.getKey();var b={selectionVariant:{},tableVariantId:"",customData:{}};if(a.selectionVariant){if(typeof a.selectionVariant==="string"){try{b.selectionVariant=JSON.parse(a.selectionVariant);}catch(x){var e=this._createTechnicalError("NavigationHandler.AppStateSave.parseError");if(O){O(e);}return undefined;}}else{b.selectionVariant=a.selectionVariant;}}if(a.tableVariantId){b.tableVariantId=a.tableVariantId;}if(a.customData){b.customData=a.customData;}A.setData(b);var c=A.save();if(o){c.done(function(){o(s);});}if(O){var n=this;c.fail(function(){e=n._createTechnicalError("NavigationHandler.AppStateSave.failed");O(e);});}return s;},_loadAppState:function(a,d){var A=this.oCrossAppNavService.getAppState(this.oComponent,a);var n=this;A.done(function(o){var b={selectionVariant:"{}",tableVariantId:"",customData:{}};var c=o.getData();if(typeof c==="undefined"){var e=n._createTechnicalError("NavigationHandler.getDataFromAppState.failed");d.reject(e,{},sap.ui.generic.app.navigation.service.NavType.iAppState);}else{if(c.selectionVariant){b.selectionVariant=n._ensureSelectionVariantFormatString(c.selectionVariant);}if(c.tableVariantId){b.tableVariantId=c.tableVariantId;}if(c.customData){b.customData=c.customData;}}d.resolve(b,{},sap.ui.generic.app.navigation.service.NavType.iAppState);});A.fail(function(){var e=n._createTechnicalError("NavigationHandler.getAppState.failed");d.reject(e,{},sap.ui.generic.app.navigation.service.NavType.iAppState);});},_getInnerAppStateKey:function(a){if(!a){return undefined;}var m=this._rIAppStateNew.exec(a);if(m===null){m=this._rIAppStateOld.exec(a);}if(m===null){m=this._rIAppStateOldAtStart.exec(a);}if(m===null){return undefined;}return m[1];},_replaceInnerAppStateKey:function(a,A){var n=this.IAPP_STATE+"="+A;if(!a){return"?"+n;}var f=function(a){if(a.indexOf("?")!==-1){return a+"&"+n;}return a+"?"+n;};if(!this._getInnerAppStateKey(a)){return f(a);}if(this._rIAppStateNew.test(a)){return a.replace(this._rIAppStateNew,function(s){return s.replace(/\=.*/ig,"="+A);});}var r=function(b,a){a=a.replace(b,"");return f(a);};if(this._rIAppStateOld.test(a)){return r(this._rIAppStateOld,a);}if(this._rIAppStateOldAtStart.test(a)){return r(this._rIAppStateOldAtStart,a);}return undefined;},_getURLParametersFromSelectionVariant:function(s){var u={};var i=0;if(typeof s==="string"){var o=new S(s);}else if(typeof s==="object"){o=s;}else{throw new E("NavigationHandler.INVALID_INPUT");}var a=o.getSelectOptionsPropertyNames();for(i=0;i<a.length;i++){var b=o.getSelectOption(a[i]);if(b.length===1&&b[0].Sign==="I"&&b[0].Option==="EQ"){u[a[i]]=b[0].Low;}}var p=o.getParameterNames();for(i=0;i<p.length;i++){var P=o.getParameter(p[i]);u[p[i]]=P;}return u;},_createTechnicalError:function(e){return new E(e);}});return N;});
