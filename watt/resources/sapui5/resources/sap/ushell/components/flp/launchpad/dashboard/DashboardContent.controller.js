// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.TileContainer");sap.ui.controller("sap.ushell.components.flp.launchpad.dashboard.DashboardContent",{onInit:function(){var e=sap.ui.getCore().getEventBus();this.handleDashboardScroll=this._handleDashboardScroll.bind(this);e.subscribe('launchpad','actionModeInactive',this._handleExitActionMode,this);e.subscribe('launchpad','actionModeActive',this._enableGroupsUIActions,this.oView);e.subscribe("launchpad","appClosed",this._resizeHandler,this);e.subscribe("launchpad","appOpened",this._appOpenedHandler,this);this.sViewId="#"+this.oView.getId();if(sap.ui.Device.browser.mobile){e.subscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);}this.isDesktop=(sap.ui.Device.system.desktop&&(navigator.userAgent.toLowerCase().indexOf('tablet')<0));},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);e.unsubscribe("launchpad","appClosed",this._resizeHandler,this);e.unsubscribe("launchpad","appOpened",this._appOpenedHandler,this);},onAfterRendering:function(){var e=sap.ui.getCore().getEventBus(),v=this.getView(),d=v.getDomRef(),s=d.getElementsByTagName('section'),t;s[0].removeEventListener('scroll',this.handleDashboardScroll);s[0].addEventListener('scroll',this.handleDashboardScroll);e.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.unsubscribe("launchpad","scrollToFirstVisibleGroup",this._scrollToFirstVisibleGroup,this);e.subscribe("launchpad","scrollToFirstVisibleGroup",this._scrollToFirstVisibleGroup,this);sap.ui.Device.orientation.attachHandler(function(){var j=jQuery('#dashboardGroups').find('.sapUshellTileContainer:visible');if(j.length){var m=this.getView().getModel(),a=m.getProperty('/topGroupInViewPortIndex'),g,i;if(j.get(a)){g=sap.ui.getCore().byId(j.get(a).id);i=m.getProperty('/editTitle');this._publishAsync("launchpad","scrollToGroup",{group:g,isInEditTitle:i});}}},this);jQuery(window).bind("resize",function(){clearTimeout(t);t=setTimeout(this._resizeHandler.bind(this),300);}.bind(this));if(this.getView().getModel().getProperty("/personalization")&&!sap.ushell.components.flp.ActionMode){jQuery.sap.require("sap.ushell.components.flp.ActionMode");sap.ushell.components.flp.ActionMode.init(this.getView().getModel());}this._updateTopGroupInModel();},dashboardTilePress:function(){sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileClick");},_updateTopGroupInModel:function(){var m=this.getView().getModel(),t=this._getIndexOfTopGroupInViewPort();m.setProperty('/topGroupInViewPortIndex',t);},_getIndexOfTopGroupInViewPort:function(){var v=this.getView(),d=v.getDomRef(),s=d.getElementsByTagName('section'),j=$(s).find('.sapUshellTileContainer'),o=j.not('.sapUshellHidden').first().offset(),f=(o&&o.top)||0,t=[],n=s[0].scrollTop,a,b=0;if(!j||!o){return b;}j.each(function(){if(!jQuery(this).hasClass("sapUshellHidden")){var c=jQuery(this).parent().offset().top;t.push([c,c+jQuery(this).parent().height()+jQuery(this).parent()[0].offsetTop]);}});a=n+f;jQuery.each(t,function(i,c){var e=c[0],g=c[1];if(e<=a&&a<=g){b=i;return;}});return b;},_handleDashboardScroll:function(){this._updateTopGroupInModel();sap.ushell.utils.handleTilesVisibility();sap.ui.getCore().getEventBus().publish("launchpad","dashboardScroll");},_handleClick:function(){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}},_handleActionModeStartDrag:function(e,u){this.uiActions.disable();var g=jQuery(".sapUshellDashboardGroupsContainerItem-clone"),a=g.find(".sapUshellContainerTitle"),t=a.height(),b=a.width();if(!sap.ui.Device.system.phone){g.find(".sapUshellTileContainerEditMode").offset({top:this.uiEditModeActions.getMove().y-t,left:this.uiEditModeActions.getMove().x-(b/2)});jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden");}else{jQuery(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");}jQuery(".sapUshellTileContainerAfterContent").addClass("sapUshellTileContainerHidden");jQuery(u).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");this.getModel().setProperty('/isInDrag',true);jQuery(u).attr('startPos',jQuery(u).index());jQuery.sap.log.info('startPos - '+jQuery(u).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");},0);var c=jQuery("#dashboardGroups").offset().top,d=jQuery(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top,f=jQuery(".sapUshellDashboardGroupsContainerItem-clone").offset().top,s=d-c-f;jQuery('.sapUshellDashboardView section').animate({scrollTop:s},0);},_handleActionModeUIStart:function(e,u){jQuery(u).find(".sapUshellTileContainerContent").css("outline-color","transparent");jQuery('body').addClass("sapUshellDisableUserSelect");},_handleActionModeDrop:function(e,u){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}var b=sap.ui.getCore().getEventBus(),q=jQuery(u),f=jQuery(q.children()[0]).attr("id"),g=sap.ui.getCore().byId(f),d=sap.ui.getCore().byId("dashboardGroups"),D={group:g,groupChanged:false,focus:false},n=q.index();q.startPos=window.parseInt(q.attr('startPos'),10);d.removeAggregation('groups',g,true);d.insertAggregation('groups',g,n,true);this.oController._handleActionModeGroupMove(e,{item:q});q.removeAttr('startPos');sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){jQuery(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerAfterContent").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");},0);window.setTimeout(jQuery.proxy(b.publish,b,"launchpad","scrollToGroup",D),1);this.uiActions.enable();},_handleActionModeGroupMove:function(e,u){var f=u.item.startPos,t=u.item.index(),m=this.getView().getModel();if(t!==-1){this._publishAsync("launchpad","moveGroup",{fromIndex:f,toIndex:t});setTimeout(function(){m.setProperty('/isInDrag',false);},100);}},_handleGroupDeletion:function(g){jQuery.sap.require('sap.m.MessageBox');var e=sap.ui.getCore().getEventBus(),G=g.getObject(),i=G.removable,s=G.title,a=G.groupId,r=sap.ushell.resources.i18n,m=sap.ushell.Container.getService("Message"),A=sap.m.MessageBox.Action,c=(i?A.DELETE:r.getText('ResetGroupBtn'));m.confirm(r.getText(i?'delete_group_msg':'reset_group_msg',s),function(o){if(o===c){e.publish("launchpad",i?'deleteGroup':'resetGroup',{groupId:a});}},r.getText(i?'delete_group':'reset_group'),[c,A.CANCEL]);},_enableGroupsUIActions:function(){if(this.uiEditModeActions){this.uiEditModeActions.enable();}},_handleExitActionMode:function(c){this.oView.uiEditModeActions.disable();},_forceBrowserRerenderElement:function(e){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame;if(a){a(function(){var d=e.style.display;e.style.display='none';e.offsetHeight;e.style.display=d;});}else{jQuery.sap.log.info('unsupported browser for animation frame');}},_webkitMobileRenderFix:function(){if(sap.ui.Device.browser.chrome||sap.ui.Device.os.android){this._forceBrowserRerenderElement(document.body);}},_resizeHandler:function(){this._addBottomSpace();sap.ushell.utils.handleTilesVisibility();var n=this.getView().getParent(),c=n&&n.getCurrentPage().getViewName(),i=c==this.getView().getViewName();if(sap.ushell.Layout&&i){sap.ushell.Layout.reRenderGroupsLayout(null,true);}},_appOpenedHandler:function(c,e,d){var p=this.getOwnerComponent(),P=p.getMetadata().getComponentName();if(d.additionalInformation.indexOf(P)===-1){sap.ushell.utils.setTilesNoVisibility();}},_addBottomSpace:function(){sap.ushell.utils.addBottomSpace();},_scrollToFirstVisibleGroup:function(c,e,d){var g,f=0,t=this;if(d.group){g=d.group.getGroupId();}else{g=d.groupId;}if(d.fromTop){f=d.fromTop-50;}jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,G){if(G.getGroupId()===g){var y;y=-1*(document.getElementById('dashboardGroups').getBoundingClientRect().top)+document.getElementById(G.sId).getBoundingClientRect().top;jQuery('.sapUshellDashboardView section').animate({scrollTop:y-f},0,t.fHandleScrollEnd);if(d.group&&d.focus){jQuery.sap.byId(G.sId).focus();}return false;}});sap.ushell.utils.addBottomSpace();},_scrollToGroup:function(c,e,d){var g,t=this,m=this.getView().getModel();if(d.group){g=d.group.getGroupId();}else{g=d.groupId;}m.setProperty("/scrollingToGroup",true);jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,G){if(G.getGroupId()===g){var y;setTimeout(function(){y=-1*(document.getElementById('dashboardGroups').getBoundingClientRect().top)+document.getElementById(G.sId).getBoundingClientRect().top;jQuery('.sapUshellDashboardView section').animate({scrollTop:y},500,t.fHandleScrollEnd);if(d.isInEditTitle){G.setEditMode(true);}},300);if(d.group&&d.focus){jQuery.sap.byId(G.sId).focus();}if(d.groupId||d.groupChanged){t._addBottomSpace();}jQuery('#groupList li').removeClass('sapUshellSelected').eq(n).addClass('sapUshellSelected');sap.ushell.utils.handleTilesVisibility();return false;}});},fHandleScrollEnd:function(){var e=sap.ui.getCore().getEventBus();e.publish("grouplist","ScrollAnimationEnd");},_handleDrop:function(e,u){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}var t=sap.ushell.Layout.getLayoutEngine().layoutEndCallback(),E=sap.ui.getCore().getEventBus(),n,a;if(!t.tileMovedFlag){return;}n=true;a=true;if((t.srcGroup!==t.dstGroup)){n=a=false;}else if(t.tile!==t.dstGroup.getTiles()[t.dstTileIndex]){a=false;}t.srcGroup.removeAggregation('tiles',t.tile,n);t.dstGroup.insertAggregation('tiles',t.tile,t.dstTileIndex,a);E.publish("launchpad","moveTile",{sTileId:t.tile.getUuid(),toGroupId:t.dstGroup.getGroupId(),toIndex:t.dstTileIndex});E.publish("launchpad","sortableStop");},_publishAsync:function(c,e,d){var b=sap.ui.getCore().getEventBus();window.setTimeout(jQuery.proxy(b.publish,b,c,e,d),1);}});}());
