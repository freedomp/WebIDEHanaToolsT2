define("tinymce/pasteplugin/Clipboard",["tinymce/Env","tinymce/dom/RangeUtils","tinymce/util/VK","tinymce/pasteplugin/Utils"],function(E,R,V,U){return function(a){var s=this,p,l,k=0,d=false;var b='%MCEPASTEBIN%',c;var m='data:text/mce-internal,';function f(e){var i,A=a.dom;i=a.fire('BeforePastePreProcess',{content:e});i=a.fire('PastePreProcess',i);e=i.content;if(!i.isDefaultPrevented()){if(a.hasEventListeners('PastePostProcess')&&!i.isDefaultPrevented()){var B=A.add(a.getBody(),'div',{style:'display:none'},e);i=a.fire('PastePostProcess',{node:B});A.remove(B);e=i.node.innerHTML;}if(!i.isDefaultPrevented()){a.insertContent(e,{merge:a.settings.paste_merge_formats!==false,data:{paste:true}});}}}function g(e){e=a.dom.encode(e).replace(/\r\n/g,'\n');var i=a.dom.getParent(a.selection.getStart(),a.dom.isBlock);var A=a.settings.forced_root_block;var B;if(A){B=a.dom.createHTML(A,a.settings.forced_root_block_attrs);B=B.substr(0,B.length-3)+'>';}if((i&&/^(PRE|DIV)$/.test(i.nodeName))||!A){e=U.filter(e,[[/\n/g,"<br>"]]);}else{e=U.filter(e,[[/\n\n/g,"</p>"+B],[/^(.*<\/p>)(<p>)$/,B+'$1'],[/\n/g,"<br />"]]);if(e.indexOf('<p>')!=-1){e=B+e;}}f(e);}function h(){var i=a.dom,A=a.getBody();var B=a.dom.getViewPort(a.getWin()),C=B.y,D=20;var F;l=a.selection.getRng();if(a.inline){F=a.selection.getScrollContainer();if(F&&F.scrollTop>0){C=F.scrollTop;}}function G(e){var J,K,L,I=e.startContainer;J=e.getClientRects();if(J.length){return J[0];}if(!e.collapsed||I.nodeType!=1){return;}L=I.childNodes[l.startOffset];while(L&&L.nodeType==3&&!L.data.length){L=L.nextSibling;}if(!L){return;}if(L.tagName=='BR'){K=i.doc.createTextNode('\uFEFF');L.parentNode.insertBefore(K,L);e=i.createRng();e.setStartBefore(K);e.setEndAfter(K);J=e.getClientRects();i.remove(K);}if(J.length){return J[0];}}if(l.getClientRects){var H=G(l);if(H){D=C+(H.top-i.getPos(A).y);}else{D=C;var I=l.startContainer;if(I){if(I.nodeType==3&&I.parentNode!=A){I=I.parentNode;}if(I.nodeType==1){D=i.getPos(I,F||A).y;}}}}p=i.add(a.getBody(),'div',{id:"mcepastebin",contentEditable:true,"data-mce-bogus":"all",style:'position: absolute; top: '+D+'px;'+'width: 10px; height: 10px; overflow: hidden; opacity: 0'},b);if(E.ie||E.gecko){i.setStyle(p,'left',i.getStyle(A,'direction',true)=='rtl'?0xFFFF:-0xFFFF);}i.bind(p,'beforedeactivate focusin focusout',function(e){e.stopPropagation();});p.focus();a.selection.select(p,true);}function r(){if(p){var e;while((e=a.dom.get('mcepastebin'))){a.dom.remove(e);a.dom.unbind(e);}if(l){a.selection.setRng(l);}}p=l=null;}function j(){var e='',A,i,B,C;A=a.dom.select('div[id=mcepastebin]');for(i=0;i<A.length;i++){B=A[i];if(B.firstChild&&B.firstChild.id=='mcepastebin'){B=B.firstChild;}C=B.innerHTML;if(e!=b){e+=C;}}return e;}function n(e){var i,A,B,C;B=[25942,29554,28521,14958];for(i=0;i<B.length;i++){if(e.charCodeAt(i)!=B[i]){return e;}}A='';for(i=0;i<e.length;i++){C=e.charCodeAt(i);A+=String.fromCharCode((C&0x00FF));A+=String.fromCharCode((C&0xFF00)>>8);}return decodeURIComponent(escape(A));}function o(e){var i,A,B;A='<!--StartFragment-->';i=e.indexOf(A);if(i!==-1){e=e.substr(i+A.length);}B='<!--EndFragment-->';i=e.indexOf(B);if(i!==-1){e=e.substr(0,i);}return e;}function q(e){var A={};if(e){if(e.getData){var B=e.getData('Text');if(B&&B.length>0){if(B.indexOf(m)==-1){A['text/plain']=B;}}}if(e.types){for(var i=0;i<e.types.length;i++){var C=e.types[i],D=e.getData(C);if(C=='text/html'){D=o(n(D));}A[C]=D;}}}return A;}function t(e){return q(e.clipboardData||a.getDoc().dataTransfer);}function u(e,A){var B=e.clipboardData||e.dataTransfer;function C(D){var i,F,G,H=false;function I(G){if(A){a.selection.setRng(A);A=null;}f('<img src="'+G.result+'">');}if(D){for(i=0;i<D.length;i++){F=D[i];if(/^image\/(jpeg|png|gif|bmp)$/.test(F.type)){G=new FileReader();G.onload=I.bind(null,G);G.readAsDataURL(F.getAsFile?F.getAsFile():F);e.preventDefault();H=true;}}}return H;}if(a.settings.paste_data_images&&B){return C(B.items)||C(B.files);}}function v(e){var i=e.clipboardData;return navigator.userAgent.indexOf('Android')!=-1&&i&&i.items&&i.items.length===0;}function w(e){return R.getCaretRangeFromPoint(e.clientX,e.clientY,a.getDoc());}function x(e,i){return i in e&&e[i].length>0;}function y(e){return(V.metaKeyPressed(e)&&e.keyCode==86)||(e.shiftKey&&e.keyCode==45);}function z(){a.on('keydown',function(e){function i(e){if(y(e)&&!e.isDefaultPrevented()){r();}}if(y(e)&&!e.isDefaultPrevented()){c=e.shiftKey&&e.keyCode==86;if(c&&E.webkit&&navigator.userAgent.indexOf('Version/')!=-1){return;}e.stopImmediatePropagation();k=new Date().getTime();if(E.ie&&c){e.preventDefault();a.fire('paste',{ieFake:true});return;}r();h();a.once('keyup',i);a.once('paste',function(){a.off('keyup',i);});}});a.on('paste',function(e){var i=new Date().getTime();var A=t(e);var B=new Date().getTime()-i;var C=(new Date().getTime()-k-B)<1000;var D=s.pasteFormat=="text"||c;c=false;if(e.isDefaultPrevented()||v(e)){r();return;}if(u(e)){r();return;}if(!C){e.preventDefault();}if(E.ie&&(!C||e.ieFake)){h();a.dom.bind(p,'paste',function(e){e.stopPropagation();});a.getDoc().execCommand('Paste',false,null);A["text/html"]=j();}setTimeout(function(){var F;if(x(A,'text/html')){F=A['text/html'];}else{F=j();if(F==b){D=true;}}F=U.trimHtml(F);if(p&&p.firstChild&&p.firstChild.id==='mcepastebin'){D=true;}r();if(!F.length){D=true;}if(D){if(x(A,'text/plain')&&F.indexOf('</p>')==-1){F=A['text/plain'];}else{F=U.innerText(F);}}if(F==b){if(!C){a.windowManager.alert('Please use Ctrl+V/Cmd+V keyboard shortcuts to paste contents.');}return;}if(D){g(F);}else{f(F);}},0);});a.on('dragstart dragend',function(e){d=e.type=='dragstart';});a.on('drop',function(e){var i=w(e);if(e.isDefaultPrevented()||d){return;}if(u(e,i)){return;}if(i&&a.settings.paste_filter_drop!==false){var A=q(e.dataTransfer);var B=A['mce-internal']||A['text/html']||A['text/plain'];if(B){e.preventDefault();a.undoManager.transact(function(){if(A['mce-internal']){a.execCommand('Delete');}a.selection.setRng(i);B=U.trimHtml(B);if(!A['text/html']){g(B);}else{f(B);}});}}});a.on('dragover dragend',function(e){if(a.settings.paste_data_images){e.preventDefault();}});}s.pasteHtml=f;s.pasteText=g;a.on('preInit',function(){z();a.parser.addNodeFilter('img',function(e,A,B){function C(B){return B.data&&B.data.paste===true;}function D(I){if(!I.attr('data-mce-object')&&H!==E.transparentSrc){I.remove();}}function F(H){return H.indexOf("webkit-fake-url")===0;}function G(H){return H.indexOf("data:")===0;}if(!a.settings.paste_data_images&&C(B)){var i=e.length;while(i--){var H=e[i].attributes.map.src;if(!H){continue;}if(F(H)){D(e[i]);}else if(!a.settings.allow_html_data_urls&&G(H)){D(e[i]);}}}});});};});
