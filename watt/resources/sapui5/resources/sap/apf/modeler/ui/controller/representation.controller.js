/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.oViewData=this.getView().getViewData();this.oConfigurationHandler=this.oViewData.oConfigurationHandler;this.oConfigurationEditor=this.oViewData.oConfigurationEditor;this.oTextPool=this.oConfigurationHandler.getTextPool();this.getText=this.oViewData.getText;this.getEntityTypeMetadata=this.oViewData.getEntityTypeMetadata;this.getRepresentationTypes=this.oViewData.getRepresentationTypes;this.mParam=this.oViewData.oParams;var s=this;if(!this.oConfigurationEditor){this.oConfigurationHandler.loadConfiguration(this.mParam.arguments.configId,function(c){s.oConfigurationEditor=c;});}this._addConfigStyleClass();this._setDisplayText();this.setDetailData();this._oPreviewButton=new sap.m.Button({text:this.getText("preview"),press:s._handlePreviewButtonPress.bind(this)});this._insertPreviewButtonInFooter();},_addConfigStyleClass:function(){this.byId("idBasicDataLayout").addStyleClass("basicLayoutData");this.byId("idChartTypeLabel").addStyleClass("chartTypeLabel");this.byId("idSortLayout").addStyleClass("sortLayoutData");this.byId("idChartIcon").addStyleClass("repChartIcon");this.byId("idRightUpper").addStyleClass("repRightCornerText");this.byId("idRightLower").addStyleClass("repRightCornerText");this.byId("idLeftUpper").addStyleClass("repLeftCornerText");this.byId("idLeftLower").addStyleClass("repLeftCornerText");},_setDisplayText:function(){this.byId("idVisualization").setTitle(this.getText("visualization"));this.byId("idChartTypeLabel").setText(this.getText("chartType"));this.byId("idBasicData").setTitle(this.getText("basicData"));this.byId("idSorting").setTitle(this.getText("sorting"));this.byId("idThumbnailTexts").setTitle(this.getText("cornerTextLabel"));this.byId("idLeftUpper").setPlaceholder(this.getText("leftTop"));this.byId("idRightUpper").setPlaceholder(this.getText("rightTop"));this.byId("idLeftLower").setPlaceholder(this.getText("leftBottom"));this.byId("idRightLower").setPlaceholder(this.getText("rightBottom"));},handleChangeForChartType:function(e){var n=e.getParameter("selectedItem").getKey();var p=this.sCurrentChartType;this.sCurrentChartType=n;this._updateAndSetDatasetsByChartType(n);var r=sap.apf.ui.utils.CONSTANTS.representationTypes;var b=r.BAR_CHART;var c=[r.COLUMN_CHART,r.STACKED_COLUMN_CHART,r.PERCENTAGE_STACKED_COLUMN_CHART,r.LINE_CHART];var i=(b===n);this.bIsBarClassType=i;var I=c.indexOf(n)!==-1;var a=(c.indexOf(n)!==-1&&c.indexOf(p)!==-1);if(i||(I&&!a)){this._switchLabelForCharts();}this.oRepresentation.setRepresentationType(n);var A;if(n!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){A=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;}var s=this._getChartPictureDataset().sSelectedChartPicture;this.oRepresentation.setAlternateRepresentationType(A);var R=this.getText(this.oRepresentation.getRepresentationType());var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({name:R,icon:s});}else{this.oViewData.updateTree();}var t=this.getText("representation")+": "+R;this.oViewData.updateTitleAndBreadCrumb(t);this.oConfigurationEditor.setIsUnsaved();},_switchLabelForCharts:function(){var s=this;var b=this.byId("idBasicDataLayout").getItems();var a,k;b.forEach(function(d){a=d.getContent()[0].getBindingContext().getProperty("sAggregationRole");k=d.getContent()[0].getBindingContext().getProperty("sKind");if(a&&k){var t=s._createDimMeasForCharts(a,k);d.getContent()[0].setText(t);}});},_createDimMeasForCharts:function(a,k){var h=sap.apf.core.constants.representationMetadata.kind.XAXIS;var v=sap.apf.core.constants.representationMetadata.kind.YAXIS;if(a==="dimension"&&k===h){k=h;if(this.bIsBarClassType){k=v;}}else if(a==="measure"){k=v;if(this.bIsBarClassType){k=h;}}a=this.getText(a);k=this.getText(k);var t=this.getText("dim-measure-label",[a,k]);return t;},handleChangeForCornerText:function(e){var c=e.getSource();var C=c.getValue();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT;var s=this.oTextPool.setText(C,t);var a=c.getBindingPath('value').replace("/","");var S=["set",a,"CornerTextKey"].join("");this.oRepresentation[S](s);this.oConfigurationEditor.setIsUnsaved();this.mDataset.oCornerTextsDataset[a]=this._getCornerTextsDataset()[a];this.mModel.oCornerTextsModel.updateBindings();},_addAutoCompleteFeatureOnInputs:function(){var s=this;var t=new sap.apf.modeler.ui.utils.TextPoolHelper(this.oTextPool);var d={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT,type:"text"};var c=["idLeftUpper","idRightUpper","idLeftLower","idRightLower"];c.forEach(function(i){var I=s.getView().byId(i);t.setAutoCompleteOn(I,d);});},_bindBasicRepresentationData:function(){var s=this;var b=this.byId("idBasicDataLayout");var p=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),text:{path:"/",formatter:function(){var c=this.getBindingContext().getProperty("sAggregationRole");var k=this.getBindingContext().getProperty("sKind");var C=s.sCurrentChartType;var R=sap.apf.ui.utils.CONSTANTS.representationTypes;var B=[R.BAR_CHART,R.STACKED_BAR_CHART,R.PERCENTAGE_STACKED_BAR_CHART];s.bIsBarClassType=(B.indexOf(C)!==-1);if(c&&k){if(s.bIsBarClassType){return s._createDimMeasForCharts(c,k);}else{c=s.getText(c);k=s.getText(k);return s.getText("dim-measure-label",[c,k]);}}}}});p.addContent(a);var P=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"})},selectedKey:"{sSelectedProperty}",change:s._handleChangeForBasicDataSelectProperty.bind(this)});p.addContent(P);var l=new sap.m.Label({textAlign:"End",width:"100%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),text:{path:"/",formatter:function(){var t;var d,S;var L=this.getBindingContext().getProperty("sLabel");if(this.getParent().getContent()[1].getSelectedItem()){S=this.getParent().getContent()[1].getSelectedItem().getText();}else{S=this.getBindingContext().getProperty("sSelectedProperty");}t=s.getText("label");if(S&&S!==s.getText("none")){d=s.oEntityMetadata.getPropertyMetadata(S).label;if(!L||(L&&d&&(L===d))){t=s.getText("label")+"("+s.getText("default")+")";}}return t;}}}).addStyleClass("repFormRightLabel");p.addContent(l);var i=new sap.m.Input({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),value:{path:"sLabel",formatter:function(){var d,S;if(this.getParent().getContent()[1].getSelectedItem()){S=this.getParent().getContent()[1].getSelectedItem().getText();}else{S=this.getBindingContext().getProperty("sSelectedProperty");}if(S&&S!==s.getText("none")){d=s.oEntityMetadata.getPropertyMetadata(S).label;}var L=this.getBindingContext().getProperty("sLabel");if((S&&S!==s.getText("none")&&!L)||(L&&d&&(L===d))){return d;}else{return L;}}},visible:{path:"sLabel",formatter:function(){if(!this.mEventRegistry.suggest){var t=new sap.apf.modeler.ui.utils.TextPoolHelper(s.oTextPool);var d={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL,type:"text"};t.setAutoCompleteOn(this,d);}return true;}},change:s._handleChangeForBasicDataPropertyRowLabelInput.bind(this)});p.addContent(i);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:s.getText("addButton"),visible:{path:"nMax",formatter:function(n){return(n==="*");}},press:s._handlerForBasicDataAddPropertyRow.bind(this)}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:s.getText("deleteButton"),visible:{path:"/",formatter:function(){var c=true;var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);if(n){var d=s.mDataset.oPropertyDataset.aPropertyRows;var C=d[n].sKind;var e=d[n].sAggregationRole;var f=n-1;var g=d[f].sKind;var h=d[f].sAggregationRole;c=!(C===g&&e===h);}return!c;}},press:s._handlerForBasicDataDeletePropertyRow.bind(this)}).addStyleClass("lessIconRepresentation");var I=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});p.addContent(I);b.bindAggregation("items","/aPropertyRows",function(c){return p.clone(c);});},_handleChangeForBasicDataSelectProperty:function(s){var S=this;var a=s.getSource().getSelectedKey();var l=s.getSource().getParent().getContent()[2];if(a&&(a!==S.getText("none"))){S._setDefaultLabelForSelectedProperty(a,l);}else{l.setText(S.getText("label"));s.getSource().getParent().getContent()[3].setValue("");}S._setPropertiesFromCurrentDataset();S.oConfigurationEditor.setIsUnsaved();},_handleChangeForBasicDataPropertyRowLabelInput:function(i){var p=i.getSource().getBindingContext().getProperty("sSelectedProperty");if(p&&p!==this.getText("none")){this._updatLabelInPropertyRow(p,i.getSource().getValue(),i.getSource().getParent().getContent()[2]);}this._setPropertiesFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handlerForBasicDataAddPropertyRow:function(a){var b=a.getSource().getBindingContext();var c=jQuery.extend(true,{},b.getObject());delete c.sSelectedProperty;delete c.sLabel;var n=parseInt(b.getPath().split("/").pop(),10);var p=this.mDataset.oPropertyDataset.aPropertyRows;p.splice(n+1,0,c);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handlerForBasicDataDeletePropertyRow:function(d){var b=d.getSource().getBindingContext();var n=parseInt(b.getPath().split("/").pop(),10);var p=this.mDataset.oPropertyDataset.aPropertyRows;p.splice(n,1);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_updatLabelInPropertyRow:function(s,l,L){var d=this.oEntityMetadata.getPropertyMetadata(s).label;var a,b;if(d!==l&&l.length!==0){a=this.getText("label");b=l;}else{a=this.getText("label")+"("+this.getText("default")+")";b=d;}this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){if(p.sSelectedProperty===s){p.sLabel=b;}});this.mModel.oPropertyModel.updateBindings();L.setText(a);},_setDefaultLabelForSelectedProperty:function(s,l){var d=this.oEntityMetadata.getPropertyMetadata(s).label;var L=this.getText("label")+"("+this.getText("default")+")";this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){if(p.sSelectedProperty===s){p.sLabel=d;}});this.mModel.oPropertyModel.updateBindings();l.setText(L);},_bindSortLayoutData:function(){var s=this;var S=this.byId("idSortLayout");var o=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),text:this.getText("sortingField")});o.addContent(a);var b=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"})},selectedKey:"{sSortProperty}",change:s._handleChangeForSortDataProperty.bind(this)});o.addContent(b);var d=new sap.m.Label({layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),width:"100%",textAlign:"End",text:this.getText("direction")});o.addContent(d);var D=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),items:[{key:this.getText("ascending"),text:this.getText("ascending")},{key:this.getText("descending"),text:this.getText("descending")}],selectedKey:"{sDirection}",change:s._handleChangeForSortDirection.bind(this)});o.addContent(D);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:this.getText("addButton"),visible:true,press:s._handleChangeForAddSortRow.bind(this)}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:this.getText("deleteButton"),visible:{path:"/",formatter:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);return!!n;}},press:s._handleChangeForDeleteSortRow.bind(this)}).addStyleClass("lessIconRepresentation");var i=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});o.addContent(i);S.bindAggregation("items","/aSortRows",o);},_handleChangeForSortDataProperty:function(){this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForSortDirection:function(s){var S=s.getSource().getBindingContext().getProperty("sSortProperty");if(S!==this.getText("none")){this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();}},_handleChangeForAddSortRow:function(a){var b=a.getSource().getBindingContext();var c=jQuery.extend(true,{},b.getObject());delete c.sSortProperty;delete c.sDirection;var n=parseInt(b.getPath().split("/").pop(),10);var s=this.mDataset.oSortDataset.aSortRows;s.splice(n+1,0,c);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForDeleteSortRow:function(d){var b=d.getSource().getBindingContext();var n=parseInt(b.getPath().split("/").pop(),10);var s=this.mDataset.oSortDataset.aSortRows;s.splice(n,1);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_validateRepresentationData:function(){var s=this;var d=this.oRepresentation.getDimensions().map(function(a){return{sType:"Dimension",sName:a};});var m=this.oRepresentation.getMeasures().map(function(a){return{sType:"Measure",sName:a};});var r=d.concat(m);r.forEach(function(a){var p=false;s.aSelectProperties.forEach(function(b){if(a.sName===b.sName){p=true;}});if(p===false){var R=["remove",a.sType].join("");s.oRepresentation[R](a.sName);s.oConfigurationEditor.setIsUnsaved();}});},setDetailData:function(){var c=this.mParam.arguments;this.oParentStep=this.oConfigurationEditor.getStep(c.stepId);this.oEntityMetadata=this.getEntityTypeMetadata(this.oParentStep.getService(),this.oParentStep.getEntitySet());this.aSelectProperties=this._getSelectPropertiesFromParentStep();this.oRepresentation=this.oParentStep.getRepresentation(c.representationId);if(!this.oRepresentation){this.oRepresentation=this.oParentStep.createRepresentation();this._setDefaultRepresentationType();this._setDefaultProperties();this.oConfigurationEditor.setIsUnsaved();}this._validateRepresentationData();var C=this._getChartTypeDataset();var p=this._getPropertyDataset();var s=this._getSortDataset();var o=this._getCornerTextsDataset();var a=this._getChartPictureDataset();this.mDataset={oChartTypeDataset:C,oPropertyDataset:p,oSortDataset:s,oCornerTextsDataset:o,oChartPictureDataset:a};var b=new sap.ui.model.json.JSONModel(this.mDataset.oChartTypeDataset);var P=new sap.ui.model.json.JSONModel(this.mDataset.oPropertyDataset);var S=new sap.ui.model.json.JSONModel(this.mDataset.oSortDataset);var d=new sap.ui.model.json.JSONModel(this.mDataset.oCornerTextsDataset);var e=new sap.ui.model.json.JSONModel(this.mDataset.oChartPictureDataset);this.mModel={oChartTypeModel:b,oPropertyModel:P,oSortModel:S,oCornerTextsModel:d,oChartPictureModel:e};this.byId("idChartType").setModel(this.mModel.oChartTypeModel);var f=this.sCurrentChartType;this._updateAndSetDatasetsByChartType(f);this.byId("idBasicDataLayout").setModel(this.mModel.oPropertyModel);this._bindBasicRepresentationData();this.byId("idSortLayout").setModel(this.mModel.oSortModel);this._bindSortLayoutData();this.byId("idLeftLower").setModel(this.mModel.oCornerTextsModel);this.byId("idRightLower").setModel(this.mModel.oCornerTextsModel);this.byId("idLeftUpper").setModel(this.mModel.oCornerTextsModel);this.byId("idRightUpper").setModel(this.mModel.oCornerTextsModel);this.byId("idChartIcon").setModel(this.mModel.oChartPictureModel);this._addAutoCompleteFeatureOnInputs();},_insertPreviewButtonInFooter:function(){var f=this.oViewData.oFooter;f.addContentRight(this._oPreviewButton);},_removePreviewButtonFromFooter:function(){var f=this.oViewData.oFooter;f.removeContentRight(this._oPreviewButton);},_handlePreviewButtonPress:function(){var p=this._getPreviewDetails();var P=new sap.ui.view({type:sap.ui.core.mvc.ViewType.XML,viewName:"sap.apf.modeler.ui.view.previewContent",viewData:p});var o=new sap.m.Dialog({title:this.getText("preview"),content:P,endButton:new sap.m.Button({text:this.getText("close"),press:function(){o.close();}})});o.open();},onExit:function(){this._removePreviewButtonFromFooter();},_getPreviewDetails:function(){var s=this;var c=this.mDataset.oChartTypeDataset.sSelectedChartType;var S=this._getParentStepTitle();var a=this._getParentStepLongTitle()||S;var d=[],m=[];this.aSelectProperties.forEach(function(o){if(o.sAggregationRole==="dimension"){d.push(o.sName);}else if(o.sAggregationRole==="measure"){m.push(o.sName);}});var C={dimensions:[],measures:[]};this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){if(p.sSelectedProperty!==s.getText("none")){var A=p.sAggregationRole+"s";C[A].push({fieldDesc:p.sLabel,fieldName:p.sSelectedProperty,kind:p.sKind});}});var b=[];this.mDataset.oSortDataset.aSortRows.forEach(function(o){var f=o.sSortProperty||(o.aAllProperties.length&&o.aAllProperties[0].sName);if(f&&f!==s.getText("none")){var A=!o.sDirection||(o.sDirection===s.getText("ascending"));b.push({sSortField:f,bDescending:!A});}});var e={sLeftUpper:this.mDataset.oCornerTextsDataset.LeftUpper,sRightUpper:this.mDataset.oCornerTextsDataset.RightUpper,sLeftLower:this.mDataset.oCornerTextsDataset.LeftLower,sRightLower:this.mDataset.oCornerTextsDataset.RightLower};return{sChartType:c,sStepTitle:S,sStepLongTitle:a,aDimensions:d,aMeasures:m,oChartParameter:C,aSort:b,aCornerTexts:e};},_getParentStepLongTitle:function(){var s=this.oParentStep.getLongTitleId();s=!this.oTextPool.isInitialTextKey(s)?s:undefined;var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getParentStepTitle:function(){var s=this.oParentStep.getTitleId();var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getSelectPropertiesFromParentStep:function(){var a=this.oParentStep.getService();var e=this.oParentStep.getEntitySet();var E=this.getEntityTypeMetadata(a,e);var s=this.oParentStep.getSelectProperties();var r=s.map(function(p){var m=E.getPropertyMetadata(p);return{sName:p,sAggregationRole:m["aggregation-role"],sLabel:m["label"]};});return r;},_getCornerTextsFromConfigObject:function(c){var s=this;var C=["LeftUpper","RightUpper","LeftLower","RightLower"];var d={};C.forEach(function(a){var m=["get",a,"CornerTextKey"].join("");var b=c[m]();var o=b&&s.oTextPool.get(b);var e=o&&o.TextElementDescription;d[a]=e;});return d;},_getChartTypeDataset:function(){var s=this;var k=Object.keys(this._getRepresentationMetadata());var c=k.map(function(K){return{sId:K,sText:s.getText(K)};});var d={aChartTypes:c,sSelectedChartType:this.oRepresentation.getRepresentationType()};this.sCurrentChartType=d.sSelectedChartType;return d;},_getChartPictureDataset:function(){var r=this.getRepresentationTypes();var d={};r.forEach(function(o){var i=o.id;d[i]=o.picture;});d.sSelectedChartPicture=d[this.oRepresentation.getRepresentationType()];return d;},_updatePictureDataset:function(c){var d=this.mModel.oChartPictureModel.getData();d.sSelectedChartPicture=d[c];},_getPropertyDataset:function(){var s=this;var p=[];var a=function(t){var g=["get",t,"s"].join("");var P=s.oRepresentation[g]();P.forEach(function(b){var l=["get",t,"TextLabelKey"].join("");var L=s.oRepresentation[l](b);var o=L&&s.oTextPool.get(L);var c=o&&o.TextElementDescription;if(c===undefined||c.length===0){c=s.oEntityMetadata.getPropertyMetadata(b).label;}var k=["get",t,"Kind"].join("");var K=s.oRepresentation[k](b);var C=s.oRepresentation.getRepresentationType();var r=s._getRepresentationMetadata()[C];var S=r[t.toLowerCase()+"s"].supportedKinds;var n,d;S.forEach(function(e){if(e.kind===K){n=e.min;d=e.max;}});p.push({sSelectedProperty:b,sAggregationRole:t.toLowerCase(),sLabel:c,sKind:K,nMin:n,nMax:d});});};a("Dimension");a("Measure");return{aPropertyRows:p};},_getSortDataset:function(){var s=this;var o=this.oRepresentation.getOrderbySpecifications();var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});if(!o.length){o.push({});}var S=o.map(function(O){var b=O.property;var c=O.ascending!==undefined&&!O.ascending?s.getText("descending"):s.getText("ascending");return{sSortProperty:b,sDirection:c,aAllProperties:a};});return{aSortRows:S};},_getCornerTextsDataset:function(){var r=this._getCornerTextsFromConfigObject(this.oRepresentation);var p=this._getCornerTextsFromConfigObject(this.oParentStep);var d=jQuery.extend({},p,r);return d;},_setDefaultRepresentationType:function(){var d;if(this.getRepresentationTypes()[0].metadata){d=this.getRepresentationTypes()[0].id;}this.oRepresentation.setRepresentationType(d);this.oRepresentation.setAlternateRepresentationType(sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION);var r=this.getText(this.oRepresentation.getRepresentationType());var s=this._getChartPictureDataset().sSelectedChartPicture;var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({id:this.oRepresentation.getId(),icon:s});}else{var R=[];var a=jQuery.extend(true,{},this.mParam);var o={id:this.oRepresentation.getId(),aStepCategories:S,stepContext:a};this.oViewData.updateTree();}},_setDefaultProperties:function(){var f,F;this.aSelectProperties.forEach(function(s){if(!f){if(s.sAggregationRole==="dimension"){f=s.sName;}}if(!F){if(s.sAggregationRole==="measure"){F=s.sName;}}});if(f){this.oRepresentation.addDimension(f);this.oRepresentation.setDimensionKind(f,sap.apf.core.constants.representationMetadata.kind.XAXIS);}if(F){this.oRepresentation.addMeasure(F);this.oRepresentation.setMeasureKind(F,sap.apf.core.constants.representationMetadata.kind.YAXIS);}},_updateAndSetDatasetsByChartType:function(c){this._updatePropertyDatasetByChartType(c);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this._updateSortDatasetByChartType(c);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this._updatePictureDataset(c);this.mModel.oChartPictureModel.updateBindings();},_updatePropertyDatasetByChartType:function(c){var s=this;var d={aPropertyRows:[]};var r=this._getRepresentationMetadata()[c];var a=["dimensions","measures"];a.forEach(function(A){if(r.hasOwnProperty(A)){var S=r[A].supportedKinds;var b;S.forEach(function(o){var p={sAggregationRole:A.slice(0,-1),sKind:o.kind,nMin:o.min,nMax:o.max,aAllProperties:s.aSelectProperties.filter(function(P){return(P.sAggregationRole===(A.slice(0,-1)));})};if(!parseInt(o.min,10)){p.aAllProperties.unshift({sName:s.getText("none"),sAggregationRole:A.slice(0,-1)});}p.aAllProperties.forEach(function(e){b=e.sName;if(b){var t=A.slice(0,-1);var f=[t.charAt(0).toUpperCase(),t.substring(1)].join("");var l=["get",f,"TextLabelKey"].join("");var L=s.oRepresentation[l](b);var g=L&&s.oTextPool.get(L);var h=g&&g.TextElementDescription;if(h){e.sLabel=h;}else{if(b!==s.getText("none")){var D=s.oEntityMetadata.getPropertyMetadata(b).label;if(D){e.sLabel=D;}}}}});d.aPropertyRows.push(p);});}});var R={aPropertyRows:[]};d.aPropertyRows.forEach(function(D){var e=false;s.mDataset.oPropertyDataset.aPropertyRows.forEach(function(E){var h=E.sAggregationRole===D.sAggregationRole;var H=E.sKind===D.sKind;var b=E.nMin===D.nMin;var f=E.nMax===D.nMax;if(h&&H&&b&&f){e=true;var C=jQuery.extend(E,D);R.aPropertyRows.push(C);}});if(!e){R.aPropertyRows.push(D);}});this.mDataset.oPropertyDataset.aPropertyRows=R.aPropertyRows;},_updateSortDatasetByChartType:function(c){var r=this._getRepresentationMetadata()[c];if(r.sortable!==undefined&&!r.sortable){var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});this.mDataset.oSortDataset.aSortRows=[{aAllProperties:a,sDirection:this.getText("ascending")}];this.byId("idSortLayout").setVisible(false);this.byId("idSorting").setVisible(false);}else{this.byId("idSortLayout").setVisible(true);this.byId("idSorting").setVisible(true);this.mModel.oSortModel.updateBindings();var s=this.byId("idSortLayout");jQuery.sap.delayedCall(10,s,s.rerender);}},_setPropertiesFromCurrentDataset:function(){var s=this;var d=this.oRepresentation.getDimensions();d.forEach(function(D){s.oRepresentation.removeDimension(D);});var m=this.oRepresentation.getMeasures();m.forEach(function(M){s.oRepresentation.removeMeasure(M);});this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){var S=p.sSelectedProperty||(p.aAllProperties.length&&p.aAllProperties[0].sName);if(S&&S!==s.getText("none")){var a=p.sAggregationRole;var A=[a.charAt(0).toUpperCase(),a.substring(1)].join("");var D=s.oEntityMetadata.getPropertyMetadata(S).label;var l=p.sLabel;var L;if(l&&l!==D){var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;L=s.oTextPool.setText(l,t);}var b=["add",A].join("");var c=["set",A,"Kind"].join("");var e=["set",A,"TextLabelKey"].join("");s.oRepresentation[b](S);s.oRepresentation[c](S,p.sKind);s.oRepresentation[e](S,L);}else{p.sLabel="";p.sSelectedProperty=s.getText("none");}});},_setSortFieldsFromCurrentDataset:function(){var s=this;this.oRepresentation.getOrderbySpecifications().forEach(function(o){s.oRepresentation.removeOrderbySpec(o.property);});this.mDataset.oSortDataset.aSortRows.forEach(function(S){var a=S.sSortProperty||(S.aAllProperties.length&&S.aAllProperties[0].sName);if(a&&a!==s.getText("none")){var A=!S.sDirection||(S.sDirection===s.getText("ascending"));s.oRepresentation.addOrderbySpec(a,A);}});},_getRepresentationMetadata:function(){var r={};this.getRepresentationTypes().forEach(function(a){if(a.metadata){r[a.id]=a.metadata;}});return r;}});
