// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var S="sap.ushell.services.Container",a="sap.ushell.Container.dirtyState.",b="sap-ushell-plugin-type",c="UserDefaults",C,p,u,f;jQuery.sap.declare(S);jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.System");sap.ushell.utils.testPublishAt(sap.ushell.services);function d(){close();}sap.ushell.utils.testPublishAt(sap.ushell.services);function r(){document.location="about:blank";}sap.ushell.utils.testPublishAt(sap.ushell.services);function g(){return localStorage;}function h(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function j(s){return(C.services&&C.services[s])||{};}function k(n,s,P){var A=j(n).adapter||{},e=A.module||h(s.getPlatform())+"."+n+"Adapter";jQuery.sap.require(e);return new(jQuery.sap.getObject(e))(s,P,{config:A.config||{}});}function l(o){var P=o.bootstrapPlugins,i={},U=[];function I(C,D){var e={name:C.component,url:C.url,componentData:{config:C.config||{}},async:true};if(C.hasOwnProperty("asyncHints")){if(jQuery.isPlainObject(C.asyncHints)){e.asyncHints=C.asyncHints;}else{jQuery.sap.log.error("Cannot pass asyncHints to plugin component: "+C.component,"The value of 'asyncHint' must be an object in the plugin configuration",S);}}return sap.ui.component(e).then(function(){if(D){D.resolve();}},function(E){E=E||"";jQuery.sap.log.error("Cannot create UI5 plugin component: "+E,E.stack,S);if(D){D.reject(E);}});}if(P){Object.keys(P).forEach(function(s){var e=P[s],n,q,t;try{if(e.hasOwnProperty("component")){t=e.component;n=e.config||{};if(n.hasOwnProperty(b)&&n[b]===c){q=new jQuery.Deferred();U.push(q.promise());}if(i.hasOwnProperty(t)){i[t].then(function(){I(e,q);},function(){I(e,q);});}else{i[t]=I(e,q);}}else if(e.hasOwnProperty("module")){jQuery.sap.require(e.module);}else{jQuery.sap.log.error("Invalid plugin configuration",["the plugin configuration for",s,"must contain <component> OR <module> keys"].join(" "),S);}}catch(E){jQuery.sap.log.error(["Error while loading bootstrap plugin:",s].join(" "),E,S);if(q){q.reject(E);}}});jQuery.when.apply(undefined,U).done(u.resolve.bind()).fail(u.reject.bind());}else{u.resolve();}}function m(A){var L=new sap.ui.base.EventProvider(),n=false,R=[],o={},s="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",q={},G,t,v=g(),w=new sap.ushell.utils.Map(),x="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",y=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelXHRLogon();}};this.createRenderer=function(e){var i,D,E,F;e=e||C.defaultRenderer;if(!e){throw new Error("Missing renderer name");}F=(C.renderers&&C.renderers[e])||{};D=F.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);jQuery.sap.require(D);if(F.componentData&&F.componentData.config){i={config:F.componentData.config};}E=new(jQuery.sap.getObject(D))({componentData:i});if(E instanceof sap.ui.core.UIComponent){E=new sap.ui.core.ComponentContainer({component:E,height:"100%",width:"100%"});}if(!(E instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+e);}o[e]=E;return E;};this.getRenderer=function(e){e=e||C.defaultRenderer;if(o[e]){return o[e].getComponentInstance();}return undefined;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,D=new jQuery.Deferred(),U=jQuery.sap.uid(),E,P=0,F=this.DirtyState.CLEAN;function H(){if(P===0||F===y.DirtyState.DIRTY){D.resolve(F);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+F,null,"sap.ushell.Container");}}function I(J){if(J.key.indexOf(a)===0&&J.newValue!==y.DirtyState.INITIAL&&J.newValue!==y.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+J.key+" value: "+J.newValue,null,"sap.ushell.Container");if(J.newValue===y.DirtyState.DIRTY||J.newValue===y.DirtyState.MAYBE_DIRTY){F=J.newValue;}P-=1;H();}}try{v.setItem(U,"CHECK");v.removeItem(U);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return D.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=D;window.addEventListener('storage',I);D.always(function(){window.removeEventListener('storage',I);G=undefined;});for(i=v.length-1;i>=0;i-=1){E=v.key(i);if(E.indexOf(a)===0){if(v.getItem(E)==='PENDING'){v.removeItem(E);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+E,null,"sap.ushell.Container");}else{P+=1;sap.ushell.utils.localStorageSetItem(E,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+E,null,"sap.ushell.Container");}}}H();setTimeout(function(){if(D.state()!=="resolved"){D.resolve('MAYBE_DIRTY');jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return D.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){n=n||R[i].call();}return n;};this.setDirtyFlag=function(i){n=i;};this.registerDirtyStateProvider=function(D){if(typeof D!=="function"){throw new Error("fnDirty must be a function");}R.push(D);};this.getService=function(e,P){var i={},M,K,D,E,F,H,I;function J(N){var O=new jQuery.Deferred();if(!N){throw new Error("Missing system");}O.resolve(k(e,N,P));sap.ushell.Container.addRemoteSystem(N);return O.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}H=j(e);M=H.module||"sap.ushell.services."+e;K=M+"/"+(P||"");I={config:H.config||{}};if(!w.containsKey(K)){jQuery.sap.require(M);D=jQuery.sap.getObject(M);if(D.hasNoAdapter===true){E=new D(i,P,I);}else{F=k(e,A.getSystem(),P);i.createAdapter=J;E=new D(F,i,P,I);}w.put(K,E);return E;}return w.get(K);};sap.ushell.utils.testPublishAt(y);function z(){var D,E,i,K;for(i=v.length-1;i>=0;i-=1){K=v.key(i);if(K.indexOf(s)===0){try{D=K.substring(s.length);E=JSON.parse(v.getItem(K));q[D]=new sap.ushell.System(E);}catch(e){v.removeItem(K);}}}return q;}sap.ushell.utils.testPublishAt(y,"suppressOData");function B(){function e(E,i,F){jQuery.sap.log.warning(E,null,"sap.ushell.Container");if(F){setTimeout(F.bind(null,E),5000);}return{abort:function(){return;}};}OData.read=function(i,D,F){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",D,F);};OData.request=function(i,D,F){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",D,F);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=q[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}q[i]=e;sap.ushell.utils.localStorageSetItem(s+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=='/'||e.indexOf('//')===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new sap.ushell.System(i));}};this.attachLogoutEvent=function(F){L.attachEvent("Logout",F);};this.detachLogoutEvent=function(F){L.detachEvent("Logout",F);};this.logout=function(){var D=new jQuery.Deferred();function i(){A.logout(true).always(function(){v.removeItem(x);D.resolve();});}function E(){if(L.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}function F(){var q,H=[];if(t){window.removeEventListener('storage',t);}sap.ushell.utils.localStorageSetItem(x,"pending");B();q=z();Object.keys(q).forEach(function(I){try{H.push(k("Container",q[I]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+I,e.toString(),"sap.ushell.Container");}v.removeItem(s+I);});jQuery.when.apply(jQuery,H).done(E);}if(typeof A.addFurtherRemoteSystems==='function'){A.addFurtherRemoteSystems().always(F);}else{F();}return D.promise();};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.setLogonFrameProvider(e);}};this.getUserDefaultPluginsPromise=function(){return u.promise();};u=new jQuery.Deferred();sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,E,D){y.addRemoteSystemForServiceUrl(D);});if(typeof A.logoutRedirect==='function'){t=function(e){function i(){d();r();}if(sap.ushell.Container!==y){return;}if(e.key.indexOf(s)===0&&e.newValue&&e.newValue!==v.getItem(e.key)){sap.ushell.utils.localStorageSetItem(e.key,e.newValue);}if(e.key===x){if(e.newValue==="pending"){B();if(L.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener('storage',t);}}sap.ushell.bootstrap=function(P,A){var o,e;if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+f);jQuery.sap.log.error(e,e.stack,S);throw e;}sap.ushell.Container=null;f=(new Error()).stack;C=JSON.parse(JSON.stringify(window["sap-ushell-config"]||{}));p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(C.modulePaths){Object.keys(C.modulePaths).forEach(function(M){jQuery.sap.registerModulePath(M,C.modulePaths[M]);});}o=k("Container",new sap.ushell.System({alias:"",platform:C.platform||P}));return o.load().done(function(){sap.ushell.Container=new m(o);l(C);});};}());
