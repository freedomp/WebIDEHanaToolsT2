/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.utils.print");jQuery.sap.require("sap.apf.ui.utils.formatter");
sap.apf.ui.utils.PrintHelper=function(I){"use strict";var c=I.oCoreApi;var u=I.uiApi;var f=I.oFilterIdHandler;var n,C,a;this.oPrintLayout={};function _(){n++;if(a===n){C.resolve();}}function b(o){if(!jQuery.isEmptyObject(o.oPrintLayout)){o.oPrintLayout.removeContent();}jQuery('#apfPrintArea').remove();jQuery("body").append('<div id="apfPrintArea"></div>');u.createApplicationLayout(false).setBusy(true);}function d(A){var s;a=0;n=0;A.forEach(function(S){s=S.getSelectedRepresentation();s=s.bIsAlternateView?s.toggleInstance:s;if(s.type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){a++;}});}function e(){var i=new Date();var A=c.getApplicationConfigProperties().appName;var s=u.getAnalysisPath().oSavedPathName.getTitle();var j=new sap.ui.core.HTML({id:'idAPFHeaderForFirstPage',content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+c.getTextHtmlEncoded(A)+' : '+jQuery.sap.encodeHTML(s)+'</p>','<p class="printHeaderDate"> '+i.toTimeString()+' </p></div><div class="clear"></div>'].join(""),sanitizeContent:true});return j;}function g(){var i,j,m,F,A,o,p,q,r,s,t,S,v;var w=[],x=[],y="",z="",B=[],D=[],E=[],G=[],H={};var J=u.getEventCallback(sap.apf.core.constants.eventTypes.printTriggered);var K={getTextNotHtmlEncoded:c.getTextNotHtmlEncoded};var L=f.getAllInternalIds();if(L.length>0){for(i=0;i<L.length;i++){A=f.get(L[i]).getExpressions();w.push(A[0]);}}function M(){function O(P){z="";D=[];s=new sap.apf.ui.utils.formatter({getEventCallback:u.getEventCallback.bind(u),getTextNotHtmlEncoded:c.getTextNotHtmlEncoded},P);z=P.label;D.push(s.getFormattedValue(P.name,w[i][j].value));}for(i=0;i<w.length;i++){for(j=0;j<w[i].length;j++){r=w[i][j];c.getMetadataFacade().getProperty(w[i][j].name,O);r["sName"]=z;r["value"]=D;x.push(r);}}return x;}if(J!==undefined){E=J.apply(K,w)||[];E=(E.length>0)?E:M();}else{E=M();}t=u.getFacetFilterForPrint();function N(S){B=[];S.forEach(function(O){B.push(O.getText());});}if(t){F=t.getLists();for(m=0;m<F.length;m++){S=[];H={};H.sName=F[m].getTitle();if(!F[m].getSelectedItems().length){S=F[m].getItems();}else{S=F[m].getSelectedItems();}N(S);H.value=B;G.push(H);}}q=E.length>0?E.concat(G):G;v=new sap.ui.layout.VerticalLayout({id:'idAPFFacetAndFooterLayout'});for(i=0;i<q.length;i++){z=q[i].sName;for(j=0;j<q[i].value.length;j++){if(j!==q[i].value.length-1){y+=q[i].value[j]+", ";}else{y+=q[i].value[j];}}o=new sap.m.Text({text:z}).addStyleClass("printFilterName");p=new sap.m.Text({text:y}).addStyleClass("printFilterValue");v.addContent(o);v.addContent(p);y="";}return v;}function h(i,j){var m;var o=new Date();var A=c.getApplicationConfigProperties().appName;var s=u.getAnalysisPath().oSavedPathName.getTitle();if(!A){m=c.createMessageObject({code:"6003",aParameters:["sAppName"]});c.putMessage(m);}var p=new sap.ui.core.HTML({id:'idAPFHeaderForEachStep'+i,content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+c.getTextHtmlEncoded(A)+' : '+jQuery.sap.encodeHTML(s)+'</p>','<p class="printHeaderDate"> '+o.toTimeString()+' </p></div><div class="clear"></div>','<div class="printChipName"><p>'+c.getTextHtmlEncoded("print-step-number",[i,j])+'</p></div>'].join(""),sanitizeContent:true});return p;}function k(s){var i,m,p,j=false,r={};var S=c.getTextNotHtmlEncoded(s.title);var o=s.getSelectedRepresentation();var q=o.bIsAlternateView?o.toggleInstance:o;if(o.bIsAlternateView){i=s.getSelectedRepresentation().getData();m=s.getSelectedRepresentation().getMetaData();q.setData(i,m);}if(q.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){r=q.getPrintContent(S);r.setWidth("1000px");}else{p=q.getPrintContent(S);r=p.oChartForPrinting;if(r.vizSelection){r.attachEventOnce("renderComplete",function(){r.vizSelection(p.aSelectionOnChart);_();});}else{r.attachInitialized(function(){r.selection(p.aSelectionOnChart);_();});}}if(q.bIsLegendVisible===undefined||q.bIsLegendVisible===true){j=true;}if(r.setVizProperties){r.setVizProperties({legend:{visible:j},sizeLegend:{visible:j}});}else{if(r.setLegend!==undefined){r.setLegend(new sap.viz.ui5.types.legend.Common({visible:j}));}if(r.setSizeLegend!==undefined){r.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:j}));}}return r;}function l(s,i,j){var S;var o=new sap.ui.layout.VerticalLayout({id:'idAPFChartLayout'+i});o.addContent(k(s));S=new sap.ui.layout.VerticalLayout({id:'idAPFStepLayout'+i,content:[h(i,j),o]}).addStyleClass("representationContent");return S;}this.doPrint=function(){var i,j,m,o,p,t,s,S,P;var q="",r=2000,v=this;var A=c.getSteps();this.oPrintLayout=new sap.ui.layout.VerticalLayout({id:"idAPFPrintLayout"});b(this);C=new jQuery.Deferred();d(A);if(a===0){C.resolve();}P=new sap.ui.layout.VerticalLayout({id:'idAPFPrintFirstPageLayout',content:[e(),g()]}).addStyleClass("representationContent");this.oPrintLayout.addContent(P);for(j=0;j<A.length;j++){m=parseInt(j,10)+1;this.oPrintLayout.addContent(l(A[j],m,A.length));}this.oPrintLayout.placeAt("apfPrintArea");if(jQuery(".v-geo-container").length){r=4000;}window.setTimeout(function(){u.createApplicationLayout(false).setBusy(false);},r-150);window.setTimeout(function(){jQuery("#"+v.oPrintLayout.sId+" > div").after("<div class='page-break'> </div>");q=v.oPrintLayout.getDomRef();t=jQuery('#apfPrintArea .sapUiTable');if(t.length){p=jQuery('#apfPrintArea .printTable .sapMListTblHeader .sapMListTblCell').length;if(p>11){jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode' > @media print and (min-resolution: 300dpi) { @page {size : landscape;}}</style>").appendTo("head");}else{jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode'>@media print and (min-resolution: 300dpi) { @page {size : portrait;}}</style>").appendTo("head");}}jQuery("#apfPrintArea").empty();jQuery("#sap-ui-static > div").hide();jQuery("#apfPrintArea").append(jQuery(q).html());for(i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=true;}C.then(function(){window.print();});window.setTimeout(function(){for(i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=false;}for(s=0;s<A.length;s++){S=A[s].getSelectedRepresentation();S=S.bIsAlternateView?S.toggleInstance:S;if(S.type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){o=v.oPrintLayout.getContent()[s+1].getContent()[1].getContent()[0];o.destroy();o=null;}}v.oPrintLayout.destroy();v.oPrintLayout=null;},10);},r);};};
