(function(){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.SearchTabStripsFormatter');var m=sap.ushell.renderers.fiori2.search.SearchTabStripsFormatter={};m.Node=function(){this.init.apply(this,arguments);};m.Node.prototype={init:function(d,c){this.dataSource=d;this.children=[];this.parent=null;this.count=c;},_arraysEqual:function(a,b){if(a===b){return true;}if(a==null||b==null){return false;}if(a.length!=b.length){return false;}for(var i=0;i<a.length;++i){if(a[i]!==b[i]){return false;}}return true;},equals:function(o){var p=false;var e=this.dataSource.equals(o.dataSource)&&this.count===o.count&&this._arraysEqual(this.children,o.children);if(this.parent){if(o.parent){p=this.parent.equals(o.parent);}else{p=false;}}else{if(o.parent){p=false;}else{p=true;}}return e&&p;},setCount:function(c){this.count=c;},childrenHaveUpToDateCount:function(){for(var i=0;i<this.children.length;++i){var c=this.children[i];if(c.count===null){return false;}}return true;},invalidateCount:function(){this.count=null;for(var i=0;i<this.children.length;++i){var c=this.children[i];c.invalidateCount();}},getChildrenSortedByCount:function(){if(!this.childrenHaveUpToDateCount()){throw'Count invalidated - cannot sort';}var c=this.children.slice();c.sort(function(a,b){return b.count-a.count;});return c;},clearChildren:function(){this.children=[];},appendNode:function(n){n.parent=this;this.children.push(n);},removeChildNode:function(n){var i=this.children.indexOf(n);if(i<0){return;}this.children.splice(i,1);},findNode:function(d,r){if(this.dataSource.equals(d)){r.push(this);return;}for(var i=0;i<this.children.length;++i){var c=this.children[i];c.findNode(d,r);if(r.length>0){return;}}},hasChild:function(n){for(var i=0;i<this.children.length;++i){var c=this.children[i];if(c===n){return true;}}return false;},hasSibling:function(n){if(this.equals(n)){return false;}if(!this.parent){return null;}for(var i=0;i<this.parent.children.length;++i){var c=this.parent.children[i];if(c===n){return true;}}return false;},getLevel1Node:function(){if(!this.parent){return null;}if(this.parent.dataSource.key&&this.parent.dataSource.key.indexOf('$$ALL$$')>-1){return this;}return this.parent.getLevel1Node();}};m.Tree=function(){this.init.apply(this,arguments);};m.Tree.prototype={init:function(){this.rootNode=null;},findNode:function(d){if(!this.rootNode){return null;}var r=[];this.rootNode.findNode(d,r);return r.length>0?r[0]:null;},hasChild:function(d,a){if(a&&a.key&&a.key.indexOf('$$ALL$$')>-1){return false;}var n=this.findNode(d);if(!n){return false;}var b=this.findNode(a);if(!b){return false;}return n.hasChild(b);},hasSibling:function(d,a){if(a&&a.key&&a.key.indexOf('$$ALL$$')>-1){return false;}var n=this.findNode(d);if(!n){return false;}var b=this.findNode(a);if(!b){return false;}return n.hasSibling(b);},updateFromPerspective:function(d,p,a){if(!this.rootNode){this.rootNode=new m.Node(d,null);}var c=null;try{c=p.getSearchFacet().getQuery().getResultSetSync().totalcount;}catch(e){}var b=this.findNode(d);if(!b){this.rootNode=new m.Node(d,c);b=this.rootNode;}else{b.setCount(c);}this.updateFromPerspectiveChildDataSources(b,p);this.updateAppTreeNode(d,a);},updateAppTreeNode:function(d,a){if(!this.rootNode.dataSource.equals(a.allDataSource)){return;}if(!d.equals(a.allDataSource)&&!d.equals(a.appDataSource)){return;}var b=a.getProperty('/appCount');var c=this.findNode(a.appDataSource);if(c){this.rootNode.removeChildNode(c);}if(b===0){return;}c=new m.Node(a.appDataSource,b);if(!this.rootNode.childrenHaveUpToDateCount()){this.rootNode.clearChildren();}this.rootNode.appendNode(c);},updateFromPerspectiveChildDataSources:function(c,p){if(!p){return;}var f=p.getChartFacets();if(f.length===0){return;}var d=f[0];if(d.facetType!=='datasource'){return;}var a=d.getQuery().getResultSetSync().getElements();c.clearChildren();for(var i=0;i<a.length;++i){var b=a[i];c.appendNode(new m.Node(b.dataSource,b.valueRaw));}}};m.Formatter=function(){this.init.apply(this,arguments);};m.Formatter.prototype={init:function(){this.tree=new m.Tree();},format:function(d,p,a){this.tree.updateFromPerspective(d,p,a);var t=this.generateTabStrips(d,a);return t;},invalidateCount:function(){if(!this.tree.rootNode){return;}this.tree.rootNode.invalidateCount();},generateTabStrips:function(d,a){var t=9999;var i,c,b;var e={strips:[],selected:null};var n=this.tree.findNode(d);if(!n){if(!d.equals(a.allDataSource)){e.strips.push(a.allDataSource);}e.strips.push(d);e.selected=d;return e;}if(n.dataSource.equals(a.allDataSource)){e.strips.push(a.allDataSource);if(n.childrenHaveUpToDateCount()){b=n.getChildrenSortedByCount();for(i=0;i<b.length&&e.strips.length<t;++i){c=b[i];e.strips.push(c.dataSource);}}e.selected=a.allDataSource;return e;}if(n.parent&&n.parent.dataSource.equals(a.allDataSource)){e.strips.push(a.allDataSource);if(n.parent.childrenHaveUpToDateCount()){var f=false;b=n.parent.getChildrenSortedByCount();for(i=0;i<b.length;++i){c=b[i];if(f){if(e.strips.length>=t){break;}e.strips.push(c.dataSource);}else{if(e.strips.length<t-1||n===c){e.strips.push(c.dataSource);if(n===c){f=true;}}}}}else{e.strips.push(n.dataSource);}e.selected=n.dataSource;return e;}e.strips.push(a.allDataSource);e.strips.push(n.dataSource);e.selected=n.dataSource;return e;}};})();
