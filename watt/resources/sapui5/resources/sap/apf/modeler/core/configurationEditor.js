/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationEditor");jQuery.sap.require("sap.apf.utils.utils");(function(){'use strict';sap.apf.modeler.core.ConfigurationEditor=function(c,a,b,d){var t=this;var e;var f;var g=a.instance.configurationHandler;var p=a.instance.persistenceProxy;var m=a.instance.messageHandler;var h=a.instance.metadataFactory;var j=true;var s,k,l,n,o,q;var r=new a.constructor.configurationObjects(a);var u=new a.constructor.configurationFactory({messageHandler:m,constructor:{registryProbe:a.constructor.registryProbe}});if(!d){s=new a.constructor.elementContainer("Step",a.constructor.step,a);k=new a.constructor.elementContainer("Category",undefined,a);l=new a.constructor.elementContainer("FacetFilter",a.constructor.facetFilter,a);n=new a.constructor.elementContainer("NavigationTarget",a.constructor.navigationTarget,a);o=new a.constructor.elementContainer("CategoryStepAssignment",a.constructor.elementContainer,a);q=[];}else{s=d.stepContainer;k=d.categoryContainer;l=d.facetFilterContainer;n=d.navigationTargetContainer;o=d.categoryStepAssignmentContainer;q=d.serviceList;}this.registerService=function(i){var y=false;if(q.indexOf(i)===-1){if(h.getMetadata(i)){q.push(i);y=true;}}else{y=true;}return y;};this.getAllServices=function(){return q;};this.getAllEntitySetsOfService=function(i){var y=[];if(q.indexOf(i)>-1){y=h.getEntitySets(i);}return y;};this.getAllEntitySetsOfServiceWithGivenProperties=function(y,z){var A=[],B;var C=this.getAllEntitySetsOfService(y);if(!z||z.length===0){return C;}B=h.getMetadata(y);C.forEach(function(D){var E=B.getFilterableProperties(D);var F=true;for(var i=0;i<z.length;i++){if(E.indexOf(z[i])<=-1){F=false;break;}}if(F){A.push(D);}});return A;};this.getAllPropertiesOfEntitySet=function(i,y){var z=[];if(q.indexOf(i)>-1){z=h.getMetadata(i).getAllAggregatePropertiesOfEntitySet(y);}return z;};this.getAllKnownProperties=function(){var i=[];var y;q.forEach(function(z){y=h.getMetadata(z);i=i.concat(y.getAllProperties());});i=sap.apf.utils.eliminateDuplicatesInArray(m,i);return i;};this.setApplicationTitle=function(i){j=false;e=i;};this.getApplicationTitle=function(){return e;};this.getConfigurationName=function(){if(!f){f=g&&g.getConfiguration&&g.getConfiguration(c.id||c).AnalyticalConfigurationName;}return f;};this.getCategoryStepAssignments=function(i){var y=[];if(!this.getCategory(i)){return false;}var z=o.getElement(i);if(z){z.getElements().forEach(function(A){y.push(A.stepId);});}return y;};this.addCategoryStepAssignment=function(i,y){if(!this.getCategory(i)||!this.getStep(y)){return false;}var z=o.getElement(i);if(!z){o.createElementWithProposedId({},i);z=o.getElement(i);}if(!z.getElement(y)){z.createElementWithProposedId({stepId:y},y);return true;}return false;};this.removeCategoryStepAssignment=function(i,y){var z;if(!y){var A=this.getCategoryStepAssignments(i);z=o.removeElement(i);if(z){_(A);}return!!z;}var B=o.getElement(i);if(!B){return false;}z=B.removeElement(y);if(B.getElements().length===0){o.removeElement(i);}if(z){_([y]);}return!!z;};function _(i){if(!i){return;}i.forEach(function(y){if(t.getCategoriesForStep(y).length===0){v(y);}});}this.moveCategoryStepAssignmentBefore=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveBefore(y,z);};this.moveCategoryStepAssignmentToEnd=function(i,y){var z=o.getElement(i);if(!z){return null;}return z.moveToEnd(y);};this.moveCategoryStepAssignmentUpOrDown=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveUpOrDown(y,z);};this.getCategory=k.getElement;this.setCategory=function(i,y){j=false;return k.setElement(i,y);};this.createCategoryWithId=function(i,y){j=false;return k.createElementWithProposedId(i,y).getId();};this.removeCategory=function(i){var y=t.getCategoryStepAssignments(i);if(y){y.forEach(function(z){var A=t.getCategoriesForStep(z);if(!A||A.length<2){v(z);}});}k.removeElement(i);};this.getCategories=k.getElements;this.copyCategory=function(i){var y=k.copyElement(i),z;if(!y){return;}t.getCategoryStepAssignments(i).forEach(function(A){z=w(A,y);});return y;};this.moveCategoryBefore=function(i,y){return k.moveBefore(i,y);};this.moveCategoryToEnd=function(i){return k.moveToEnd(i);};this.moveCategoryUpOrDown=function(i,y){return k.moveUpOrDown(i,y);};this.serialize=function(){return r.serializeConfiguration(t);};this.isSaved=function(){return j;};this.setIsUnsaved=function(){j=false;};this.save=function(i){function y(B,C,D){if(!D){j=true;f=A.AnalyticalConfigurationName;g.replaceConfigurationId(c.id||c,B.AnalyticalConfiguration);c=B.AnalyticalConfiguration;}i(c,C,D);}function z(B,C){if(!C){j=true;f=A.AnalyticalConfigurationName;}i(c.id||c,B,C);}var A={AnalyticalConfiguration:"",AnalyticalConfigurationName:g.getConfiguration(c.id||c).AnalyticalConfigurationName,Application:g.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){p.create("configuration",A,y);}else{A.AnalyticalConfiguration=c;p.update("configuration",A,z,[{name:"AnalyticalConfiguration",value:c}]);}}else{if(c.id.indexOf("apf1972-")===0){A.AnalyticalConfiguration="";A.CreationUTCDateTime=null;A.LastChangeUTCDateTime=null;}else{A.AnalyticalConfiguration=c.id;A.CreationUTCDateTime=c.creationDate;A.LastChangeUTCDateTime=c.lastChangeDate;}if(c.updateExisting){p.update("configuration",A,z,[{name:"AnalyticalConfiguration",value:c.id}]);}else{p.create("configuration",A,y);}}};this.createFacetFilterWithId=function(i){return l.createElementWithProposedId(undefined,i).getId();};this.createFacetFilter=function(){return l.createElement().getId();};this.removeFacetFilter=l.removeElement;this.getFacetFilter=l.getElement;this.getFacetFilters=l.getElements;this.copyFacetFilter=l.copyElement;this.moveFacetFilterBefore=function(i,y){return l.moveBefore(i,y);};this.moveFacetFilterToEnd=function(i){return l.moveToEnd(i);};this.moveFacetFilterUpOrDown=function(i,y){return l.moveUpOrDown(i,y);};this.createNavigationTargetWithId=function(i){return n.createElementWithProposedId(undefined,i).getId();};this.createNavigationTarget=function(){return n.createElement().getId();};this.removeNavigationTarget=n.removeElement;this.getNavigationTarget=n.getElement;this.getNavigationTargets=n.getElements;this.copyNavigationTarget=n.copyElement;this.moveNavigationTargetBefore=function(i,y){return n.moveBefore(i,y);};this.moveNavigationTargetToEnd=function(i){return n.moveToEnd(i);};this.moveNavigationTargetUpOrDown=function(i,y){return n.moveUpOrDown(i,y);};this.createStepWithId=function(i){return s.createElementWithProposedId(undefined,i).getId();};this.createStep=function(i){if(!this.getCategory(i)){return;}var y=s.createElement().getId();this.addCategoryStepAssignment(i,y);return y;};var v=s.removeElement;this.getStep=s.getElement;this.getSteps=s.getElements;this.getStepsNotAssignedToCategory=function(i){var y=this.getCategoryStepAssignments(i);var z=[];t.getSteps().forEach(function(A){var B=A.getId();if(y.indexOf(B)===-1){z.push(B);}});return z;};this.copyStep=function(i){var y=w(i);if(!y){return false;}var z=this.getCategoriesForStep(i);if(z){z.forEach(function(A){t.addCategoryStepAssignment(A,y);});}return y;};function w(i,y){if(y&&!t.getCategory(y)){return false;}var z=s.copyElement(i);if(!z){return false;}if(y){t.addCategoryStepAssignment(y,z);}return z;}this.getCategoriesForStep=function getCategoriesForStep(i){var y=[];var z=t.getCategories();if(z){z.forEach(function(A){var B=A.getId();var C=t.getCategoryStepAssignments(B);if(C&&C.indexOf(i)>-1){y.push(B);}});}return y;};this.getAssignableStepsForNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(!A){y.push(z.getId());}});return y;};this.getStepsAssignedToNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(A){y.push(z.getId());}});return y;};this.copy=function(i){var y={stepContainer:s,categoryContainer:k,facetFilterContainer:l,navigationTargetContainer:n,categoryStepAssignmentContainer:o,serviceList:q};var d=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(y);return new sap.apf.modeler.core.ConfigurationEditor(i,a,undefined,d);};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){j=false;if(b){b(t,undefined);}}else{if(!d){x(c,p,function(i,y){if(!y){var z=JSON.parse(i.SerializedAnalyticalConfiguration);t.setApplicationTitle(z.applicationTitle);u.loadConfig(z);r.mapToDesignTime(u.getRegistry(),t);j=true;f=i.AnalyticalConfigurationName;b(t,undefined);}else{b(undefined,y);}});}}}else{u.loadConfig(c.content);r.mapToDesignTime(u.getRegistry(),this);if(b){b(t,undefined);}}function x(i,y,b){y.readEntity("configuration",function(z,A,B){b(z,B);},[{name:"AnalyticalConfiguration",value:i}],undefined,true,g.getApplicationId());}};}());
