// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.defaultParameters_selector.DefaultParameters",{onInit:function(){this.oModelRecords={};this.oChangedParameters={};this.oBlockedParameters={};this.aDisplayedUserDefaults=[];var t=this;this.DefaultParametersService=sap.ushell.Container.getService("UserDefaultParameters");this.DefaultParametersService.editorGetParameters().done(function(p){t.oMdlParameter=new sap.ui.model.json.JSONModel(p);t.oMdlParameter.setDefaultBindingMode("TwoWay");t.getView().setModel(t.oMdlParameter,"MdlParameter");t.oOriginalParameters=jQuery.extend(true,{},p);t.oCurrentParameters=jQuery.extend(true,{},p);t.constructControlSet(p);});},overrideOdataModelValue:function(e){var u=e.getParameter('url'),m=e.getSource(),f,F,t=this;this.aDisplayedUserDefaults.forEach(function(r){if(r.editorMetadata&&r.editorMetadata.editorInfo){F=r.editorMetadata.editorInfo.odataURL+r.editorMetadata.editorInfo.bindingPath;if(F===u){f=r.editorMetadata.editorInfo.bindingPath+"/"+r.editorMetadata.editorInfo.propertyName;if(m.getProperty(f)!==r.valueObject.value){m.setProperty(f,r.valueObject.value);}t.oBlockedParameters[r.parameterName]=false;}}});},getOrCreateModelForODataService:function(u){if(!this.oModelRecords[u]){var m=new sap.ui.model.odata.ODataModel(u,true);m.setCountSupported(false);m.setDefaultBindingMode("TwoWay");m.attachRequestCompleted(this.overrideOdataModelValue.bind(this));this.oModelRecords[u]=m;}return this.oModelRecords[u];},constructControlSet:function(p){var u=[];for(var P in p){for(var n=0;n<u.length;n++){if(u[n].parameterName===P){u.splice(n,1);}}p[P].parameterName=P;u.push(p[P]);}this.sortParametersByGroupIdParameterIndex(u);this.aDisplayedUserDefaults=u;this.sForm=new sap.ui.comp.smartform.SmartForm({editable:true});this.getView().addContent(this.sForm);},getValue:function(){var d=jQuery.Deferred();var a=sap.ushell.Container.getService("UserDefaultParameters").editorGetParameters();a.done(function(p){d.resolve({value:Object.keys(p).length,displayText:""});});a.fail(function(e){d.reject(e);});return d.promise();},createPlainModel:function(g,r){r.modelBind.model=this.oMdlParameter;g.setModel(r.modelBind.model);var m="/sUserDef_"+r.nr+"_";r.modelBind.sFullPropertyPath=m;r.modelBind.sPropertyName="{"+m+"}";r.modelBind.model.setProperty(r.modelBind.sFullPropertyPath,r.valueObject.value);},revertToPlainModelControls:function(g,r){jQuery.sap.log.error("Metadata loading for parameter "+r.parameterName+" failed"+JSON.stringify(r.editorMetadata));r.modelBind.isOdata=false;this.createPlainModel(g,r);this.createAppropriateControl(g,r);},getContent:function(){jQuery.sap.require('sap.ui.model.odata.v2.ODataModel');var d=new jQuery.Deferred();var l="nevermore";var g;this.aChangedParameters=[];this.setPropValue=function(r){r.modelBind.model.setProperty(r.modelBind.sFullPropertyPath,r.valueObject.value);this.oBlockedParameters[r.parameterName]=false;};this.oMdlParameter.setProperty("/sUser");for(var i=0;i<this.aDisplayedUserDefaults.length;++i){var r=this.aDisplayedUserDefaults[i];r.nr=i;r.editorMetadata=r.editorMetadata||{};r.valueObject=r.valueObject||{value:""};var a=new sap.ui.comp.smartform.GroupElement({});if(l!=r.editorMetadata.groupId){g=new sap.ui.comp.smartform.Group({label:r.editorMetadata.groupTitle||"no Title","editable":true});l=r.editorMetadata.groupId;this.sForm.addGroup(g);}g.addGroupElement(a);r.modelBind={model:undefined,sModelPath:undefined,sPropertyName:undefined,sFullPropertyPath:undefined};r.valueObject.value=r.valueObject.value||"";if(r.editorMetadata.editorInfo&&r.editorMetadata.editorInfo.propertyName){r.modelBind.isOdata=true;var u=r.editorMetadata.editorInfo.odataURL;r.modelBind.model=this.getOrCreateModelForODataService(u);a.setModel(r.modelBind.model);a.bindElement(r.editorMetadata.editorInfo.bindingPath);r.modelBind.sPropertyName="{"+r.editorMetadata.editorInfo.propertyName+"}";r.modelBind.sFullPropertyPath=r.editorMetadata.editorInfo.bindingPath+"/"+r.editorMetadata.editorInfo.propertyName;}else{this.createPlainModel(a,r);}r.valueObject.value=r.valueObject.value||"";r.modelBind.model.setProperty(r.modelBind.sFullPropertyPath,r.valueObject.value);if(r.modelBind.isOdata){this.oBlockedParameters[r.parameterName]=true;r.modelBind.model.attachMetadataLoaded(this.createAppropriateControl.bind(this,a,r));r.modelBind.model.attachMetadataFailed(this.revertToPlainModelControls.bind(this,a,r));}else{this.createAppropriateControl(a,r);}r.modelBind.model.bindTree(r.modelBind.sFullPropertyPath).attachChange(this.storeChangedData.bind(this));}this.oMdlParameter.bindTree("/").attachChange(this.storeChangedData.bind(this));d.resolve(this.getView());return d.promise();},createAppropriateControl:function(g,r){var s,l;jQuery.sap.log.debug("Creating controls for parameter"+r.parameterName+" type "+r.modelBind.isOdata);var e=g.getElements().slice();e.forEach(function(E){g.removeElement(E);});var f=g.getFields().slice();f.forEach(function(E){g.removeField(E);});if(r.modelBind.isOdata&&r.editorMetadata.editorInfo){s=new sap.ui.comp.smartfield.SmartField({value:r.modelBind.sPropertyName,name:r.parameterName});}else{s=new sap.m.Input({name:r.parameterName,value:r.modelBind.sPropertyName,type:"Text"});l=new sap.ui.comp.smartfield.SmartLabel({text:r.editorMetadata.displayText||r.parameterName,tooltip:r.editorMetadata.description||r.parameterName});l.setLabelFor(s);g.addElement(l);this.setPropValue(r);}s.attachChange(this.storeChangedData.bind(this));g.addElement(s);},sortParametersByGroupIdParameterIndex:function(u){function c(d,D){if(!(D.editorMetadata&&D.editorMetadata.groupId)){return-1;}if(!(d.editorMetadata&&d.editorMetadata.groupId)){return 1;}if(d.editorMetadata.groupId<D.editorMetadata.groupId){return-1;}if(d.editorMetadata.groupId>D.editorMetadata.groupId){return 1;}return 0;}function a(d,D){if(!(D.editorMetadata&&D.editorMetadata.parameterIndex)){return-1;}if(!(d.editorMetadata&&d.editorMetadata.parameterIndex)){return 1;}return d.editorMetadata.parameterIndex-D.editorMetadata.parameterIndex;}u.sort(function(d,D){var r=c(d,D);if(r===0){return a(d,D);}return r;});},storeChangedData:function(){var i=0,t=this,a=t.aDisplayedUserDefaults,c=this.sForm.check(),s=sap.ui.getCore().byId("saveButton");s.setEnabled(!c.length);for(i=0;i<a.length;++i){var p=a[i].parameterName;if(!t.oBlockedParameters[p]){var o=t.oCurrentParameters[p].valueObject&&t.oCurrentParameters[p].valueObject.value;if(a[i].modelBind&&a[i].modelBind.model){var d=a[i].modelBind.model;var P=a[i].modelBind.sFullPropertyPath;var b=d.getProperty(P);if(this.isValueDifferent({value:b},{value:o})){t.oCurrentParameters[p].valueObject.value=b;t.oChangedParameters[p]=true;}}}}},onCancel:function(){sap.ui.getCore().byId("saveButton").setEnabled(true);},isValueDifferent:function(v,V){if(v===V){return false;}if(v===undefined){return false;}if(V===undefined){return false;}if(v.value===""&&V.value===undefined){return false;}if(V.value===""&&v.value===undefined){return false;}return(v.value!==V.value);},onSave:function(){var d=new jQuery.Deferred(),i,c=Object.keys(this.oChangedParameters).sort(),s,p;for(i=0;i<c.length;i++){p=c[i];if(this.isValueDifferent(this.oOriginalParameters[p].valueObject,this.oCurrentParameters[p].valueObject)){if(this.oCurrentParameters[p].valueObject===""||(this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.value==="")){s=sap.ushell.Container.getService("UserDefaultParameters").editorSetValue(p,undefined);}else{s=sap.ushell.Container.getService("UserDefaultParameters").editorSetValue(p,this.oCurrentParameters[p].valueObject);}s.done(d.resolve);s.fail(d.reject);}}return d.promise();}});}());
