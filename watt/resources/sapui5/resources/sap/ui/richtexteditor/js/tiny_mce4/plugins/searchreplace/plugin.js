(function(){
// released under UNLICENSE that is compatible with LGPL
function f(r,n,a,c,s){var m,b=[],t,d=0,e;var g,h,j;e=n.ownerDocument;g=s.getBlockElements();h=s.getWhiteSpaceElements();j=s.getShortEndedElements();function k(m,c){c=c||0;if(!m[0]){throw'findAndReplaceDOMText cannot handle zero-length matches';}var i=m.index;if(c>0){var l=m[c];if(!l){throw'Invalid capture group';}i+=m[0].indexOf(l);m[0]=l;}return[i,i+m[0].length,[m[0]]];}function o(n){var i;if(n.nodeType===3){return n.data;}if(h[n.nodeName]&&!g[n.nodeName]){return'';}i='';if(g[n.nodeName]||j[n.nodeName]){i+='\n';}if((n=n.firstChild)){do{i+=o(n);}while((n=n.nextSibling));}return i;}function p(n,b,i){var l,u,v,w,x=[],y=0,z=n,A=b.shift(),B=0;out:while(true){if(g[z.nodeName]||j[z.nodeName]){y++;}if(z.nodeType===3){if(!u&&z.length+y>=A[1]){u=z;w=A[1]-y;}else if(l){x.push(z);}if(!l&&z.length+y>A[0]){l=z;v=A[0]-y;}y+=z.length;}if(l&&u){z=i({startNode:l,startNodeIndex:v,endNode:u,endNodeIndex:w,innerNodes:x,match:A[2],matchIndex:B});y-=(u.length-w);l=null;u=null;x=[];A=b.shift();B++;if(!A){break;}}else if((!h[z.nodeName]||g[z.nodeName])&&z.firstChild){z=z.firstChild;continue;}else if(z.nextSibling){z=z.nextSibling;continue;}while(true){if(z.nextSibling){z=z.nextSibling;break;}else if(z.parentNode!==n){z=z.parentNode;}else{break out;}}}}function q(u){var v;if(typeof u!='function'){var w=u.nodeType?u:e.createElement(u);v=function(i,l){var x=w.cloneNode(false);x.setAttribute('data-mce-index',l);if(i){x.appendChild(e.createTextNode(i));}return x;};}else{v=u;}return function(x){var y,z,A,B=x.startNode,C=x.endNode,D=x.matchIndex;if(B===C){var n=B;A=n.parentNode;if(x.startNodeIndex>0){y=e.createTextNode(n.data.substring(0,x.startNodeIndex));A.insertBefore(y,n);}var E=v(x.match[0],D);A.insertBefore(E,n);if(x.endNodeIndex<n.length){z=e.createTextNode(n.data.substring(x.endNodeIndex));A.insertBefore(z,n);}n.parentNode.removeChild(n);return E;}y=e.createTextNode(B.data.substring(0,x.startNodeIndex));z=e.createTextNode(C.data.substring(x.endNodeIndex));var F=v(B.data.substring(x.startNodeIndex),D);var G=[];for(var i=0,l=x.innerNodes.length;i<l;++i){var H=x.innerNodes[i];var I=v(H.data,D);H.parentNode.replaceChild(I,H);G.push(I);}var J=v(C.data.substring(0,x.endNodeIndex),D);A=B.parentNode;A.insertBefore(y,B);A.insertBefore(F,B);A.removeChild(B);A=C.parentNode;A.insertBefore(J,C);A.insertBefore(z,C);A.removeChild(C);return J;};}t=o(n);if(!t){return;}if(r.global){while((m=r.exec(t))){b.push(k(m,c));}}else{m=t.match(r);b.push(k(m,c));}if(b.length){d=b.length;p(n,b,q(a));}return d;}function P(a){var s=this,c=-1;function b(){var l={},i;i=tinymce.trim(a.selection.getContent({format:'text'}));function k(){w.statusbar.find('#next').disabled(!d(c+1).length);w.statusbar.find('#prev').disabled(!d(c-1).length);}function n(){tinymce.ui.MessageBox.alert('Could not find the specified string.',function(){w.find('#find')[0].focus();});}var w=tinymce.ui.Factory.create({type:'window',layout:"flex",pack:"center",align:"center",onClose:function(){a.focus();s.done();},onSubmit:function(e){var o,p,t,q;e.preventDefault();p=w.find('#case').checked();q=w.find('#words').checked();t=w.find('#find').value();if(!t.length){s.done(false);w.statusbar.items().slice(1).disabled(true);return;}if(l.text==t&&l.caseState==p&&l.wholeWord==q){if(d(c+1).length===0){n();return;}s.next();k();return;}o=s.find(t,p,q);if(!o){n();}w.statusbar.items().slice(1).disabled(o===0);k();l={text:t,caseState:p,wholeWord:q};},buttons:[{text:"Find",subtype:'primary',onclick:function(){w.submit();}},{text:"Replace",disabled:true,onclick:function(){if(!s.replace(w.find('#replace').value())){w.statusbar.items().slice(1).disabled(true);c=-1;l={};}}},{text:"Replace all",disabled:true,onclick:function(){s.replace(w.find('#replace').value(),true,true);w.statusbar.items().slice(1).disabled(true);l={};}},{type:"spacer",flex:1},{text:"Prev",name:'prev',disabled:true,onclick:function(){s.prev();k();}},{text:"Next",name:'next',disabled:true,onclick:function(){s.next();k();}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,items:[{type:'textbox',name:'find',size:40,label:'Find',value:i},{type:'textbox',name:'replace',size:40,label:'Replace with'},{type:'checkbox',name:'case',text:'Match case',label:' '},{type:'checkbox',name:'words',text:'Whole words',label:' '}]}}).renderTo().reflow();}s.init=function(e){e.addMenuItem('searchreplace',{text:'Find and replace',shortcut:'Meta+F',onclick:b,separator:'before',context:'edit'});e.addButton('searchreplace',{tooltip:'Find and replace',shortcut:'Meta+F',onclick:b});e.addCommand("SearchReplace",b);e.shortcuts.add('Meta+F','',b);};function g(e){var v=e.getAttribute('data-mce-index');if(typeof v=="number"){return""+v;}return v;}function m(e){var n,i;i=a.dom.create('span',{"data-mce-bogus":1});i.className='mce-match-marker';n=a.getBody();s.done(false);return f(e,n,i,false,a.schema);}function u(n){var p=n.parentNode;if(n.firstChild){p.insertBefore(n.firstChild,n);}n.parentNode.removeChild(n);}function d(e){var n,k=[];n=tinymce.toArray(a.getBody().getElementsByTagName('span'));if(n.length){for(var i=0;i<n.length;i++){var l=g(n[i]);if(l===null||!l.length){continue;}if(l===e.toString()){k.push(n[i]);}}}return k;}function h(e){var t=c,i=a.dom;e=e!==false;if(e){t++;}else{t--;}i.removeClass(d(c),'mce-match-marker-selected');var k=d(t);if(k.length){i.addClass(d(t),'mce-match-marker-selected');a.selection.scrollIntoView(k[0]);return t;}return-1;}function r(n){var e=a.dom,p=n.parentNode;e.remove(n);if(e.isEmpty(p)){e.remove(p);}}s.find=function(t,e,w){t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");t=w?'\\b'+t+'\\b':t;var i=m(new RegExp(t,e?'g':'gi'));if(i){c=-1;c=h(true);}return i;};s.next=function(){var i=h(true);if(i!==-1){c=i;}};s.prev=function(){var i=h(false);if(i!==-1){c=i;}};function j(n){var e=g(n);return e!==null&&e.length>0;}s.replace=function(t,e,k){var i,n,l,o,p,q=c,v;e=e!==false;l=a.getBody();n=tinymce.grep(tinymce.toArray(l.getElementsByTagName('span')),j);for(i=0;i<n.length;i++){var w=g(n[i]);o=p=parseInt(w,10);if(k||o===c){if(t.length){n[i].firstChild.nodeValue=t;u(n[i]);}else{r(n[i]);}while(n[++i]){o=parseInt(g(n[i]),10);if(o===p){r(n[i]);}else{i--;break;}}if(e){q--;}}else if(p>c){n[i].setAttribute('data-mce-index',p-1);}}a.undoManager.add();c=q;if(e){v=d(q+1).length>0;s.next();}else{v=d(q-1).length>0;s.prev();}return!k&&v;};s.done=function(k){var i,n,e,l;n=tinymce.toArray(a.getBody().getElementsByTagName('span'));for(i=0;i<n.length;i++){var o=g(n[i]);if(o!==null&&o.length){if(o===c.toString()){if(!e){e=n[i].firstChild;}l=n[i].firstChild;}u(n[i]);}}if(e&&l){var p=a.dom.createRng();p.setStart(e,0);p.setEnd(l,l.data.length);if(k!==false){a.selection.setRng(p);}return p;}};}tinymce.PluginManager.add('searchreplace',P);})();
