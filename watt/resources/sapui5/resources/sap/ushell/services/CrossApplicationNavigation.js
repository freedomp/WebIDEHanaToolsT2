// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.CrossApplicationNavigation");jQuery.sap.require("sap.ushell.services.Personalization");sap.ushell.services.CrossApplicationNavigation=function(){var a;function g(t,c){var r,s,S,C,b,o;if(typeof t!=="string"&&!jQuery.isPlainObject(t)&&t!==undefined){jQuery.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(t===undefined){return undefined;}if(c){if(typeof c.getComponentData!=="function"||!jQuery.isPlainObject(c.getComponentData())||!c.getComponentData().startupParameters||!jQuery.isPlainObject(c.getComponentData().startupParameters)){jQuery.sap.log.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation");}else{o=c.getComponentData().startupParameters;if(o.hasOwnProperty("sap-system")){S=o["sap-system"][0];}}}else{r=sap.ushell.Container.getService("NavTargetResolution").getCurrentResolution();if(r&&r["sap-system"]){S=r["sap-system"];}else if(r&&r.url){S=jQuery.sap.getUriParameters(r.url).get("sap-system");}}if(jQuery.isPlainObject(t)){C=jQuery.extend(true,{},t);if(!S){return C;}if(C.target&&C.target.shellHash){if(typeof C.target.shellHash==="string"){C.target.shellHash=g(C.target.shellHash,c);}return C;}C.params=C.params||{};if(!Object.prototype.hasOwnProperty.call(C.params,"sap-system")){C.params["sap-system"]=S;}return C;}else{b=t;if(!S){return b;}if(!/[?&]sap-system=/.test(b)){s=(b.indexOf("?")>-1)?"&":"?";b+=s+"sap-system="+S;}return b;}}this.hrefForExternal=function(A,c,b){var o;if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){o=g(A,c);return sap.ushell.Container.getService("ShellNavigation").hrefForExternal(o,undefined,c,b);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation");if(b){return(new jQuery.Deferred()).resolve("").promise();}return"";};this.expandCompactHash=function(h){return sap.ushell.Container.getService("NavTargetResolution").expandCompactHash(h);};this.backToPreviousApp=function(){this.historyBack();};this.historyBack=function(){window.history.back();};this.toExternal=function(A,c){var o;if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){o=g(A,c);sap.ushell.Container.getService("ShellNavigation").toExternal(o,c);return;}jQuery.sap.log.debug("Shell not avialable, no Cross App Navigation");return;};this.hrefForAppSpecificHash=function(A){if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){return sap.ushell.Container.getService("ShellNavigation").hrefForAppSpecificHash(A);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(A);};this.getSemanticObjectLinks=function(s,p,i,c,A,C){var P=g({params:p},c).params,S=sap.ushell.Container.getService("NavTargetResolution"),e=sap.ushell.utils.invokeUnfoldingArrayArguments(S.getSemanticObjectLinks.bind(S),[s,P,i,c,A,!!C]);return e;};this.isIntentSupported=function(i,c){var d=new jQuery.Deferred(),o={},C=i.map(function(I){var s=g(I,c);o[s]=I;return s;});sap.ushell.Container.getService("NavTargetResolution").isIntentSupported(C).done(function(I){var m={};Object.keys(I).forEach(function(k){m[o[k]]=I[k];});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};this.isNavigationSupported=function(i,c){var C=i.map(function(I){return g(I,c);});return sap.ushell.Container.getService("NavTargetResolution").isNavigationSupported(C);};this.isUrlSupported=function(u){var d=new jQuery.Deferred(),U,h;if(typeof u!=="string"){d.reject();return d.promise();}U=sap.ushell.Container.getService("URLParsing");if(U.isIntentUrl(u)){h=U.getHash(u);this.isIntentSupported(["#"+h]).done(function(r){if(r["#"+h]&&r["#"+h].supported){d.resolve();}else{d.reject();}}).fail(function(){d.reject();});}else{d.resolve();}return d.promise();};this.createComponentInstance=function(i,c){var d=new jQuery.Deferred(),u=sap.ushell.Container.getService("URLParsing"),C=u.constructShellHash(u.parseShellHash(i));if(!C){d.reject("Navigation intent invalid!");return d.promise();}sap.ushell.Container.getService("NavTargetResolution").resolveHashFragment("#"+C).done(function(r){var I=r.url.indexOf("?"),o={startupParameters:{}};c=c||{};if(r.applicationType!==sap.ushell.components.container.ApplicationType.URL&&!(/^SAPUI5\.Component=/.test(r.additionalInformation))){d.reject("The resolved target mapping is not of type UI5 component.");return d.promise();}if(I>=0){o.startupParameters=jQuery.sap.getUriParameters(r.url).mParams;o["sap-xapp-state"]=o.startupParameters["sap-xapp-state"];delete o.startupParameters["sap-xapp-state"];r.url=r.url.slice(0,I);}c.name=r.additionalInformation&&r.additionalInformation.replace(/^SAPUI5\.Component=/,"");c.url=r.url;if(c.componentData){jQuery.extend(true,o,c.componentData);}c.componentData=o;if(c.async===true){sap.ui.component(c).then(function(b){d.resolve(b);},function(e){e=e||"";jQuery.sap.log.error("Cannot create UI5 component: "+e,e.stack,"sap.ushell.services.CrossApplicationNavigation");d.reject(e);});}else{d.resolve(sap.ui.component(c));}}).fail(function(m){d.reject(m);});return d.promise();};this.createEmptyAppState=function(A){if(!a){a=sap.ushell.Container.getService("AppState");}if(!(A instanceof sap.ui.core.UIComponent)){throw new Error("oAppComponent passed must be a UI5 Component");}return a.createEmptyAppState(A);};this.getStartupAppState=function(A){this._checkComponent(A);var c=A.getComponentData()&&A.getComponentData()["sap-xapp-state"]&&A.getComponentData()["sap-xapp-state"][0];return this.getAppState(A,c);};this._checkComponent=function(A){if(!(A instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}};this.getAppState=function(A,s){var c,d=new jQuery.Deferred();this._checkComponent(A);if(!a){a=sap.ushell.Container.getService("AppState");}if(typeof s!=="string"){if(s!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){c=a.createEmptyUnmodifiableAppState(A);d.resolve(c);},0);return d.promise();}return a.getAppState(s);};this.getAppStateData=function(A){return sap.ushell.utils.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[A]);};this._getAppStateData=function(A){var d=new jQuery.Deferred();if(!a){a=sap.ushell.Container.getService("AppState");}if(typeof A!=="string"){if(A!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){d.resolve(undefined);},0);}else{a.getAppState(A).done(function(o){d.resolve(o.getData());}).fail(d.resolve.bind(d,undefined));}return d.promise();};this.saveMultipleAppStates=function(A){var r=[],d=new jQuery.Deferred();A.forEach(function(o){r.push(o.save());});jQuery.when.apply(this,r).done(function(){d.resolve(r);}).fail(function(){d.reject("save failed");});return d.promise();};};sap.ushell.services.CrossApplicationNavigation.hasNoAdapter=true;}());
