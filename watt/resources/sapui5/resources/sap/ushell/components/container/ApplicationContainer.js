// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var p="sap.ushell.components.container.",c=p+"ApplicationContainer",d="sap.ushell.Container.dirtyState.",l,r,f=true;jQuery.sap.declare("sap.ushell.components.container.ApplicationContainer");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.require("sap.m.MessagePopover");sap.ushell.utils.testPublishAt(sap.ushell.components.container);function a(T){var C=sap.ushell.Container.getService("CrossApplicationNavigation");C.isUrlSupported(T.url).done(function(){T.promise.resolve({"allowed":true,"id":T.id});}).fail(function(){T.promise.resolve({"allowed":false,"id":T.id});});}l=new sap.ushell.utils.Map();sap.ushell.components.container.ApplicationType={URL:"URL",WDA:"WDA",NWBC:"NWBC"};sap.ushell.utils.testPublishAt(sap.ushell.components.container);function g(C){return l.get(C.getId());}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function b(U){var P=jQuery.sap.getUriParameters(U).mParams,e=P["sap-xapp-state"];delete P["sap-xapp-state"];return{startupParameters:P,"sap-xapp-state":e};}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function h(K,e){if(!r){r=jQuery.sap.resources({url:jQuery.sap.getModulePath(p)+"/resources/resources.properties",language:sap.ui.getCore().getConfiguration().getLanguage()});}return r.getText(K,e);}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function i(){return new sap.ui.core.Icon({size:"2rem",src:"sap-icon://error",tooltip:h("an_error_has_occured")});}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function j(C){var e=C.getAggregation("child"),B;if(e instanceof sap.ui.core.ComponentContainer){B=e.getComponentInstance().getMetadata().getName().replace(/\.Component$/,"");jQuery.sap.log.debug("unloading component "+B,null,c);}C.destroyAggregation("child");}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function k(C,U,e){var B,D,I,L,M,E,N,V={},F,G;I=U.indexOf("?");if(I>=0){E=b(U);V=E.startupParameters;U=U.slice(0,I);}if(U.slice(-1)!=='/'){U+='/';}if(/\.view\.(\w+)$/i.test(e)){M=/^SAPUI5=(?:([^\/]+)\/)?([^\/]+)\.view\.(\w+)$/i.exec(e);if(!M){jQuery.sap.log.error("Invalid SAPUI5 URL",e,c);return i();}N=M[1];F=M[2];G=M[3].toUpperCase();if(N){F=N+"."+F;}else{L=F.lastIndexOf(".");if(L<1){jQuery.sap.log.error("Missing namespace",e,c);return i();}N=F.slice(0,L);}}else{N=e.replace(/^SAPUI5=/,"");}jQuery.sap.registerModulePath(N,U+N.replace(/\./g,'/'));j(C);if(F){if(C.getApplicationConfiguration()){V.config=C.getApplicationConfiguration();}D=sap.ui.view({id:C.getId()+"-content",type:G,viewData:V||{},viewName:F});C.fireEvent("applicationConfiguration");}else{jQuery.sap.log.debug("loading component "+N,null,c);var H=E?{startupParameters:E.startupParameters,"sap-xapp-state":E["sap-xapp-state"]}:{startupParameters:{}};if(C.getApplicationConfiguration()){H.config=C.getApplicationConfiguration();}B=sap.ui.component({id:C.getId()+"-component",componentData:H,name:N});C.fireEvent("applicationConfiguration",{"configuration":B.getMetadata().getConfig()});D=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:B});}D.setWidth(C.getWidth());D.setHeight(C.getHeight());D.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",D,true);return D;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function m(e,D){setTimeout(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer",e,D);},0);}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function n(C,U,e){var I,B,D,E,F={startupParameters:{}};I=U.indexOf("?");if(I>=0){E=b(U);F={startupParameters:E.startupParameters,"sap-xapp-state":E["sap-xapp-state"]};U=U.slice(0,I);}if(C.getApplicationConfiguration()){F.config=C.getApplicationConfiguration();}if(U.slice(-1)!=='/'){U+='/';}jQuery.sap.registerModulePath(e,U);jQuery.sap.require("sap.ushell.services.CrossApplicationNavigation");j(C);jQuery.sap.log.debug("loading component "+e,null,c);sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",{name:e});B=sap.ui.component({id:C.getId()+"-component",name:e,componentData:F});C.fireEvent("applicationConfiguration",{"configuration":B.getMetadata().getConfig()});D=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:B});D.setHeight(C.getHeight());D.setWidth(C.getWidth());D.addStyleClass("sapUShellApplicationContainer");C._disableRouterEventHandler=o.bind(this,B);sap.ui.getCore().getEventBus().subscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",C._disableRouterEventHandler);C.setAggregation("child",D,true);m("componentCreated",{component:B});return D;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function o(C){var e;if((C instanceof sap.ui.core.Component)&&(typeof C.getRouter==="function")){e=C.getRouter();if(e&&(typeof e.stop==="function")){jQuery.sap.log.info("router stopped for instance "+C.getId());e.stop();}}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function q(U){var e=document.createElement("a"),C=jQuery.sap.getUriParameters(U).get("sap-client"),B;e.href=U;B=e.protocol+"//"+e.host;return new sap.ushell.System({alias:C?B+"?sap-client="+C:B,baseUrl:B,client:C||undefined,platform:"abap"});}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function s(C,M){var T=false,D=C.getDomRef(),e=C.getApplicationType(),U,O;if(D){if(e===sap.ushell.components.container.ApplicationType.NWBC){U=URI(D.src);O=U.protocol()+"://"+U.host();T=(M.source===D.contentWindow)||(M.origin===O);}else if(e===sap.ushell.components.container.ApplicationType.URL){U=URI();O=U.protocol()+"://"+U.host();T=(M.origin===O);}}return T;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function t(C,M,e){var P=jQuery.sap.getObject("sap-ushell-config.services.PostMessage.config",0),S=e&&e.service;if(!S||S.indexOf("sap.ushell.services.CrossApplicationNavigation")!==0||e.type!=="request"){return;}if(P&&P.enabled===false){jQuery.sap.log.warning("Received message for CrossApplicationNavigation, but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!s(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,M.data,"sap.ushell.components.container.ApplicationContainer");return;}function B(F,G){M.source.postMessage(JSON.stringify({type:"response",service:e.service,request_id:e.request_id,status:F,body:G}),M.origin);}function D(F){switch(F){case"sap.ushell.services.CrossApplicationNavigation.hrefForExternal":return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(e.body.oArgs)).promise();case"sap.ushell.services.CrossApplicationNavigation.getSemanticObjectLinks":return sap.ushell.Container.getService("CrossApplicationNavigation").getSemanticObjectLinks(e.body.sSemanticObject,e.body.mParameters,e.body.bIgnoreFormFactors,undefined,undefined,e.body.bCompactIntents);case"sap.ushell.services.CrossApplicationNavigation.isIntentSupported":return sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(e.body.aIntents);case"sap.ushell.services.CrossApplicationNavigation.isNavigationSupported":return sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported(e.body.aIntents);case"sap.ushell.services.CrossApplicationNavigation.toExternal":return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(e.body.oArgs)).promise();case"sap.ushell.services.CrossApplicationNavigation.getAppStateData":return sap.ushell.Container.getService("CrossApplicationNavigation").getAppStateData(e.body.sAppStateKey);default:return undefined;}}try{D(e.service).done(function(R){B("success",{result:R});}).fail(function(F){B("error",{message:F});});}catch(E){B("error",{message:E.message});}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function u(C,M){var B=M.data;if(typeof B==="string"){try{B=JSON.parse(M.data);}catch(e){jQuery.sap.log.debug("Message received from origin '"+M.origin+"' cannot be parsed: "+e,B,"sap.ushell.components.container.ApplicationContainer");return;}}if(B.action==="pro54_setGlobalDirty"&&localStorage.getItem(C.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!s(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,B,"sap.ushell.components.container.ApplicationContainer");return;}jQuery.sap.log.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+C.globalDirtyStorageKey+" value: "+B.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,B.parameters.globalDirty,true);}else{t(C,M,B);}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function v(C,e){var I=C.getDomRef();if(C.getApplicationType()===sap.ushell.components.container.ApplicationType.NWBC&&I&&I.tagName==="IFRAME"){I.contentWindow.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),'*');e.preventDefault();}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function w(R,C,e){R.write("<div").writeControlData(C).writeAccessibilityState(C).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write(">").renderControl(e);R.write("</div>");}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function x(U){var T,e=function(){return jQuery.sap.getUriParameters().get("sap-theme")||sap.ushell.Container.getUser().getTheme()||sap.ui.getCore().getConfiguration().getTheme();},B=function(){var D=sap.ushell.utils.getParameterValueBoolean("sap-accessibility");if(D!==undefined){return D;}return sap.ushell.Container.getUser().getAccessibilityMode();},V,C=function(){var V=sap.ui.getVersionInfo().version,M=/\d+\.\d+\.\d+/.exec(V);if(M&&M[0]){V=M[0];}return V;};U+=U.indexOf("?")>=0?"&":"?";U+="sap-ie=edge";T=e();if(T){U+=U.indexOf("?")>=0?"&":"?";U+="sap-theme="+encodeURIComponent(T);}if(B()){U+=U.indexOf("?")>=0?"&":"?";U+="sap-accessibility=X";}V=C();if(V){U+=U.indexOf("?")>=0?"&":"?";U+="sap-shell="+encodeURIComponent("FLP"+V+"-NWBC");}return U;}function y(R,C,U,e){var B=C.getAggregation("child");if(!B||C._bRecreateChild){B=n(C,U,e);C._bRecreateChild=false;}w(R,C,B);}function z(C,K,V){var O=C.getProperty(K);if(jQuery.sap.equal(O,V)){return;}C.setProperty(K,V);C._bRecreateChild=true;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function A(R,C,e,U,B){var L;localStorage.removeItem(C.globalDirtyStorageKey);if(B&&B.indexOf("SAPUI5.Component=")===0&&e===sap.ushell.components.container.ApplicationType.URL){y(R,C,U,B.replace(/^SAPUI5\.Component=/,""));return;}if(B&&B.indexOf("SAPUI5=")===0&&e===sap.ushell.components.container.ApplicationType.URL){w(R,C,k(C,U,B));return;}jQuery.sap.log.debug("Not resolved as \"SAPUI5.Component=\" or \"SAPUI5=\" , "+"will attempt to load into iframe "+B);try{U=C.getFrameSource(e,U,B);}catch(D){jQuery.sap.log.error(D.message||D,null,c);C.fireEvent("applicationConfiguration");R.renderControl(i());return;}if(sap.ushell.Container){L=g(C);if(!L){if(e===sap.ushell.components.container.ApplicationType.NWBC){L=v.bind(null,C);l.put(C.getId(),L);sap.ushell.Container.attachLogoutEvent(L);sap.ushell.Container.addRemoteSystem(q(U));}}else{if(e!==sap.ushell.components.container.ApplicationType.NWBC){sap.ushell.Container.detachLogoutEvent(L);l.remove(C.getId());}}}if(e===sap.ushell.components.container.ApplicationType.NWBC){U=x(U);sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,sap.ushell.Container.DirtyState.INITIAL);}C.fireEvent("applicationConfiguration");R.write("<iframe").writeControlData(C).writeAccessibilityState(C).writeAttributeEscaped("src",U).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write("></iframe>");}sap.ui.core.Control.extend(c,{metadata:{properties:{additionalInformation:{defaultValue:"",type:"string"},application:{type:"object"},applicationConfiguration:{type:"object"},applicationType:{defaultValue:"URL",type:p+"ApplicationType"},height:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},navigationMode:{defaultValue:"",type:"string"},text:{defaultValue:"",type:"string"},url:{defaultValue:"",type:"string"},visible:{defaultValue:true,type:"boolean"},width:{defaultValue:"100%",type:"sap.ui.core.CSSSize"}},events:{"applicationConfiguration":{}},aggregations:{child:{multiple:false,type:"sap.ui.core.Control",visibility:"hidden"}},library:"sap.ushell"},exit:function(){var L;if(sap.ushell.Container){L=g(this);if(L){sap.ushell.Container.detachLogoutEvent(L);l.remove(this.getId());}}localStorage.removeItem(this.globalDirtyStorageKey);if(this._unloadEventListener){removeEventListener("unload",this._unloadEventListener);}if(this._disableRouterEventHandler){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",this._disableRouterEventHandler);}if(this._storageEventListener){removeEventListener("storage",this._storageEventListener);}if(this._messageEventListener){removeEventListener("message",this._messageEventListener);}j(this);if(sap.ui.core.Control.exit){sap.ui.core.Control.exit.apply(this);}},init:function(){var e=this;this.globalDirtyStorageKey=d+jQuery.sap.uid();this._unloadEventListener=this.exit.bind(this);addEventListener("unload",this._unloadEventListener);this._storageEventListener=function(S){if(S.key===e.globalDirtyStorageKey&&S.newValue===sap.ushell.Container.DirtyState.PENDING&&e.getApplicationType()===sap.ushell.components.container.ApplicationType.NWBC){var I=e.getDomRef();if(I&&I.tagName==="IFRAME"){jQuery.sap.log.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.components.container.ApplicationContainer");I.contentWindow.postMessage(JSON.stringify({action:"pro54_getGlobalDirty"}),'*');}}};addEventListener('storage',this._storageEventListener);this._messageEventListener=u.bind(null,this);addEventListener('message',this._messageEventListener);if(f){var M={"asyncURLHandler":a};if(sap.m.MessagePopover&&sap.m.MessagePopover.setDefaultHandlers){sap.m.MessagePopover.setDefaultHandlers(M);}f=false;}},renderer:function(R,C){var e=C.getApplication(),L=C.launchpadData,B;if(!C.getVisible()){w(R,C);return;}if(C.error){delete C.error;w(R,C,i());}else if(!e){A(R,C,C.getApplicationType(),C.getUrl(),C.getAdditionalInformation());}else if(!e.isResolvable()){A(R,C,e.getType(),e.getUrl(),"");}else if(L){A(R,C,L.applicationType,L.Absolute.url.replace(/\?$/,""),L.applicationData);}else{jQuery.sap.log.debug("Resolving "+e.getUrl(),null,c);e.resolve(function(D){jQuery.sap.log.debug("Resolved "+e.getUrl(),JSON.stringify(D),c);C.launchpadData=D;j(C);},function(E){var D=e.getMenu().getDefaultErrorHandler();if(D){D(E);}j(C);C.error=E;});B=new sap.m.Text({text:h("loading",[e.getText()])});j(C);C.setAggregation("child",B);w(R,C,B);}}});sap.ushell.components.container.ApplicationContainer.prototype.getFrameSource=function(e,U,B){if(!Object.prototype.hasOwnProperty.call(sap.ushell.components.container.ApplicationType,e)){throw new Error("Illegal application type: "+e);}return U;};sap.ushell.components.container.ApplicationContainer.prototype.setUrl=function(V){z(this,"url",V);};sap.ushell.components.container.ApplicationContainer.prototype.setAdditionalInformation=function(V){z(this,"additionalInformation",V);};sap.ushell.components.container.ApplicationContainer.prototype.setApplicationType=function(V){z(this,"applicationType",V);};}());
