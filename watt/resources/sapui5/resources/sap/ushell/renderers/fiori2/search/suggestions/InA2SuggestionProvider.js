(function(){"use strict";jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchHelper');var S=sap.ushell.renderers.fiori2.search.SearchHelper;jQuery.sap.require('sap.ushell.renderers.fiori2.search.suggestions.InABaseSuggestionProvider');var I=sap.ushell.renderers.fiori2.search.suggestions.InABaseSuggestionProvider;jQuery.sap.require('sap.ushell.renderers.fiori2.search.suggestions.SuggestionTypes');var a=sap.ushell.renderers.fiori2.search.suggestions.SuggestionTypes;jQuery.sap.declare('sap.ushell.renderers.fiori2.search.suggestions.InA2SuggestionProvider');var b=function(){this.init.apply(this,arguments);};b.prototype={init:function(){this.terms={};},addTerm:function(t){t=t.trim().toLowerCase();this.terms[t]=true;},hasTerm:function(t){t=t.trim().toLowerCase();return!!this.terms[t];},reset:function(){this.terms={};}};var m=sap.ushell.renderers.fiori2.search.suggestions.InA2SuggestionProvider=function(){this.init.apply(this,arguments);};m.prototype=jQuery.extend(new I(),{suggestionLimit:jQuery.device.is.phone?5:7,init:function(p){I.prototype.init.apply(this,arguments);this.getResultSet=S.refuseOutdatedRequests(this.getResultSet);this.dataSourceDeferred=null;},abortSuggestions:function(){this.getResultSet.abort();},getResultSet:function(){return this.suggestionQuery.getResultSet();},getSuggestions:function(){var t=this;var s=t.getAllAndAppSuggestions();if(!t.model.isBusinessObjSearchEnabled()){return jQuery.when(s);}if(t.model.getDataSource().equals(t.model.appDataSource)){return jQuery.when(s);}var c=t.model.getProperty('/searchBoxTerm');var d=t.splitSuggestionTerm(c);t.suggestionQuery.clearSearchTerms();if(d.searchTerm){t.suggestionQuery.addSearchTerm(d.searchTerm);}t.suggestionQuery.setSuggestionTerm(d.suggestionTerm);if(!t.suggestionQuery.getDataSource()||!t.model.getProperty('/dataSource').equals(t.suggestionQuery.getDataSource())){t.suggestionQuery.resetFilterConditions();}t.suggestionQuery.setDataSource(t.model.getProperty("/dataSource"));return t.getResultSet().then(function(r){var e=r.getElements();t.concatenateSearchTerm(e,d);var f=t.formatSinaSuggestions(e);s.push.apply(s,f);return s;});},getAllAndAppSuggestions:function(){if(!this.model.getDataSource().equals(this.model.allDataSource)){return[];}var d=[];d.unshift(this.model.appDataSource);d.unshift(this.model.allDataSource);var c=[];var s=this.model.getProperty('/searchBoxTerm');var e=s.replace(/\*/g,'');var t=new S.Tester(e);for(var i=0;i<d.length;++i){var f=d[i];if(f.key===this.model.getDataSource().key){continue;}var T=t.test(f.label);if(T.bMatch===true){var g={};g.label='<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",T.sHighlightedText)+'</i>';g.labelRaw='';g.dataSource=f;g.type=a.SUGGESTION_TYPE_DATASOURCE;g.position=a.datasource.position;c.push(g);}}return c;},formatSinaSuggestions:function(s){this.suggestions=[];this.firstSuggestionTerm=null;this.numberObjectDataSuggestions=0;this.numberDataSourceSuggestions=0;this.numberHistorySuggestions=0;this.suggestionTermBuffer=new b();this.formatSinaSuggestionsInternal(s,['DataSources','ObjectData']);this.formatSinaSuggestionsInternal(s,['SearchHistory']);return this.suggestions;},formatSinaSuggestionsInternal:function(s,c){for(var i=0;i<s.length;++i){var d=s[i];if(c.indexOf(d.scope)<0){continue;}switch(d.scope){case'DataSources':this.formatDataSourceSuggestion(d);break;case'ObjectData':this.formatObjectDataSuggestion(d);break;case'SearchHistory':this.formatHistorySuggestion(d);break;default:break;}}},formatDataSourceSuggestion:function(s){if(!this.model.getDataSource().equals(this.model.allDataSource)){return;}if(this.numberDataSourceSuggestions>=a.datasource.limit){return;}if(!s.dataSource.equals(this.model.allDataSource)){return;}if(!s.labelRaw){return;}this.numberDataSourceSuggestions++;this.suggestions.push({label:'<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",s.label)+'</i>',labelRaw:'',dataSource:s.labelRaw,type:a.SUGGESTION_TYPE_DATASOURCE,position:a.datasource.position});},formatObjectDataSuggestion:function(s){if(this.numberObjectDataSuggestions>=a.objectData.limit){return;}if(s.attribute.value!=='$$AllAttributes$$'){return;}if(this.firstSuggestionTerm===null){this.firstSuggestionTerm=s.labelRaw;}if(s.dataSource.equals(this.model.allDataSource)===true){this.numberObjectDataSuggestions++;this.suggestionTermBuffer.addTerm(s.labelRaw);var l;if(this.firstSuggestionTerm===s.labelRaw&&this.model.getDataSource().equals(this.model.allDataSource)){l=this.assembleSearchInSuggestionLabel(s);}else{l=s.label;}this.suggestions.push({label:l,labelRaw:s.labelRaw,position:a.objectData.position,type:a.SUGGESTION_TYPE_OBJECT_DATA,dataSource:this.model.getDataSource()});}else{if(this.firstSuggestionTerm!==s.labelRaw){return;}if(!this.model.getDataSource().equals(this.model.allDataSource)){return;}this.numberObjectDataSuggestions++;this.suggestions.push({label:this.assembleSearchInSuggestionLabel(s),labelRaw:s.labelRaw,position:a.objectData.position,type:a.SUGGESTION_TYPE_OBJECT_DATA,dataSource:s.dataSource});}},formatHistorySuggestion:function(s){if(this.numberHistorySuggestions>=a.history.limit){return;}if(s.dataSource.equals(this.model.allDataSource)!==true){return;}if(this.suggestionTermBuffer.hasTerm(s.labelRaw)){return;}this.numberHistorySuggestions++;this.suggestions.push({label:s.label,labelRaw:s.labelRaw,position:a.history.position,type:a.SUGGESTION_TYPE_HISTORY,dataSource:this.model.getDataSource()});},assembleSearchInSuggestionLabel:function(s){return s.label+' <i>in '+s.dataSource.label+"</i>";}});})();
