/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");sap.ui.base.Object.extend("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler",{constructor:function(b,j,s,S,t,p,a,B){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");this._oFilterConstants=new sap.collaboration.components.socialtimeline.filter.FilterType();this._oBusinessObjectMap=b;this._sBusinessObjectKey="";this._oJamDataHandler=j;this._oSMIntegrationDataHandler=s;this._oServiceDataHandler=S;this._oTimelineTermsUtility=t;this._bSocialFeaturesEnabled=a;this._bBackendFeaturesEnabled=B;this._iPageSize=p;this._iTimelineEntriesPageSize=p;this._iTimelineEntriesSkip=0;this._iFeedEntriesPageSize=p*2;this._sFeedEntriesNextLink="";this._fCustomActionCallBack=b.customActionCallback;this._aTimelineEntries=[];this._aFeedEntries=[];this._oMemberDataBuffer={};},setBusinessObject:function(o){this.reset();this._sBusinessObjectKey=o.key;this._sBusinessObjectName=o.name;if(this._oTimelineEntriesReadRequest){this._oTimelineEntriesReadRequest.abort();}if(this._oFeedEntriesReadRequest){this._oFeedEntriesReadRequest.abort();}},reset:function(){this._iTimelineEntriesSkip=0;this._sFeedEntriesNextLink="";this._aTimelineEntries=[];this._aFeedEntries=[];},getExternalObjectFromInternalObject:function(){var t=this;var i={"appContext":this._oBusinessObjectMap.applicationContext,"collection":this._oBusinessObjectMap.collection,"name":this._sBusinessObjectName,"key":this._sBusinessObjectKey,"odataServicePath":this._oBusinessObjectMap.servicePath};var p=this._oSMIntegrationDataHandler.mapInternalBOToExternalBO(i).then(function(e){e.Name=t._sBusinessObjectName;return t._oJamDataHandler.getExternalObject(e);});return p.promise();},getTimelineData:function(f){var p=jQuery.Deferred();if(f.type===this._oFilterConstants.FILTER_TYPE.feedUpdates){p=this._getExternalObjectFeedEntries();}else if(f.type===this._oFilterConstants.FILTER_TYPE.systemUpdates||f.type===this._oFilterConstants.FILTER_TYPE.custom){p=this._getTimelineEntries(f);}else{this._oLogger.error("The filter type is invalid.");p.resolve([]);}return p.promise();},_getExternalObjectFeedEntries:function(){var t=this;var p=this.getExternalObjectFromInternalObject().then(function(e){t.setCurrentExternalBOId(e.Id);if(t._sFeedEntriesNextLink==undefined){var g=jQuery.Deferred();g.resolve({"results":[]},null);return{request:null,promise:g};}else if(t._sFeedEntriesNextLink==""){return t._oJamDataHandler.getFeedEntries(e.Id);}else{return t._oJamDataHandler.getFeedEntries(e,t._sFeedEntriesNextLink);}}).then(function(g){t._oFeedEntriesReadRequest=g.request;return g.promise;}).then(function(f){t._sFeedEntriesNextLink=f.__next;return f.results;}).then(function(f){return t._mapFeedEntriesToTimelineItems(f);});return p.promise();},_getTimelineEntries:function(f){var b=f.type;if(b!==this._oFilterConstants.FILTER_TYPE.custom){b=undefined;}else{b=f.value;}var t=this;var r=this._oServiceDataHandler.readTimelineEntries(this._oBusinessObjectMap.collection,this._sBusinessObjectKey,b,this._iTimelineEntriesSkip,this._iTimelineEntriesPageSize);this._oTimelineEntriesReadRequest=r.request;var g=r.promise.then(function(T){t._iTimelineEntriesSkip+=t._iTimelineEntriesPageSize;return t._mapTimelineEntriesToTimelineItems(T);}).then(function(T){if(t._bSocialFeaturesEnabled===true){return t._fillPicturesForTimelineItems(T);}return T;});return g.promise();},_fillPicturesForTimelineItems:function(t){var a=this;var p=jQuery.Deferred();var e=[];t.forEach(function(T){if(!T.timelineItemData.userPicture){e.push(T.timelineItemData.userEmail);}});var u=e.filter(function(b,i){return e.indexOf(b)==i;});if(u.length>0){var g=this._oJamDataHandler.getUserInfoBatch(u);g.promise.done(function(U){var b=jQuery.grep(U,function(o){return o.results.length>0;});b.forEach(function(o){a.addUserInfoToBuffer(o.results[0]);});t.forEach(function(T){if(!T.timelineItemData.userPicture){T.timelineItemData.userPicture=a.getUserPicture(T.timelineItemData.userEmail);}});p.resolve(t);});g.promise.fail(function(E){p.resolve(t);});}else{p.resolve(t);}return p.promise();},_getAtMentions:function(f){var a={};var g=this._oJamDataHandler.getAtMentions(f.Id);g.promise.done(function(j,r){var J=j.results;for(var i=0;i<J.length;i++){if(J[i]){a[i]=J[i];}}});g.promise.fail(function(){this._oLogger.error('Failed to get the @mentions.');});return a;},_mapFeedEntriesToTimelineItems:function(f){var t=this;var T=[];f.forEach(function(F){var o={};o.timelineItemData=t._mapFeedEntryToTimelineItem(F);o._feedEntryData=F;if(F.ConsolidatedCount>1){o._feedEntryData._consolidatedUrl="https://integration3.sapjam.com/feed/consolidated/"+F.Id;}T.push(o);});return T;},_mapFeedEntryToTimelineItem:function(f){var P="sap-icon://post";if(!this.getUserInfoFromBuffer(f.Creator.Email)){this.addUserInfoToBuffer(f.Creator);}var t={feedId:f.Id,dateTime:f.CreatedAt,userName:f.Creator.FullName,userEmail:f.Creator.Email,title:f.Action,text:f.Text,textWithPlaceholders:f.TextWithPlaceholders,replyCount:f.RepliesCount,icon:P};t.userPicture=this.getUserPicture(t.userEmail);return t;},_mapTimelineEntriesToTimelineItems:function(t){var a=this;var T=[];t.forEach(function(o){var b={};b.timelineItemData=a._mapTimelineEntryToTimelineItem(o);var c=undefined;if(a._fCustomActionCallBack){c=a._fCustomActionCallBack(o);if(c){var C=true;if(!jQuery.isArray(c)){a._oLogger.error("The type defined for the return statement of the function 'customActionCallback' is "+typeof(c)+", expected type is array. Custom actions have been removed.");C=false;}else{for(var i=0;i<c.length;i++){if(typeof(c[i])!=='object'){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(c[i])+" of type "+typeof(c[i])+", expected type is object. Custom actions have been removed.");C=false;break;}else if(!c[i].key||!c[i].value){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(c[i])+" with the property 'key' or 'value' as undefined. Custom actions have been removed.");C=false;break;}else if(typeof(c[i].value)!=='string'){a._oLogger.error("The function 'customActionCallback' returned the item "+JSON.stringify(c[i])+" with the property 'value' as type "+typeof(c[i].value)+", expected type is string. Custom actions have been removed.");C=false;break;}}}if(C){c.oDataEntry=o;b.timelineItemData.customActionData=c;}}}T.push(b);});return T;},_mapTimelineEntryToTimelineItem:function(t){var T=this._oTimelineTermsUtility.getTimelineEntryFields(this._oBusinessObjectMap.collection);var o={dateTime:t[T.TimeStamp],userName:t[T.ActorName],userEmail:t[T.ActorExtID].toLowerCase(),title:t[T.ActionText],text:t[T.SummaryText],icon:t[T.Icon],timelineEntryDetails:this._processTimelineEntryDetails(t[T.TimelineDetailNavigationPath].results,this._oBusinessObjectMap.collection)};o.userPicture=this.getUserPicture(o.userEmail);return o;},_processTimelineEntryDetails:function(t,e){var a=this;var T=[];var o=a._oTimelineTermsUtility.getTimelineEntryDetailFields(e);t.forEach(function(b){var d={};d.afterValue=b[o.AfterValue];d.beforeValue=b[o.BeforeValue];d.changeType=b[o.ChangeType];d.propertyLabel=b[o.PropertyLabel];T.push(d);});return T;},getUserPicture:function(u){var m=this.getUserInfoFromBuffer(u);if(!m){return"";}return m.picture;},buildImageUrl:function(o){return this._oJamDataHandler._oCollabModel.sServiceUrl+"/"+o.__metadata.uri+"/ThumbnailImage/$value";},addUserInfoToBuffer:function(m){var u=this.buildImageUrl(m);var U=m.Email.toLowerCase();this._oMemberDataBuffer[U]={"email":U,"fullname":m.FullName,"id":m.Id,"address":m.MemberProfile.Address,"title":m.Title,"role":m.Role,"picture":u};},getUserInfoFromBuffer:function(u){var U=u.toLowerCase();return this._oMemberDataBuffer[U];},setCurrentExternalBOId:function(e){this._sCurrentExternalBOId=e;},getCurrentExternalBOId:function(){return this._sCurrentExternalBOId;}});
