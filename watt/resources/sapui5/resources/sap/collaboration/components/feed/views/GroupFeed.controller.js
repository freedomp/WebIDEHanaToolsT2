/*
* ! @copyright@
*/
sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/suite/ui/commons/TimelineItem","sap/m/MessageBox","sap/collaboration/components/utils/LanguageBundle","sap/collaboration/components/utils/DateUtil","sap/collaboration/components/controls/FeedEntryEmbedded","sap/collaboration/components/controls/ReplyPopover","sap/collaboration/components/controls/AddPostPopover","sap/collaboration/components/controls/FilterPopover","sap/collaboration/components/feed/GroupIDsMode","sap/collaboration/components/feed/BOMode"],function(q,C,T,M,L,D,F,R,A,a,G,B){"use strict";var c="sap.collaboration.components.feed.views.GroupFeed";var j="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData";var s="/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV";var g=C.extend(c,{onInit:function(){this._initializeUtilities();this._initializeRequestStateData();this._initializeSystemData();this._initializeModels();this._initializeTimeline();},onBeforeRendering:function(){if(!this._isJamConfigured()){this._displayErrorMessage();}},onAfterRendering:function(){},onExit:function(){this._abortAllPendingRequests();this.byId("filter_popover").destroy();this.byId("addPost_popover").destroy();},_initializeUtilities:function(){this._oLogger=new q.sap.log.getLogger(c);this._oLanguageBundle=new L();this._oDateUtil=new D();},_initializeSystemData:function(){this._oModes={};this._mCurrentUser;},_initializeRequestStateData:function(){this._oNextLinks={"feedEntriesNextLink":"","repliesNextLink":""};this._oPendingRequests={"loadingFeedEntriesRequest":undefined,"loadingRepliesRequest":undefined,"loadingSuggestionsRequest":undefined,"loadingFeedAtMentions":undefined,"refreshingSecurityToken":undefined};this._oPostRequestData={"path":undefined,"payload":undefined,"parameters":undefined};},_initializeModels:function(){var i=this._oLanguageBundle.createResourceModel();this.getView().setModel(i,"i18n");this._i18nModel=i;var S=new sap.ui.model.odata.ODataModel(s,true);this.getView().setModel(S,"smi");this._oSMIModel=S;var J=new sap.ui.model.odata.v2.ODataModel(j);J.attachMetadataFailed(this._onMetadataFailed,this);J.attachRequestCompleted(this._onJamRequestCompleted,this);J.attachRequestFailed(this._onJamRequestFailed,this);J.attachRequestSent(this._onJamRequestSent,this);J.attachBatchRequestCompleted(this._onBatchCompleted,this);J.attachBatchRequestFailed(this._onBatchFailed,this);J.attachBatchRequestSent(this._onBatchSent,this);this.getView().setModel(J,"jam");this._oJamModel=J;var v=new sap.ui.model.json.JSONModel();v.setData({"feedSources":undefined,"axisOrientation":undefined,"enableSocial":true,"enableScroll":false,"forceGrowing":true,"growingThreshold":20,"groupSelectorEnabled":true,"groupSelected":{},"groups":[],"filterEnabled":false,"filter":[],"filterMessage":"","url":undefined,"addPostButtonEnabled":true,});v.bindProperty("/feedSources").attachChange(this._onFeedSourcesChange,this);v.bindProperty("/url").attachChange(this.onUrlChange,this);v.bindProperty("/filterMessage").attachChange(this.onFilterMessageChange,this);this.getView().setModel(v);this._oViewDataModel=v;},_initializeTimeline:function(){var t=this.byId("timeline");t.setContent([]);this._modifyHeaderBar();this._createSocialProfile();},_modifyHeaderBar:function(){var h=this.byId("timeline").getHeaderBar();h.removeAllContent();var o=this._createGroupSelector();h.insertContent(o,0);var S=new sap.m.ToolbarSpacer(this.createId("header_spacer"));h.insertContent(S,1);var f=this._createFilterButton();h.insertContent(f,2);var b=this._createAddPostButton();h.insertContent(b,3);},_createGroupSelector:function(){var o=new sap.m.Button(this.createId("groupSelect_button"),{icon:"sap-icon://navigation-down-arrow",iconFirst:false,text:"{/groupSelected/Name}",width:"20em",enabled:"{/groupSelectorEnabled}",type:sap.m.ButtonType.Transparent,press:[this.onGroupSelectorButtonPress,this]});o.setModel(this._oViewDataModel);return o;},_createFilterButton:function(){if(!this.byId("filter_popover")){var S=new sap.m.StandardListItem(this.createId("filterListItem"),{title:"{text}"});new a(this.createId("filter_popover"),{title:this._oLanguageBundle.getText("ST_FILTER_HEADER"),}).setModel(this._oViewDataModel).bindItems("/filter",S);}var f=new sap.m.Button(this.createId("filter_button"),{enabled:"{/filterEnabled}",visible:"{/filterEnabled}",icon:"sap-icon://filter",type:sap.m.ButtonType.Transparent,press:[function(){this.byId("filter_popover").openBy(this.byId("filter_button"));},this]}).setModel(this._oViewDataModel);return f;},_createAddPostButton:function(){if(this.byId("addPost_popover")===undefined){new A(this.createId("addPost_popover"),{notifyAllEnabled:true,postPress:[this.onAddPost,this],suggest:[this.onSuggest,this],afterSuggestionClose:[function(){this._oPendingRequests.loadingSuggestionsRequest&&this._oPendingRequests.loadingSuggestionsRequest.abort();},this]});}var o=new sap.m.Button(this.createId("addPost_button"),{enabled:"{/addPostButtonEnabled}",icon:"sap-icon://add",type:sap.m.ButtonType.Transparent,press:[function(){this.byId("addPost_popover").openBy(this.byId("addPost_button"));},this]});o.setModel(this._oViewDataModel);return o;},_clearTimeline:function(){var t=this.byId("timeline");t.destroyContent();},_createTimelineItem:function(f){var o=new sap.ui.model.json.JSONModel(f);var b=new F(this.createId(f.Id+"_embedded"),{"feedEntry":"{/}","atMentionClick":[this.onAtMentionClicked,this]});var r=new R(this.createId("replyPostPopover_"+f.Id),{notifyAllEnabled:true,postReplyPress:[this.onPostReplyPress,this],moreRepliesPress:[function(e){var t=e.getSource().getParent();this._getReplies(undefined,t.getModel().getData().Replies.__next,t);},this],suggest:[this.onSuggest,this],afterSuggestionClose:[function(){if(this._oPendingRequests.loadingSuggestionsRequest){this._oPendingRequests.loadingSuggestionsRequest.abort();}},this],afterClose:[function(){if(this._oPendingRequests.loadingRepliesRequest){this._oPendingRequests.loadingRepliesRequest.abort();}},this]});var m=new sap.ui.core.CustomData({key:"1",value:this._oLanguageBundle.getText("ST_MORE_CUSTOM_ACTION")});var t=new T(this.createId(f.Id),{"dateTime":"{/CreatedAt}","userName":"{/Creator/FullName}","title":"{/Action}","text":"{/Text}","icon":"sap-icon://post","userNameClickable":this._oViewDataModel.getProperty("/enableSocial"),"userNameClicked":[this.onUserNameClicked,this],"userPicture":{path:"/Creator/Id",formatter:this._buildThumbnailImageURL.bind(this)},"replyCount":"{/RepliesCount}","embeddedControl":b,"customReply":r,"replyListOpen":[this.onReplyListOpen,this],"customAction":m,"customActionClicked":[this.onMoreClicked,this]});t.setModel(o);return t;},_addFeedEntriesToTimeline:function(f){var t=this.byId("timeline");f.forEach(function(o){var b=this._createTimelineItem(o);t.addContent(b);},this);},_processFeedEntries:function(f){if(f.length>0){this._addFeedEntriesToTimeline(f);}else{this._oViewDataModel.setProperty("/forceGrowing",false);}this._setTimelineToNotBusy();},_createSocialProfile:function(){this._oSocialProfile=new sap.ui.getCore().createComponent("sap.collaboration.components.socialprofile");return this._oSocialProfile;},_setTimelineToBusy:function(){var t=this.byId("timeline");t.setBusyIndicatorDelay(0).setBusy(true);},_setTimelineToNotBusy:function(){var t=this.byId("timeline");t.setBusyIndicatorDelay(0).setBusy(false);},onGrow:function(e){if(!this._oPendingRequests.loadingFeedEntriesRequest||!this._oPendingRequests.loadingFeedEntriesRequest.state()!="pending"){var u=this._oViewDataModel.getProperty("/url");this._loadFeedEntries(u).done(function(d,r){var f=d.results;this._processFeedEntries(f);});}},onGroupSelectorButtonPress:function(e){this._oMode.onGroupSelectorButtonPress(e);},onGroupSelectorUpdateStarted:function(o){this._oMode.onGroupSelectorUpdateStarted(o);},onGroupSelectorUpdateFinished:function(o){this._oMode.onGroupSelectorUpdateFinished(o);},onGroupSearch:function(o){this._oMode.onGroupSearch(o);},onAddPost:function(e){var t=this;var b=e.getParameter("value");this._getLoggedInUser();if(b&&b.trim()!==""){this._setTimelineToBusy();var S=function(d,r){t._setTimelineToNotBusy();var h=d.results;h.Creator=t._mCurrentUser;var i=t._createTimelineItem(h);t.byId("timeline").insertContent(i,0);};var f=function(E){t._oLogger.error("Error occured when adding a post.",E.stack);};var m=this._oMode.addPost(b,this._oViewDataModel.getProperty("/groupSelected/Id"));this._oPostRequestData={"path":m.path,"payload":m.payload};this._oPostRequestData.parameters={success:S,error:f};var o=m.promise;o.then(S,f);}else{this._oLogger.info('Posting an empty comment is not allowed, no feed entry will be created.');}},onReplyListOpen:function(e){var t=e.getSource();var f=t.getModel().getProperty("/Id");this._getReplies(f,undefined,t);},onPostReplyPress:function(e){var t=this;var v=e.getParameter("value");var o=e.getSource().getParent();var b=o.getCustomReply();var f=o.getModel().getData().Id;var p="/FeedEntries('"+q.sap.encodeURL(f)+"')/Replies";var d={"Text":v};this._getLoggedInUser();var P={"async":true,"success":function(h,r){b.setBusy(false);var J=h.results;var i={"CreatedAt":t._oDateUtil.formatDateToString(J.CreatedAt),"Text":J.Text,"Creator":t._mCurrentUser};i.Creator.ThumbnailImage=t._buildThumbnailImageURL(t._mCurrentUser.Id);b.addReply(i);o.getModel().setProperty("/RepliesCount",o.getModel().getProperty("/RepliesCount")+1);},"error":function(E){t._oLogger.error("Failed to post reply: "+E.statusText,E.stack);}};b.getTextArea().focus();b.setBusyIndicatorDelay(0).setBusy(true);this._oPostRequestData={"path":p,"payload":d,"parameters":P};this._oJamModel.create(p,d,P);},onSuggest:function(e){var t=this;if(this._oPendingRequests.loadingSuggestionsRequest){this._oPendingRequests.loadingSuggestionsRequest.abort();}var p=e.getSource();var v=e.getParameter("value");if(v.trim()===""){p.setSuggestionData([]);}else{var P="/Members_Autocomplete";var b=this._oViewDataModel.getProperty("/groupSelected/Id");var m={"async":true,"urlParameters":{"Query":"'"+v+"'","GroupId":"'"+b+"'","$top":"4"},"success":function(o,r){d.resolveWith(t,[o,r]);},"error":function(E){t._oLogger.error("Failed to get suggestions: "+E.statusText);d.rejectWith(t,[E]);}};var d=q.Deferred();d.done(function(o,r){var J=o.results;if(J.length===0){p.closeSuggestionPopover();}else{var S=[];var f=J.length;for(var i=0;i<f;i++){S.push({fullName:J[i].FullName,email:J[i].Email,userImage:t._buildThumbnailImageURL(J[i].Id)});}p.setSuggestionData(S);}});this._oPendingRequests.loadingSuggestionsRequest=d.promise(this._oJamModel.read(P,m));}},onUserNameClicked:function(o){var t=o.getSource();var b=t.getModel();var S={openingControl:t._userNameLink,memberId:b.getProperty("/Creator/Email")};this._oSocialProfile.setSettings(S);this._oSocialProfile.open();},onMoreClicked:function(o){var f=o.getSource().getModel().getProperty("/WebURL");var b=o.getSource().getModel().getProperty("/Id");var S=o.getSource().getParent().getModel().getProperty("/groupSelected/Name");var d=o.getSource().getParent().getModel().getProperty("/groupSelected/WebURL");var m=this.byId(this.createId("moreListPopover_"+b));if(m===undefined){var e=new sap.m.List(this.createId("moreList_"+b),{});var h=new sap.m.Link(this.createId("groupNameLink_"+b),{text:this._oLanguageBundle.getText("ST_GROUP_NAME_LINK",S),target:"_blank",href:d}).addStyleClass("sapCollaborationCustomLinkPadding");var i=new sap.m.CustomListItem(this.createId(b+"_groupNameLinkListItem"),{content:h});e.addItem(i);var k=new sap.m.Link(this.createId("feedEntryLink_"+b),{text:this._oLanguageBundle.getText("ST_FEED_ENTRY_LINK"),target:"_blank",href:f}).addStyleClass("sapCollaborationCustomLinkPadding");var l=new sap.m.CustomListItem(this.createId("feedEntryLinkListItem_"+b),{content:k});e.addItem(l);m=new sap.m.ResponsivePopover(this.createId("moreListPopover_"+b),{content:e,showHeader:false,placement:sap.m.PlacementType.VerticalPreferedBottom});}m.openBy(o.getParameter("linkObj"));},onAtMentionClicked:function(o){if(this._oPendingRequests.loadingFeedAtMentions&&this._oPendingRequests.loadingFeedAtMentions.state("pending")){this._oPendingRequests.loadingFeedAtMentions.abort();}var f=o.getSource().getModel().getProperty("/Id");var u=o.getParameter("link");var p=u.getModel().getProperty("/placeholderIndex");var b=q.Deferred();var t=this;var P="/FeedEntries("+q.sap.encodeURL("'"+f+"'")+")/AtMentions";var m={"success":function(d,r){b.resolveWith(t,[d,r]);},"error":function(e){t._oLogger.error('Failed to retrieve the @mentions.');b.rejectWith(t,[e]);}};b.done(function(d,r){var e=d.results;var S={openingControl:u,memberId:e[p].Email};this._oSocialProfile.setSettings(S);this._oSocialProfile.open();});this._oPendingRequests.loadingFeedAtMentions=b.promise(this._oJamModel.read(P,m));},onUrlChange:function(e){if(this._oPendingRequests.loadingFeedEntriesRequest){this._oPendingRequests.loadingFeedEntriesRequest.abort();}this._initializeRequestStateData();this._oViewDataModel.setProperty("/forceGrowing",true);var u=e.getSource().getValue();this._loadFeedEntries(u).done(function(d,r){this._clearTimeline();var f=d.results;this._processFeedEntries(f);});},_onFeedSourcesChange:function(e){var f=e.getSource().getValue();var o;if(this._oMode){this._oMode.stop();}if(Array.isArray(f)){o=q.merge([],f);if(this._oModes[sap.collaboration.FeedType.GroupIds]===undefined){this._oModes[sap.collaboration.FeedType.GroupIds]=new G(this);}this._oMode=this._oModes[sap.collaboration.FeedType.GroupIds];}else if(Object.prototype.toString.call(f)==="[object Object]"&&f.mode&&f.mode===sap.collaboration.FeedType.GroupIds&&Array.isArray(f.data)){o=q.merge([],f.data);if(this._oModes[sap.collaboration.FeedType.GroupIds]===undefined){this._oModes[sap.collaboration.FeedType.GroupIds]=new G(this);}this._oMode=this._oModes[sap.collaboration.FeedType.GroupIds];}else if(Object.prototype.toString.call(f)==="[object Object]"&&f.mode&&f.mode===sap.collaboration.FeedType.BusinessObjectGroups&&Object.prototype.toString.call(f.data)==="[object Object]"&&Object.prototype.toString.call(f.data.appContext)==="[object String]"&&Object.prototype.toString.call(f.data.odataServicePath)==="[object String]"&&Object.prototype.toString.call(f.data.collection)==="[object String]"&&Object.prototype.toString.call(f.data.key)==="[object String]"&&Object.prototype.toString.call(f.data.name)==="[object String]"){if(this._oModes[sap.collaboration.FeedType.BusinessObjectGroups]===undefined){this._oModes[sap.collaboration.FeedType.BusinessObjectGroups]=new B(this,this._oLanguageBundle);}o=f.data;this._oMode=this._oModes[sap.collaboration.FeedType.BusinessObjectGroups];}else{this._oLogger.error("The paramater feedSources is not valid.");this._displayErrorMessage();return;}this._oMode.start(o);},onFilterMessageChange:function(e){var t=e.getSource().getValue();this.byId("timeline").setCustomMessage(t);},_onMetadataFailed:function(e){switch(e.oSource.sServiceUrl){case j:this._oLogger.error("Failed to load Jam metadata.");this._displayJamConnectionErrorMessage();break;case s:this._oLogger.error("Failed to load SMIv2 metadata.");this._displayErrorMessage();break;}this._disableGroupFeed();},_onJamRequestCompleted:function(e){var m=e.getParameter("method");if(e.success&&m==="POST"){this._oPendingRequests.refreshingSecurityToken=undefined;}},_onJamRequestFailed:function(e){this._setTimelineToNotBusy();var m=e.getParameter("method");var u=e.getParameter("url");var S=parseInt(e.getParameter("response").statusCode,10);if(/ExternalObjects_FindByExidAndObjectType/.test(u)){this._disableGroupFeed();return;}switch(S){case 403:if(m==="POST"){if(this._oPendingRequests.refreshingSecurityToken===undefined){this._refreshSecurityToken().done(function(d,r){this._oJamModel.create(this._oPostRequestData.path,this._oPostRequestData.payload,this._oPostRequestData.parameters);});}else{this._oPendingRequests.refreshingSecurityToken=undefined;this._displayErrorMessage(this._oLanguageBundle.getText('JAM_NO_ACCESS_TO_POST_TO_GROUP'));}}else{this._displayErrorMessage(this._oLanguageBundle.getText('JAM_FORBIDDEN_ACCESS'));}break;case 404:if(/Groups\(.*\)\/FeedEntries/.test(u)){this._displayErrorMessage(this._oLanguageBundle.getText('JAM_NO_ACCESS_TO_GROUP'));this._disableGroupFeed();}else if(/Groups\(.*\)/.test(u)){this._displayErrorMessage(this._oLanguageBundle.getText('JAM_NO_ACCESS_TO_GROUP'));this._disableGroupFeed();}else{this._displayErrorMessage();}break;case 500:case 503:this._displayJamConnectionErrorMessage();break;default:this._displayErrorMessage();}},_onJamRequestSent:function(e){},_onBatchCompleted:function(e){this._oJamModel.setUseBatch(false);this._oMode.onBatchCompleted(e);},_onBatchFailed:function(e){},_onBatchSent:function(e){},_abortAllPendingRequests:function(){if(this._oPendingRequests.loadingFeedEntriesRequest){this._oPendingRequests.loadingFeedEntriesRequest.abort();}if(this._oPendingRequests.loadingRepliesRequest){this._oPendingRequests.loadingRepliesRequest.abort();}if(this._oPendingRequests.loadingSuggestionsRequest){this._oPendingRequests.loadingSuggestionsRequest.abort();}},_isJamConfigured:function(){var S=this.getView().getModel("smi");if(this._bIsJamConfigured===undefined){var t=this;var p="/GetJamConfigurationStatus";var P={"async":false,"success":function(d,r){t._bIsJamConfigured=true;},"error":function(e){t._bIsJamConfigured=false;t._oLogger.error("Error in the Social Media Integration configuration for the connection to SAP Jam.");t._disableGroupFeed();}};S.read(p,P);}return this._bIsJamConfigured;},_refreshSecurityToken:function(){var t=this;var r=q.Deferred();return this._oPendingRequests.refreshingSecurityToken=r.promise(this._oJamModel.refreshSecurityToken(function(d,b){t._oLogger.info("Security token refreshed");r.resolveWith(t,[d,b]);},function(S){t._oLogger.error("Security token error: "+S.statusText);r.rejectWith([S],t);}));},_getLoggedInUser:function(){if(!this._mCurrentUser){var t=this;var p="/Self";var P={"success":function(d,r){t._mCurrentUser=d.results;},"error":function(e){t._oLogger.error('Failed to get the logged in user',e.stack);}};this._oJamModel.read(p,P);}},_loadFeedEntries:function(u){if(!this._isJamConfigured()){return;}this._setTimelineToBusy();var n=this._oNextLinks.feedEntriesNextLink;if(n!==""){n=decodeURIComponent(n);var S=this._extractUrlParams(n).$skiptoken;}return this._oPendingRequests.loadingFeedEntriesRequest=this._oMode.getFeedEntries.apply(this,[u,S]);},_getReplies:function(f,n,t){var b=this;var p;var P={"async":true,"urlParameters":{'$orderby':'CreatedAt desc','$expand':'Creator'},"success":function(e,r){b._oLogger.info("Replies were successfully retrieved.");d.resolveWith(b,[e,r]);},"error":function(e){b._oLogger.error("Failed to retrieve replies: "+e.statusText);d.rejectWith(b,[e]);}};var o=t.getCustomReply();if(n){p="/"+n;P.urlParameters=this._extractUrlParams(decodeURIComponent(n));P.urlParameters.$orderby=P.urlParameters.$orderby.replace("+"," ");}else{p="/FeedEntries('"+q.sap.encodeURL(f)+"')/Replies";}var d=q.Deferred();d.done(function(e,r){var h=e.results.reverse();h.forEach(function(i){i.Creator.ThumbnailImage=b._buildThumbnailImageURL(i.Creator.Id);i.CreatedAt=b._oDateUtil.formatDateToString(i.CreatedAt);});o.addReplies({data:h,more:e.__next?true:false});t.getModel().getData().Replies.__next=e.__next;}).always(function(){o.setBusy(false);}).fail(function(){o._oReplyPopover.close();});o.setBusyIndicatorDelay(0).setBusy(true);this._oPendingRequests.loadingRepliesRequest=d.promise(this._oJamModel.read(p,P));},logError:function(e){this._oLogger.error(e);},getModel:function(n){return this.getView().getModel(n);},_displayErrorMessage:function(e){var m=e||this._oLanguageBundle.getText("SYSTEM_ERROR_MESSAGEBOX_GENERAL_TEXT");M.error(m);},_displayJamConnectionErrorMessage:function(){var m=this._oLanguageBundle.getText("JAM_CONNECTION_ERROR_MESSAGEBOX_TEXT");M.error(m);},_disableGroupFeed:function(){this._abortAllPendingRequests();var t=this.byId("timeline");if(!q.isEmptyObject(t)){t.setBusyIndicatorDelay(0).setBusy(false);this._clearTimeline();this._oViewDataModel.setProperty("/groupSelectorEnabled",false);this._oViewDataModel.setProperty("/addPostButtonEnabled",false);this._oViewDataModel.setProperty("/forceGrowing",false);}},_extractUrlParams:function(u){var U=u.slice(u.indexOf("?")+1);var b=U.split("&");var m={};b.forEach(function(d){var i=d.indexOf("=");m[d.slice(0,i)]=d.slice(i+1);});return m;},_buildThumbnailImageURL:function(u){return this._oJamModel.sServiceUrl+"/Members('"+q.sap.encodeURL(u)+"')/ThumbnailImage/$value";}});return g;},true);
