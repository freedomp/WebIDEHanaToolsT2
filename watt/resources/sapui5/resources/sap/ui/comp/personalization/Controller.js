/*
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','./ColumnsController','./FilterController','./GroupController','./SortController','./Util','sap/ui/comp/library'],function(q,M,C,F,G,S,U,a){"use strict";var b=M.extend("sap.ui.comp.personalization.Controller",{constructor:function(i,s){M.apply(this,arguments);},metadata:{publicMethods:["setPersonalizationData"],properties:{setting:{type:"object",defaultValue:null},resetToInitialTableState:{type:"boolean",defaultValue:true}},associations:{table:{type:"sap.ui.core.Control",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{},afterP13nModelDataChange:{parameters:{changeReason:{type:"sap.ui.comp.personalization.ResetType"},persistentData:{type:"object"},changeData:{type:"object"},changeType:{type:"sap.ui.comp.personalization.ChangeType"},changeTypeVariant:{type:"sap.ui.comp.personalization.ChangeType"}}}},library:"sap.ui.comp"}});b.prototype.setSetting=function(s){s=this.validateProperty("setting",s);this.setProperty("setting",s,true);if(!s){return this;}this._oSettingCurrent=U.copy(this._oSettingOriginal);for(var t in s){if(s[t].visible===false){delete this._oSettingCurrent[t];continue;}if(this._oSettingCurrent[t]&&this._oSettingCurrent[t].visible===true){this._oSettingCurrent[t].controller=s[t].controller?s[t].controller:this._oSettingCurrent[t].controller;this._oSettingCurrent[t].payload=s[t].payload?s[t].payload:undefined;this._oSettingCurrent[t].ignoreColumnKeys=s[t].ignoreColumnKeys?s[t].ignoreColumnKeys:[];}else{this._oSettingCurrent[t]={visible:s[t].visible,controller:s[t].controller?s[t].controller:undefined,payload:s[t].payload?s[t].payload:undefined,ignoreColumnKeys:s[t].ignoreColumnKeys?s[t].ignoreColumnKeys:[]};}}this._removeUnsupportedNamespaces();this._checkIgnoredColumnKeys();this._masterSync(b.SyncReason.NewSetting,null);return this;};b.prototype.setTable=function(t){this.setAssociation("table",t);if(!t){return this;}this._removeUnsupportedNamespaces();this._checkIgnoredColumnKeys();var c=this.getTable().getColumns();if(!U.isConsistent(c)){throw"The table instance provided contain some columns for which a columnKey is provided, some for which a columnKey is not provided. This is not allowed ! ";}this._masterSync(b.SyncReason.NewTable,null);return this;};b.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t);}return t;};b.prototype.getModel=function(){return this._oModel;};b.prototype.init=function(){var t=this;this._oDialog=null;this._oPayload=null;this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oModel=null;this._aColumnKeysOfDateType=[];this._oSettingOriginal={columns:{controller:new C({afterColumnsModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},sort:{controller:new S({afterSortModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},filter:{controller:new F({afterFilterModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true},group:{controller:new G({afterGroupModelDataChange:function(e){t._fireChangeEvent();},beforePotentialTableChange:function(e){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(e){t.fireAfterPotentialTableChange();}}),visible:true}};this._oSettingCurrent=U.copy(this._oSettingOriginal);this._oInitialVisiblePanelType=this._getInitialVisiblePanelType();};b.prototype.openDialog=function(s){this._masterSync(b.SyncReason.NewTableBinding,null);this._oDialog=new sap.m.P13nDialog({stretch:sap.ui.Device.system.phone,showReset:true,initialVisiblePanelType:this._oInitialVisiblePanelType,validationExecutor:q.proxy(this._handleDialogValidate,this)});this._oDialog.toggleStyleClass("sapUiSizeCompact",!!q(this.getTable().getDomRef()).closest(".sapUiSizeCompact").length);var o=this._mixSetting(this._oSettingCurrent,s);var p=this._callControllers(o,"getPanel");for(var t in o){if(p[t]){this._oDialog.addPanel(p[t]);}}this._oPersistentDataBeforeOpen=this._getPersistentDataCopy();this._oDialog.attachOk(this._handleDialogOk,this);this._oDialog.attachCancel(this._handleDialogCancel,this);this._oDialog.attachReset(this._handleDialogReset,this);this._oDialog.attachAfterClose(this._handleDialogAfterClose,this);this._oDialog.open();};b.prototype._mixSetting=function(s,o){if(!o){return s;}for(var t in o){if(o[t].visible&&s[t]&&s[t].visible){o[t].controller=s[t].controller;if(!o[t].payload){o[t].payload=s[t].payload;}}}return o;};sap.ui.comp.personalization.Controller.prototype._getSettingOfPanels=function(){if(!this._oDialog||!this._oDialog.getPanels()){return{};}var s={};this._oDialog.getPanels().forEach(function(p){var t=p.getType();s[t]={controller:this._oSettingCurrent[t].controller,visible:this._oSettingCurrent[t].visible};},this);return s;};b.prototype._getPersistentDataCopy=function(){var p={};if(this.getModel()&&this.getModel().getData().persistentData){p=U.copy(this.getModel().getData().persistentData);}return p;};b.prototype.setPersonalizationData=function(n){if(!this._sanityCheck(n)){return;}this._masterSync(b.SyncReason.NewModelData,n);if(this.getTable()&&this.getTable().setFixedColumnCount){this.getTable().setFixedColumnCount(0);}this._fireChangeEvent();};b.prototype.resetPersonalization=function(r){var R=this.getResetToInitialTableState();if(r===sap.ui.comp.personalization.ResetType.ResetFull||r===sap.ui.comp.personalization.ResetType.ResetPartial){R=(r===sap.ui.comp.personalization.ResetType.ResetFull);}if(R){this._masterSync(b.SyncReason.ResetModelData,null);this._fireChangeEvent(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._masterSync(b.SyncReason.ResetModelDataVariant,null);this._fireChangeEvent(sap.ui.comp.personalization.ResetType.ResetPartial);}};b.prototype._handleDialogReset=function(e){if(this.getResetToInitialTableState()){this._masterSync(b.SyncReason.ResetModelData,null);}else{this._masterSync(b.SyncReason.ResetModelDataVariant,null);}var r=this._getSettingOfPanels();this._callControllers(r,"onAfterReset",e.getParameter("payload"));};b.prototype._handleDialogCancel=function(e){this._oDialog.detachCancel(this._handleDialogCancel,this);this._oDialog.close();};b.prototype._handleDialogOk=function(e){this._oDialog.detachOk(this._handleDialogOk,this);this._oPayload={trigger:"ok",payload:e.getParameter("payload")};this._oDialog.close();};b.prototype._handleDialogValidate=function(p){var s=this._getSettingOfPanels();var P=this._callControllers(s,"getUnionData",U.copy(this._oPersistentDataRestore),this._getPersistentDataCopy());return sap.ui.comp.personalization.Util.validate(s,p,this.getTable(),P);};b.prototype._getInitialVisiblePanelType=function(){for(var t in this._oSettingCurrent){return t;}};b.prototype._handleDialogAfterClose=function(){var t=this;var _=this._oPayload;this._oInitialVisiblePanelType=this._oDialog.getVisiblePanel()?this._oDialog.getVisiblePanel().getType():this._getInitialVisiblePanelType();if(_&&_.trigger==="ok"){setTimeout(function(){var s=t._getSettingOfPanels();if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._callControllers(s,"onAfterSubmit",t._oPayload.payload);t._oPayload=null;t._fireChangeEvent();t._oPersistentDataBeforeOpen=null;},0);}else{setTimeout(function(){if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._masterSync(b.SyncReason.NewModelData,t._oPersistentDataBeforeOpen);t._oPersistentDataBeforeOpen=null;},0);}};b.prototype._masterSync=function(u,n){var t=null,j=null;switch(u){case b.SyncReason.NewTableBinding:this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");break;case b.SyncReason.NewTable:this.initializeModel();this._callControllers(this._oSettingCurrent,"setTable",this.getTable());this.getModel().setSizeLimit(this.getTable().getColumns().length+1000);this._callControllers(this._oSettingCurrent,"createTableRestoreJson");this._callControllers(this._oSettingCurrent,"syncTable2PersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");j=this._callControllers(this._oSettingCurrent,"getTableRestoreJson");this._oPersistentDataRestore=U.copy(j);this._oPersistentDataCurrentVariant={};this._aColumnKeysOfDateType=[];this._oPersistentDataAlreadyKnown=U.copy(this._oPersistentDataRestore);break;case b.SyncReason.NewSetting:this.initializeModel();if(this.getTable()){this._callControllers(this._oSettingCurrent,"setTable",this.getTable());this.getModel().setSizeLimit(this.getTable().getColumns().length+1000);}this._callControllers(this._oSettingCurrent,"setIgnoreColumnKeys");this._callControllers(this._oSettingCurrent,"createTableRestoreJson");this._callControllers(this._oSettingCurrent,"syncTable2PersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");j=this._callControllers(this._oSettingCurrent,"getTableRestoreJson");this._oPersistentDataRestore=U.copy(j);this._oPersistentDataAlreadyKnown=U.copy(this._oPersistentDataRestore);for(t in this._oPersistentDataRestore){if(!this._oSettingCurrent[t]){delete this._oPersistentDataRestore[t];}}for(t in this._oPersistentDataAlreadyKnown){if(!this._oSettingCurrent[t]){delete this._oPersistentDataAlreadyKnown[t];}}for(t in this._oPersistentDataCurrentVariant){if(!this._oSettingCurrent[t]){delete this._oPersistentDataCurrentVariant[t];}}break;case b.SyncReason.NewModelData:if(n===null){n={};}var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(n));this.initializeModel(p);this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",p);this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._oPersistentDataCurrentVariant=U.copy(n);break;case b.SyncReason.ResetModelData:var P=this._projectRestoreData2PersistentModel4Panels(this._oPersistentDataRestore);this.initializeModel(P);this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",U.copy(P));this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");break;case b.SyncReason.ResetModelDataVariant:var P=this._projectRestoreData2PersistentModel4Panels(this._oPersistentDataCurrentVariant);var o=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(P));this.initializeModel(o);this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",o);this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");break;default:}this.getModel().refresh();};b.prototype.initializeModel=function(n){if(!this.getModel()){this._oModel=new sap.ui.model.json.JSONModel();this._oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);}var N=null;if(n){N=U.copy(n);}var c=N||((this.getModel().getData()&&this.getModel().getData().persistentData)?this.getModel().getData().persistentData:{});for(var t in c){if(!this._oSettingCurrent[t]){delete c[t];}}this.getModel().setData({transientData:{},persistentData:c});this._callControllers(this._oSettingCurrent,"initializeModel",this.getModel());};b.prototype._fireChangeEvent=function(r){var c={};var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),this._getPersistentDataCopy());var s=this._callControllers(this._oSettingCurrent,"getChangeType",p,U.copy(this._oPersistentDataAlreadyKnown));var P=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(this._oPersistentDataCurrentVariant));c.changeTypeVariant=this._callControllers(this._oSettingCurrent,"getChangeType",p,P);var o=U.copy(this._oPersistentDataAlreadyKnown);c.changeType=this._callControllers(this._oSettingCurrent,"getChangeType",p,o);if(!U.hasChangedType(s)&&!U.hasChangedType(c.changeTypeVariant)){return;}if(!this._aColumnKeysOfDateType.length&&(U.isNamespaceChanged(c.changeType,sap.m.P13nPanelType.filter)||U.isNamespaceChanged(c.changeTypeVariant,sap.m.P13nPanelType.filter))){this._aColumnKeysOfDateType=U.getColumnKeysOfDateType(this.getTable());}if(r===sap.ui.comp.personalization.ResetType.ResetFull||r===sap.ui.comp.personalization.ResetType.ResetPartial){c.changeReason=r;}var d=this._callControllers(this._oSettingCurrent,"getChangeData",p,o);c.changeData=U.removeEmptyProperty(d);U.recoverPersonalisationData(c.changeData,this.getTable(),this._aColumnKeysOfDateType);var e=U.copy(this._oPersistentDataRestore);var f=this._callControllers(this._oSettingCurrent,"getChangeData",p,e);c.persistentData=U.removeEmptyProperty(f);U.recoverPersonalisationData(c.persistentData,this.getTable(),this._aColumnKeysOfDateType);this.fireAfterP13nModelDataChange(c);this._oPersistentDataAlreadyKnown=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataAlreadyKnown),U.copy(c.changeData));};b.prototype._projectRestoreData2PersistentModel4Panels=function(p){if(!this._oDialog||q.isEmptyObject(p)){return p;}var P=this._getPersistentDataCopy();var c=this._oDialog.getPanels();c.forEach(function(o){if(p[o.getType()]){P[o.getType()]=U.copy(p[o.getType()]);}else{delete P[o.getType()];}});return P;};b.prototype._checkIgnoredColumnKeys=function(){var t=this.getTable();if(!t){return;}var i=U.getUnionOfAttribute(this._oSettingCurrent,"ignoreColumnKeys");var v=U.getVisibleColumnKeys(t);i.some(function(s){if(v.indexOf(s)>-1){throw"The provided 'ignoreColumnKeys' are inconsistent. No columns specified as ignored is allowed to be visible.";}});var c=this;t.getColumns().forEach(function(o){var s=q.proxy(o.setVisible,o);var f=function(V){if(V){var i=U.getUnionOfAttribute(c._oSettingCurrent,"ignoreColumnKeys");if(i.indexOf(U.getColumnKey(this))>-1){throw"The provided 'ignoreColumnKeys' are inconsistent. No column specified as ignored is allowed to be visible. "+this;}}s(V);};if(o.setVisible.toString()===f.toString()){return;}o.setVisible=f;});};b.prototype._removeUnsupportedNamespaces=function(){var t=this.getTable();if(t&&t instanceof sap.ui.table.Table&&!(t instanceof sap.ui.table.AnalyticalTable)){delete this._oSettingCurrent.group;}};b.prototype._getArgumentsByType=function(A,t){var r=[],o=null;if(A&&A.length&&t){A.forEach(function(c){if(c&&c[t]&&typeof c[t]!=="function"){o={};o[t]=c[t];r.push(o);}else{r.push(c);}});}return r;};b.prototype._callControllers=function(s,m){var t=null,o=null,c=null,A=null;var r={},d=Array.prototype.slice.call(arguments,2);for(t in s){o=c=A=null;o=s[t];c=o.controller;if(!c||!o.visible||!c[m]){continue;}A=this._getArgumentsByType(d,t);if(m==="getPanel"){A.push(o.payload);}else if(m==="setIgnoreColumnKeys"){A.push(o.ignoreColumnKeys);}var R=c[m].apply(c,A);if(R!==null&&R!==undefined&&R[t]!==undefined){r[t]=R[t];}else{r[t]=R;}}return r;};b.prototype._sanityCheck=function(n){return true;};b.prototype.exit=function(){var t;if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}this._callControllers(this._oSettingCurrent,"destroy");for(t in this._oSettingCurrent){this._oSettingCurrent[t]=null;}this._oSettingCurrent=null;for(t in this._oSettingOriginal){this._oSettingOriginal[t]=null;}this._oSettingOriginal=null;if(this.getModel()){this.getModel().destroy();this._oModel=null;}this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oPayload=null;};b.SyncReason={NewTable:0,NewSetting:1,NewModelData:2,ResetModelData:3,ResetModelDataVariant:4,NewTableBinding:5};return b;},true);
