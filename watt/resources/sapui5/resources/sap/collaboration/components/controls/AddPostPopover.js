/*
* ! @copyright@
*/
jQuery.sap.declare("sap.collaboration.components.controls.AddPostPopover");jQuery.sap.require("sap.collaboration.components.controls.SuggestionUtility");jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.includeStyleSheet(jQuery.sap.getModulePath("sap.collaboration.components.resources.css.AddPostPopover",".css"));sap.ui.core.Control.extend("sap.collaboration.components.controls.AddPostPopover",{metadata:{library:"sap.collaboration",properties:{notifyAllEnabled:{type:"boolean",group:"Behavior",defaultValue:true}},events:{postPress:{parameters:{value:{type:"string"}}},suggest:{parameters:{value:{type:"string"}}},afterSuggestionClose:{}}}});
sap.collaboration.components.controls.AddPostPopover.prototype.init=function(){this._oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this._oLangBundle=this._oCommonUtil.getLanguageBundle();this._oSuggestionUtil=sap.collaboration.components.controls.SuggestionUtility;this._sId=this.getId();this._sTextAreaOldValue="";this._sTextAreaCurrentValue="";this._aAtMentionBuffer=[];this._oAddPostPopover=this._oAddPostPopover||this._createAddPostPopover();this._oSuggestionList;this._oSuggestionPopover=this._oSuggestionPopover||this._createSuggestionPopover();this._oSuggestionModel;this._aSuggestionModelData;};
sap.collaboration.components.controls.AddPostPopover.prototype.exit=function(){this._oAddPostPopover.destroy();this._oSuggestionPopover.destroy();};
sap.collaboration.components.controls.AddPostPopover.prototype.openBy=function(o){this._oAddPostPopover.openBy(o);};
sap.collaboration.components.controls.AddPostPopover.prototype.setSuggestionData=function(s){this._aSuggestionModelData=s;if(s.length!==0&&s[s.length-1].fullName!=="@@notify"&&this.getNotifyAllEnabled()){this._aSuggestionModelData.push({fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"});}this._oSuggestionModel.setData(this._aSuggestionModelData);this._oSuggestionPopover.openBy(this._oAddPostTextArea);};
sap.collaboration.components.controls.AddPostPopover.prototype.closeSuggestionPopover=function(){if(this._oSuggestionPopover.isOpen()===true){this._oSuggestionPopover.close();}this.fireAfterSuggestionClose();};
sap.collaboration.components.controls.AddPostPopover.prototype.setNotifyAllEnabled=function(n){var l;n?l="ST_NO_SUGGESTIONS":l="ST_ADD_POST_NO_SUGGESTIONS";this._oSuggestionList.setProperty("noDataText",this._oLangBundle.getText(l,["@@notify"]));this.setProperty("notifyAllEnabled",n);return this;};
sap.collaboration.components.controls.AddPostPopover.prototype._createAddPostPopover=function(){var a=new sap.m.ResponsivePopover(this._sId+"_addPostPopover",{title:this._oLangBundle.getText("ST_ADD_POST_TITLE"),contentWidth:"25rem",contentHeight:"10rem",placement:sap.m.PlacementType.Auto,content:[this._createTextArea()],beginButton:this._createMentionButton(),endButton:this._createPostButton()});a.setInitialFocus(this._oAddPostTextArea);return a;};
sap.collaboration.components.controls.AddPostPopover.prototype._createTextArea=function(){this._oAddPostTextArea=new sap.m.TextArea(this._sId+"_addPostTextArea",{height:"10rem",width:"100%",placeholder:this._oLangBundle.getText("ST_ADD_POST_TEXT_AREA"),liveChange:[function(e){this._sTextAreaCurrentValue=e.getParameter("value");if(this._sTextAreaCurrentValue.trim()===""){this._aAtMentionBuffer=[];this.closeSuggestionPopover();}else{this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);}this._sTextAreaOldValue=this._sTextAreaCurrentValue;this._enableDisablePostButton(this._sTextAreaCurrentValue);},this]}).addStyleClass("addPostTextArea");return this._oAddPostTextArea;};
sap.collaboration.components.controls.AddPostPopover.prototype._createPostButton=function(){var t=this;this._oAddPostButton=new sap.m.Button(this._sId+"_addPostButton",{text:this._oLangBundle.getText("ST_ADD_POST_BUTTON"),enabled:false,press:function(){t._oAddPostPopover.close();t._oAddPostButton.setEnabled(false);var v=t._oSuggestionUtil.convertTextWithFullNamesToEmailAliases(t._oAddPostTextArea.getValue(),t._aAtMentionBuffer);t.firePostPress({value:v});t._oAddPostTextArea.setValue("");t._sTextAreaOldValue="";t._aAtMentionBuffer=[];}});return this._oAddPostButton;};
sap.collaboration.components.controls.AddPostPopover.prototype._createMentionButton=function(){var m=new sap.m.Button(this._sId+"_mentionButton",{text:"@",tooltip:this._oLangBundle.getText("ST_MENTION_TOOLTIP"),press:[function(){var c=this._oAddPostTextArea.getDomRef("inner").selectionStart;var M=this._oSuggestionUtil.atMentionsButtonPressed(this._oAddPostTextArea.getValue(),c);this._oAddPostTextArea.setValue(M[0]);this._oAddPostTextArea.focus();this._oAddPostTextArea.selectText(M[1],M[1]);this._oAddPostTextArea.fireLiveChange({value:this._oAddPostTextArea.getValue()});},this]});return m;};
sap.collaboration.components.controls.AddPostPopover.prototype._createSuggestionPopover=function(){var s=new sap.m.ResponsivePopover(this._sId+"_sugestionPop",{showHeader:false,contentWidth:"25rem",placement:sap.m.PlacementType.Bottom,offsetY:-20,content:[this._addSuggestionList()]}).addStyleClass("suggestionPopover");s.setInitialFocus(this._oAddPostTextArea);return s;};
sap.collaboration.components.controls.AddPostPopover.prototype._addSuggestionList=function(){var s=new sap.m.StandardListItem({icon:"{userImage}",title:"{fullName}",description:"{email}",});this._aSuggestionModelData=[];this._oSuggestionModel=new sap.ui.model.json.JSONModel(this._aSuggestionModelData);this._oSuggestionList=new sap.m.List(this._sId+"_sugestionList",{mode:sap.m.ListMode.SingleSelectMaster,rememberSelections:false,showSeparators:sap.m.ListSeparators.None,selectionChange:[function(e){var f=e.getParameter("listItem").getProperty("title");var E=e.getParameter("listItem").getProperty("description");this._sTextAreaCurrentValue=this._oSuggestionUtil.getTextAreaValueAfterSuggestionSelected(f,E,this._mCurrentAtMention,this._aAtMentionBuffer,this._sTextAreaCurrentValue,f==="@@notify");this._oAddPostTextArea.setValue(this._sTextAreaCurrentValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;this.closeSuggestionPopover();this._oAddPostTextArea.selectText(this._mCurrentAtMention.endIndex+2,this._mCurrentAtMention.endIndex+2);},this]}).setModel(this._oSuggestionModel);this._oSuggestionList.bindItems("/",s);return this._oSuggestionList;};
sap.collaboration.components.controls.AddPostPopover.prototype._enableDisablePostButton=function(v){v.trim()!==""?this._oAddPostButton.setEnabled(true):this._oAddPostButton.setEnabled(false);};
sap.collaboration.components.controls.AddPostPopover.prototype._triggerSuggestions=function(t,T){var o=this._oSuggestionUtil.getChangesInTextArea(t,T);if(o.operation==="addChar"){this._handleAddedCharacters(o,t);}else if(o.operation==="deleteChar"){this._handleDeletedCharacters(o,t,this._aAtMentionBuffer);}};
sap.collaboration.components.controls.AddPostPopover.prototype._handleAddedCharacters=function(t,T){var a=t.changeIndex;var s=t.charactersChanged;var A=this._aAtMentionBuffer.length;var I=this.getNotifyAllEnabled();if(I&&s[0]==="@"&&T[a-1]==="@"&&(T[a-2]===" "||T[a-2]==="\n"||T[a-2]===undefined)){this.setSuggestionData([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);for(var i=0;i<A;i++){if(this._aAtMentionBuffer[i].startIndex===a-1){this._aAtMentionBuffer[i].endIndex+=s.length;}else if(a<this._aAtMentionBuffer[i].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);}}}else if(s[0]==="@"||(s[0]===" "&&s[1]==="@")){if(s[1]==="@"){a+=1;}var c=this._oSuggestionUtil.addToAtMentionBuffer(this._aAtMentionBuffer,a,s);this._mCurrentAtMention=this._aAtMentionBuffer[c];if(s==="@ "){this._mCurrentAtMention.endIndex-=1;}var C=T[this._mCurrentAtMention.startIndex-1];if(C===" "||C===undefined||C==='\n'){this.fireSuggest({value:T.substring(a+1,a+s.length)});}else{this.closeSuggestionPopover();}}else{for(var i=A-1;i>=0;i--){if(a>this._aAtMentionBuffer[i].startIndex){var S=this._oSuggestionUtil.getStringAfterAtMention(a+s.length-1,T,this._aAtMentionBuffer[i]);var b=this._oSuggestionUtil.getStringBeforeAtMention(this._aAtMentionBuffer[i],T,a);var q=b+s+S;var r=new RegExp("^"+q);if(I&&r.test("@notify")){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].endIndex+s.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];this.setSuggestionData([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else if(!q.match(/ /g)||(q.match(/ /g)&&q.match(/ /g).length===1)){if((this._aAtMentionBuffer[i].atMentioned===true||this._aAtMentionBuffer[i].notifyAll===true)&&a<=this._aAtMentionBuffer[i].endIndex){var d=this._aAtMentionBuffer[i].startIndex;var e=T.slice(0,d)+" "+T.slice(d+1,T.length);this._oAddPostTextArea.setValue(e);this._sTextAreaCurrentValue=e;this._aAtMentionBuffer.splice(i,1);this._oAddPostTextArea.selectText(a+1,a+1);this.closeSuggestionPopover();}else if(q.search("\n")===-1&&q.search("@")===-1){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].startIndex+q.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];var C=T[this._mCurrentAtMention.startIndex-1];if(C===" "||C===undefined||C==='\n'){this.fireSuggest({value:q});}}else{this.closeSuggestionPopover();}}else{this.closeSuggestionPopover();}break;}this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);if(i===0){this.closeSuggestionPopover();}}}};
sap.collaboration.components.controls.AddPostPopover.prototype._handleDeletedCharacters=function(t,T){var i=t.changeIndex;var s=t.charactersChanged;var c;var a=this._oSuggestionUtil.isDeletedCharPartOfAtMentioned(this._aAtMentionBuffer,i);if(a!==undefined){if(this._aAtMentionBuffer[a].atMentioned===true||this._aAtMentionBuffer[a].notifyAll===true){this.closeSuggestionPopover();this._sTextAreaCurrentValue=this._sTextAreaCurrentValue.substr(0,this._aAtMentionBuffer[a].startIndex)+this._sTextAreaCurrentValue.substr(this._aAtMentionBuffer[a].endIndex-t.numberOfCharsChanged+1);this._oAddPostTextArea.setValue(this._sTextAreaCurrentValue);this._oAddPostTextArea.selectText(this._aAtMentionBuffer[a].startIndex,this._aAtMentionBuffer[a].startIndex);this._sTextAreaOldValue=this._sTextAreaCurrentValue;c=1+this._aAtMentionBuffer[a].endIndex-this._aAtMentionBuffer[a].startIndex;this._aAtMentionBuffer.splice(a,1);}else{c=t.numberOfCharsChanged;var C=T[this._aAtMentionBuffer[a].startIndex-1];if(s.search("@")!==-1&&T[t.changeIndex-1]!=="@"){this.closeSuggestionPopover();this._aAtMentionBuffer.splice(a,1);}else if(C===" "||C===undefined||C==='\n'){this._aAtMentionBuffer[a].endIndex-=c;var v=T.substring(this._aAtMentionBuffer[a].startIndex+1,this._aAtMentionBuffer[a].endIndex+1);var r=new RegExp("^"+v);if(v!==""&&r.test("@notify")){this.setSuggestionData([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else{this.fireSuggest({value:v});}}}}a=a||0;c=c||t.numberOfCharsChanged;for(var j=a;j<this._aAtMentionBuffer.length;j++){if(i<this._aAtMentionBuffer[j].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[j],-c);}}};
