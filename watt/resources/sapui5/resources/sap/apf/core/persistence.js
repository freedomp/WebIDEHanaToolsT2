/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.persistence");jQuery.sap.require("sap.apf.core.constants");(function(){'use strict';sap.apf.core.Persistence=function(I){var t=this;var l;this.createPath=function(n,C,E){var R;var S=I.coreApi.serializePath();if(E){S.filterIdHandler=E.filterIdHandler;S.startFilterHandler=E.startFilterHandler;}var o=e(S);j().then(function(l){R={data:{AnalysisPath:"",AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"POST"};if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){R.data.AnalyticalConfiguration=I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId;}s(R,i.bind(t));},function(m){C({oResponse:undefined,status:"failed"},{},m);});function i(k,m,p){if(p){C({oResponse:k,status:"failed"},m,p);}else{I.messageHandler.check(k&&k.data&&k.statusCode===201&&k.statusText==="Created","Persistence create Path - proper response");C({AnalysisPath:k.data.AnalysisPath,status:"successful"},m,p);}}};this.readPaths=function(C){var R={method:"GET"};s(R,k.bind(this));function k(o,E,m){if(!m&&o&&o.data&&o.data.results){for(var i in o.data.results){o.data.results[i].StructuredAnalysisPath=JSON.parse(o.data.results[i].StructuredAnalysisPath);}}else if(!m||o.statusCode!==200||o.statusText!=="OK"){m=I.messageHandler.createMessageObject({code:'5211'});}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({paths:o.data.results,status:"successful"},E,m);}}};this.deletePath=function(A,C){var R={method:"DELETE"};s(R,i.bind(this),A);function i(o,E,m){if((o.statusCode!==204||o.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}));}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({status:"successful"},E,m);}}};this.modifyPath=function(A,n,C,E){var S=I.coreApi.serializePath();if(E){S.filterIdHandler=E.filterIdHandler;S.startFilterHandler=E.startFilterHandler;}var o=e(S);j().then(function(l){var i={data:{AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"PUT"};s(i,R.bind(this),A);},function(m){C({oResponse:undefined,status:"failed"},{},m);});function R(i,k,m){if((i.statusCode!==204||i.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[i.statusCode,i.statusText]}));}if(m){C({oResponse:i,status:"failed"},k,m);}else{C({AnalysisPath:A,status:"successful"},k,m);}}};this.openPath=function(A,C,n){var R={method:"GET"};s(R,i.bind(this),A);function i(o,E,m){var M;if(!m&&o&&o.statusCode===200&&o.data&&o.data.SerializedAnalysisPath){o.data.SerializedAnalysisPath=JSON.parse(o.data.SerializedAnalysisPath);m=a(o.data,n);}if(m){M=I.messageHandler.createMessageObject({code:'5210'});M.setPrevious(m);I.messageHandler.putMessage(M);}if(M){C({oResponse:o,status:"failed"},E,M);}else{C({path:o.data,status:"successful"},E,M);}}};function s(R,L,A){var S=function(D,o){L(o,f(),undefined);};var E=function(o){var m;if(o.messageObject&&o.messageObject.getCode&&o.messageObject.getCode()===5021){L(o,f(),o.messageObject);return;}var i=c(o.response.body);if(i!==undefined){m=I.messageHandler.createMessageObject({code:i});}if(o.response.body.match("274")){m=I.messageHandler.createMessageObject({code:'5207'});}if(o.response.statusCode===400){m=I.messageHandler.createMessageObject({code:'5203'});}if(o.response.statusCode===403){m=I.messageHandler.createMessageObject({code:'5206'});}if(o.response.statusCode===405){m=I.messageHandler.createMessageObject({code:'5202'});}if(o.response.statusCode===404){m=I.messageHandler.createMessageObject({code:'5208'});}if(!m&&o.response.statusCode===500){m=I.messageHandler.createMessageObject({code:'5200',aParameters:[o.response.statusCode,o.response.statusText]});}if(!m){m=I.messageHandler.createMessageObject({code:'5201'});}I.messageHandler.putMessage(m);L(o,f(),m);};var u=d();R.headers={"x-csrf-token":I.coreApi.getXsrfToken(d())};switch(R.method){case"GET":if(!R.data&&A){R.requestUri=u+"('"+A+"')";I.coreApi.odataRequest(R,S,E);}else if(!R.data&&!A){g().then(function(i){R.requestUri=u+i;I.coreApi.odataRequest(R,S,E);},function(m){L({},f(),m);});}break;case"POST":if(R.data&&!A){R.requestUri=u;}I.coreApi.odataRequest(R,S,E);break;case"DELETE":if(!R.data&&A){R.requestUri=u+"('"+A+"')";}I.coreApi.odataRequest(R,S,E);break;case"PUT":if(R.data&&A){R.requestUri=u+"('"+A+"')";}I.coreApi.odataRequest(R,S,E);break;default:I.coreApi.odataRequest(R,S,E);break;}}function g(){var i=jQuery.Deferred();j().then(function(l){var k="";if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){k="AnalyticalConfiguration%20eq%20'"+I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId+"'%20and%20";}var u="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+k+"LogicalSystem%20eq%20'"+l+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+I.coreApi.getApplicationConfigurationURL()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";i.resolve(u);},function(m){i.fail(m);});return i.promise();}function c(E){var i=E.match("52[0-9]{2}");if(i){return i[0];}return undefined;}function a(R,n){var p;var m;function i(){I.messageHandler.putMessage=p;}function k(){p=I.messageHandler.putMessage;I.messageHandler.putMessage=function(m){var o=I.messageHandler.getConfigurationByCode(m.getCode());if(o&&o.severity&&o.severity==="warning"){return;}throw m;};}if(n!==undefined){R.SerializedAnalysisPath.path.indicesOfActiveSteps[0]=n;}I.coreApi.resetPath(true);k();try{I.coreApi.deserializePath(R.SerializedAnalysisPath);}catch(E){I.coreApi.restoreOriginalPath();m=b(E);}finally{i();}return m;}function b(E){var m;if(E.type&&E.type==="messageObject"){m=E;}else{m=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});m.setSeverity(sap.apf.core.constants.message.severity.error);m.setMessage("Unknown exception caught "+E.message);}return m;}function d(){var p=I.coreApi.getPersistenceConfiguration().path;var S=p.service+"/"+p.entitySet;return S;}function e(S){var k=[];var m=S.path.steps;var n;for(var i in m){k.push({stepId:m[i].stepId,selectedRepresentationId:m[i].binding.selectedRepresentationId});}n={steps:k,indexOfActiveStep:S.path.indicesOfActiveSteps[0]};return n;}function f(){var C=I.coreApi.getPersistenceConfiguration();var E=I.coreApi.getEntityTypeMetadata(C.path.service,C.path.entitySet);return E;}function h(C){var T=C&&C.getFilterTermsForProperty('SAPClient');if(T===undefined||T.length!==1){return undefined;}return T[0].getValue();}function r(i,k){var m=I.messageHandler;var n=I.coreApi.getPersistenceConfiguration().logicalSystem;if(!n){l=k;i.resolve(k);return i.promise();}var S=n.service;var E=n.entitySet||n.entityType;if(S===null){l=k;i.resolve(k);return i.promise();}if(E===undefined){E=sap.apf.core.constants.entitySets.logicalSystem;}var F=new sap.apf.core.utils.Filter(m,"SAPClient",'eq',k);var u=I.coreApi.getUriGenerator().getAbsolutePath(S);u=u+I.coreApi.getUriGenerator().buildUri(m,E,['LogicalSystem'],F,undefined,undefined,undefined,undefined,undefined,'Results');var R={requestUri:u,method:"GET",headers:{"x-csrf-token":I.coreApi.getXsrfToken(d())}};var o=function(D){var q;if(D&&D.results&&D.results instanceof Array&&D.results.length===1&&D.results[0].LogicalSystem){l=D.results[0].LogicalSystem;i.resolve(l);}else{q=m.createMessageObject({code:"5026",aParameters:[k]});i.fail(q);}};var p=function(q){var v=m.createMessageObject({code:"5026",aParameters:[k]});if(q.messageObject!==undefined&&q.messageObject.type==="messageObject"){v.setPrevious(q.messageObject);}i.fail(v);};I.coreApi.odataRequest(R,o,p);}function j(){var i=jQuery.Deferred();if(l){i.resolve(l);return i.promise();}var k=I.coreApi.getStartParameterFacade().getSapClient();if(k){r(i,k);return i.promise();}I.coreApi.getCumulativeFilter().done(function(C){k=h(C);if(!k){i.resolve('');}else{r(i,k);}});return i.promise();}};}());
