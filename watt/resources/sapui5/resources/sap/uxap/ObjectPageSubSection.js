/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright
		2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/CustomData','sap/ui/layout/Grid','./ObjectPageSectionBase','./ObjectPageSubSectionLayout','./ObjectPageSubSectionMode','./BlockBase','./library'],function(C,G,O,a,b,B,l){"use strict";var c=O.extend("sap.uxap.ObjectPageSubSection",{metadata:{library:"sap.uxap",properties:{mode:{type:"sap.uxap.ObjectPageSubSectionMode",group:"Appearance",defaultValue:b.Collapsed},titleUppercase:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"blocks",aggregations:{_grid:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},blocks:{type:"sap.ui.core.Control",multiple:true,singularName:"block"},moreBlocks:{type:"sap.ui.core.Control",multiple:true,singularName:"moreBlock"},actions:{type:"sap.ui.core.Control",multiple:true,singularName:"action"}}}});c.prototype.init=function(){O.prototype.init.call(this);this._bRenderedFirstTime=false;this._aAggregationProxy={blocks:[],moreBlocks:[]};this._$spacer=[];this._sContainerSelector=".sapUxAPBlockContainer";this._switchSubSectionMode(this.getMode());};c.prototype._expandSection=function(){O.prototype._expandSection.call(this);var p=this.getParent();p&&typeof p._expandSection==="function"&&p._expandSection();return this;};c.prototype._getGrid=function(){if(!this.getAggregation("_grid")){this.setAggregation("_grid",new sap.ui.layout.Grid({id:this.getId()+"-innerGrid",defaultSpan:"XL12 L12 M12 S12",hSpacing:1,vSpacing:1,width:"100%"}));}return this.getAggregation("_grid");};c.prototype.connectToModels=function(){var d=this.getBlocks()||[],m=this.getMoreBlocks()||[],s=this.getMode();d.forEach(function(o){if(o instanceof B){if(!o.getMode()){o.setMode(s);}o.connectToModels();}});if(m.length>0&&s===b.Expanded){m.forEach(function(M){if(M instanceof B){if(!M.getMode()){M.setMode(s);}M.connectToModels();}});}};c.prototype.exit=function(){if(this._oSeeMoreButton){this._oSeeMoreButton.destroy();this._oSeeMoreButton=null;}if(this._iResizeId){sap.ui.core.ResizeHandler.deregister(this._iResizeId);}if(O.prototype.exit){O.prototype.exit.call(this);}};c.prototype.onAfterRendering=function(){var o=this._getObjectPageLayout();if(O.prototype.onAfterRendering){O.prototype.onAfterRendering.call(this);}if(!o){return;}if(o.getSubSectionLayout()===a.TitleOnLeft){this._afterRenderingTitleOnLeftLayout();}this._$spacer=jQuery.sap.byId(o.getId()+"-spacer");};c.prototype.onBeforeRendering=function(){if(O.prototype.onBeforeRendering){O.prototype.onBeforeRendering.call(this);}this._setAggregationProxy();this._getGrid().removeAllContent();this._applyLayout(this._getObjectPageLayout());this.refreshSeeMoreVisibility();};c.prototype._applyLayout=function(L){var v,g=this._getGrid(),s=this.getMode(),d=L.getSubSectionLayout(),o=this._calculateLayoutConfiguration(d,L),e=this.getBlocks(),A=e.concat(this.getMoreBlocks());this._resetLayoutData(A);if(s===b.Expanded){v=A;}else{v=e;}this._calcBlockColumnLayout(v,o);try{v.forEach(function(f){this._setBlockMode(f,s);g.addContent(f);},this);}catch(E){jQuery.sap.log.error("ObjectPageSubSection :: error while building layout "+d+": "+E);}return this;};c.prototype._calculateLayoutConfiguration=function(L,o){var d={M:2,L:3,XL:4},i=d.L,e=d.XL,t=(L===a.TitleOnLeft),u=o.getUseTwoColumnsForLargeScreen();if(t){i-=1;e-=1;}if(u){i-=1;}d.L=i;d.XL=e;return d;};c.prototype.refreshSeeMoreVisibility=function(){var d=!!this.getMoreBlocks().length,s=this._getSeeMoreButton(),$=s.$(),e=this.$();if(!d){d=this.getBlocks().some(function(o){if(o instanceof B&&o.getVisible()&&o.getShowSubSectionMore()){return true;}});}if(e.length){e.toggleClass("sapUxAPObjectPageSubSectionWithSeeMore",d);}this.toggleStyleClass("sapUxAPObjectPageSubSectionWithSeeMore",d);if($.length){$.toggleClass("sapUxAPSubSectionSeeMoreButtonVisible",d);}s.toggleStyleClass("sapUxAPSubSectionSeeMoreButtonVisible",d);return d;};c.prototype.setMode=function(m){if(this.getMode()!==m){this._switchSubSectionMode(m);if(this._bRenderedFirstTime){this.rerender();}}return this;};c.prototype.onkeydown=function(e){if(e.keyCode===jQuery.sap.KeyCodes.F7){e.stopPropagation();var t=sap.ui.getCore().byId(e.target.id);if(t instanceof c){this._handleSubSectionF7();}else{this._handleInteractiveElF7();this._oLastFocusedControlF7=t;}}};c.prototype._handleInteractiveElF7=function(){if(this.getParent().getSubSections().length>1){this.$().focus();}else{this.getParent().$().focus();}};c.prototype._handleSubSectionF7=function(e){if(this._oLastFocusedControlF7){this._oLastFocusedControlF7.$().focus();}else{this.$().firstFocusableDomRef().focus();}};c.prototype._calcBlockColumnLayout=function(d,o){var g=12,v,M,L,X,D;M={iRemaining:o.M,iColumnConfig:o.M};L={iRemaining:o.L,iColumnConfig:o.L};X={iRemaining:o.XL,iColumnConfig:o.XL};D=[X,L,M];v=d.filter(function(e){return e.getVisible&&e.getVisible();});v.forEach(function(e,i){D.forEach(function(f){f.iCalculatedSize=this._calculateBlockSize(e,f.iRemaining,v,i,f.iColumnConfig);},this);e.setLayoutData(new sap.ui.layout.GridData({spanS:g,spanM:M.iCalculatedSize*(g/M.iColumnConfig),spanL:L.iCalculatedSize*(g/L.iColumnConfig),spanXL:X.iCalculatedSize*(g/X.iColumnConfig),linebreakM:(i>0&&M.iRemaining===M.iColumnConfig),linebreakL:(i>0&&L.iRemaining===L.iColumnConfig),linebreakXL:(i>0&&X.iRemaining===X.iColumnConfig)}));D.forEach(function(f){f.iRemaining-=f.iCalculatedSize;if(f.iRemaining<1){f.iRemaining=f.iColumnConfig;}});},this);return v;};c.prototype._calculateBlockSize=function(o,r,v,i,m){var d,f=m,e;if(!this._hasAutoLayout(o)){return Math.min(m,parseInt(o.getColumnLayout(),10));}for(e=1;e<=f;e++){d=this._calcLayout(v[i+e]);if(d<r){r-=d;}else{break;}}return r;};c.prototype._calcLayout=function(o){var L=1;if(!o){L=0;}else if(o instanceof B&&o.getColumnLayout()!="auto"){L=parseInt(o.getColumnLayout(),10);}return L;};c.prototype._hasAutoLayout=function(o){return!(o instanceof B)||o.getColumnLayout()=="auto";};c.prototype._afterRenderingTitleOnLeftLayout=function(){this._$standardHeader=jQuery.sap.byId(this.getId()+"-header");this._$grid=this._getGrid().$();if(!this._iResizeId){this._iResizeId=sap.ui.core.ResizeHandler.register(this,this._titleOnLeftSynchronizeLayouts.bind(this));}this._titleOnLeftSynchronizeLayouts();};c.prototype._titleOnLeftSynchronizeLayouts=function(){jQuery.sap.delayedCall(50,this,function(){var u=(this._$grid.hasClass("sapUiRespGridMedia-Std-Desktop")||this._$grid.hasClass("sapUiRespGridMedia-Std-LargeDesktop"));this._$standardHeader.toggleClass("titleOnLeftLayout",u);});};c.prototype._setAggregationProxy=function(){if(this._bRenderedFirstTime){return;}jQuery.each(this._aAggregationProxy,jQuery.proxy(function(A,v){this._setAggregation(A,this.removeAllAggregation(A));},this));this._bRenderedFirstTime=true;};c.prototype.hasProxy=function(A){return this._bRenderedFirstTime&&this._aAggregationProxy.hasOwnProperty(A);};c.prototype._getAggregation=function(A){return this._aAggregationProxy[A];};c.prototype._setAggregation=function(A,v){this._aAggregationProxy[A]=v;this._notifyObjectPageLayout();this.invalidate();return this._aAggregationProxy[A];};c.prototype.addAggregation=function(A,o){var d;if(this.hasProxy(A)){d=this._getAggregation(A);d.push(o);this._setAggregation(d);if(o instanceof B){o.setParent(this);}return this;}return O.prototype.addAggregation.apply(this,arguments);};c.prototype.insertAggregation=function(A,o,i){if(this.hasProxy(A)){jQuery.sap.log.warning("ObjectPageSubSection :: used of insertAggregation for "+A+" is not supported, will use addAggregation instead");return this.addAggregation(A,o);}return O.prototype.insertAggregation.apply(this,arguments);};c.prototype.removeAllAggregation=function(A){var i,I;if(this.hasProxy(A)){i=this._getAggregation(A);I=i.slice(0,i.length-1);this._setAggregation(A,[]);return I;}return O.prototype.removeAllAggregation.apply(this,arguments);};c.prototype.removeAggregation=function(A,o){var r=false,i;if(this.hasProxy(A)){i=this._getAggregation(A);i.forEach(function(d,I){if(d.getId()===o.getId()){i.splice(I,1);this._setAggregation(i);r=true;}return!r;},this);return(r?o:null);}return O.prototype.removeAggregation.apply(this,arguments);};c.prototype.indexOfAggregation=function(A,o){var i=-1;if(this.hasProxy(A)){this._getAggregation(A).some(function(d,I){if(d.getId()===o.getId()){i=I;return true;}},this);return i;}return O.prototype.indexOfAggregation.apply(this,arguments);};c.prototype.getAggregation=function(A){if(this.hasProxy(A)){return this._getAggregation(A);}return O.prototype.getAggregation.apply(this,arguments);};c.prototype.destroyAggregation=function(A){if(this.hasProxy(A)){this._getAggregation(A).forEach(function(o){o.destroy();});this._setAggregation(A,[]);return this;}return O.prototype.destroyAggregation.apply(this,arguments);};c.prototype._getSeeMoreButton=function(){if(!this._oSeeMoreButton){this._oSeeMoreButton=new sap.m.Button(this.getId()+"--seeMore",{type:sap.m.ButtonType.Transparent,iconFirst:false}).addStyleClass("sapUxAPSubSectionSeeMoreButton").attachPress(this._seeMoreLessControlPressHandler,this);}return this._oSeeMoreButton;};c.prototype._seeMoreLessControlPressHandler=function(e){var s=this.getMode(),t,m=this.getMoreBlocks()||[];if(s===b.Expanded){t=b.Collapsed;}else{t=b.Expanded;m.forEach(function(o){if(o instanceof B){o.setMode(s);o.connectToModels();}},this);}this._switchSubSectionMode(t);if(this._$spacer.length>0){this._$spacer.height(this._$spacer.height()+this.$().height());}this.rerender();};c.prototype._switchSubSectionMode=function(s){s=this.validateProperty("mode",s);if(s===b.Collapsed){this.setProperty("mode",b.Collapsed,true);this._getSeeMoreButton().setText(this._getResourceBundle().getText("SEE_MORE"));}else{this.setProperty("mode",b.Expanded,true);this._getSeeMoreButton().setText(this._getResourceBundle().getText("SEE_LESS"));}};c.prototype._setBlockMode=function(o,m){if(o instanceof B){o.setMode(m);}else{jQuery.sap.log.debug("ObjectPageSubSection :: cannot propagate mode "+m+" to "+o.getMetadata().getName());}};c.prototype._setToFocusable=function(f){var F='0',n='-1',t="tabIndex";if(f){this.$().attr(t,F);}else{this.$().attr(t,n);}return this;};c.prototype._resetLayoutData=function(d){d.forEach(function(o){if(!this._bRenderedFirstTime&&o.getLayoutData()){o.destroyLayoutData();jQuery.sap.log.warning("ObjectPageSubSection :: forbidden use of layoutData for block "+o.getMetadata().getName(),"layout will be set by subSection");}},this);};c.prototype.getVisibleBlocksCount=function(){var v=0;(this.getBlocks()||[]).forEach(function(o){if(o.getVisible&&!o.getVisible()){return true;}v++;});(this.getMoreBlocks()||[]).forEach(function(m){if(m.getVisible&&!m.getVisible()){return true;}v++;});return v;};return c;});
